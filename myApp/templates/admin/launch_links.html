{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Launch Links</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-6">
      <div>
        <div class="text-xl font-semibold text-slate-900">Launch Links</div>
        <div class="text-xs text-slate-500">Org: {{ org.name }}</div>
      </div>
      <a href="/portal/dashboard/" class="text-sm text-emerald-700 hover:underline">Back to portal</a>
    </div>

    <div class="grid md:grid-cols-2 gap-6">
      <!-- Staff apps -->
      <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-xl">
        <div class="font-medium text-slate-900 mb-3">Staff apps (pin on iPad)</div>
        <div class="space-y-2 text-sm">
          {% for label, url in staff_links.items %}
            <div class="flex items-center justify-between">
              <span class="text-slate-700">{{ label }}</span>
              <a href="{{ url }}" class="text-emerald-700 hover:underline" target="_blank" rel="noopener">Open</a>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Kiosk mint -->
      <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-xl">
        <div class="font-medium text-slate-900 mb-3">Create kiosk link</div>
        <form id="mint" class="flex items-end gap-3">
          {% csrf_token %}
          <div class="flex-1">
            <label class="text-sm text-slate-600">Kiosk app</label>
            <select name="app" class="mt-1 w-full rounded-xl border-slate-300 focus:border-emerald-500 focus:ring-emerald-500">
              <option value="intake">Patient Intake</option>
              <option value="consent">Consent</option>
            </select>
          </div>
          <button class="rounded-xl bg-emerald-600 text-white px-4 py-2.5 hover:bg-emerald-700">Mint link</button>
        </form>

        <div id="result" class="mt-4 hidden">
          <div class="text-xs text-slate-500 mb-1">Kiosk URL</div>
          <input id="url" class="w-full rounded-xl border-slate-300" readonly>
          <div class="mt-3 flex items-center gap-2">
            <button id="copy" class="rounded-xl border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50">Copy</button>
            <a id="open" class="rounded-xl bg-emerald-600 text-white px-3 py-2 text-sm hover:bg-emerald-700" target="_blank" rel="noopener">Open</a>
          </div>
          <p id="err" class="hidden mt-2 text-sm text-rose-700"></p>
        </div>
      </div>
    </div>
  </div>

<script>
const form = document.getElementById('mint');
form.onsubmit = async (e) => {
  e.preventDefault();
  const fd = new FormData(form);
  const token = document.querySelector('input[name=csrfmiddlewaretoken]').value;

  try {
    const r = await fetch("{% url 'launch_links_new' %}", {
      method: "POST",
      headers: {"X-CSRFToken": token},
      body: fd
    });
    const j = await r.json();
    if (j.ok) {
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('url').value = j.url;
      document.getElementById('open').href = j.url;
      const err = document.getElementById('err'); err.classList.add('hidden'); err.textContent = "";
    } else {
      showErr("Failed to mint link.");
    }
  } catch (err) {
    showErr("Network error creating link.");
  }
};

document.getElementById('copy').onclick = async (e) => {
  e.preventDefault();
  try {
    await navigator.clipboard.writeText(document.getElementById('url').value);
    alert("Copied to clipboard");
  } catch (err) {}
};

function showErr(msg){
  document.getElementById('result').classList.remove('hidden');
  const el = document.getElementById('err');
  el.textContent = msg;
  el.classList.remove('hidden');
}
</script>
</body>
</html>
