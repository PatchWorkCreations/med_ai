<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>NeuroMed AI Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="/static/pwa/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/static/pwa/icons/apple-touch-icon-180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/pwa/icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/pwa/icons/favicon-16.png">
  <meta name="theme-color" content="#236092">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<style>
  /* ----- Base surface/background ----- */
  body { background: linear-gradient(to right, #f5f7fa, #e4ebf5); }
  .glass { background:#ffffff; border:1px solid #e5e7eb; } /* light gray border */

  /* ----- Chat bubbles (single source of truth) ----- */
  .chat-bubble{
    border-radius: 1.25rem;
    padding: 12px 18px;
    font-size: 15px;          /* unified with rich content */
    line-height: 1.45;        /* unified with rich content */
    max-width: 75%;
    white-space: pre-wrap;
    word-break: break-word;
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
    animation: fadeInUp .25s ease;
  }
  /* Inner typography utility used by JS-rendered content AND typing bubble */
  .chat-rich{ font-size:15px; line-height:1.45; }

  /* kill default paragraph spacing inside bubbles */
  .chat-bubble p{ margin: .25rem 0; }
  .chat-bubble p:first-child{ margin-top: 0; }
  .chat-bubble p:last-child{  margin-bottom: 0; }
  .chat-bubble > *:first-child{ margin-top:0 !important; }
  .chat-bubble > *:last-child{  margin-bottom:0 !important; }

  /* Sides: color + alignment ONLY (no padding/radius/width here to avoid overrides) */
  .chat-user{
    background-color:#dbeafe; color:#1f2937;
    margin-left:auto; margin-right:0;     /* RIGHT side */
  }
  .chat-ai{
    background-color:#ecfdf5; color:#1f2937;
    margin-right:auto; margin-left:0;     /* LEFT side  */
  }

  /* ===== Ultra-compact AI markdown (AI bubbles only) ===== */
.chat-ai.chat-bubble { white-space: normal; line-height: 1.40; padding: 10px 12px; }

.chat-user.chat-bubble { white-space: normal; line-height: 1.40; padding: 10px 12px; }

.chat-ai .md-prose { font-size: .98rem; line-height: 1.40; }
.chat-ai .md-prose > :first-child { margin-top: 0 !important; }
.chat-ai .md-prose > :last-child  { margin-bottom: 0 !important; }

.chat-ai .md-prose h1,
.chat-ai .md-prose h2,
.chat-ai .md-prose h3,
.chat-ai .md-prose h4 { margin: .22em 0 .14em !important; line-height: 1.18; }
.chat-ai .md-prose h1 { font-size: 1.18rem; }
.chat-ai .md-prose h2 { font-size: 1.08rem; }
.chat-ai .md-prose h3 { font-size: 1.02rem; }
.chat-ai .md-prose h4 { font-size: .98rem; }

.chat-ai .md-prose p { margin: .12em 0 !important; }
.chat-ai .md-prose p + p { margin-top: .10em !important; }
.chat-ai .md-prose p:empty { display: none; }

.chat-ai .md-prose :is(h1,h2,h3,h4) + :is(p,ul,ol,table,blockquote) { margin-top: .16em !important; }
.chat-ai .md-prose :is(p,ul,ol,table,blockquote) + :is(h1,h2,h3,h4) { margin-top: .24em !important; }

.chat-ai .md-prose ul, .chat-ai .md-prose ol { margin: .14em 0 .2em 1em !important; }
.chat-ai .md-prose li { margin: .04em 0 !important; }

.chat-ai .md-prose blockquote { border-left: 2px solid #e2e8f0; padding-left: .45rem; margin: .18em 0 !important; color: #475569; }

.chat-ai .md-prose code { background:#0f172a0d; padding:.04rem .18rem; border-radius:.3rem; }
.chat-ai .md-prose pre  { background:#0f172a0d; padding:.5rem; border-radius:.6rem; margin:.22rem 0 !important; }

.chat-ai .md-prose table { width:100%; border-collapse: collapse; margin:.22rem 0 !important; font-size:.93rem; }
.chat-ai .md-prose th, .chat-ai .md-prose td { border:1px solid #e2e8f0; padding:.28rem .4rem; }
.chat-ai .md-prose thead th { background:#f8fafc; }




  /* Hover / small UI polish */
  .sidebar-link:hover{ background:#f0f0f0; transition:all .2s; }

  /* Animations (single definition) */
  @keyframes fadeInUp{ from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
  .animate-fadeInUp{ animation: fadeInUp .35s ease-out; }
  #loadingOverlay i{ animation:pulseFade 1.2s infinite ease-in-out; }
  @keyframes pulseFade{ 0%,100%{opacity:.6; transform:scale(1)} 50%{opacity:1; transform:scale(1.1)} }
  #chatWindow > div:first-child{ margin-top:0!important; margin-bottom:0!important; }

  /* Composer */
  .dropzone{ border:2px dashed rgba(0,0,0,.08); transition:.15s ease; }
  .dropzone.dragover{ border-color:#28926D; background:rgba(40,146,109,.08); }
  .thumb{ position:relative; border-radius:.75rem; border:1px solid rgba(0,0,0,.06); background:#fff; }
  .thumb img{ display:block; width:100%; height:100%; object-fit:cover; border-radius:.65rem; }
  .thumb-remove{
    position:absolute; top:6px; right:6px; background:#111827; color:#fff;
    border-radius:9999px; width:22px; height:22px; display:flex; align-items:center;
    justify-content:center; font-size:.75rem;
  }

  /* Rotated side tab (hidden on tiny phones; see media queries) */
  #feedbackTab{
    position:fixed; top:50%; right:10px; transform:translateY(-50%) rotate(-90deg);
    transform-origin:bottom right; background-color:#236092; color:#fff;
    padding:.5rem 1rem; border-radius:.25rem .25rem 0 0; box-shadow:0 2px 8px rgba(0,0,0,.2);
    z-index:9999; cursor:pointer; white-space:nowrap;
  }
  #feedbackTab:hover{ background-color:#1B5A8E; }
  #feedbackTab:focus{ outline:none; }
  #feedbackTab, #feedbackTab *{ pointer-events:auto; }

  /* --- Core fixes: prevent right-edge clipping on tiny screens --- */
  :where(header, #toneBar, #chatWindow, #dropzone, #composer, section.flex-1){
    min-width:0 !important; max-width:100vw;
  }
  #toneBar{ overflow-x:auto; -webkit-overflow-scrolling:touch; }

  /* iOS Safari 100vh fix */
  @media (max-width:480px){
    @supports (height:100dvh){
      .h-screen{ height:100dvh; }
    }
  }

  /* Hide rotated tab on small phones; rely on FAB */
  @media (max-width:380px){ #feedbackTab{ display:none !important; } }

  /* --- Tiny phone hardening (<= 320px) --- */
  @media (max-width:320px){
    html, body{ overflow-x:hidden; }

    #sidebar{ width:88vw !important; padding:16px !important; }
    header{ padding-left:12px !important; padding-right:12px !important; }
    #chatWindow{ padding:10px 12px !important; }

    .chat-bubble{
      font-size:14px !important;
      padding:8px 12px !important;
      max-width:92% !important;
    }

    #toneBar{ font-size:12px !important; padding-left:8px !important; padding-right:12px !important; }
    #toneBar label{ margin-right:8px !important; }

    #dropzone{ gap:6px !important; padding:8px !important; }
    #addBtn, #micBtn, #sendBtn{ width:34px !important; height:34px !important; }
    #addBtn i, #micBtn i, #sendBtn i{ font-size:13px !important; }
    #chatInput{ font-size:13px !important; padding:8px 10px !important; min-width:0 !important; }

    #composer{
      position:sticky; bottom:env(safe-area-inset-bottom); z-index:30; background:#fff;
      padding-bottom:calc(12px + env(safe-area-inset-bottom)) !important;
    }

    #feedbackPanel{ width:100% !important; }
    #feedbackPanel .px-5{ padding-left:12px !important; padding-right:12px !important; }

    #summaryModal .p-8{ padding:16px !important; }
    #summaryModal .text-2xl{ font-size:18px !important; }
    #modalContent{ font-size:14px !important; }
  }

  /* Slight boost just above 320 for consistency */
  @media (max-width:340px){
    header h1{ font-size:18px !important; }
    header i.text-2xl{ font-size:18px !important; }
    #chatInput{ font-size:13px !important; }
    .chat-bubble{ max-width:94% !important; }
  }

  @media (max-width:360px){ #feedbackTab{ top:30% !important; } }

  /* ======= Spotlight Tour (no libs) ======= */
  .nm-tour-overlay{ position:fixed; inset:0; z-index:10050; pointer-events:auto; }
  .nm-tour-dim{ position:absolute; inset:0; background:rgba(0,0,0,.55); }
  .nm-tour-hole{
    position:absolute; border-radius:12px;
    box-shadow:0 0 0 200vmax rgba(0,0,0,.55);
    background:transparent; pointer-events:none;
    transition:top .18s ease, left .18s ease, width .18s ease, height .18s ease;
  }
  .nm-tour-pop{ position:fixed; max-width:min(92vw, 340px); z-index:10051; }
  @media (max-width:360px){ .nm-tour-pop{ max-width:min(92vw, 300px);} }
  .nm-tour-sr-only{ position:absolute!important; left:-9999px!important; }

  :root{ --kebab-space:36px; }

  /* Cards / list */
  .nm-card{ position:relative; border-radius:12px; background:#fff; }
  .nm-row{  padding:8px 10px; min-height:44px; border-radius:12px; }
  .nm-content{ padding-right:var(--kebab-space); }
  .nm-title{ font-size:14px; line-height:1.25; font-weight:600; color:#0f172a; }
  .nm-1line{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .nm-chip{ font-size:10px; line-height:1; padding:3px 6px; border-radius:9999px; white-space:nowrap; }
  .nm-chips{ margin-top:4px; display:flex; gap:6px; justify-content:flex-end; margin-right:calc(var(--kebab-space) + 4px); }
  .nm-kebab{ position:absolute; top:6px; right:6px; z-index:10; padding:6px; border-radius:8px; }
  .nm-kebab button{ pointer-events:auto; }
  .nm-kebab:hover{ background:#f1f5f9; }
  .nm-rename-input{
    font-size:14px; font-weight:600; color:#0f172a; border:1px solid #e2e8f0; background:#fff;
    padding:4px 8px; border-radius:8px; width:100%;
  }
  .nm-rename-input:focus{ outline:none; box-shadow:0 0 0 2px rgba(40,146,109,.25); border-color:#28926D; }

/* Geriatric accessibility zoom */
/* Full-height shell; page itself never scrolls */
#appShell { height: 100vh; height: 100svh; height: 100dvh; overflow: hidden; }
section.flex-1 { min-height: 0; }
#chatWindow { min-height: 0; overflow-y: auto; }

/* Composer pinned at the bottom of the viewport */
#composer { position: sticky; bottom: 0; z-index: 20; background: #fff; }

/* Zoom: scale ONLY the main content area, not the sidebar */
:root {
  --nm-zoom: 1;
  --composer-h: 84px; /* JS will update this */
}

#zoomScope {
  transform-origin: top left;
  transform: scale(var(--nm-zoom));
  width: calc(100% / var(--nm-zoom));
  padding-bottom: calc(var(--composer-h) + 12px); /* keep bottom UI visible */
}

/* Sidebar stays layout-stable */
body.geriatric-zoom #sidebar { font-size: 1.05em; }

/* Enable zoom when Geriatric */
body.geriatric-zoom { --nm-zoom: 1.25; font-size: 112%; }

@media (max-width: 380px){
  body.geriatric-zoom { --nm-zoom: 1.15; }
}


</style>



</head>

<body class="bg-white font-sans text-gray-800">
  <div id="appShell" class="w-full h-screen flex overflow-y-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-[300px] md:w-[320px] glass border-r p-6 overflow-y-auto fixed inset-y-0 left-0 z-40 transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:translate-x-0 md:z-auto md:flex flex-col shadow-xl">
      <div class="flex items-center justify-between mb-6 border-b border-gray-200 pb-2">
        <h2 class="text-2xl font-semibold text-gray-800 flex items-center gap-3">
          <i class="fa-solid fa-clock-rotate-left text-[#236092] text-2xl"></i>
          <span class="tracking-tight">Summary History</span>
        </h2>
        <div class="relative">
          <button onclick="openSettingsModal()" class="text-gray-600 hover:text-[#236092] focus:outline-none">
            <i class="fa-solid fa-user-circle text-2xl"></i>
          </button>
          <div id="settingsDropdown" class="absolute right-0 mt-2 w-44 bg-white rounded-lg shadow-lg hidden z-50 text-base">
            <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-user mr-2 text-gray-400"></i> Profile</a>
            <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-pen-to-square mr-2 text-gray-400"></i> Change Name</a>
            <a href="{% url 'logout' %}" class="block px-4 py-2 hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-right-from-bracket mr-2 text-gray-400"></i> Logout</a>
          </div>
        </div>
      </div>

      <button class="mb-4 w-full bg-[#236092] text-white text-base py-2 rounded-lg hover:bg-[#1B5A8E] transition" id="newChatBtn">
        <i class="fa-solid fa-plus mr-2"></i>New Chat
      </button>

      <div class="mb-4 relative">
        <input type="text" placeholder="Search summaries..." class="w-full px-3 py-2 text-base rounded-md bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-[#28926D]" />
        <i class="fa-solid fa-magnifying-glass absolute right-3 top-2.5 text-gray-400 text-base"></i>
      </div>

      <!-- Sidebar list -->
      <ul id="sessionList" class="space-y-4">
        <!-- JS will populate -->
      </ul>
    </aside>

    <!-- Main -->
<section class="flex-1 flex flex-col relative bg-white">
  <div id="zoomScope" class="flex-1 flex flex-col min-h-0 bg-white">
        <!-- Header -->
        <header class="flex items-center justify-between px-6 py-4 border-b relative">
          <!-- Left group: logo + title -->
          <div class="flex items-center gap-2 relative group">
            <i class="fa-solid fa-notes-medical text-[#236092] text-2xl"></i>
            <h1 class="text-2xl font-bold text-gray-800 cursor-help">
              NeuroMed <span class="text-[#236092]">AI</span>
            </h1>

            <!-- tooltip -->
            <div class="absolute -bottom-12 left-0 z-10 w-max max-w-xs px-3 py-2 text-base text-white bg-gray-800 rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none shadow-md">
              NeuroMed AI simplifies complex medical records into compassionate, easy-to-understand summaries.
            </div>
          </div>

          <!-- Right group -->
          <div class="flex items-center gap-3">
            <!-- Desktop language picker -->
            <div class="hidden md:block">
              <div class="relative">
                <button id="langBtn"
                        class="inline-flex items-center gap-2 px-2.5 py-1.5 rounded-md border hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#28926D]"
                        aria-haspopup="true" aria-expanded="false" aria-controls="langMenu" title="Language">
                  <i class="fa-solid fa-globe"></i>
                  <span id="langBtnLabel" class="text-sm text-gray-700">English</span>
                  <i class="fa-solid fa-chevron-down text-xs text-gray-500"></i>
                </button>

                <!-- options injected by JS -->
                <div id="langMenu"
                     class="hidden absolute right-0 mt-2 w-56 max-h-72 overflow-auto bg-white border rounded-lg shadow-lg z-50">
                </div>
              </div>
            </div>

            <!-- Mobile language trigger -->
            <div class="md:hidden">
              <button id="mLangBtn"
                      class="px-3 py-2 rounded-lg border flex items-center justify-between bg-white active:scale-[.99] transition"
                      aria-haspopup="dialog" aria-expanded="false">
                <span class="flex items-center gap-2">
                  <i class="fa-solid fa-globe"></i>
                  <span id="mLangBtnLabel">English</span>
                </span>
                <i class="fa-solid fa-caret-down opacity-70"></i>
              </button>
            </div>

            <!-- Burger (mobile only) -->
            <button id="burgerBtn" onclick="toggleSidebar()" class="md:hidden text-gray-600 text-2xl focus:outline-none">
              <i class="fa-solid fa-bars"></i>
            </button>
          </div>
        </header>

        <div id="toneBar" class="px-3 py-1 bg-[#fefaf7] text-gray-600 overflow-x-auto whitespace-nowrap">
          <span class="font-semibold mr-2">Summary Tone:</span>
          <label class="inline-flex items-center mr-3">
            <input type="radio" name="tone" value="PlainClinical" checked>
            <span class="ml-1">Balanced</span>
          </label>
          <label class="inline-flex items-center mr-3">
            <input type="radio" name="tone" value="Caregiver">
            <span class="ml-1">Caregiver</span>
          </label>
          <label class="inline-flex items-center mr-3">
            <input type="radio" name="tone" value="Faith">
            <span class="ml-1">Faith</span>
          </label>
          <label class="inline-flex items-center mr-3">
            <input type="radio" name="tone" value="Clinical">
            <span class="ml-1">Clinical</span>
          </label>
          <label class="inline-flex items-center mr-3">
            <input type="radio" name="tone" value="Geriatric">
            <span class="ml-1">Geriatric</span>
          </label>
          <!-- New Emotional Support tone -->
          <label class="inline-flex items-center mr-3">
            <input type="radio" name="tone" value="EmotionalSupport">
            <span class="ml-1">Emotional Support</span>
          </label>
        </div>

        <!-- Chat Window -->
        <div id="chatWindow" class="flex-1 px-6 py-4 overflow-y-auto text-base bg-gradient-to-br from-white to-gray-50 rounded-xl"></div>

        <!-- Tone Selector -->
        
      </div><!-- /#zoomScope -->

      <!-- Composer (INTENTIONALLY OUTSIDE zoomScope so it stays pinned) -->
      <div id="composer" class="border-t p-4 bg-white shadow-inner">
        <!-- Pending attachments tray -->
        <div id="pendingTray" class="hidden mb-3">
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm text-gray-600"><i class="fa-solid fa-paperclip mr-2"></i>Pending attachments</div>
            <button id="clearAllBtn" class="text-xs text-red-600 hover:underline">Clear all</button>
          </div>
          <!-- NOTE: 2 columns by default for tiny phones -->
          <div id="pendingGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3"></div>
        </div>

        <!-- Input row with dropzone -->
        <div id="dropzone" class="dropzone rounded-xl p-3 flex items-center gap-2 overflow-hidden">
          <!-- Add -->
          <button id="addBtn" class="shrink-0 w-10 h-10 rounded-full bg-[#236092] hover:bg-[#1B5A8E] text-white flex items-center justify-center text-xl shadow-md" title="Add files">
            <i class="fa-solid fa-plus"></i>
          </button>

          <input type="file" id="fileInput" class="hidden" multiple
                accept=".pdf,.docx,.txt,.jpg,.jpeg,.png,.webp,.heic" />

          <!-- Text input -->
          <input type="text" id="chatInput"
                class="flex-1 min-w-0 px-4 py-2 text-base border rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-[#28926D]/40"
                placeholder="Type your question… (attachments will send with this)" />

          <!-- Mic -->
          <button id="micBtn" class="shrink-0 w-10 h-10 rounded-full bg-gray-200 text-gray-800 flex items-center justify-center hover:bg-gray-300" title="Dictate">
            <i class="fa-solid fa-microphone"></i>
          </button>

          <!-- Send -->
          <button id="sendBtn" type="button" class="shrink-0 w-10 h-10 rounded-full bg-black text-white flex items-center justify-center shadow-md hover:bg-gray-900" title="Send">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>

        <p class="mt-1 text-xs text-gray-500 pl-12">Tip: Drag & drop files here to stage them. They won’t send until you hit <b>Send</b>.</p>
      </div>
    </section>
  </div>

  <!-- Summary Modal -->
  <div id="summaryModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl relative p-8 ring-1 ring-gray-200">
      <button onclick="closeModal()" class="absolute top-3 right-4 text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
      <div class="mb-4">
        <h2 class="text-2xl font-bold text-[#236092] flex items-center gap-2">
          <i class="fa-solid fa-brain text-[#236092] text-2xl"></i> Full Summary
        </h2>
        <p class="text-base text-gray-500">Here’s the complete AI-generated explanation.</p>
      </div>
      <div id="modalContent" class="text-gray-800 text-base leading-relaxed max-h-[60vh] overflow-y-auto space-y-4 prose prose-sm"></div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 z-50 flex flex-col items-center justify-center text-center hidden">
    <div class="animate-spin mb-4 text-[#236092] text-4xl"><i class="fa-solid fa-brain"></i></div>
    <p class="text-2xl font-semibold text-gray-700">NeuroMed is thinking…</p>
    <p class="text-base text-gray-500 mt-2 italic"><i class="fa-solid fa-brain text-[#236092] text-2xl"></i> Please hold the coffee ☕</p>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity duration-300">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 relative ring-1 ring-gray-200 animate-fadeInUp">
      <button onclick="closeSettingsModal()" class="absolute top-5 right-6 text-gray-400 hover:text-gray-600 text-2xl transition">&times;</button>
      <div class="mb-6 flex items-center gap-3">
        <i class="fa-solid fa-sliders text-2xl text-[#236092]"></i>
        <h2 class="text-3xl font-bold text-gray-800 tracking-tight">Settings</h2>
      </div>
      <div class="mb-5">
        <label for="displayName" class="block text-sm font-semibold text-gray-700 mb-1">Display Name</label>
        <input type="text" id="displayName" placeholder="e.g. Maria Gregory" class="w-full px-4 py-3 border rounded-lg shadow-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-[#28926D] bg-gray-50 transition" />
      </div>
      <div class="mb-5">
        <label for="profession" class="block text-sm font-semibold text-gray-700 mb-1">Profession</label>
        <input type="text" id="profession" placeholder="e.g. Healthcare Advocate, Tech Founder" class="w-full px-4 py-3 border rounded-lg shadow-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-[#28926D] bg-gray-50 transition" />
      </div>
      <div class="mb-6 text-sm text-gray-500 italic">
        <i class="fa-solid fa-image-portrait mr-2 text-gray-400"></i> Profile photo upload coming soon...
      </div>
      <div class="flex justify-between items-center mt-6">
        <button onclick="saveSettings()" class="bg-[#236092] hover:bg-[#1B5A8E] text-white font-semibold px-6 py-2.5 rounded-full shadow-md transition flex items-center gap-2">
          <i class="fa-solid fa-check-circle text-white text-lg"></i> Save Changes
        </button>
        <button onclick="logoutUser()" class="text-sm text-red-600 hover:underline">Logout</button>
      </div>
    </div>
  </div>

  <!-- Rotated side tab (hidden on tiny phones) -->
  <button id="feedbackTab"
    class="sm:flex fixed 
           top-1/2 sm:top-1/2 top-[40%]
           -translate-y-1/2 z-[9999]
           bg-[#236092] hover:bg-[#1B5A8E] text-white shadow-lg
           px-3 py-2 rounded-tl-md rounded-tr-md
           transform -rotate-90 origin-bottom-right
           whitespace-nowrap tracking-wide text-sm"
    style="right: 10px;">
    <i class="fa-solid fa-comment-dots mr-2 rotate-90"></i> Give feedback
  </button>

  <!-- Slide-over Panel -->
  <div id="feedbackPanel" class="fixed inset-y-0 right-0 w-full sm:w-[520px] z-[70] translate-x-full transition-transform duration-300">
    <div class="h-full bg-white shadow-2xl border-l flex flex-col">
      <!-- Header -->
      <div class="px-5 py-4 border-b flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-heart text-[#236092] text-xl"></i>
          <h3 class="text-lg font-semibold">NeuroMed AI — Quick Feedback</h3>
        </div>
        <button id="feedbackClose" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
      </div>

      <!-- Body -->
      <form id="feedbackForm" class="px-5 py-4 overflow-y-auto space-y-4" enctype="multipart/form-data">
        <p class="text-sm text-gray-600 -mt-1">
          Thanks for trying NeuroMed AI! Please use <b>synthetic or public sample data</b> only — no Personal Health Information (PHI).
        </p>

        <!-- Consent -->
        <label class="flex items-start gap-2 text-sm bg-gray-50 border rounded p-3">
          <input type="checkbox" name="consent" required>
          <span>I agree to share feedback to help improve the product and will not include Personal Health Information (PHI).</span>
        </label>

        <!-- What you tested -->
        <div>
          <label class="text-sm font-medium">What did you try today? (choose all that apply)</label>
          <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
            <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="upload_summarize"> Upload → Summary</label>
            <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="multi_attachments"> Multiple attachments tray</label>
            <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="tone_selector"> Tone selector</label>
            <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="chat_qna"> Chat Q&amp;A</label>
            <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="summary_modal"> Full summary modal</label>
            <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="drag_drop"> Drag &amp; drop</label>
            <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="mic_dictation"> Voice dictation</label>
            <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="settings_update"> Settings update</label>
          </div>
        </div>

        <!-- Profile -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm">Your role</label>
            <select name="role" class="mt-1 w-full border rounded p-2" required>
              <option value="">Select…</option>
              <option value="caregiver">Caregiver</option>
              <option value="patient">Patient</option>
              <option value="clinician">Clinician</option>
              <option value="student">Student</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="text-sm">Email (optional, for follow-up)</label>
            <input name="email" type="email" class="mt-1 w-full border rounded p-2" placeholder="you@example.com">
          </div>
          <div>
            <label class="text-sm">What kind of input did you use?</label>
            <select name="input_type" class="mt-1 w-full border rounded p-2" required>
              <option value="">Select…</option>
              <option value="dummy">Text I wrote (dummy)</option>
              <option value="synthetic">Synthetic sample from the app</option>
              <option value="public">Public document (no PHI)</option>
              <option value="other">Other (no PHI)</option>
            </select>
          </div>
          <div>
            <label class="text-sm">Device</label>
            <input name="device" class="mt-1 w-full border rounded p-2" placeholder="e.g., MacBook, iPhone, Windows PC">
          </div>
          <div>
            <label class="text-sm">Browser</label>
            <input name="browser" class="mt-1 w-full border rounded p-2" placeholder="e.g., Safari 17, Chrome 126">
          </div>
        </div>

        <!-- Ratings -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm">Ease of use (1–5)</label>
            <input name="ease" type="number" min="1" max="5" value="3" class="mt-1 w-full border rounded p-2">
          </div>
          <div>
            <label class="text-sm">Speed (1–5)</label>
            <input name="speed" type="number" min="1" max="5" value="3" class="mt-1 w-full border rounded p-2">
          </div>
          <div>
            <label class="text-sm">Accuracy (1–5)</label>
            <input name="accuracy" type="number" min="1" max="5" value="3" class="mt-1 w-full border rounded p-2">
          </div>
          <div>
            <label class="text-sm">Clarity (1–5)</label>
            <input name="clarity" type="number" min="1" max="5" value="3" class="mt-1 w-full border rounded p-2">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm" for="nps">How likely are you to recommend NeuroMed AI? (0–10)</label>
            <input id="nps" name="nps" type="number" min="0" max="10" class="mt-1 w-full border rounded p-2" required>
            <div class="text-xs text-gray-500 mt-1">0 = Not at all likely • 10 = Extremely likely</div>
          </div>
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" name="allow_contact"> It’s okay to contact me about this feedback
          </label>
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" name="allow_anon" checked> Store my feedback anonymously
          </label>
        </div>

        <!-- Open text + screenshot -->
        <div>
          <label class="text-sm">What worked well?</label>
          <textarea name="pros" rows="2" class="w-full border rounded p-2" placeholder="What felt smooth or helpful?"></textarea>
        </div>
        <div>
          <label class="text-sm">What can we improve?</label>
          <textarea name="cons" rows="2" class="w-full border rounded p-2" placeholder="Any rough edges or missing pieces?"></textarea>
        </div>
        <div>
          <label class="text-sm">Bugs or errors — steps to reproduce</label>
          <textarea name="bugs" rows="2" class="w-full border rounded p-2" placeholder="1) Go to… 2) Click… 3) What happened…"></textarea>
        </div>
        <div>
          <label class="text-sm">Screenshot (optional)</label>
          <input type="file" name="screenshot" accept="image/*">
        </div>

        <!-- Submit -->
        <div class="flex items-center justify-between pt-2">
          <button type="submit" class="bg-[#236092] hover:bg-[#1B5A8E] text-white px-4 py-2 rounded">Submit feedback</button>
        </div>

        <div id="fbErrors" class="text-sm text-red-600 hidden"></div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div id="fbToast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="bg-[#28926D] text-white px-4 py-2 rounded shadow">Thanks! Feedback received. 💜</div>
  </div>

  <!-- Success Modal -->
  <div id="fbSuccess"
      class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/40 backdrop-blur-[1px]">
    <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl ring-1 ring-gray-200 p-6 relative">
      <button id="fbSuccessCloseX" class="absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>

      <div class="flex items-start gap-3 mb-3">
        <div class="shrink-0 rounded-full p-2 bg-[#28926D]/10 text-[#236092]">
          <i class="fa-solid fa-check"></i>
        </div>
        <div>
          <h3 class="text-xl font-semibold text-gray-800">Thanks for the feedback! 💜</h3>
          <p id="fbSuccessMsg" class="text-sm text-gray-600 mt-1">
            We’ve received your submission. Your input helps make NeuroMed AI kinder and sharper.
          </p>
        </div>
      </div>

      <div id="fbSuccessMeta" class="hidden text-xs text-gray-500 mb-4"></div>

      <div class="flex justify-end gap-2 mt-4">
        <button id="fbSuccessAnother"
                class="px-4 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-50">
          Send another
        </button>
        <button id="fbSuccessClose"
                class="px-4 py-2 rounded bg-[#236092] text-white hover:bg-[#1B5A8E]">
          Done
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Language Bottom Sheet (FIXED; must be outside #zoomScope) -->
  <div id="mLangMenu" class="fixed inset-0 z-50 hidden">
    <!-- Backdrop -->
    <button id="mLangBackdrop" class="absolute inset-0 bg-black/40" aria-label="Close language menu"></button>

    <!-- Sheet -->
    <div id="mLangPanel"
        class="absolute inset-x-0 bottom-0 max-h:[70vh] max-h-[70vh] overflow-hidden rounded-t-2xl bg-white shadow-2xl
               translate-y-full transition-transform duration-200 ease-out">
      <!-- Header -->
      <div class="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between">
        <div class="text-sm font-semibold">Choose language</div>
        <button id="mLangClose" class="p-2 text-slate-500" aria-label="Close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <!-- Search -->
      <div class="p-3">
        <label for="mLangSearch" class="sr-only">Search language</label>
        <div class="relative">
          <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
          <input id="mLangSearch" type="text"
                class="w-full pl-9 pr-3 py-2 border rounded-lg"
                placeholder="Search…">
        </div>
      </div>

      <!-- List -->
      <div id="mLangList"
          class="px-2 pb-4 overflow-y-auto"
          style="max-height: calc(70vh - 96px); padding-bottom: calc(env(safe-area-inset-bottom) + 12px);">
        <!-- options injected by JS -->
      </div>
    </div>
  </div>

  <!-- Mobile overlay (FIXED; must be outside #zoomScope) -->
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 z-30 hidden md:hidden" onclick="toggleSidebar()"></div>
</body>


<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js" defer></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer></script>
<script>
(() => {
  const chatWindow = document.getElementById('chatWindow');
  const composer   = document.getElementById('composer');

  const debounce = (fn, ms = 80) => {
    let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
  };

  function updateComposerPadding(){
    if (!chatWindow || !composer) return;
    const h = Math.ceil(composer.getBoundingClientRect().height || 0);
    chatWindow.style.paddingBottom = `calc(${h}px + 12px)`;          // so last bubble never hides
    document.documentElement.style.setProperty('--composer-h', `${h}px`); // so zoomScope reserves space
  }
  window.updateComposerPadding = updateComposerPadding;

  function applyZoomFromTone(){
    const selected = document.querySelector('input[name="tone"]:checked')?.value;
    const on = selected === 'Geriatric';
    document.body.classList.toggle('geriatric-zoom', on);
    if (on) localStorage.setItem('nm_zoom_mode', 'geriatric');
    else    localStorage.removeItem('nm_zoom_mode');
    requestAnimationFrame(updateComposerPadding);
    setTimeout(updateComposerPadding, 120);
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('input[name="tone"]').forEach(r =>
      r.addEventListener('change', applyZoomFromTone)
    );
    if (localStorage.getItem('nm_zoom_mode') === 'geriatric') {
      const g = document.querySelector('input[name="tone"][value="Geriatric"]');
      if (g && !g.checked) g.checked = true;
      applyZoomFromTone();
    } else {
      updateComposerPadding();
    }
  });

  window.addEventListener('resize', debounce(updateComposerPadding, 80));
  if (window.visualViewport) {
    visualViewport.addEventListener('resize', debounce(updateComposerPadding, 80));
  }

  if (chatWindow) {
    const mo = new MutationObserver(debounce(updateComposerPadding, 30));
    mo.observe(chatWindow, { childList: true });
  }
})();

(function(){
  // ---------- Elements ----------
  const tab       = document.getElementById('feedbackTab');
  const panel     = document.getElementById('feedbackPanel');
  const closeBtn  = document.getElementById('feedbackClose');
  const form      = document.getElementById('feedbackForm');
  const errBox    = document.getElementById('fbErrors');
  const toast     = document.getElementById('fbToast');

  // Success modal bits (optional, if present)
  const okModal   = document.getElementById('fbSuccess');
  const okClose   = document.getElementById('fbSuccessClose');
  const okCloseX  = document.getElementById('fbSuccessCloseX');
  const okAnother = document.getElementById('fbSuccessAnother');
  const okMsg     = document.getElementById('fbSuccessMsg');
  const okMeta    = document.getElementById('fbSuccessMeta');

  // ---------- Backdrop ----------
  let backdrop = null;
  function ensureBackdrop(show){
    if (show) {
      if (!backdrop) {
        backdrop = document.createElement('button');
        backdrop.type = 'button';
        backdrop.id = 'fbBackdrop';
        backdrop.className = 'fixed inset-0 z-[60] bg-black/40';
        backdrop.addEventListener('click', closeFeedback);
        document.body.appendChild(backdrop);
      }
      backdrop.classList.remove('hidden');
    } else {
      backdrop?.classList.add('hidden');
    }
  }

  // ---------- Open/Close ----------
  function openFeedback(){
    ensureBackdrop(true);
    panel?.classList.remove('translate-x-full');
    setTimeout(()=> panel?.querySelector('input,select,textarea,button')?.focus(), 60);
  }
  function closeFeedback(){
    panel?.classList.add('translate-x-full');
    ensureBackdrop(false);
    if (errBox){ errBox.classList.add('hidden'); errBox.textContent = ''; }
  }
  window.closeFeedback = closeFeedback; // expose for your other code if needed

  tab?.addEventListener('click', openFeedback);
  closeBtn?.addEventListener('click', closeFeedback);
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeFeedback(); });

  // ---------- Tiny toast ----------
  function showToast(msg='Thanks! Feedback received. 💜'){
    if (!toast) return;
    const box = toast.querySelector('div') || toast;
    box.textContent = msg;
    toast.classList.remove('hidden');
    setTimeout(()=> toast.classList.add('hidden'), 2000);
  }

  // ---------- Helpers ----------
  function getCSRFToken(){
    const m = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  function collectUseCase(){
    const boxes = form?.querySelectorAll('input[name="use_case_multi"]:checked') || [];
    return Array.from(boxes).map(b => b.value).join(', ');
  }

  function detectBrowserPretty() {
    const ua = navigator.userAgent || '';
    const rules = [
      { name: 'Edge',    re: /(Edg|Edge)\/(\d+)/i },
      { name: 'Chrome',  re: /(Chrome|Chromium)\/(\d+)/i },
      { name: 'Firefox', re: /Firefox\/(\d+)/i },
      { name: 'Safari',  re: /Version\/(\d+).+Safari/i },
    ];
    for (const r of rules) { const m = ua.match(r.re); if (m) return `${r.name} ${m[m.length - 1]}`; }
    return ua ? ua.split(') ').pop() || 'Unknown' : 'Unknown';
  }

  function prefillMeta() {
    if (!form) return;
    const dev = (navigator.userAgentData && navigator.userAgentData.platform) || navigator.platform || 'Unknown';
    const browserPretty = detectBrowserPretty();
    const devInput = form.querySelector('input[name="device"]');
    const brInput  = form.querySelector('input[name="browser"]');
    if (devInput && !devInput.value) devInput.value = dev;
    if (brInput  && !brInput.value)  brInput.value  = browserPretty;
  }
  document.addEventListener('DOMContentLoaded', prefillMeta);

  // ---------- Success modal ----------
  function openFbSuccess(data){
    if (!okModal){ showToast(); return; }
    okMeta?.classList.add('hidden');
    if (okMsg) okMsg.textContent = 'We’ve received your submission. Your input helps make NeuroMed AI kinder and sharper.';
    okModal.classList.remove('hidden');
    okModal.classList.add('flex');
  }
  function closeOk(){ okModal?.classList.add('hidden'); okModal?.classList.remove('flex'); }
  okClose?.addEventListener('click', closeOk);
  okCloseX?.addEventListener('click', closeOk);
  okAnother?.addEventListener('click', ()=>{ closeOk(); openFeedback(); });

  // ---------- Submit feedback ----------
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!form) return;

    // UI reset
    errBox?.classList.add('hidden');
    if (errBox) errBox.textContent = '';

    // Build FormData (multipart)
    const fd = new FormData(form);
    fd.append('use_case', collectUseCase()); // consolidate checkboxes → single field

    // Minimal validation to avoid server 400
    const consent = fd.get('consent');
    const nps     = Number(fd.get('nps'));
    const role    = String(fd.get('role') || '');
    const inputT  = String(fd.get('input_type') || '');

    if (!consent)      return showError('Please confirm consent (no PHI).');
    if (!Number.isFinite(nps) || nps < 0 || nps > 10) return showError('Please enter an NPS score from 0 to 10.');
    if (!role)         return showError('Please select your role.');
    if (!inputT)       return showError('Please select the input type.');

    const submitBtn = form.querySelector('button[type="submit"]');
    const originalHTML = submitBtn ? submitBtn.innerHTML : '';
    const setLoading = (on) => {
      if (!submitBtn) return;
      if (on) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Sending your feedback… hang tight';
      } else {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHTML;
      }
    };

    function showError(msg){
      if (errBox){ errBox.textContent = msg; errBox.classList.remove('hidden'); }
    }

    setLoading(true);

    try {
      const endpoint = form.getAttribute('action') || '/beta/api/submit/';

      const res = await fetch(endpoint, {
        method: 'POST',
        body: fd,
        credentials: 'include',
        headers: { 'X-CSRFToken': getCSRFToken() } // don't set Content-Type for FormData
      });

      let data = null;
      try { data = await res.json(); } catch { /* server might not return JSON on error */ }

      if (!res.ok || (data && data.success === false)) {
        const serverMsg = (data && (data.errors || data.detail || data.message)) || `Submit failed (${res.status}).`;
        showError(typeof serverMsg === 'string' ? serverMsg : JSON.stringify(serverMsg));
        setLoading(false);
        return;
      }

      // Success
      if (data && data.session_id && typeof window.setSessionId === 'function') {
        setSessionId(data.session_id);
        if (typeof window.refreshSessionList === 'function') {
          window.refreshSessionList().catch(()=>{});
        }
      }

      form.reset();
      prefillMeta(); // repopulate device/browser if blank
      setLoading(false);
      closeFeedback();
      openFbSuccess(data);

    } catch (err) {
      showError('Hi! It seems the connection is busy at the moment — give it another try in a few minutes. We appreciate your patience.');
      setLoading(false);
    }
  });
})();

/* =========================
   Chat + Sessions + Compose
   (safe drop-in replacement)
   ========================= */

/* ——— Reusable helpers ——— */
async function apiPost(url, data) {
  const opts = {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': (window.getCSRFToken ? getCSRFToken() : '')
    },
    credentials: 'include',
    body: data ? JSON.stringify(data) : '{}'
  };
  const r = await fetch(url, opts);
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

async function apiJson(url, opt={}) {
  const res = await fetch(url, { credentials: 'include', ...opt });
  if (!res.ok) throw new Error(`${res.status}`);
  return res.json();
}

function getCSRFToken(){
  const m = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}

/* ——— Session id helpers ——— */
const SESSION_KEY = 'nm_session_id';
function getSessionId(){ return localStorage.getItem(SESSION_KEY); }
function setSessionId(id){ localStorage.setItem(SESSION_KEY, String(id)); }
function clearSessionId(){ localStorage.removeItem(SESSION_KEY); }

/* =========================
   Inline rename (unchanged)
   ========================= */
async function startInlineRename(li, id){
  const titleEl = li.querySelector('.nm-title');
  if (!titleEl) return;

  const current = (titleEl.textContent || '').trim();
  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'nm-rename-input';
  input.value = current;
  input.setAttribute('maxlength', '120');

  titleEl.replaceWith(input);
  input.focus();
  input.select();

  let saved = false;
  const done = async (commit) => {
    if (saved) return;
    saved = true;
    const next = (commit ? input.value.trim() : current) || 'Untitled';

    const h3 = document.createElement('h3');
    h3.className = 'nm-title nm-1line';
    h3.textContent = next;
    input.replaceWith(h3);

    if (commit && next !== current) {
      try {
        await apiPost(`/api/chat/sessions/${id}/rename/`, { title: next });
        await refreshSessionList();
      } catch (e) {
        console.warn('Rename failed', e);
      }
    }
  };

  input.addEventListener('keydown', async (e) => {
    if (e.key === 'Enter') { e.preventDefault(); await done(true); }
    if (e.key === 'Escape'){ e.preventDefault(); await done(false); }
  });
  input.addEventListener('blur', () => done(true));
  input.addEventListener('click', (e) => e.stopPropagation());
}

/* =========================
   Sidebar list (unchanged)
   ========================= */
function fmtDate(s){ try { return new Date(s).toLocaleString(); } catch { return s; } }

async function refreshSessionList() {
  const SHOW_MENU = true;
  const ul = document.getElementById('sessionList');
  if (!ul) return;

  const escapeHtml = s => String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&gt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const toneMeta = t => ({
    PlainClinical:['Balanced','bg-slate-100 text-slate-700'],
    Balanced:     ['Balanced','bg-slate-100 text-slate-700'],
    Caregiver:    ['Caregiver','bg-rose-50 text-rose-700'],
    Faith:        ['Faith','bg-indigo-50 text-indigo-700'],
    Clinical:     ['Clinical','bg-amber-50 text-amber-700'],
    Geriatric:    ['Geriatric','bg-emerald-50 text-emerald-700'],
    EmotionalSupport:['Support','bg-violet-50 text-violet-700'],
  }[t] || ['Balanced','bg-slate-100 text-slate-700']);
  const langShort = c => (c || 'en-US').split('-')[0].toUpperCase();

  ul.innerHTML = '';
  for (let i=0;i<3;i++){
    ul.insertAdjacentHTML('beforeend', `
      <li class="nm-card border bg-white p-2 mb-2">
        <div class="h-4 w-32 bg-slate-200 rounded animate-pulse"></div>
      </li>
    `);
  }

  let rows = [];
  try { rows = await apiJson('/api/chat/sessions/'); }
  catch { ul.innerHTML = `<li class="text-sm text-red-600">Could not load history.</li>`; return; }

  if (!rows.length) {
    ul.innerHTML = `
      <li class="nm-card border border-dashed p-4 text-center bg-white/70 text-sm text-slate-600">
        No conversations yet
      </li>`;
    return;
  }

  const activeId = String(localStorage.getItem('nm_session_id') || '');
  ul.innerHTML = '';

  for (const s of rows) {
    const [tLabel, tClass] = toneMeta(s.tone);
    const isActive = String(s.id) === activeId;

    const li = document.createElement('li');
    li.className = `nm-card border mb-2 rounded-xl ${isActive ? 'ring-1 ring-[#28926D]' : ''}`;
    li.dataset.sid = s.id;

    li.innerHTML = `
  <button type="button" data-open-session="${s.id}" class="nm-row w-full flex items-start gap-2 text-left">
    <div class="mt-0.5 h-6 w-1 rounded bg-[#28926D]/80"></div>
    <div class="mt-0.5 h-6 w-6 rounded-md bg-slate-50 grid place-items-center text-[#236092] text-[11px]">
      <i class="fa-solid fa-brain"></i>
    </div>
    <div class="min-w-0 flex-1 nm-content">
      <div class="flex items-start">
        <h3 class="nm-title nm-1line" title="${escapeHtml(s.title || 'New chat')}">
          ${escapeHtml(s.title || 'New chat')}
        </h3>
      </div>
      <div class="nm-chips">
        <span class="nm-chip ${tClass}">${escapeHtml(tLabel)}</span>
        <span class="nm-chip bg-slate-100 text-slate-700">${escapeHtml(langShort(s.lang))}</span>
      </div>
    </div>
  </button>
  <div class="nm-kebab">
    <button class="rounded p-1.5 hover:bg-slate-100" aria-haspopup="true" data-menu="${s.id}">
      <i class="fa-solid fa-ellipsis-vertical text-slate-500"></i>
    </button>
    <div id="menu-${s.id}" class="hidden absolute right-0 top-8 w-44 bg-white border rounded-xl shadow-md z-10">
      <button class="w-full text-left px-3 py-2 hover:bg-slate-50 text-sm" data-rename="${s.id}">
        <i class="fa-solid fa-i-cursor mr-2"></i>Rename
      </button>
      <button class="w-full text-left px-3 py-2 hover:bg-slate-50 text-sm ${s.archived ? '' : 'text-amber-700'}" data-archive="${s.id}">
        <i class="fa-solid fa-box-archive mr-2"></i>${s.archived ? 'Unarchive' : 'Archive'}
      </button>
      <button class="w-full text-left px-3 py-2 hover:bg-slate-50 text-sm text-red-600" data-delete="${s.id}">
        <i class="fa-regular fa-trash-can mr-2"></i>Delete
      </button>
    </div>
  </div>
`;
    ul.appendChild(li);
  }

  ul.querySelectorAll('[data-open-session]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-open-session');
      localStorage.setItem('nm_session_id', String(id));
      try { await openSession(id); } catch {}
      ul.querySelectorAll('li').forEach(el => el.classList.remove('ring-1','ring-[#28926D]'));
      btn.closest('li')?.classList.add('ring-1','ring-[#28926D]');
      const overlay = document.getElementById('overlay');
      if (overlay && !overlay.classList.contains('hidden')) toggleSidebar();
    });
  });

  function closeAllMenus(){ ul.querySelectorAll('[id^="menu-"]').forEach(m=>m.classList.add('hidden')); }
  ul.querySelectorAll('[data-menu]').forEach(trigger=>{
    trigger.addEventListener('click', e=>{
      e.stopPropagation();
      const id = trigger.getAttribute('data-menu');
      const menu = document.getElementById(`menu-${id}`);
      const open = menu && !menu.classList.contains('hidden');
      closeAllMenus();
      if (menu) menu.classList.toggle('hidden', open);
    });
  });
  document.addEventListener('click', closeAllMenus, { once:true });

  ul.querySelectorAll('[data-rename]').forEach(btn=>{
    btn.addEventListener('click', async e=>{
      e.stopPropagation();
      const id = btn.getAttribute('data-rename');
      const list = await apiJson('/api/chat/sessions/').catch(()=>[]);
      const current = list.find(r=>String(r.id)===String(id))?.title || '';
      const next = prompt('Rename chat', current);
      if (!next || !next.trim()) return;
      await fetch(`/api/chat/sessions/${id}/rename/`, {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken': (window.getCSRFToken?getCSRFToken():'')},
        body: JSON.stringify({ title: next.trim() })
      }).catch(()=>{});
      refreshSessionList().catch(()=>{});
    });
  });
  ul.querySelectorAll('[data-archive]').forEach(btn=>{
    btn.addEventListener('click', async e=>{
      e.stopPropagation();
      const id = btn.getAttribute('data-archive');
      await fetch(`/api/chat/sessions/${id}/archive/`, {
        method:'POST',
        headers:{'X-CSRFToken': (window.getCSRFToken?getCSRFToken():'')}
      }).catch(()=>{});
      refreshSessionList().catch(()=>{});
    });
  });
  ul.querySelectorAll('[data-delete]').forEach(btn=>{
    btn.addEventListener('click', async e=>{
      e.stopPropagation();
      const id = btn.getAttribute('data-delete');
      if (!confirm('Delete this conversation? This cannot be undone.')) return;
      await fetch(`/api/chat/sessions/${id}/delete/`, {
        method:'POST',
        headers:{'X-CSRFToken': (window.getCSRFToken?getCSRFToken():'')}
      }).catch(()=>{});
      if (String(localStorage.getItem('nm_session_id')) === String(id)) {
        localStorage.removeItem('nm_session_id');
      }
      refreshSessionList().catch(()=>{});
    });
  });
}

/* =========================
   Open a session (uses rich)
   ========================= */
async function openSession(id){
  try {
    const data = await apiJson(`/api/chat/sessions/${id}/`);
    setSessionId(id);
    const chatWindow = document.getElementById('chatWindow');
    if (chatWindow) chatWindow.innerHTML = '';

    const visible = (data.messages || []).filter(m => m.role === 'user' || m.role === 'assistant');
    visible.forEach(m => appendRichBubble(m.content, m.role === 'user'));
  } catch (e) {
    console.warn(e);
  }
}


document.addEventListener('DOMContentLoaded', () => {
  // Build sidebar on load
  refreshSessionList().catch(console.warn);

  // Auto-open last session if any
  const sid = getSessionId();
  if (sid) {
    openSession(sid).catch(()=>clearSessionId());
  }
});

/* =========================
   Voice dictation (unchanged)
   ========================= */
(() => {
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  const micBtn = document.getElementById('micBtn');
  const input  = document.getElementById('chatInput');
  let rec = null, listening = false;

  const IS_TRUSTED =
    window.isSecureContext ||
    location.hostname === 'localhost' ||
    location.hostname === '127.0.0.1' ||
    location.hostname === '::1' ||
    location.hostname.endsWith('.localhost');

  function nmLangCode() {
    try {
      return (typeof window.__nmLang === 'function' && window.__nmLang()) ||
             navigator.language || 'en-US';
    } catch { return 'en-US'; }
  }

  function startDictation() {
    if (!SpeechRec) { alert('Voice dictation needs a Chromium browser (Chrome/Edge).'); return; }
    if (!IS_TRUSTED) { alert('Use HTTPS or localhost for mic access.'); return; }
    if (listening) { try { rec.stop(); } catch {} return; }

    rec = new SpeechRec();
    rec.lang = nmLangCode();
    rec.continuous = false;
    rec.interimResults = true;

    rec.onstart = () => {
      listening = true;
      micBtn.classList.add('bg-[#236092]','text-white');
      micBtn.title = 'Listening… click to stop';
    };
    rec.onend = () => {
      listening = false;
      micBtn.classList.remove('bg-[#236092]','text-white');
      micBtn.title = 'Dictate';
      rec = null;
    };
    rec.onerror = (e) => console.warn('speech error:', e.error);

    let finalText = '';
    rec.onresult = (e) => {
      let interim = '';
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const t = e.results[i][0].transcript;
        if (e.results[i].isFinal) finalText += t; else interim += t;
      }
      input.value = (finalText || interim).trim();
      input.focus();
      input.setSelectionRange(input.value.length, input.value.length);
    };

    rec.start();
  }
  micBtn?.addEventListener('click', startDictation);
  window.nmDictation = { start: startDictation, supported: !!SpeechRec, trusted: IS_TRUSTED };
})();

/* =========================
   Language picker (unchanged
   API: window.__nmLang)
   ========================= */
const LANGUAGE_CHOICES = [
  ['en-US','English'],['ja-JP','Japanese'],['es-ES','Spanish'],['fr-FR','French'],['de-DE','German'],
  ['it-IT','Italian'],['pt-PT','Portuguese (Portugal)'],['pt-BR','Portuguese (Brazil)'],['ru-RU','Russian'],
  ['zh-CN','Chinese (Simplified)'],['zh-TW','Chinese (Traditional)'],['ko-KR','Korean'],['ar-SA','Arabic (Saudi Arabia)'],
  ['tr-TR','Turkish'],['nl-NL','Dutch'],['sv-SE','Swedish'],['pl-PL','Polish'],['da-DK','Danish'],['no-NO','Norwegian'],
  ['fi-FI','Finnish'],['he-IL','Hebrew'],['th-TH','Thai'],['hi-IN','Hindi'],['cs-CZ','Czech'],['ro-RO','Romanian'],
  ['hu-HU','Hungarian'],['sk-SK','Slovak'],['bg-BG','Bulgarian'],['uk-UA','Ukrainian'],['vi-VN','Vietnamese'],['id-ID','Indonesian'],
  ['ms-MY','Malay'],['sr-RS','Serbian'],['hr-HR','Croatian'],['el-GR','Greek'],['lt-LT','Lithuanian'],['lv-LV','Latvian'],
  ['et-EE','Estonian'],['sl-SI','Slovenian'],['is-IS','Icelandic'],['sq-AL','Albanian'],['mk-MK','Macedonian'],
  ['bs-BA','Bosnian'],['ca-ES','Catalan'],['gl-ES','Galician'],['eu-ES','Basque'],['hy-AM','Armenian'],['fa-IR','Persian'],
  ['sw-KE','Swahili'],['ta-IN','Tamil'],['te-IN','Telugu'],['kn-IN','Kannada'],['ml-IN','Malayalam'],['mr-IN','Marathi'],
  ['pa-IN','Punjabi'],['gu-IN','Gujarati'],['or-IN','Odia'],['as-IN','Assamese'],['ne-NP','Nepali'],['si-LK','Sinhala'],
];
function guessBrowserLang(){
  const nav = (navigator.languages && navigator.languages[0]) || navigator.language || 'en-US';
  return LANGUAGE_CHOICES.find(([code]) => code === nav) ? nav : 'en-US';
}
function loadLang(){ return localStorage.getItem('nm_lang') || guessBrowserLang(); }
function saveLang(code){ localStorage.setItem('nm_lang', code); }
function labelForLang(code){ const found = LANGUAGE_CHOICES.find(([c])=>c===code); return found ? found[1] : code; }
function toggleMenu(el, open){ if (el) el.classList.toggle('hidden', !open); }
function applyLangUI(code){
  const label = labelForLang(code);
  const b1 = document.getElementById('langBtnLabel');
  const b2 = document.getElementById('mLangBtnLabel');
  if (b1) b1.textContent = label;
  if (b2) b2.textContent = label;
  document.querySelectorAll('#mLangList [data-lang]').forEach(el=>{
    el.querySelector('.fa-check')?.classList.toggle('hidden', el.dataset.lang !== code);
  });
  if (typeof showToast === 'function'){
    showToast(`Language set: ${label}`, 'fa-solid fa-globe', 'text-[#236092]');
  }
}
document.addEventListener('DOMContentLoaded', () => {
  const desktopBtn   = document.getElementById('langBtn');
  const desktopMenu  = document.getElementById('langMenu');
  const mobileBtn    = document.getElementById('mLangBtn');
  const mobileMenu   = document.getElementById('mLangMenu');
  const mobilePanel  = document.getElementById('mLangPanel');
  const mobileList   = document.getElementById('mLangList');
  const mobileSearch = document.getElementById('mLangSearch');
  const mobileClose  = document.getElementById('mLangClose');
  const mobileBack   = document.getElementById('mLangBackdrop');

  function buildDesktopMenu(menuEl, onPick){
    if (!menuEl) return;
    menuEl.innerHTML = '';
    LANGUAGE_CHOICES.forEach(([code, label]) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'w-full text-left px-3 py-2 hover:bg-slate-50 flex items-center gap-2';
      btn.dataset.lang = code;
      btn.innerHTML = `<span class="flex-1 truncate">${label}</span>
                       <span class="text-xs text-slate-500">${code}</span>`;
      btn.addEventListener('click', () => onPick(code));
      menuEl.appendChild(btn);
    });
  }
  function buildMobileLangList(listEl, selected, onPick){
    if (!listEl) return;
    listEl.innerHTML = '';
    LANGUAGE_CHOICES.forEach(([code, label])=>{
      const item = document.createElement('button');
      item.type = 'button';
      item.dataset.lang = code;
      item.className = 'w-full px-4 py-3 mb-1 flex items-center gap-3 rounded-[10px] text-left hover:bg-slate-50';
      item.innerHTML = `
        <div class="min-w-0">
          <div class="text-[15px] font-medium nm-lang-label truncate">${label}</div>
          <div class="text-xs text-slate-500">${code}</div>
        </div>
        <i class="fa-solid fa-check ml-auto text-emerald-600 ${code===selected ? '' : 'hidden'}"></i>`;
      item.addEventListener('click', () => onPick(code));
      listEl.appendChild(item);
    });
  }

  const current = loadLang();
  buildDesktopMenu(desktopMenu, pickLang);
  if (mobileList) buildMobileLangList(mobileList, current, pickLang);
  applyLangUI(current);

  function pickLang(code){
    saveLang(code); applyLangUI(code);
    toggleMenu(desktopMenu, false);
    if (mobilePanel) { mobilePanel.classList.add('translate-y-full'); setTimeout(()=> mobileMenu?.classList.add('hidden'), 180); }
    else toggleMenu(mobileMenu, false);
  }

  desktopBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = desktopMenu && !desktopMenu.classList.contains('hidden');
    toggleMenu(desktopMenu, !isOpen);
  });
  mobileBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    if (mobilePanel){
      mobileMenu?.classList.remove('hidden');
      requestAnimationFrame(()=> mobilePanel.classList.remove('translate-y-full'));
      mobileBtn.setAttribute('aria-expanded','true');
      setTimeout(()=> mobileSearch?.focus(), 80);
    } else {
      const isOpen = mobileMenu && !mobileMenu.classList.contains('hidden');
      toggleMenu(mobileMenu, !isOpen);
    }
  });
  mobileBack?.addEventListener('click', ()=>{ mobilePanel?.classList.add('translate-y-full'); setTimeout(()=> mobileMenu?.classList.add('hidden'), 180); });
  mobileClose?.addEventListener('click', ()=>{ mobilePanel?.classList.add('translate-y-full'); setTimeout(()=> mobileMenu?.classList.add('hidden'), 180); });

  mobileSearch?.addEventListener('input', (e)=>{
    const q = (e.target.value || '').trim().toLowerCase();
    document.querySelectorAll('#mLangList [data-lang]').forEach(el=>{
      const code  = el.dataset.lang.toLowerCase();
      const label = el.querySelector('.nm-lang-label')?.textContent.toLowerCase() || '';
      el.classList.toggle('hidden', !(code.includes(q) || label.includes(q)));
    });
  });

  document.addEventListener('click', (e) => {
    if (desktopMenu && !desktopMenu.contains(e.target) && e.target !== desktopBtn) toggleMenu(desktopMenu, false);
    if (!mobilePanel && mobileMenu && !mobileMenu.contains(e.target) && e.target !== mobileBtn) toggleMenu(mobileMenu, false);
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape'){ toggleMenu(desktopMenu, false); if (mobilePanel){ mobilePanel.classList.add('translate-y-full'); setTimeout(()=> mobileMenu?.classList.add('hidden'), 180); } }
  });
});
window.__nmLang = () => loadLang();

/* =========================
   Markdown rendering
   ========================= */

/* 1) One-time style tweaks so headings/bold look right inside AI bubbles */
(function injectAiMdStyles(){
  if (document.getElementById('nm-ai-md-style')) return;
  const css = `
    .chat-ai .md-prose h1,.chat-ai .md-prose h2,.chat-ai .md-prose h3,.chat-ai .md-prose h4{font-weight:600;margin:.22em 0 .14em}
    .chat-ai .md-prose h1{font-size:1.18rem}.chat-ai .md-prose h2{font-size:1.08rem}.chat-ai .md-prose h3{font-size:1.02rem}.chat-ai .md-prose h4{font-size:.98rem}
    .chat-ai .md-prose strong,.chat-ai .md-prose b{font-weight:600}
    .chat-ai .md-prose ul{list-style:disc;padding-left:1.5rem;margin:.18rem 0}.chat-ai .md-prose ol{list-style:decimal;padding-left:1.5rem;margin:.18rem 0}
    .chat-ai .md-prose ol>li::marker{font-weight:700;color:#236092}
    .chat-ai .md-prose blockquote{border-left:2px solid #e2e8f0;padding-left:.45rem;margin:.18em 0;color:#475569}
    .chat-ai .md-prose table{width:100%;border-collapse:collapse;margin:.22rem 0;font-size:.93rem}
    .chat-ai .md-prose th,.chat-ai .md-prose td{border:1px solid #e2e8f0;padding:.28rem .4rem}
    .chat-ai .md-prose thead th{background:#f8fafc}
  `;
  const s = document.createElement('style');
  s.id = 'nm-ai-md-style';
  s.textContent = css;
  document.head.appendChild(s);
})();

/* 2) Parse → sanitize → return a <div.md-prose> */
function renderAssistantMarkdown(mdText){
  const normalized = (mdText ?? '')
    .trim()
    .replace(/\r\n/g, '\n')
    .replace(/[ \t]+\n/g, '\n')
    .replace(/\n{3,}/g, '\n\n')
    .replace(/\n\s*\n(?=\s*#{1,4}\s)/g, '\n')
    .replace(/\n\s*\n(?=\s*([-*] |\d+\. ))/g, '\n');

  const raw = marked.parse(normalized, { gfm:true, breaks:false, headerIds:false });
  const safe = DOMPurify.sanitize(raw, { USE_PROFILES:{ html:true } });

  const container = document.createElement('div');
  container.className = 'md-prose';
  container.innerHTML = safe;

  container.querySelectorAll('p').forEach(p => { if (!p.textContent.trim()) p.remove(); });
  container.querySelectorAll('a[href]').forEach(a => {
    try{ const u = new URL(a.getAttribute('href'), location.href);
      if (u.origin !== location.origin) a.target = '_blank', a.rel = 'noopener noreferrer';
    }catch{}
  });

  return container;
}

/* 3) Streaming effect: types words, then swaps to full Markdown node */
function renderStreamingMarkdown(mdText, targetEl){
  const node = renderAssistantMarkdown(mdText);
  const words = node.innerText.split(/\s+/);
  targetEl.innerHTML = '';
  let i = 0;
  const t = setInterval(()=>{
    if (i < words.length){
      targetEl.innerHTML += (i ? ' ' : '') + words[i++];
      targetEl.scrollIntoView({ behavior:'smooth', block:'end' });
    } else {
      clearInterval(t);
      targetEl.replaceWith(node); // restore links/bold/etc.
    }
  }, 35);
}

/* =========================
   Chat UI bubble renderers
   ========================= */

function appendRichBubble(content, isUser = false) {
  const chatWindow = document.getElementById("chatWindow");
  if (!chatWindow) return;

  const wrap = document.createElement("div");
  wrap.className = `w-full flex mb-2 ${isUser ? "justify-end" : "justify-start"}`;

  const bubble = document.createElement("div");
  bubble.className = `chat-bubble ${isUser ? "chat-user" : "chat-ai"}`;
  bubble.setAttribute("role", "article");
  bubble.setAttribute("aria-live", "polite");

  const rich = document.createElement("div");
  rich.className = isUser ? "" : "md-prose";
  rich.setAttribute("dir", "auto");

  // If it's a DOM node (attachments grid), append as-is
  const asNode = !!(content && typeof content === "object" && ("nodeType" in content));

  if (isUser) {
    // user: plain text (no markdown parsing)
    if (asNode) rich.appendChild(content);
    else rich.textContent = String(content ?? "");
  } else {
    // assistant: stream then swap to full markdown
    if (asNode) {
      // rare case: assistant DOM node — just append
      rich.appendChild(content);
    } else {
      renderStreamingMarkdown(String(content || ''), rich);
    }
  }

  bubble.appendChild(rich);
  wrap.appendChild(bubble);
  chatWindow.appendChild(wrap);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// simple alias used elsewhere
function appendBubble(message, isUser = false) { appendRichBubble(message, isUser); }


/* =========================
   Sidebar: Session History
   ========================= */
async function refreshSessionList() {
  const ul = document.getElementById('sessionList');
  if (!ul) return;

  // quick skeleton placeholders
  ul.innerHTML = '';
  for (let i=0;i<3;i++){
    ul.insertAdjacentHTML('beforeend', `
      <li class="nm-card border bg-white p-2 mb-2">
        <div class="h-4 w-32 bg-slate-200 rounded animate-pulse"></div>
      </li>
    `);
  }

  let rows = [];
  try { rows = await fetch('/api/chat/sessions/', { credentials:'include' }).then(r=>r.json()); }
  catch { ul.innerHTML = `<li class="text-sm text-red-600">Could not load history.</li>`; return; }

  if (!rows.length) {
    ul.innerHTML = `
      <li class="nm-card border border-dashed p-4 text-center bg-white/70 text-sm text-slate-600">
        No conversations yet
      </li>`;
    return;
  }

  const activeId = String(localStorage.getItem('nm_session_id') || '');
  ul.innerHTML = '';

  rows.forEach(s => {
    const isActive = String(s.id) === activeId;
    const li = document.createElement('li');
    li.className = `nm-card border mb-2 rounded-xl ${isActive ? 'ring-1 ring-[#28926D]' : ''}`;
    li.dataset.sid = s.id;

    li.innerHTML = `
      <button type="button" data-open-session="${s.id}" class="nm-row w-full flex items-start gap-2 text-left">
        <div class="mt-0.5 h-6 w-1 rounded bg-[#28926D]/80"></div>
        <div class="mt-0.5 h-6 w-6 rounded-md bg-slate-50 grid place-items-center text-[#236092] text-[11px]">
          <i class="fa-solid fa-brain"></i>
        </div>
        <div class="min-w-0 flex-1 nm-content">
          <h3 class="nm-title nm-1line">${s.title || 'New chat'}</h3>
        </div>
      </button>
    `;
    ul.appendChild(li);
  });

  // wire up click to open sessions
  ul.querySelectorAll('[data-open-session]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-open-session');
      localStorage.setItem('nm_session_id', String(id));
      try { await openSession(id); } catch {}
      ul.querySelectorAll('li').forEach(el => el.classList.remove('ring-1','ring-[#28926D]'));
      btn.closest('li')?.classList.add('ring-1','ring-[#28926D]');
    });
  });
}

/* =========================
   Greeting & New Chat
   ========================= */
async function greetUser() {
  try {
    const res = await fetch("/api/user/settings/");
    const data = await res.json();
    const name = data.display_name || "there";
    const options = [
  `Hi ${name} — how are you feeling today?`,
  `Welcome, ${name}. What do you need help with: symptoms, results, or next steps?`,
  `${name}, I’m here to help. Share a document and I’ll summarize it in plain language.`,
  `Hey ${name}, got labs or notes? I can translate the medical jargon for you.`,
  `Hello ${name}! Tell me what’s going on and we’ll make a plan together.`,
  `${name}, your health matters. Want me to draft questions for your next appointment?`,
  `Hi ${name}. On a scale of 1–10, how are you feeling today?`,
  `Welcome back, ${name}. How can I support you right now?`
];
    appendBubble(options[Math.floor(Math.random()*options.length)], false);
  } catch {
    appendBubble("Welcome back. Let’s take care of what matters most today.", false);
  }
}

async function newChat() {
  const chatWindow = document.getElementById('chatWindow');
  if (chatWindow) chatWindow.innerHTML = '';

  localStorage.removeItem('nm_session_id');
  await fetch('/clear-session/', { method:'POST', headers:{ 'X-CSRFToken': getCSRFToken() } });

  const r = await fetch('/api/chat/sessions/new/', { method:'POST', headers:{ 'X-CSRFToken': getCSRFToken() } });
  const data = await r.json();

  if (data && data.session_id) {
    localStorage.setItem('nm_session_id', String(data.session_id));
    if (window.openSession) { try { await openSession(Number(data.session_id)); } catch {} }
  }
  appendBubble('I’m here to help. How are you feeling today, and what would you like to do—summarize records, explain results, or ask a health question?', false);
}

/* =========================
   Pending attachments tray
   ========================= */
const pending = []; // {file: File, url?: string, kind: 'image'|'doc'}
const pendingTray = document.getElementById('pendingTray');
const pendingGrid = document.getElementById('pendingGrid');

function renderPending() {
  if (!pendingTray || !pendingGrid) return;
  pendingGrid.innerHTML = '';
  if (pending.length === 0) { pendingTray.classList.add('hidden'); return; }
  pendingTray.classList.remove('hidden');

  pending.forEach((item, idx) => {
    const cell = document.createElement('div');
    cell.className = 'thumb p-2';

    if (item.kind === 'image') {
      const imgWrap = document.createElement('div');
      imgWrap.className = 'w-full h-24';
      const img = document.createElement('img');
      img.src = item.url; img.alt = item.file.name;
      imgWrap.appendChild(img); cell.appendChild(imgWrap);
    } else {
      const box = document.createElement('div');
      box.className = 'h-24 flex items-center justify-center text-gray-600';
      box.innerHTML = `<div class="text-center px-2">
          <i class="fa-solid fa-file-lines text-2xl"></i>
          <div class="text-[11px] mt-1 truncate max-w-[110px]">${item.file.name}</div>
        </div>`;
      cell.appendChild(box);
    }

    const rm = document.createElement('button');
    rm.className = 'thumb-remove'; rm.title = 'Remove';
    rm.innerHTML = '<i class="fa-solid fa-xmark"></i>';
    rm.onclick = () => removePending(idx);
    cell.appendChild(rm);

    pendingGrid.appendChild(cell);
  });
}
function addFiles(files) {
  [...files].forEach(f => {
    const isImage = /^image\//.test(f.type);
    const obj = { file: f, kind: isImage ? 'image' : 'doc' };
    if (isImage) obj.url = URL.createObjectURL(f);
    pending.push(obj);
  });
  renderPending();
}
function removePending(index) {
  const item = pending[index];
  if (item?.url) URL.revokeObjectURL(item.url);
  pending.splice(index, 1);
  renderPending();
}
function clearPending() {
  pending.forEach(p => p.url && URL.revokeObjectURL(p.url));
  pending.length = 0;
  renderPending();
}

/* =========================
   Send chat (uses streaming)
   ========================= */
document.getElementById('sendBtn')?.addEventListener('click', sendChat);
document.getElementById('chatInput')?.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
});

async function sendChat() {
  const input = document.getElementById("chatInput");
  const chatWindow = document.getElementById("chatWindow");
  const userMessage = (input?.value || '').trim();

  const tone =
    window.__nmToneOverride ||
    document.querySelector('input[name="tone"]:checked')?.value ||
    "PlainClinical";

  const lang =
    (typeof window.__nmLang === 'function' && window.__nmLang()) ||
    navigator.language || 'en-US';

  if (!userMessage && pending.length === 0) return;

  // user bubble + attachments
  if (userMessage) appendBubble(userMessage, true);
  if (pending.length) {
    const gallery = document.createElement('div');
    gallery.className = 'grid grid-cols-2 sm:grid-cols-3 gap-2';
    pending.forEach(item => {
      const card = document.createElement('div');
      card.className = 'border rounded-lg overflow-hidden';
      if (item.kind === 'image') {
        const img = document.createElement('img');
        img.src = item.url; img.alt = item.file.name;
        img.className = 'block w-full h-28 object-cover';
        card.appendChild(img);
      } else {
        card.className += ' p-3 flex items-center gap-2 text-sm';
        card.innerHTML = `<i class="fa-solid fa-file-lines"></i><span class="truncate">${item.file.name}</span>`;
      }
      gallery.appendChild(card);
    });
    appendRichBubble(gallery, true);
  }

  // payload
  const formData = new FormData();
  if (userMessage) formData.append("message", userMessage);
  formData.append("tone", tone);
  formData.append("lang", lang);
  const sidExisting = getSessionId();
  if (sidExisting) formData.append("session_id", sidExisting);
  pending.forEach(p => formData.append("files[]", p.file, p.file.name));

  // clear composer
  if (input) input.value = "";
  clearPending();

  // typing indicator
  const typingWrap = document.createElement("div");
typingWrap.className = "w-full flex mb-2 justify-start";

const typing = document.createElement("div");
typing.className = "chat-bubble chat-ai";

const inner = document.createElement("div");
inner.className = "text-gray-500 italic";
inner.textContent = "Analyzing";

typing.appendChild(inner);
typingWrap.appendChild(typing);
chatWindow.appendChild(typingWrap);
chatWindow.scrollTop = chatWindow.scrollHeight;

// Animate the dots
let dotCount = 0;
const maxDots = 3;
const interval = setInterval(() => {
  dotCount = (dotCount + 1) % (maxDots + 1);
  inner.textContent = "Analyzing" + ".".repeat(dotCount);
}, 500);

// (Optional) if you want to stop the animation later when the real AI reply comes in:
// clearInterval(interval);


  try {
    const API_SEND = "/api/send-chat/";
    const res = await fetch(API_SEND, {
      method:"POST",
      headers:{ "X-CSRFToken": getCSRFToken(), "Accept-Language": lang },
      body: formData,
      credentials: "include"
    });

    let data = null;
    try { data = await res.json(); } catch {}

    if (!res.ok) {
      throw new Error((data && (data.error || data.detail)) || `HTTP ${res.status}`);
    }

    typingWrap.remove();
    const reply = (data && data.reply) ? data.reply : "⚠️ No reply received.";
    appendRichBubble(reply, false);   // ← streams + full markdown swap
  } catch (err) {
    inner.classList.remove("italic","text-gray-500");
    inner.classList.add("text-red-700");
    inner.textContent = "Hi! Our system is busy right now — please try again in a few minutes.";
  }
}

/* =========================
   Basic layout / settings (unchanged)
   ========================= */
function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("overlay");
  const isOpen = sidebar.classList.contains("translate-x-0");
  if (isOpen) { sidebar.classList.remove("translate-x-0"); sidebar.classList.add("-translate-x-full"); overlay.classList.add("hidden"); }
  else { sidebar.classList.remove("-translate-x-full"); sidebar.classList.add("translate-x-0"); overlay.classList.remove("hidden"); }
}
async function openSettingsModal() {
  const modal = document.getElementById("settingsModal");
  const nameEl = document.getElementById("displayName");
  const profEl = document.getElementById("profession");

  // 1) Open the modal first so the user sees something immediately
  if (modal) { modal.classList.remove("hidden"); modal.classList.add("flex"); }

  try {
    const res = await fetch("/api/user/settings/", {
      credentials: "include",
      headers: { "Accept": "application/json" }
    });

    // If redirected to HTML (e.g., login), res.ok might still be true but JSON will fail.
    const ct = res.headers.get("content-type") || "";
    if (!res.ok || !ct.includes("application/json")) {
      throw new Error(`Unexpected response (${res.status}); content-type=${ct}`);
    }

    const data = await res.json();

    if (nameEl) nameEl.value = data.display_name || "";
    if (profEl) profEl.value = data.profession || "";
  } catch (err) {
    console.warn("Settings fetch failed:", err);
    // Leave fields blank; optionally show a small inline note/toast if you want.
  }
}

function saveSettings() {
  const name = document.getElementById("displayName").value.trim();
  const profession = document.getElementById("profession").value.trim();
  fetch("/api/user/settings/update/", {
    method:"POST",
    headers:{ "Content-Type":"application/json","X-CSRFToken":getCSRFToken() },
    body: JSON.stringify({ display_name:name, profession })
  }).then(r=>r.json()).then(()=>{ alert("Settings updated successfully!"); closeSettingsModal(); });
}
function closeSettingsModal(){
  const modal = document.getElementById("settingsModal");
  modal.classList.remove("flex"); modal.classList.add("hidden");
}
document.addEventListener("click", (e)=>{
  const dd = document.getElementById("settingsDropdown");
  const button = e.target.closest("button[onclick='toggleSettingsMenu()']");
  if (!button && dd && !dd.contains(e.target)) { dd.classList.add("hidden"); dd.classList.remove("block"); }
});
function toggleSettingsMenu(){
  const menu = document.getElementById("settingsDropdown");
  menu.classList.toggle("hidden"); menu.classList.toggle("block");
}
function logoutUser(){
  clearSessionId(); // <-- add this
  fetch("{% url 'logout' %}", { method: "POST", headers: { "X-CSRFToken": getCSRFToken() } })
    .then(() => { window.location.href = "{% url 'login' %}"; })
    .catch(() => { window.location.href = "{% url 'login' %}"; });
}


function updateComposerPadding() {
  const c = document.getElementById('composer');
  const w = document.getElementById('chatWindow');
  if (!c || !w) return;
  const h = Math.ceil(c.getBoundingClientRect().height || 0);
  w.style.paddingBottom = `calc(${h}px + 12px)`;
}

/* =========================
   Summary modal (now keeps bold/headings)
   ========================= */
function closeModal(){ document.getElementById("summaryModal").classList.add("hidden"); }

document.addEventListener("DOMContentLoaded", async () => {
  const chatWindow = document.getElementById("chatWindow");
  if (chatWindow && chatWindow.innerHTML.trim() === '') { greetUser(); }

  document.querySelectorAll(".open-summary-modal").forEach(btn => {
    btn.addEventListener("click", function () {
      const raw = this.dataset.summary || "";

      let text = "";
      try {
        text = JSON.parse(
          '"' +
          raw.replace(/\\/g, '\\\\').replace(/"/g, '\\"') +
          '"'
        );
      } catch { text = raw; }

      const node = renderAssistantMarkdown(text); // keep real markdown!
      const target = document.getElementById("modalContent");
      if (target) {
        target.innerHTML = '';
        target.appendChild(node);
      }
      document.getElementById("summaryModal")?.classList.remove("hidden");
    });
  });
});

/* =========================
   Page init bits you had (tour/install/etc.)
   — keep as-is if you already include them elsewhere
   ========================= */

// New Chat
document.getElementById('newChatBtn')?.addEventListener('click', newChat);

// Search filter in sidebar (unchanged)
const searchInput = document.querySelector('input[placeholder="Search summaries..."]');
searchInput?.addEventListener('input', function () {
  const q = this.value.toLowerCase();
  document.querySelectorAll('.sidebar-link').forEach(item => {
    const filename = item.querySelector('p.text-white-800')?.innerText.toLowerCase() || '';
    const text = item.querySelector('p.text-base')?.innerText.toLowerCase() || '';
    item.style.display = (filename.includes(q) || text.includes(q)) ? 'block' : 'none';
  });
});

// Composer controls (unchanged)
document.getElementById('addBtn')?.addEventListener('click', () => document.getElementById('fileInput').click());
document.getElementById('fileInput')?.addEventListener('change', e => {
  if (e.target.files?.length) addFiles(e.target.files);
  e.target.value = '';
});
document.getElementById('clearAllBtn')?.addEventListener('click', clearPending);

// Drag & drop (unchanged)
const dz = document.getElementById('dropzone');
if (dz){
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('dragover');
    if (e.dataTransfer?.files?.length) addFiles(e.dataTransfer.files);
  });
}

/* Resume or start fresh depending on your flag */
const NEW_SESSION_ON_REFRESH = true;
document.addEventListener('DOMContentLoaded', async () => {
  try {
    await refreshSessionList().catch(console.warn);

    const chatWindow = document.getElementById('chatWindow');
    if (chatWindow) chatWindow.innerHTML = ''; // ensure we start clean

    if (NEW_SESSION_ON_REFRESH) {
      clearSessionId(); // <-- remove any old nm_session_id first
      await fetch('/clear-session/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() },
        credentials: 'include'
      }).catch(()=>{});

      appendBubble('I’m here to help. How are you feeling today, and what would you like to do—summarize records, explain results, or ask a health question?', false);
    } else {
      const sid = getSessionId();
      if (sid) {
        await openSession(sid).catch(() => clearSessionId());
      } else {
        await greetUser();
      }
    }
  } catch (e) {
    console.warn('Session init error:', e);
  }
});

</script>

<!-- Keep your existing styles; these are just tiny extras -->
<style>
  @keyframes fadeInUp { from {opacity:0; transform:translateY(12px)} to {opacity:1; transform:translateY(0)} }
  .animate-fadeInUp { animation: fadeInUp .22s ease-out; }
  .nm-lang-item.active { background:#f0fdfa; }
</style>

<script>
  /* Service worker (unchanged) */
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js").catch(console.warn);
    });
  }
</script>

  
</body>
</html>
