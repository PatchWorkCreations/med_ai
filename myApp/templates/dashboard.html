<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>NeuroMed AI Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body { background: linear-gradient(to right, #f5f7fa, #e4ebf5); }
    .glass { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); }

    .chat-bubble {
      border-radius: 1.25rem; padding: 12px 18px; line-height: 1.6; font-size: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,.05); max-width: 75%; white-space: pre-wrap; word-break: break-word;
      animation: fadeInUp .25s ease;
    }

    /* User on the RIGHT */
.chat-user {
  background-color: #dbeafe;
  color: #1f2937;
  padding: 0.5rem 0.75rem;
  border-radius: 1rem;
  max-width: 75%;
  margin-left: auto;    /* RIGHT side */
  margin-right: 0;
}

/* AI on the LEFT */
.chat-ai {
  background-color: #ecfdf5;
  color: #1f2937;
  padding: 0.5rem 0.75rem;
  border-radius: 1rem;
  max-width: 75%;
  margin-right: auto;   /* LEFT side */
  margin-left: 0;
}


    .sidebar-link:hover { background:#f0f0f0; transition:all .2s; }
    @keyframes fadeInUp { from {opacity:0; transform:translateY(20px)} to {opacity:1; transform:translateY(0)} }
    .animate-fadeInUp { animation: fadeInUp .35s ease-out; }
    #loadingOverlay i { animation: pulseFade 1.2s infinite ease-in-out; }
    @keyframes pulseFade { 0%,100%{opacity:.6; transform:scale(1)} 50%{opacity:1; transform:scale(1.1)} }
    #chatWindow > div:first-child { margin-top:0!important; margin-bottom:0!important; }

    /* Composer */
    .dropzone { border: 2px dashed rgba(0,0,0,.08); transition: .15s ease; }
    .dropzone.dragover { border-color: #0f766e; background: rgba(20,184,166,.06); }
    .thumb { position: relative; border-radius: .75rem; border: 1px solid rgba(0,0,0,.06); background: #fff; }
    .thumb img { display:block; width:100%; height:100%; object-fit:cover; border-radius:.65rem; }
    .thumb-remove {
      position:absolute; top:6px; right:6px; background:#111827; color:#fff; border-radius:9999px; width:22px; height:22px;
      display:flex; align-items:center; justify-content:center; font-size:.75rem;
    }

    /* Rotated side tab (hidden on tiny phones; see media queries) */
    #feedbackTab {
      position: fixed;
      top: 50%;
      right: 10px;
      transform: translateY(-50%) rotate(-90deg);
      transform-origin: bottom right;
      background-color: #0d9488; /* teal-600 */
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem 0.25rem 0 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 9999;
      cursor: pointer;
      white-space: nowrap;
    }
    #feedbackTab:hover { background-color: #0f766e; }
    #feedbackTab:focus { outline: none; }
    #feedbackTab, #feedbackTab * { pointer-events: auto; }

    /* --- Core fixes: prevent right-edge clipping on tiny screens --- */
    /* Let key flex rows shrink and respect viewport width */
    :where(header, #toneBar, #chatWindow, #dropzone, #composer, section.flex-1) {
      min-width: 0 !important;
      max-width: 100vw;
    }
    #toneBar { overflow-x: auto; -webkit-overflow-scrolling: touch; }

    /* Root container: hide vertical overflow only (allow horizontal to avoid hard clipping) */
    /* iOS Safari 100vh fix */
    @media (max-width: 480px) {
      @supports (height: 100dvh) {
        .h-screen { height: 100dvh; }
      }
    }

    /* Hide rotated tab on small phones and rely on FAB */
    @media (max-width: 380px) {
      #feedbackTab { display: none !important; }
    }

    /* --- Tiny phone hardening (<= 320px) --- */
    @media (max-width: 320px) {
      html, body { overflow-x: hidden; }

      #sidebar { width: 88vw !important; padding: 16px !important; }

      header { padding-left: 12px !important; padding-right: 12px !important; }
      #chatWindow { padding: 10px 12px !important; }

      .chat-bubble { 
        font-size: 14px !important; 
        padding: 8px 12px !important; 
        max-width: 92% !important; 
      }

      #toneBar {
        font-size: 12px !important;
        padding-left: 8px !important;
        padding-right: 12px !important; /* reduced now that side tab is hidden */
      }
      #toneBar label { margin-right: 8px !important; }

      #dropzone { gap: 6px !important; padding: 8px !important; }
      #addBtn, #micBtn, #sendBtn { width: 34px !important; height: 34px !important; }
      #addBtn i, #micBtn i, #sendBtn i { font-size: 13px !important; }
      #chatInput { font-size: 13px !important; padding: 8px 10px !important; min-width: 0 !important; }

      #composer { 
        position: sticky; 
        bottom: env(safe-area-inset-bottom); 
        z-index: 30; 
        background: #fff; 
        padding-bottom: calc(12px + env(safe-area-inset-bottom)) !important;
      }

      /* Feedback slide-over: full width on 320 */
      #feedbackPanel { width: 100% !important; }
      #feedbackPanel .px-5 { padding-left: 12px !important; padding-right: 12px !important; }

      #summaryModal .p-8 { padding: 16px !important; }
      #summaryModal .text-2xl { font-size: 18px !important; }
      #modalContent { font-size: 14px !important; }
    }

    /* Slight boost just above 320 for consistency */
    @media (max-width: 340px) {
      header h1 { font-size: 18px !important; }
      header i.text-2xl { font-size: 18px !important; }
      #chatInput { font-size: 13px !important; }
      .chat-bubble { max-width: 94% !important; }
    }

    @media (max-width: 360px) {
      /* side tab is hidden; no need for big right padding */
      #feedbackTab { top: 30% !important; }
    }
  </style>
</head>

<body class="bg-white font-sans text-gray-800">
<div id="appShell" class="w-full h-screen flex overflow-y-hidden">
  <!-- Sidebar -->
  <aside id="sidebar" class="w-[280px] glass border-r p-6 overflow-y-auto fixed inset-y-0 left-0 z-40 transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:translate-x-0 md:z-auto md:flex flex-col shadow-xl">
    <div class="flex items-center justify-between mb-6 border-b border-gray-200 pb-2">
      <h2 class="text-2xl font-semibold text-gray-800 flex items-center gap-3">
        <i class="fa-solid fa-clock-rotate-left text-teal-600 text-2xl"></i>
        <span class="tracking-tight">Summary History</span>
      </h2>
      <div class="relative">
        <button onclick="openSettingsModal()" class="text-gray-600 hover:text-teal-600 focus:outline-none">
          <i class="fa-solid fa-user-circle text-2xl"></i>
        </button>
        <div id="settingsDropdown" class="absolute right-0 mt-2 w-44 bg-white rounded-lg shadow-lg hidden z-50 text-base">
          <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-user mr-2 text-gray-400"></i> Profile</a>
          <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-pen-to-square mr-2 text-gray-400"></i> Change Name</a>
          <a href="{% url 'logout' %}" class="block px-4 py-2 hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-right-from-bracket mr-2 text-gray-400"></i> Logout</a>
        </div>
      </div>
    </div>

    <button class="mb-4 w-full bg-teal-600 text-white text-base py-2 rounded-lg hover:bg-teal-700 transition" id="newChatBtn">
      <i class="fa-solid fa-plus mr-2"></i>New Chat
    </button>

    <div class="mb-4 relative">
      <input type="text" placeholder="Search summaries..." class="w-full px-3 py-2 text-base rounded-md bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-500" />
      <i class="fa-solid fa-magnifying-glass absolute right-3 top-2.5 text-gray-400 text-base"></i>
    </div>

    {% if summaries %}
      <ul class="space-y-4">
        {% for item in summaries %}
          <li class="bg-white border rounded-xl p-4 text-base shadow-sm hover:shadow-md transition sidebar-link">
            <p class="text-gray-400 text-base">{{ item.created_at|date:"M d, Y â€“ H:i" }} Â· {{ item.tone }}</p>
            <p class="text-gray-800 font-medium mt-1 truncate">{{ item.uploaded_filename }}</p>
            <p class="text-base text-gray-600 mt-1 line-clamp-3">{{ item.summary|truncatewords:20 }}</p>
            <button class="mt-2 text-teal-600 text-base hover:underline open-summary-modal" data-summary="{{ item.summary|escapejs }}">
              View Full Summary
            </button>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-base italic text-gray-400">No summaries yet.</p>
    {% endif %}
  </aside>

  <!-- Main -->
  <section class="flex-1 flex flex-col relative">
    <!-- Header -->
    <header class="flex items-center justify-between px-6 py-4 border-b relative">
      <div class="flex items-center gap-2 relative group">
        <i class="fa-solid fa-notes-medical text-teal-600 text-2xl"></i>
        <h1 class="text-2xl font-bold text-gray-800 cursor-help">NeuroMed <span class="text-teal-600">AI</span></h1>
        <div class="absolute -bottom-12 left-0 z-10 w-max max-w-xs px-3 py-2 text-base text-white bg-gray-800 rounded-md opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none shadow-md">
          NeuroMed AI simplifies complex medical records into compassionate, easy-to-understand summaries.
        </div>
      </div>
      <button onclick="toggleSidebar()" class="md:hidden text-gray-600 text-2xl focus:outline-none">
        <i class="fa-solid fa-bars"></i>
      </button>
    </header>

    <!-- Mobile overlay -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 z-30 hidden md:hidden" onclick="toggleSidebar()"></div>

    <!-- Chat Window -->
    <div id="chatWindow" class="flex-1 px-6 py-4 overflow-y-auto text-base bg-gradient-to-br from-white to-gray-50 rounded-xl"></div>

    <!-- Tone Selector -->
    <div id="toneBar" class="px-3 py-1 bg-[#fefaf7] text-gray-600 overflow-x-auto whitespace-nowrap">
      <span class="font-semibold mr-2">Summary Tone:</span>
      <label class="inline-flex items-center mr-3"><input type="radio" name="tone" value="Plain" checked> <span class="ml-1">Plain</span></label>
      <label class="inline-flex items-center mr-3"><input type="radio" name="tone" value="Caregiver"> <span class="ml-1">Caregiver</span></label>
      <label class="inline-flex items-center mr-3"><input type="radio" name="tone" value="Faith"> <span class="ml-1">Faith</span></label>
      <label class="inline-flex items-center mr-3"><input type="radio" name="tone" value="Clinical"> <span class="ml-1">Clinical</span></label>
      <label class="inline-flex items-center mr-3"><input type="radio" name="tone" value="Bilingual"> <span class="ml-1">Bilingual</span></label>
    </div>

    <!-- Composer -->
    <div id="composer" class="border-t p-4 bg-white shadow-inner">
      <!-- Pending attachments tray -->
      <div id="pendingTray" class="hidden mb-3">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm text-gray-600"><i class="fa-solid fa-paperclip mr-2"></i>Pending attachments</div>
          <button id="clearAllBtn" class="text-xs text-red-600 hover:underline">Clear all</button>
        </div>
        <!-- NOTE: 2 columns by default for tiny phones -->
        <div id="pendingGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3"></div>
      </div>

      <!-- Input row with dropzone -->
      <div id="dropzone" class="dropzone rounded-xl p-3 flex items-center gap-2 overflow-hidden">
        <!-- Add -->
        <button id="addBtn" class="shrink-0 w-10 h-10 rounded-full bg-teal-600 hover:bg-teal-700 text-white flex items-center justify-center text-xl shadow-md" title="Add files">
          <i class="fa-solid fa-plus"></i>
        </button>

        <input type="file" id="fileInput" class="hidden" multiple
              accept=".pdf,.docx,.txt,.jpg,.jpeg,.png,.webp,.heic" />

        <!-- Text input -->
        <input type="text" id="chatInput"
              class="flex-1 min-w-0 px-4 py-2 text-base border rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-300"
              placeholder="Type your questionâ€¦ (attachments will send with this)" />

        <!-- Mic -->
        <button id="micBtn" class="shrink-0 w-10 h-10 rounded-full bg-gray-200 text-gray-800 flex items-center justify-center hover:bg-gray-300" title="Dictate">
          <i class="fa-solid fa-microphone"></i>
        </button>

        <!-- Send -->
        <button id="sendBtn" class="shrink-0 w-10 h-10 rounded-full bg-black text-white flex items-center justify-center shadow-md hover:bg-gray-900" title="Send">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>

      <p class="mt-1 text-xs text-gray-500 pl-12">Tip: Drag & drop files here to stage them. They wonâ€™t send until you hit <b>Send</b>.</p>
    </div>
  </section>
</div>

<!-- Summary Modal -->
<div id="summaryModal" class="fixed inset-0 bg-black bg-opacity-40 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl relative p-8 ring-1 ring-gray-200">
    <button onclick="closeModal()" class="absolute top-3 right-4 text-gray-400 hover:text-gray-800 text-2xl">&times;</button>
    <div class="mb-4">
      <h2 class="text-2xl font-bold text-teal-700 flex items-center gap-2">
        <i class="fa-solid fa-brain text-teal-600 text-2xl"></i> Full Summary
      </h2>
      <p class="text-base text-gray-500">Hereâ€™s the complete AI-generated explanation.</p>
    </div>
    <div id="modalContent" class="text-gray-800 text-base leading-relaxed max-h-[60vh] overflow-y-auto space-y-4 prose prose-sm"></div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 z-50 flex flex-col items-center justify-center text-center hidden">
  <div class="animate-spin mb-4 text-teal-600 text-4xl"><i class="fa-solid fa-brain"></i></div>
  <p class="text-2xl font-semibold text-gray-700">NeuroMed is thinkingâ€¦</p>
  <p class="text-base text-gray-500 mt-2 italic"><i class="fa-solid fa-brain text-teal-600 text-2xl"></i> Please hold the coffee â˜•</p>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity duration-300">
  <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 relative ring-1 ring-gray-200 animate-fadeInUp">
    <button onclick="closeSettingsModal()" class="absolute top-5 right-6 text-gray-400 hover:text-gray-600 text-2xl transition">&times;</button>
    <div class="mb-6 flex items-center gap-3">
      <i class="fa-solid fa-sliders text-2xl text-teal-600"></i>
      <h2 class="text-3xl font-bold text-gray-800 tracking-tight">Settings</h2>
    </div>
    <div class="mb-5">
      <label for="displayName" class="block text-sm font-semibold text-gray-700 mb-1">Display Name</label>
      <input type="text" id="displayName" placeholder="e.g. Maria Gregory" class="w-full px-4 py-3 border rounded-lg shadow-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-500 bg-gray-50 transition" />
    </div>
    <div class="mb-5">
      <label for="profession" class="block text-sm font-semibold text-gray-700 mb-1">Profession</label>
      <input type="text" id="profession" placeholder="e.g. Healthcare Advocate, Tech Founder" class="w-full px-4 py-3 border rounded-lg shadow-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-teal-500 bg-gray-50 transition" />
    </div>
    <div class="mb-6 text-sm text-gray-500 italic">
      <i class="fa-solid fa-image-portrait mr-2 text-gray-400"></i> Profile photo upload coming soon...
    </div>
    <div class="flex justify-between items-center mt-6">
      <button onclick="saveSettings()" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold px-6 py-2.5 rounded-full shadow-md transition flex items-center gap-2">
        <i class="fa-solid fa-check-circle text-white text-lg"></i> Save Changes
      </button>
      <button onclick="logoutUser()" class="text-sm text-red-600 hover:underline">Logout</button>
    </div>
  </div>
</div>

<!-- Rotated side tab (hidden on tiny phones) -->
<button id="feedbackTab"
  class="sm:flex fixed 
         top-1/2 sm:top-1/2 top-[40%]
         -translate-y-1/2 z-[9999]
         bg-teal-600 hover:bg-teal-700 text-white shadow-lg
         px-3 py-2 rounded-tl-md rounded-tr-md
         transform -rotate-90 origin-bottom-right
         whitespace-nowrap tracking-wide text-sm"
  style="right: 10px;">
  <i class="fa-solid fa-comment-dots mr-2 rotate-90"></i> Give feedback
</button>

<!-- Mobile FAB to open feedback (shows when side tab is hidden) -->


<!-- Slide-over Panel -->
<div id="feedbackPanel" class="fixed inset-y-0 right-0 w-full sm:w-[520px] z-[70] translate-x-full transition-transform duration-300">
  <div class="h-full bg-white shadow-2xl border-l flex flex-col">
    <!-- Header -->
    <div class="px-5 py-4 border-b flex items-center justify-between">
      <div class="flex items-center gap-3">
        <i class="fa-solid fa-heart text-teal-600 text-xl"></i>
        <h3 class="text-lg font-semibold">NeuroMed AI â€” Quick Feedback</h3>
      </div>
      <button id="feedbackClose" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
    </div>

    <!-- Body -->
    <form id="feedbackForm" class="px-5 py-4 overflow-y-auto space-y-4" enctype="multipart/form-data">
      <p class="text-sm text-gray-600 -mt-1">
        Thank you for testing! Please use <b>synthetic/public data</b> only â€” no PHI.
      </p>

      <!-- Consent -->
      <label class="flex items-start gap-2 text-sm bg-gray-50 border rounded p-3">
        <input type="checkbox" name="consent" required>
        <span>I agree to share feedback for product improvement and wonâ€™t include sensitive personal health information.</span>
      </label>

      <!-- What you tested -->
      <div>
        <label class="text-sm font-medium">What did you test? (pick any)</label>
        <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
          <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="upload_summarize"> Upload â†’ Summarize</label>
          <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="multi_attachments"> Multiple attachments tray</label>
          <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="tone_selector"> Tone selector</label>
          <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="chat_qna"> Chat Q&A</label>
          <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="summary_modal"> Full Summary modal</label>
          <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="drag_drop"> Drag & drop</label>
          <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="mic_dictation"> Mic dictation</label>
          <label class="flex items-start gap-2 bg-gray-50 border rounded p-2"><input type="checkbox" name="use_case_multi" value="settings_update"> Settings update</label>
        </div>
      </div>

      <!-- Profile -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="text-sm">Role</label>
          <select name="role" class="mt-1 w-full border rounded p-2" required>
            <option value="">Selectâ€¦</option>
            <option value="caregiver">Caregiver</option>
            <option value="patient">Patient</option>
            <option value="clinician">Clinician</option>
            <option value="student">Student</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Email (optional)</label>
          <input name="email" type="email" class="mt-1 w-full border rounded p-2" placeholder="you@example.com">
        </div>
        <div>
          <label class="text-sm">Input type</label>
          <select name="input_type" class="mt-1 w-full border rounded p-2" required>
            <option value="">Selectâ€¦</option>
            <option value="dummy">Dummy text I wrote</option>
            <option value="synthetic">Synthetic sample from app</option>
            <option value="public">Public doc (no PHI)</option>
            <option value="other">Other (no PHI)</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Device</label>
          <input name="device" class="mt-1 w-full border rounded p-2" placeholder="e.g. MacBook, iPhone, Windows PC">
        </div>
        <div>
          <label class="text-sm">Browser</label>
          <input name="browser" class="mt-1 w-full border rounded p-2" placeholder="e.g. Safari 17, Chrome 126">
        </div>
      </div>

      <!-- Ratings -->
      <div class="grid grid-cols-2 gap-3">
        <div><label class="text-sm">Ease (1â€“5)</label><input name="ease" type="number" min="1" max="5" value="3" class="mt-1 w-full border rounded p-2"></div>
        <div><label class="text-sm">Speed (1â€“5)</label><input name="speed" type="number" min="1" max="5" value="3" class="mt-1 w-full border rounded p-2"></div>
        <div><label class="text-sm">Accuracy (1â€“5)</label><input name="accuracy" type="number" min="1" max="5" value="3" class="mt-1 w-full border rounded p-2"></div>
        <div><label class="text-sm">Clarity (1â€“5)</label><input name="clarity" type="number" min="1" max="5" value="3" class="mt-1 w-full border rounded p-2"></div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div><label class="text-sm">NPS (0â€“10)</label><input name="nps" type="number" min="0" max="10" class="mt-1 w-full border rounded p-2" required></div>
        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="allow_contact"> OK to contact</label>
        <label class="flex items-center gap-2 text-sm"><input type="checkbox" name="allow_anon" checked> Store anonymously</label>
      </div>

      <!-- Open text + screenshot -->
      <div>
        <label class="text-sm">What worked well?</label>
        <textarea name="pros" rows="2" class="w-full border rounded p-2"></textarea>
      </div>
      <div>
        <label class="text-sm">What can we improve?</label>
        <textarea name="cons" rows="2" class="w-full border rounded p-2"></textarea>
      </div>
      <div>
        <label class="text-sm">Bugs or errors (steps)</label>
        <textarea name="bugs" rows="2" class="w-full border rounded p-2" placeholder="1) Go toâ€¦ 2) Clickâ€¦ 3) See errorâ€¦"></textarea>
      </div>
      <div>
        <label class="text-sm">Screenshot (optional)</label>
        <input type="file" name="screenshot" accept="image/*">
      </div>

      <!-- Submit -->
      <div class="flex items-center justify-between pt-2">
        <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded">Send feedback</button>
      </div>

      <div id="fbErrors" class="text-sm text-red-600 hidden"></div>
    </form>
  </div>
</div>

<!-- Toast -->
<div id="fbToast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden">
  <div class="bg-green-600 text-white px-4 py-2 rounded shadow">Thanks! Feedback received. ðŸ’œ</div>
</div>

<!-- Success Modal -->
<div id="fbSuccess"
     class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/40 backdrop-blur-[1px]">
  <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl ring-1 ring-gray-200 p-6 relative">
    <button id="fbSuccessCloseX" class="absolute top-3 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>

    <div class="flex items-start gap-3 mb-3">
      <div class="shrink-0 rounded-full p-2 bg-teal-100 text-teal-700">
        <i class="fa-solid fa-check"></i>
      </div>
      <div>
        <h3 class="text-xl font-semibold text-gray-800">Thanks for the feedback! ðŸ’œ</h3>
        <p id="fbSuccessMsg" class="text-sm text-gray-600 mt-1">
          Weâ€™ve received your submission. Your input helps make NeuroMed AI kinder and sharper.
        </p>
      </div>
    </div>

    <div id="fbSuccessMeta" class="hidden text-xs text-gray-500 mb-4"></div>

    <div class="flex justify-end gap-2 mt-4">
      <button id="fbSuccessAnother"
              class="px-4 py-2 rounded border border-gray-300 text-gray-700 hover:bg-gray-50">
        Send another
      </button>
      <button id="fbSuccessClose"
              class="px-4 py-2 rounded bg-teal-600 text-white hover:bg-teal-700">
        Done
      </button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js" defer></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer></script>

<script>
/* ---------- Helpers ---------- */
function getCSRFToken() {
  const m = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}

/* Ensure external libs are ready (marked/DOMPurify/hljs) without blocking forever */
async function ensureReady() {
  const t0 = Date.now();
  while (Date.now() - t0 < 800) {
    if (window.marked && window.DOMPurify && window.hljs) break;
    await new Promise(r => setTimeout(r, 50));
  }
}

/* ---------- Feedback panel controls ---------- */
const panel   = document.getElementById('feedbackPanel');
const tabBtn  = document.getElementById('feedbackTab');
const fabBtn  = document.getElementById('feedbackFab');
const closeBtn= document.getElementById('feedbackClose');
const form    = document.getElementById('feedbackForm');
const toast   = document.getElementById('fbToast');
const errBox  = document.getElementById('fbErrors');

function openFeedback(){ panel.classList.remove('translate-x-full'); }
function closeFeedback(){ panel.classList.add('translate-x-full'); }

tabBtn?.addEventListener('click', openFeedback);
fabBtn?.addEventListener('click', openFeedback);
closeBtn?.addEventListener('click', closeFeedback);

// ESC to close slide-over
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeFeedback(); });

/* ---------- Success modal ---------- */
const fbSuccess         = document.getElementById('fbSuccess');
const fbSuccessMsg      = document.getElementById('fbSuccessMsg');
const fbSuccessMeta     = document.getElementById('fbSuccessMeta');
const fbSuccessClose    = document.getElementById('fbSuccessClose');
const fbSuccessCloseX   = document.getElementById('fbSuccessCloseX');
const fbSuccessAnother  = document.getElementById('fbSuccessAnother');

function openFbSuccess(data){
  if (data && (data.id || data.created_at)) {
    fbSuccessMeta.classList.remove('hidden');
    fbSuccessMeta.textContent = `Ref: ${data.id || 'â€”'} â€¢ ${data.created_at || ''}`;
  } else {
    fbSuccessMeta.classList.add('hidden');
    fbSuccessMeta.textContent = '';
  }
  fbSuccess.classList.remove('hidden');
  fbSuccess.classList.add('flex');
  document.body.classList.add('overflow-hidden'); // lock background scroll
}

function closeFbSuccess(){
  fbSuccess.classList.add('hidden');
  fbSuccess.classList.remove('flex');
  document.body.classList.remove('overflow-hidden');
}

fbSuccessClose?.addEventListener('click', closeFbSuccess);
fbSuccessCloseX?.addEventListener('click', closeFbSuccess);
fbSuccess.addEventListener('click', (e) => {
  if (e.target === fbSuccess) closeFbSuccess(); // click backdrop to close
});
document.addEventListener('keydown', (e) => {
  if (!fbSuccess.classList.contains('hidden') && e.key === 'Escape') closeFbSuccess();
});

// "Send another" = reopen the panel
fbSuccessAnother?.addEventListener('click', () => {
  closeFbSuccess();
  openFeedback();
});

/* ---------- Submit feedback ---------- */
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  errBox.classList.add('hidden');
  errBox.textContent = '';

  const fd = new FormData(form);
  if (typeof collectUseCase === 'function') {
    fd.append('use_case', collectUseCase());
  }

  const submitBtn = form.querySelector('button[type="submit"]');
  const originalHTML = submitBtn ? submitBtn.innerHTML : '';
  const setLoading = (on) => {
    if (!submitBtn) return;
    if (on) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Sending your feedbackâ€¦ hang tight';
    } else {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalHTML;
    }
  };

  setLoading(true);

  try {
    const res = await fetch('/beta/api/submit/', {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() },
      body: fd
    });
    const data = await res.json();

    if (!res.ok || !data.success) {
      const msg = data?.errors ? JSON.stringify(data.errors) : 'Please check your inputs.';
      errBox.textContent = msg;
      errBox.classList.remove('hidden');
      setLoading(false);
      return;
    }

    form.reset();
    if (typeof prefillMeta === 'function') prefillMeta();
    setLoading(false);
    closeFeedback();
    openFbSuccess(data);
  } catch (err) {
    errBox.textContent = 'Network error. Please try again.';
    errBox.classList.remove('hidden');
    setLoading(false);
  }
});

/* ---------- Device/browser prefill ---------- */
function detectBrowserPretty() {
  const ua = navigator.userAgent || '';
  const rules = [
    { name: 'Edge',    re: /(Edg|Edge)\/(\d+)/i },
    { name: 'Chrome',  re: /(Chrome|Chromium)\/(\d+)/i },
    { name: 'Firefox', re: /Firefox\/(\d+)/i },
    { name: 'Safari',  re: /Version\/(\d+).+Safari/i },
  ];
  for (const r of rules) { const m = ua.match(r.re); if (m) return `${r.name} ${m[m.length - 1]}`; }
  return ua ? ua.split(') ').pop() || 'Unknown' : 'Unknown';
}
function prefillMeta() {
  const form = document.getElementById('feedbackForm');
  if (!form) return;
  const dev = (navigator.userAgentData && navigator.userAgentData.platform) || navigator.platform || 'Unknown';
  const browserPretty = detectBrowserPretty();
  const devInput = form.querySelector('input[name="device"]');
  const brInput  = form.querySelector('input[name="browser"]');
  if (devInput && !devInput.value) devInput.value = dev;
  if (brInput  && !brInput.value)  brInput.value  = browserPretty;
}
document.addEventListener('DOMContentLoaded', prefillMeta);

/* ---------- Chat UI helpers ---------- */
function closeModal(){ document.getElementById("summaryModal").classList.add("hidden"); }

function appendRichBubble(content, isUser = false) {
  const chatWindow = document.getElementById("chatWindow");
  if (!chatWindow) return;

  const wrap = document.createElement("div");
  wrap.className = "w-full flex mb-3";

  const bubble = document.createElement("div");
  bubble.className = `chat-bubble ${isUser ? "chat-user" : "chat-ai"}`;

  const rich = document.createElement("div");
  rich.className = "leading-relaxed text-[15px] space-y-2";
  rich.setAttribute("dir", "auto");

  const asNode = content instanceof Node;
  const text = asNode ? null : String(content ?? "");

  try {
    if (asNode) {
      rich.appendChild(content);
    } else {
      let html = text;
      if (window.marked && typeof marked.parse === "function") {
        html = marked.parse(text);
      } else {
        html = text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\n/g, "<br>");
      }
      rich.innerHTML = window.DOMPurify ? DOMPurify.sanitize(html) : html;

      rich.querySelectorAll("p").forEach(el => el.classList.add("text-gray-800"));
      rich.querySelectorAll("h1,h2,h3,h4").forEach(el =>
        el.classList.add("font-semibold","tracking-tight","text-gray-900","mt-2")
      );
      rich.querySelectorAll("h1").forEach(el => el.classList.add("text-xl"));
      rich.querySelectorAll("h2").forEach(el => el.classList.add("text-lg"));
      rich.querySelectorAll("h3,h4").forEach(el => el.classList.add("text-base"));
      rich.querySelectorAll("ul").forEach(el => el.classList.add("list-disc","pl-5","space-y-1"));
      rich.querySelectorAll("ol").forEach(el => el.classList.add("list-decimal","pl-5","space-y-1"));
      rich.querySelectorAll("blockquote").forEach(el =>
        el.classList.add("border-l-4","border-teal-500","pl-3","italic","text-gray-700","bg-teal-50/40","rounded-r")
      );
      rich.querySelectorAll("a").forEach(a => {
        a.classList.add("text-teal-700","hover:underline","font-medium");
        a.target = "_blank"; a.rel = "noopener noreferrer";
      });
      rich.querySelectorAll("p > code, li > code").forEach(code =>
        code.classList.add("px-1.5","py-0.5","rounded","bg-gray-100","text-gray-900","text-[13px]")
      );
      rich.querySelectorAll("pre code").forEach(code =>
        code.parentElement.classList.add("overflow-x-auto","rounded-lg","p-3","bg-gray-900","text-gray-100","text-sm")
      );
      rich.querySelectorAll("img").forEach(img => {
        img.classList.add("rounded-lg","shadow-sm","max-w-full");
        img.loading = "lazy";
      });
      if (window.hljs) {
        rich.querySelectorAll("pre code").forEach(code => { try { hljs.highlightElement(code); } catch {} });
      }
    }
  } catch {
    rich.textContent = asNode ? "[Unsupported content]" : (text || "");
  }

  bubble.appendChild(rich);
  wrap.appendChild(bubble);
  chatWindow.appendChild(wrap);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function appendBubble(message, isUser = false) { appendRichBubble(message, isUser); }

/* ---------- Init ---------- */
document.addEventListener("DOMContentLoaded", async () => {
  await ensureReady();
  const chatWindow = document.getElementById("chatWindow");
  if (chatWindow && chatWindow.innerHTML.trim() === '') { greetUser(); }

  // Summary modal openers
  document.querySelectorAll(".open-summary-modal").forEach(btn => {
    btn.addEventListener("click", function () {
      const raw = this.dataset.summary;
      const text = JSON.parse('"' + raw.replace(/"/g, '\\"') + '"');
      const formatted = text.split(/\n{2,}/g).map(p => `<p>${p.trim()}</p>`).join('');
      document.getElementById("modalContent").innerHTML = formatted;
      document.getElementById("summaryModal").classList.remove("hidden");
    });
  });

  // New Chat
  document.getElementById('newChatBtn')?.addEventListener('click', newChat);

  // Search filter
  const searchInput = document.querySelector('input[placeholder="Search summaries..."]');
  searchInput?.addEventListener('input', function () {
    const q = this.value.toLowerCase();
    document.querySelectorAll('.sidebar-link').forEach(item => {
      const filename = item.querySelector('p.text-white-800')?.innerText.toLowerCase() || '';
      const text = item.querySelector('p.text-base')?.innerText.toLowerCase() || '';
      item.style.display = (filename.includes(q) || text.includes(q)) ? 'block' : 'none';
    });
  });

  // Composer controls
  document.getElementById('addBtn').addEventListener('click', () => document.getElementById('fileInput').click());
  document.getElementById('fileInput').addEventListener('change', e => {
    if (e.target.files?.length) addFiles(e.target.files);
    e.target.value = '';
  });
  document.getElementById('clearAllBtn').addEventListener('click', clearPending);
  document.getElementById('micBtn').addEventListener('click', startDictation);
  document.getElementById('sendBtn').addEventListener('click', sendChat);

  // Drag & drop
  const dz = document.getElementById('dropzone');
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('dragover');
    if (e.dataTransfer?.files?.length) addFiles(e.dataTransfer.files);
  });

  // Enter to send
  document.getElementById('chatInput').addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
  });

  // Keep chat padding above composer height
  const c = document.getElementById('composer');
  const w = document.getElementById('chatWindow');
  const ro = new ResizeObserver(updateComposerPadding);
  if (c) ro.observe(c);
  updateComposerPadding();
  addEventListener('resize', updateComposerPadding);
  addEventListener('orientationchange', updateComposerPadding);
});

/* ---------- Greeting & new chat ---------- */
async function greetUser() {
  try {
    const res = await fetch("/api/user/settings/");
    const data = await res.json();
    const name = data.display_name || "there";
    const options = [
      `Welcome, ${name}! Letâ€™s get you started on understanding your records.`,
      `Hi ${name}, ready to make sense of your medical documents?`,
      `Glad youâ€™re here, ${name}. Letâ€™s take the first step together.`,
      `${name}, Iâ€™m here to help simplify your health informationâ€”letâ€™s begin.`,
    ];
    appendBubble(options[Math.floor(Math.random()*options.length)], false);
  } catch {
    appendBubble("Welcome back. Letâ€™s take care of what matters most today.", false);
  }
}

async function newChat() {
  const chatWindow = document.getElementById("chatWindow");
  if (chatWindow) chatWindow.innerHTML = '';
  clearPending();
  try {
    await fetch("/clear-session/", { method:"POST", headers:{ "X-CSRFToken": getCSRFToken(), "Content-Type":"application/json" }});
    const res = await fetch("/api/user/settings/");
    const data = await res.json();
    const name = data.display_name || "there";
    const greetings = [
      `Hi ${name}, how can I help you today? ðŸŒ¿`,
      `Hello ${name}! What can I do for you today? ðŸ¤–`,
      `Hey ${name}, Iâ€™m here for you. How are you feeling? ðŸ’¬`,
      `${name}, letâ€™s figure things out together. What do you need today? ðŸ§ `
    ];
    appendBubble(greetings[Math.floor(Math.random()*greetings.length)], false);
  } catch {
    appendBubble("Hi there! How can I help you today?", false);
  }
}

/* ---------- Pending attachments state ---------- */
const pending = []; // {file: File, url?: string, kind: 'image'|'doc'}
const pendingTray = document.getElementById('pendingTray');
const pendingGrid = document.getElementById('pendingGrid');

function renderPending() {
  pendingGrid.innerHTML = '';
  if (pending.length === 0) { pendingTray.classList.add('hidden'); return; }
  pendingTray.classList.remove('hidden');

  pending.forEach((item, idx) => {
    const cell = document.createElement('div');
    cell.className = 'thumb p-2';

    if (item.kind === 'image') {
      const imgWrap = document.createElement('div');
      imgWrap.className = 'w-full h-24';
      const img = document.createElement('img');
      img.src = item.url; img.alt = item.file.name;
      imgWrap.appendChild(img); cell.appendChild(imgWrap);
    } else {
      const box = document.createElement('div');
      box.className = 'h-24 flex items-center justify-center text-gray-600';
      box.innerHTML = `<div class="text-center px-2">
          <i class="fa-solid fa-file-lines text-2xl"></i>
          <div class="text-[11px] mt-1 truncate max-w-[110px]">${item.file.name}</div>
        </div>`;
      cell.appendChild(box);
    }

    const rm = document.createElement('button');
    rm.className = 'thumb-remove'; rm.title = 'Remove';
    rm.innerHTML = '<i class="fa-solid fa-xmark"></i>';
    rm.onclick = () => removePending(idx);
    cell.appendChild(rm);

    pendingGrid.appendChild(cell);
  });
}

function addFiles(files) {
  [...files].forEach(f => {
    const isImage = /^image\//.test(f.type);
    const obj = { file: f, kind: isImage ? 'image' : 'doc' };
    if (isImage) obj.url = URL.createObjectURL(f);
    pending.push(obj);
  });
  renderPending();
}

function removePending(index) {
  const item = pending[index];
  if (item?.url) URL.revokeObjectURL(item.url);
  pending.splice(index, 1);
  renderPending();
}
function clearPending() {
  pending.forEach(p => p.url && URL.revokeObjectURL(p.url));
  pending.length = 0;
  renderPending();
}

/* ---------- Send chat (bundles text + pending files) ---------- */
async function sendChat() {
  const input = document.getElementById("chatInput");
  const userMessage = (input.value || '').trim();
  const tone = document.querySelector('input[name="tone"]:checked')?.value || "Plain";

  if (!userMessage && pending.length === 0) return;

  // Render user bubble + staged attachments gallery
  if (userMessage) appendBubble(userMessage, true);
  if (pending.length) {
    const gallery = document.createElement('div');
    gallery.className = 'grid grid-cols-2 sm:grid-cols-3 gap-2';
    pending.forEach(item => {
      const card = document.createElement('div');
      card.className = 'border rounded-lg overflow-hidden';
      if (item.kind === 'image') {
        const img = document.createElement('img');
        img.src = item.url; img.alt = item.file.name;
        img.className = 'block w-full h-28 object-cover';
        card.appendChild(img);
      } else {
        card.className += ' p-3 flex items-center gap-2 text-sm';
        card.innerHTML = `<i class="fa-solid fa-file-lines"></i><span class="truncate">${item.file.name}</span>`;
      }
      gallery.appendChild(card);
    });
    appendRichBubble(gallery, true);
  }

  // Build payload
  const formData = new FormData();
  if (userMessage) formData.append("message", userMessage);
  formData.append("tone", tone);
  pending.forEach(p => formData.append("files[]", p.file, p.file.name));

  // Clear composer state
  input.value = "";
  clearPending();

  // Typing indicator (single, de-duped)
  const chatWindow = document.getElementById("chatWindow");
  const typingWrap = document.createElement("div");
  typingWrap.className = "w-full flex mb-2 justify-start";
  const typing = document.createElement("div");
  typing.className = "chat-bubble chat-ai text-gray-500 italic";
  typing.innerText = "Analyzingâ€¦";
  typingWrap.appendChild(typing);
  chatWindow.appendChild(typingWrap);
  chatWindow.scrollTop = chatWindow.scrollHeight;

  // Send to backend
  try {
    const res = await fetch("/api/send-chat/", {
      method: "POST",
      headers: { "X-CSRFToken": getCSRFToken() },
      body: formData
    });
    const data = await res.json();
    typing.classList.remove("italic","text-gray-500");
    typing.classList.add("text-gray-800");
    typing.innerText = data.reply || "âš ï¸ No reply received.";
  } catch (err) {
    typing.classList.remove("italic","text-gray-500");
    typing.classList.add("text-red-700","bg-red-100");
    typing.innerText = "âŒ Error getting a response.";
  }
}

/* ---------- Speech ---------- */
function startDictation() {
  if (!('webkitSpeechRecognition' in window)) return alert("Speech recognition only works in Chrome.");
  const rec = new webkitSpeechRecognition();
  rec.lang = "en-US";
  rec.onresult = (e) => {
    const t = e.results[0][0].transcript;
    document.getElementById("chatInput").value = t;
  };
  rec.start();
}

/* ---------- Sidebar / Settings ---------- */
function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("overlay");
  const isOpen = sidebar.classList.contains("translate-x-0");
  if (isOpen) {
    sidebar.classList.remove("translate-x-0");
    sidebar.classList.add("-translate-x-full");
    overlay.classList.add("hidden");
  } else {
    sidebar.classList.remove("-translate-x-full");
    sidebar.classList.add("translate-x-0");
    overlay.classList.remove("hidden");
  }
}
function openSettingsModal() {
  fetch("/api/user/settings/").then(r=>r.json()).then(data=>{
    document.getElementById("displayName").value = data.display_name || "";
    document.getElementById("profession").value  = data.profession || "";
    const modal = document.getElementById("settingsModal");
    modal.classList.remove("hidden"); modal.classList.add("flex");
  });
}
function saveSettings() {
  const name = document.getElementById("displayName").value.trim();
  const profession = document.getElementById("profession").value.trim();
  fetch("/api/user/settings/update/", {
    method:"POST",
    headers:{ "Content-Type":"application/json","X-CSRFToken":getCSRFToken() },
    body: JSON.stringify({ display_name:name, profession })
  }).then(r=>r.json()).then(()=>{ alert("Settings updated successfully!"); closeSettingsModal(); });
}
function closeSettingsModal(){
  const modal = document.getElementById("settingsModal");
  modal.classList.remove("flex"); modal.classList.add("hidden");
}
document.addEventListener("click", (e)=>{
  const dd = document.getElementById("settingsDropdown");
  const button = e.target.closest("button[onclick='toggleSettingsMenu()']");
  if (!button && dd && !dd.contains(e.target)) { dd.classList.add("hidden"); dd.classList.remove("block"); }
});
function toggleSettingsMenu(){
  const menu = document.getElementById("settingsDropdown");
  menu.classList.toggle("hidden"); menu.classList.toggle("block");
}
function logoutUser(){
  fetch("{% url 'logout' %}", {
    method: "POST",
    headers: { "X-CSRFToken": getCSRFToken() }
  }).then(() => {
    window.location.href = "{% url 'login' %}";
  }).catch(() => {
    window.location.href = "{% url 'login' %}";
  });
}

/* ---------- Layout padding sync ---------- */
function updateComposerPadding() {
  const c = document.getElementById('composer');
  const w = document.getElementById('chatWindow');
  if (!c || !w) return;
  const h = Math.ceil(c.getBoundingClientRect().height || 0);
  w.style.paddingBottom = `calc(${h}px + 12px)`;
}
</script>
</body>
</html>
