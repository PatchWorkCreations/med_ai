<section aria-label="Front Desk Workspace">
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-xl font-extrabold">Front Desk</h2>
    <div class="text-sm text-slate-600">Click a card to preview & act</div>
  </div>

  <!-- Legend -->
  <div class="rounded-xl bg-white border border-slate-200 p-3 mb-3">
    <div class="text-xs text-slate-600 flex flex-wrap gap-2 items-center">
      <span class="me-2">Priority:</span>
      <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-rose-50 text-rose-700">
        <span class="h-2 w-2 rounded-full bg-rose-600"></span> High
      </span>
      <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-amber-50 text-amber-700">
        <span class="h-2 w-2 rounded-full bg-amber-500"></span> Medium
      </span>
      <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-50 text-emerald-700">
        <span class="h-2 w-2 rounded-full bg-emerald-600"></span> Low
      </span>
    </div>
  </div>

  <!-- Board (uses frontdesk_board: [{label, key, items:[...]}]) -->
  <div class="grid lg:grid-cols-4 gap-4">
    {% for col in frontdesk_board %}
    <div class="rounded-2xl bg-white border border-slate-200 soft flex flex-col">
      <!-- Column Header -->
      <div class="px-4 pt-4 pb-3 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="font-semibold">{{ col.label }}</div>
          <span class="count inline-flex items-center justify-center h-6 min-w-6 px-2 rounded-full text-xs bg-slate-100 text-slate-700">
            {{ col.items|length }}
          </span>
        </div>
        <button class="text-xs text-slate-500 hover:text-slate-700 hidden lg:inline">Sort</button>
      </div>

      <!-- Cards -->
      <div class="px-3 pb-4 space-y-3 min-h-40" data-col="{{ col.key }}">
        {% for item in col.items %}
          <div
            class="nm-card relative rounded-xl border border-slate-200 p-3 bg-white hover:shadow-sm cursor-pointer focus:ring-2 focus:ring-emerald-300 outline-none"
            data-enc-id="{{ item.id }}"
            tabindex="0"
            role="button"
            aria-label="Open encounter {{ item.id }}"
          >
            <div class="flex items-center justify-between text-sm">
              <span class="font-medium">{{ item.name }}</span>
              {% if item.priority == 'high' %}
                <span class="px-2 py-0.5 rounded-full bg-rose-50 text-rose-700">High</span>
              {% elif item.priority == 'low' %}
                <span class="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700">Low</span>
              {% else %}
                <span class="px-2 py-0.5 rounded-full bg-amber-50 text-amber-700">Medium</span>
              {% endif %}
            </div>
            <div class="mt-1 text-xs text-slate-500">
              {{ item.reason }} • Insurance: {{ item.insurer }}
            </div>
          </div>
        {% empty %}
          <div class="text-xs text-slate-400 px-3 py-3">No items</div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Modal -->
  <div id="fdModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="fdModalTitle">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-slate-900/50"></div>

    <!-- Card -->
    <div class="relative mx-auto my-8 w-[min(100%,68rem)]">
      <div class="rounded-2xl bg-white border border-slate-200 shadow-2xl overflow-hidden">
        <!-- Modal header -->
        <div class="px-5 py-3 border-b border-slate-200 flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-500">Encounter</div>
            <h3 id="fdModalTitle" class="text-lg font-extrabold">#<span id="m_id">—</span></h3>
          </div>
          <div class="flex items-center gap-2">
            <span id="m_status_badge" class="px-2 py-1 rounded-full bg-slate-100 text-slate-700 text-xs">Status: —</span>
            <span id="m_priority_badge" class="px-2 py-1 rounded-full bg-amber-50 text-amber-700 text-xs">Priority: —</span>
            <button id="fdModalClose" class="rounded-lg px-2 py-1 text-sm border hover:bg-slate-50" aria-label="Close">Close</button>
          </div>
        </div>

        <!-- Modal body -->
        <div class="p-5 grid lg:grid-cols-3 gap-4">
          <!-- Left: summary -->
          <div class="lg:col-span-2 space-y-4">
            <div class="rounded-2xl bg-white border border-slate-200 p-4">
              <div class="text-slate-800">
                <div class="font-semibold">Reason</div>
                <div id="m_reason" class="mt-1">—</div>
              </div>
              <div id="m_one_liner_wrap" class="mt-3 hidden">
                <div class="text-sm font-semibold text-slate-700">Intake one-liner</div>
                <div id="m_one_liner" class="mt-1">—</div>
              </div>
            </div>

            <div class="rounded-2xl bg-white border border-slate-200 p-4">
              <div class="font-semibold">We collected</div>
              <dl class="mt-3 grid sm:grid-cols-2 gap-4 text-sm">
                <div><dt class="text-slate-500">Chief complaint</dt><dd id="m_cc" class="font-medium">—</dd></div>
                <div><dt class="text-slate-500">Duration</dt><dd id="m_duration" class="font-medium">—</dd></div>
                <div><dt class="text-slate-500">Severity</dt><dd id="m_severity" class="font-medium">—</dd></div>
                <div><dt class="text-slate-500">Location</dt><dd id="m_location" class="font-medium">—</dd></div>
                <div class="sm:col-span-2">
                  <dt class="text-slate-500">Red flags</dt><dd id="m_redflags" class="font-medium">—</dd>
                </div>
              </dl>
            </div>

            <div class="rounded-2xl bg-white border border-slate-200 p-4">
              <div class="font-semibold">Transcript</div>
              <div id="m_transcript" class="mt-3 space-y-2 text-sm max-h-64 overflow-auto">
                <div class="text-slate-500">—</div>
              </div>
            </div>
          </div>

          <!-- Right: actions -->
          <aside class="space-y-4">
            <div class="rounded-2xl bg-white border border-slate-200 p-4">
              <div class="font-semibold">Patient</div>
              <div class="mt-2 text-sm">
                <div id="m_patient_name" class="font-medium">Anonymous</div>
                <div class="text-slate-500">Insurer: <span id="m_insurer">Self-pay</span></div>
              </div>
            </div>

            <div class="rounded-2xl bg-white border border-slate-200 p-4">
              <div class="font-semibold">Move status</div>
              <div class="mt-2 grid grid-cols-2 gap-2">
                <button class="m-move rounded-lg border px-3 py-1.5 text-sm" data-to="new">New</button>
                <button class="m-move rounded-lg border px-3 py-1.5 text-sm" data-to="screening">Screening</button>
                <button class="m-move rounded-lg border px-3 py-1.5 text-sm" data-to="ready">Ready</button>
                <button class="m-move rounded-lg border px-3 py-1.5 text-sm" data-to="scheduled">Scheduled</button>
              </div>
              <div id="m_move_msg" class="mt-2 text-xs text-slate-500"></div>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------------------------
    // Helpers
    // -------------------------
    function getCookie(name){
      const v = `; ${document.cookie}`.split(`; ${name}=`);
      if (v.length === 2) return v.pop().split(';').shift();
    }
    function showModal(){ document.getElementById('fdModal').classList.remove('hidden'); }
    function hideModal(){ document.getElementById('fdModal').classList.add('hidden'); }

    function badge(el, label, tone){
      el.textContent = label;
      el.className = 'px-2 py-1 rounded-full text-xs ' +
        (tone==='high' ? 'bg-rose-50 text-rose-700'
         : tone==='low' ? 'bg-emerald-50 text-emerald-700'
         : tone==='status' ? 'bg-slate-100 text-slate-700'
         : 'bg-amber-50 text-amber-700');
    }

    function setCountBadges(){
      document.querySelectorAll('[data-col]').forEach(col=>{
        const c = col.querySelectorAll('.nm-card').length;
        const header = col.closest('.soft').querySelector('.count');
        if (header) header.textContent = c;
      });
    }

    // -------------------------
    // Open modal with encounter
    // -------------------------
    async function openEncounter(encId){
      try{
        const r = await fetch(`/api/v1/encounters/${encId}`);
        const j = await r.json();
        if(!r.ok) throw new Error(j.error || 'Failed');

        // Header
        document.getElementById('m_id').textContent = j.id;
        badge(document.getElementById('m_status_badge'), `Status: ${j.status||'new'}`, 'status');
        badge(document.getElementById('m_priority_badge'), `Priority: ${j.priority||'medium'}`, (j.priority||'medium').toLowerCase());

        // Reason + one-liner
        const reason = j.reason
          || (j.summary && j.summary.triage && j.summary.triage.one_sentence)
          || (j.summary && j.summary.fields && j.summary.fields.complaint)
          || 'Patient-reported symptoms';
        document.getElementById('m_reason').textContent = reason;

        const one = j.summary && j.summary.triage && j.summary.triage.one_sentence;
        const oneWrap = document.getElementById('m_one_liner_wrap');
        const oneEl = document.getElementById('m_one_liner');
        if(one){ oneEl.textContent = one; oneWrap.classList.remove('hidden'); } else { oneWrap.classList.add('hidden'); }

        // We-collected
        const f = (j.summary && j.summary.fields) || {};
        document.getElementById('m_cc').textContent       = f.complaint || '—';
        document.getElementById('m_duration').textContent = f.duration  || '—';
        document.getElementById('m_severity').textContent = f.severity  || '—';
        document.getElementById('m_location').textContent = f.location  || '—';
        const rfs = Array.isArray(f.red_flags) ? f.red_flags.join(', ') : (f.red_flags || '');
        document.getElementById('m_redflags').textContent = rfs || '—';

        // Patient block (prefer actual Patient, else summary.patient)
        const p = (j.summary && j.summary.patient) || {};
        const ptName = p.full_name || 'Anonymous';
        const insurer = p.insurer || 'Self-pay';
        document.getElementById('m_patient_name').textContent = ptName;
        document.getElementById('m_insurer').textContent = insurer;

        // Transcript
        const tWrap = document.getElementById('m_transcript');
        tWrap.innerHTML = '';
        const tx = (j.summary && Array.isArray(j.summary.transcript)) ? j.summary.transcript : [];
        if (tx.length === 0){
          tWrap.innerHTML = '<div class="text-slate-500">No transcript captured.</div>';
        } else {
          tx.forEach(turn=>{
            const row = document.createElement('div');
            row.className = 'flex gap-2';
            const pill = document.createElement('span');
            pill.className = 'px-2 py-0.5 rounded bg-slate-100 text-slate-700';
            pill.textContent = turn.role;
            const text = document.createElement('span');
            text.className = 'text-slate-800';
            text.textContent = turn.content;
            row.appendChild(pill);
            row.appendChild(text);
            tWrap.appendChild(row);
          });
        }

        // Store current id on modal for move actions
        document.getElementById('fdModal').dataset.encId = j.id;

        showModal();
      }catch(e){
        alert(e.message);
      }
    }

    // Click/keyboard on cards
    document.querySelectorAll('.nm-card').forEach(card=>{
      card.addEventListener('click', ()=> openEncounter(card.dataset.encId));
      card.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openEncounter(card.dataset.encId); }});
    });

    // Close modal
    document.getElementById('fdModalClose').addEventListener('click', hideModal);
    document.getElementById('fdModal').addEventListener('click', (e)=>{
      if(e.target.id === 'fdModal') hideModal(); // click backdrop
    });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') hideModal(); });

    // -------------------------
    // Move status from modal
    // -------------------------
    document.querySelectorAll('.m-move').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const encId = document.getElementById('fdModal').dataset.encId;
        if(!encId) return;
        const msg = document.getElementById('m_move_msg');
        btn.disabled = true; msg.textContent = 'Updating…';
        try{
          const r = await fetch('/api/v1/encounters/move', {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'X-CSRFToken': getCookie('csrftoken')||''
            },
            body: JSON.stringify({ id: Number(encId), to: btn.dataset.to })
          });
          const j = await r.json();
          if(!r.ok) throw new Error(j.error || 'Failed');

          // Update status badge in modal
          badge(document.getElementById('m_status_badge'), `Status: ${j.status}`, 'status');

          // Move the card in the board
          const card = document.querySelector(`.nm-card[data-enc-id="${encId}"]`);
          const dstCol = document.querySelector(`[data-col="${j.status}"]`);
          if(card && dstCol){
            dstCol.appendChild(card);
            setCountBadges();
          }
          msg.textContent = 'Updated.';
        }catch(e){
          msg.textContent = e.message;
        }finally{
          btn.disabled = false;
        }
      });
    });

    // Initial counts sanity
    setCountBadges();
  </script>
</section>
