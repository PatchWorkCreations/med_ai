<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NeuroMed.ai — Friendlier Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root {
      --brand:#0b3b36;
    }
    body { background: #f6f8fb; }
    .chip { border:1px solid rgba(0,0,0,.08); }
    .chat-bubble{ border-radius:18px; padding:12px 16px; line-height:1.6; box-shadow:0 1px 4px rgba(0,0,0,.04); max-width:80%; white-space:pre-wrap; word-break:break-word; font-size:.95rem }
    .chat-user{ background:#0f172a; color:#fff; border-bottom-right-radius:6px!important; margin-left:auto }
    .chat-ai{ background:#ffffff; color:#111827; border:1px solid rgba(0,0,0,.05); border-bottom-left-radius:6px!important; margin-right:auto }
    .pulse{ animation:pulse 1.1s ease-in-out infinite }
    @keyframes pulse{ 0%,100%{ opacity:.55 } 50%{ opacity:1 } }
    .dotty::after{ content:""; display:inline-block; width:1.2ch; text-align:left; animation: ellipsis 1.2s steps(4,end) infinite }
    @keyframes ellipsis{ 0%{ content:"" } 25%{ content:"." } 50%{ content:".." } 75%{ content:"..." } 100%{ content:"" } }
  .mode-badge{display:inline-flex;align-items:center;gap:.5rem;font-size:.75rem;border-radius:999px;padding:.25rem .6rem;border:1px solid rgba(0,0,0,.08);background:#fff}
    .toast{transform:translateY(-10px);opacity:0;transition:transform .2s ease,opacity .2s ease}
    .toast.show{transform:translateY(0);opacity:1}
    .shimmer{position:relative;overflow:hidden}
    .shimmer::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.7) 50%,rgba(255,255,255,0) 100%);transform:translateX(-100%);animation:shimmer 900ms ease forwards}
    @keyframes shimmer{to{transform:translateX(100%)}}
  </style>
</head>
<body class="text-slate-800">
  <!-- Top bar -->
  <header class="w-full border-b bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-5 py-4 flex items-center justify-between">
      <!-- Logo -->
      <div class="flex items-center gap-3">
        <i class="fa-solid fa-heart-pulse text-teal-600 text-xl" aria-hidden="true"></i>
        <span class="font-semibold tracking-tight">NeuroMed.ai</span>
      </div>
  
      <!-- Links (both visible on mobile + desktop) -->
      <div class="flex items-center gap-3 text-sm">
        <span class="hidden md:inline text-slate-500">You can send 1 free message as guest.</span>
        <a href="/signup" class="text-slate-600 hover:text-slate-900">Sign up</a>
        <a href="/login" class="rounded-full px-3 py-1.5 border hover:bg-slate-50">Log in</a>
      </div>
    </div>
  </header>
  

  <!-- Main -->
  <main class="max-w-4xl mx-auto px-4 md:px-5 pt-6 md:pt-10 pb-24">
    <div class="text-center">
      <h1 class="text-3xl md:text-5xl font-bold tracking-tight">Let’s <span class="text-emerald-700">chat</span></h1>
      <p class="mt-2 text-slate-600">Explain results, decode prescriptions, draft questions for your doctor — in plain language.</p>
    </div>

    <!-- Mode switcher (segmented) -->
    <div class="mt-5">
      <div class="text-center text-sm text-slate-600 mb-2">Choose a mode</div>
      <div id="modeGroup" class="mx-auto max-w-xl grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2">
        <!-- template items; icons help scanning -->
        <button data-mode="Plain" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 flex items-center justify-center gap-2 text-sm aria-pressed" aria-pressed="true">
          <i class="fa-regular fa-message" aria-hidden="true"></i><span>Plain</span>
        </button>
        <button data-mode="Caregiver" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 flex items-center justify-center gap-2 text-sm" aria-pressed="false">
          <i class="fa-solid fa-hands-holding-child" aria-hidden="true"></i><span>Caregiver</span>
        </button>
        <button data-mode="Faith" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 flex items-center justify-center gap-2 text-sm" aria-pressed="false">
          <i class="fa-solid fa-hands-praying" aria-hidden="true"></i><span>Faith</span>
        </button>
        <button data-mode="Clinical" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 flex items-center justify-center gap-2 text-sm" aria-pressed="false">
          <i class="fa-solid fa-stethoscope" aria-hidden="true"></i><span>Clinical</span>
        </button>
        <button data-mode="Bilingual" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 flex items-center justify-center gap-2 text-sm" aria-pressed="false">
          <i class="fa-solid fa-language" aria-hidden="true"></i><span>Bilingual</span>
        </button>
      </div>
    </div>

    <!-- Card -->
    <section class="mt-6 bg-white border rounded-2xl shadow-sm overflow-hidden">
      <!-- Intro + mode badge -->
      <div class="px-5 md:px-6 pt-5 flex items-start justify-between gap-3">
        <div id="intro" class="chat-bubble chat-ai flex-1">
Hi there! 👋 I’m NeuroMed — your medical-summary companion. Upload notes, labs, or prescriptions; I’ll translate them into clear action steps you can use.
        </div>
        <span id="modeBadge" class="mode-badge text-slate-600" title="Current tone"><i class="fa-regular fa-message"></i><span>Plain</span></span>
      </div>

      <!-- Chat area -->
      <div id="chatWindow" class="px-5 md:px-6 pb-3 pt-3 max-h-[55vh] overflow-y-auto scroll-smooth"></div>

      <!-- Suggestions (wrap into a responsive grid; no drag) -->
      <div class="px-5 md:px-6 pb-3">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2" role="list">
          <button class="chip w-full text-left px-3 py-2 rounded-full text-sm hover:bg-slate-50 suggestion" role="listitem"><i class="fa-regular fa-hospital mr-2"></i>Summarize this ER discharge note for a caregiver.</button>
          <button class="chip w-full text-left px-3 py-2 rounded-full text-sm hover:bg-slate-50 suggestion" role="listitem"><i class="fa-solid fa-vial-circle-check mr-2"></i>Explain these lab results (CBC, CMP) in simple terms.</button>
          <button class="chip w-full text-left px-3 py-2 rounded-full text-sm hover:bg-slate-50 suggestion" role="listitem"><i class="fa-solid fa-pills mr-2"></i>Turn these prescriptions into a daily medication schedule.</button>
          <button class="chip w-full text-left px-3 py-2 rounded-full text-sm hover:bg-slate-50 suggestion" role="listitem"><i class="fa-regular fa-clipboard mr-2"></i>Draft questions to ask my doctor about this diagnosis.</button>
          <button class="chip w-full text-left px-3 py-2 rounded-full text-sm hover:bg-slate-50 suggestion" role="listitem"><i class="fa-solid fa-language mr-2"></i>Translate this summary to Taglish for my lola.</button>
        </div>
      </div>

      <!-- Composer -->
      <div class="border-t bg-slate-50/50">
        <div class="px-3 md:px-4 py-3 md:py-4">
          <div class="rounded-xl border bg-white p-2 md:p-2.5">
            <div id="dropZone" class="relative flex items-end gap-2">
              <!-- Upload -->
              <input id="fileInput" type="file" class="hidden" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png" />
              <button id="uploadBtn" class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-slate-100 hover:bg-slate-200 grid place-items-center" title="Upload a record" aria-label="Upload a medical record">
                <i class="fa-solid fa-paperclip"></i>
              </button>

              <!-- Textarea (autosizing) -->
              <div class="flex-1 min-w-0">
                <textarea id="chatInput" rows="1" class="w-full resize-none px-3 py-2 outline-none placeholder-slate-400" placeholder="Type your question… (Shift+Enter for new line)" aria-label="Message"></textarea>
                <div class="flex flex-wrap gap-2 mt-1" id="fileChips"></div>
                
              </div>

              <!-- Controls -->
              <div class="flex items-center gap-2">
                <button id="micBtn" class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-slate-100 hover:bg-slate-200 grid place-items-center" title="Dictate" aria-label="Dictate">
                  <i class="fa-solid fa-microphone"></i>
                </button>
                <button id="sendBtn" class="w-16 h-9 md:h-10 rounded-xl bg-black text-white hover:bg-slate-900 grid place-items-center disabled:opacity-40 disabled:cursor-not-allowed" title="Send" aria-label="Send" disabled>
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>

              <!-- Drop overlay -->
              <div id="dropHint" class="pointer-events-none hidden absolute inset-0 rounded-xl ring-2 ring-emerald-600/50 bg-emerald-50/50 grid place-items-center text-emerald-900 text-sm font-medium">
                Drop your file to attach
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Tiny toast for mode changes -->
  <div id="toast" class="toast fixed top-4 right-4 z-[60] hidden">
    <div class="bg-white border shadow-lg rounded-xl px-3 py-2 text-sm flex items-center gap-2">
      <i id="toastIcon" class="fa-regular fa-message text-emerald-700" aria-hidden="true"></i>
      <span id="toastText" class="text-slate-800">Mode set to Plain</span>
    </div>
  </div>

  <!-- Signup gate -->
  <div id="signupGate" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-xl">
      <div class="flex items-center gap-2 mb-2">
        <i class="fa-regular fa-circle-question text-emerald-700" aria-hidden="true"></i>
        <h3 class="text-xl font-semibold">Create an account to continue</h3>
      </div>
      <p class="text-sm text-slate-600 mb-4">You just used your free guest message. Sign up to save chats, sync across devices, and unlock history.</p>
      <div class="flex items-center justify-end gap-2">
        <button class="px-4 py-2 rounded-lg border" onclick="hideSignupGate()">Not now</button>
        <a href="/signup" class="px-4 py-2 rounded-lg bg-emerald-700 text-white hover:bg-emerald-800">Sign up</a>
      </div>
    </div>
  </div>

  <script>
    // ---------------- Utilities
    function getCSRFToken(){ const m=document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)'); return m?m.pop():''; }
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function appendBubble({ message, isUser=false, timestamp=new Date() }){
      const chatWindow = $('#chatWindow');
      const wrap = document.createElement('div');
      wrap.className = 'w-full flex mb-3';
      const bubble = document.createElement('div');
      bubble.className = `chat-bubble ${isUser?'chat-user':'chat-ai'}`;
      bubble.innerText = message;
      const meta = document.createElement('div');
      meta.className = 'text-[11px] text-slate-400 mt-1 ' + (isUser ? 'text-right ml-auto pr-1' : 'pl-1');
      meta.innerText = new Intl.DateTimeFormat(undefined,{ hour:'2-digit', minute:'2-digit' }).format(timestamp);
      const col = document.createElement('div');
      col.className = 'flex flex-col ' + (isUser ? 'items-end ml-auto' : 'items-start mr-auto');
      col.appendChild(bubble); col.appendChild(meta);
      wrap.appendChild(col); chatWindow.appendChild(wrap);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function setSendDisabled(disabled){ const btn=$('#sendBtn'); btn.disabled=disabled; }

    // Persist mode to localStorage
    function loadMode(){ return localStorage.getItem('nm_mode') || 'Plain'; }
    function saveMode(m){ localStorage.setItem('nm_mode', m); }

    // ---------------- Auth check
    async function isAuthenticated(){
      try{ const r=await fetch('/api/auth/status/',{ credentials:'include' }); if(!r.ok) return false; const j=await r.json(); return !!j.authenticated; }catch{ return false; }
    }

    // ---------------- State
    let firstSendAttempted = false; // allow 1 guest message
    let files = []; // multiple attachments UX, backend will read first if needed
    let abortController = null; // stop generating support if you stream later

    // ---------------- Init
    document.addEventListener('DOMContentLoaded', () => {
      // Mode buttons
      const savedMode = loadMode();
      $$('#modeGroup button').forEach(btn => {
        const mode = btn.dataset.mode;
        if(mode === savedMode){ selectMode(btn); }
        btn.addEventListener('click', () => selectMode(btn));
      });

      // Suggestions -> input
      $$('.suggestion').forEach(btn => btn.addEventListener('click', () => { $('#chatInput').value = btn.innerText.trim(); autosize(); toggleSend(); $('#chatInput').focus(); }));

      // Input events
      $('#chatInput').addEventListener('input', () => { autosize(); toggleSend(); });
      $('#chatInput').addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }
      });
      $('#sendBtn').addEventListener('click', sendChat);

      // Upload controls
      $('#uploadBtn').addEventListener('click', () => $('#fileInput').click());
      $('#fileInput').addEventListener('change', (e) => { if(e.target.files?.length){ for(const f of e.target.files){ addFile(f); } e.target.value=''; } });

      // Drag & drop
      const dz = $('#dropZone');
      ;['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, (e)=>{ e.preventDefault(); $('#dropHint').classList.remove('hidden'); }));
      ;['dragleave','drop'].forEach(evt => dz.addEventListener(evt, (e)=>{ e.preventDefault(); if(evt==='drop'){ const dt=e.dataTransfer; if(dt?.files?.length){ for(const f of dt.files){ addFile(f); } } } $('#dropHint').classList.add('hidden'); }));

      // Paste image/file
      document.addEventListener('paste', (e)=>{ const items=e.clipboardData?.items || []; for(const it of items){ if(it.kind==='file'){ addFile(it.getAsFile()); } } });

      // Mic
      $('#micBtn').addEventListener('click', startDictation);

      // Initial autosize
      autosize(); toggleSend();

      // Focus input for faster first type
      setTimeout(()=>$('#chatInput').focus(), 200);
    });

    function selectMode(btn){
      $$('#modeGroup button').forEach(b => { b.setAttribute('aria-pressed','false'); b.classList.remove('ring','ring-emerald-600'); });
      btn.setAttribute('aria-pressed','true'); btn.classList.add('ring','ring-emerald-600');
      const mode = btn.dataset.mode;
      saveMode(mode);
      applyModeUI(mode);
    }

    const MODE_META = {
      'Plain':     { icon:'fa-regular fa-message',      color:'text-emerald-700', intro:"Hi there! 👋 I’m NeuroMed — your medical-summary companion. Upload notes, labs, or prescriptions; I’ll translate them into clear action steps you can use." },
      'Caregiver': { icon:'fa-solid fa-hands-holding-child', color:'text-amber-700', intro:"Caregiver mode on. I’ll keep things gentle and practical — plain-language steps you can follow and watch-outs to keep your loved one safe." },
      'Faith':     { icon:'fa-solid fa-hands-praying',   color:'text-indigo-700', intro:"Faith mode on. I’ll explain medically, with optional words of encouragement and sensitivity to faith-forward language when asked." },
      'Clinical':  { icon:'fa-solid fa-stethoscope',     color:'text-slate-800', intro:"Clinical mode on. I’ll use precise medical terms, cite ranges when relevant, and keep recommendations structured and concise." },
      'Bilingual': { icon:'fa-solid fa-language',        color:'text-teal-700', intro:"Bilingual mode on. I’ll explain in English + Tagalog (Taglish), keeping key terms accurate and easy to pass along to family." }
    };

    function applyModeUI(mode){
      const meta = MODE_META[mode] || MODE_META['Plain'];
      // Badge update
      const badge = $('#modeBadge');
      badge.querySelector('i').className = meta.icon + ' ' + meta.color;
      badge.querySelector('span').textContent = mode;
      // Intro refresh with shimmer hint
      const intro = $('#intro');
      intro.classList.add('shimmer');
      setTimeout(()=>{ intro.textContent = meta.intro; intro.classList.remove('shimmer'); }, 220);
      // Tiny toast
      showToast(`${mode} mode applied` , meta.icon, meta.color);
    }

    function showToast(text, icon, color){
      const t = $('#toast'); const ti = $('#toastIcon'); const tt = $('#toastText');
      ti.className = icon + ' ' + color; tt.textContent = text;
      t.classList.remove('hidden');
      // force reflow to restart transition
      void t.offsetWidth; t.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.classList.add('hidden'), 220); }, 1600);
    }

    function addFile(file){
      if(!file) return;
      files.push(file);
      const chip = document.createElement('span');
      chip.className = 'text-xs bg-slate-100 border rounded-full px-2 py-1 inline-flex items-center gap-1';
      chip.innerHTML = `<i class="${iconFor(file.name)}"></i><span class="max-w-[12rem] truncate">${escapeHtml(file.name)}</span>`;
      const x = document.createElement('button'); x.className='ml-1 text-slate-500 hover:text-slate-800'; x.innerHTML='&times;'; x.setAttribute('aria-label','Remove attachment');
      x.addEventListener('click', ()=>{ files = files.filter(f=>f!==file); chip.remove(); });
      chip.appendChild(x);
      $('#fileChips').appendChild(chip);
      toggleSend();
    }

    function iconFor(name){
      const n = name.toLowerCase();
      if(n.endsWith('.pdf')) return 'fa-regular fa-file-pdf';
      if(n.endsWith('.doc')||n.endsWith('.docx')) return 'fa-regular fa-file-word';
      if(n.endsWith('.jpg')||n.endsWith('.jpeg')||n.endsWith('.png')) return 'fa-regular fa-file-image';
      return 'fa-regular fa-file';
    }

    function escapeHtml(str){ return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    function autosize(){
      const ta = $('#chatInput');
      ta.style.height = 'auto';
      ta.style.height = Math.min(200, ta.scrollHeight) + 'px';
    }

    function toggleSend(){
      const hasText = ( $('#chatInput').value || '' ).trim().length > 0;
      const hasFile = files.length > 0;
      setSendDisabled(!(hasText || hasFile));
    }

    async function sendChat(){
      const msg = ($('#chatInput').value || '').trim();
      const mode = loadMode();
      if(!msg && files.length===0) return;

      if(!firstSendAttempted){
        firstSendAttempted = true; // allow first send even if guest
        const authed = await isAuthenticated();
        if(!authed){ // let them send the first message; show gate AFTER response
          // proceed but mark to show signup later
          showGateAfterResponse = true;
        }
      }

      if(msg) appendBubble({ message: msg, isUser:true });
      $('#chatInput').value=''; autosize(); toggleSend();

      // Typing indicator
      const chatWindow = $('#chatWindow');
      const typingWrap = document.createElement('div'); typingWrap.className='w-full flex mb-2';
      const typing = document.createElement('div'); typing.className='chat-bubble chat-ai text-slate-600'; typing.innerHTML = '<i class="fa-solid fa-spinner pulse mr-2" aria-hidden="true"></i><span class="dotty">Thinking</span>';
      const col = document.createElement('div'); col.className='flex flex-col items-start mr-auto'; col.appendChild(typing); typingWrap.appendChild(col); chatWindow.appendChild(typingWrap); chatWindow.scrollTop=chatWindow.scrollHeight;

      // Payload
      const fd = new FormData();
      if(msg) fd.append('message', msg);
      fd.append('mode', mode);
      if(files.length){ fd.append('file', files[0]); } // backend currently supports single; keep UX multi for future

      // Optional: enable streaming cancel
      abortController = new AbortController();

      try{
        const res = await fetch('/api/send-chat/', { method:'POST', headers:{ 'X-CSRFToken': getCSRFToken() }, body: fd, credentials:'include', signal: abortController.signal });
        const data = await res.json();
        typing.classList.remove('text-slate-600'); typing.classList.add('text-slate-800');
        typing.innerText = data.reply || '⚠️ No reply received.';
      }catch(e){
        typing.classList.remove('text-slate-600'); typing.classList.add('text-red-700','bg-red-100');
        typing.innerText = '❌ Error getting a response.';
      }finally{
        files = []; $('#fileChips').innerHTML=''; toggleSend();
        if(showGateAfterResponse){ showSignupGate(); showGateAfterResponse=false; }
      }
    }

    let showGateAfterResponse = false;

    // Speech
    function startDictation(){
      if(!('webkitSpeechRecognition' in window)){ alert('Speech recognition works best in Chrome.'); return; }
      const rec = new webkitSpeechRecognition(); rec.lang='en-US';
      rec.onresult = (e)=>{ $('#chatInput').value = e.results[0][0].transcript; autosize(); toggleSend(); };
      rec.start();
    }

    // Gate modal
    function showSignupGate(){ const m=$('#signupGate'); m.classList.remove('hidden'); m.classList.add('flex'); }
    function hideSignupGate(){ const m=$('#signupGate'); m.classList.add('hidden'); m.classList.remove('flex'); }
    window.hideSignupGate = hideSignupGate; // expose for button
  </script>
</body>
</html>
