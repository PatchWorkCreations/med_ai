<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>neuromed.ai — Chat</title>

  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <style>
    body { background:#fff; }
    .chip { border:1px solid rgba(0,0,0,.08); }
    .chat-bubble{
      border-radius:18px;padding:12px 16px;line-height:1.6;box-shadow:0 1px 4px rgba(0,0,0,.04);
      max-width:75%;white-space:pre-wrap;word-break:break-word;font-size:.95rem
    }
    .chat-user{background:#0f172a;color:#fff;border-bottom-right-radius:6px!important;margin-left:auto}
    .chat-ai{background:#f8fafc;color:#111827;border-bottom-left-radius:6px!important;margin-right:auto}
    .selector-pill input:checked+label{background:#0b3b36;color:#fff;border-color:#0b3b36}
    .selector-pill label{transition:all .15s ease}
    .pulse{animation:pulse 1.1s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:.55}50%{opacity:1}}
  </style>
</head>

<body class="text-slate-800">
  <!-- Top bar -->
  <header class="w-full border-b">
    <div class="max-w-6xl mx-auto px-5 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <i class="fa-solid fa-heart-pulse text-emerald-700 text-xl"></i>
        <span class="font-semibold tracking-tight">neuromed.ai</span>
      </div>
      <div class="flex items-center gap-3">
        <a href="/signup" class="hidden sm:inline text-sm text-slate-600 hover:text-slate-900">Sign up</a>
        <a href="/login"  class="text-sm rounded-full px-3 py-1.5 border hover:bg-slate-50">Log in</a>
      </div>
    </div>
  </header>

  <!-- Hero + Chat Card -->
  <main class="max-w-4xl mx-auto px-5 pt-8 pb-16">
    <h1 class="text-center text-4xl sm:text-5xl font-bold tracking-tight mb-2">
      LET’S <span class="text-emerald-700">CHAT</span>
    </h1>

    <!-- Modes -->
    <div class="text-center text-sm text-slate-600 mb-3">Choose a Mode:</div>
    <div class="selector-pill flex items-center justify-center gap-2 mb-8">
      <input id="mode-plain" class="hidden peer" type="radio" name="mode" value="Plain" checked>
      <label for="mode-plain" class="peer-checked:bg-emerald-800 peer-checked:text-white cursor-pointer text-sm border rounded-full px-4 py-2 bg-white">Plain</label>

      <input id="mode-care" class="hidden peer" type="radio" name="mode" value="Caregiver">
      <label for="mode-care" class="peer-checked:bg-emerald-800 peer-checked:text-white cursor-pointer text-sm border rounded-full px-4 py-2 bg-white">Caregiver</label>

      <input id="mode-faith" class="hidden peer" type="radio" name="mode" value="Faith">
      <label for="mode-faith" class="peer-checked:bg-emerald-800 peer-checked:text-white cursor-pointer text-sm border rounded-full px-4 py-2 bg-white">Faith</label>

      <input id="mode-clinical" class="hidden peer" type="radio" name="mode" value="Clinical">
      <label for="mode-clinical" class="peer-checked:bg-emerald-800 peer-checked:text-white cursor-pointer text-sm border rounded-full px-4 py-2 bg-white">Clinical</label>

      <input id="mode-bilingual" class="hidden peer" type="radio" name="mode" value="Bilingual">
      <label for="mode-bilingual" class="peer-checked:bg-emerald-800 peer-checked:text-white cursor-pointer text-sm border rounded-full px-4 py-2 bg-white">Bilingual</label>
    </div>

    <!-- Chat Card -->
    <section class="bg-white border rounded-2xl shadow-sm">
      <!-- Greeting / AI Intro -->
      <div class="px-6 pt-6">
        <div id="intro" class="chat-bubble chat-ai">
Hi there! 👋 I’m NeuroMed—your medical-summary companion. Ask about results, meds, or next steps—I'll explain with clarity and care.
        </div>
      </div>

      <!-- Chat window -->
      <div id="chatWindow" class="px-6 pb-4 pt-2 max-h-[50vh] overflow-y-auto"></div>

      <!-- Medical suggestion chips -->
      <div class="px-6 pb-3 flex flex-wrap gap-2">
        <button class="chip px-3 py-1.5 rounded-full text-sm hover:bg-slate-50 suggestion">
          Summarize this ER discharge note for a caregiver.
        </button>
        <button class="chip px-3 py-1.5 rounded-full text-sm hover:bg-slate-50 suggestion">
          Explain these lab results (CBC, CMP) in simple terms.
        </button>
        <button class="chip px-3 py-1.5 rounded-full text-sm hover:bg-slate-50 suggestion">
          Turn these prescriptions into a daily medication schedule.
        </button>
        <button class="chip px-3 py-1.5 rounded-full text-sm hover:bg-slate-50 suggestion">
          Draft questions to ask my doctor about this diagnosis.
        </button>
        <button class="chip px-3 py-1.5 rounded-full text-sm hover:bg-slate-50 suggestion">
          Translate this summary to Taglish for my lola.
        </button>
      </div>

      <!-- Composer (with Upload on the LEFT) -->
      <div class="px-4 pb-5">
        <div class="flex items-center gap-2 border rounded-xl px-2 py-2">
          <!-- Upload button -->
          <input id="fileInput" type="file" class="hidden" accept=".pdf,.docx,.txt,.jpg,.jpeg,.png"/>
          <button id="uploadBtn" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center" title="Upload a record">
            <i class="fa-solid fa-paperclip"></i>
          </button>

          <!-- Optional selected file pill -->
          <span id="filePill" class="hidden text-xs bg-slate-100 border rounded-full px-2 py-1 mr-1"></span>

          <!-- Text input -->
          <input
            id="chatInput"
            class="flex-1 px-3 py-2 rounded-md focus:outline-none"
            placeholder="Type a message..."
            autocomplete="off"
          />
          <button id="micBtn" class="w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center" title="Dictate">
            <i class="fa-solid fa-microphone"></i>
          </button>
          <button id="sendBtn" class="w-16 h-10 rounded-xl bg-black text-white hover:bg-slate-900 flex items-center justify-center" title="Send">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
        <p class="mt-1 text-[11px] text-slate-500">Tip: Attach a medical record (PDF/DOCX/images) to get a richer summary.</p>
      </div>
    </section>
  </main>

  <!-- Sign-up gate modal (shown for guests on first send) -->
  <div id="signupGate" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-xl">
      <div class="flex items-center gap-2 mb-2">
        <i class="fa-regular fa-circle-question text-emerald-700"></i>
        <h3 class="text-xl font-semibold">Create an account to continue</h3>
      </div>
      <p class="text-sm text-slate-600 mb-5">
        You’re chatting as a guest. Please sign up (it’s quick!) to send your first message and save your conversations.
      </p>
      <div class="flex items-center justify-end gap-2">
        <button class="px-4 py-2 rounded-lg border" onclick="hideSignupGate()">Not now</button>
        <a href="/signup" class="px-4 py-2 rounded-lg bg-emerald-700 text-white hover:bg-emerald-800">Sign up</a>
      </div>
    </div>
  </div>

  <script>
    // ---------- Utilities
    function getCSRFToken(){
      const m=document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)'); return m?m.pop():'';
    }
    function appendBubble(message,isUser=false){
      const chatWindow=document.getElementById("chatWindow");
      const wrap=document.createElement("div"); wrap.className="w-full flex mb-3";
      const bubble=document.createElement("div"); bubble.className=`chat-bubble ${isUser?'chat-user':'chat-ai'}`;
      bubble.innerText=message; wrap.appendChild(bubble); chatWindow.appendChild(wrap);
      chatWindow.scrollTop=chatWindow.scrollHeight;
    }

    // ---------- Simple auth probe
    async function isAuthenticated(){
      try{
        const r=await fetch("/api/auth/status/",{credentials:"include"});
        if(!r.ok) return false; const j=await r.json(); return !!j.authenticated;
      }catch{return false;}
    }

    // ---------- UI wiring
    let firstSendAttempted=false;
    let attachedFile=null;

    document.addEventListener("DOMContentLoaded",()=>{
      document.querySelectorAll(".suggestion").forEach(btn=>{
        btn.addEventListener("click",()=>{
          document.getElementById("chatInput").value=btn.innerText.trim();
          document.getElementById("chatInput").focus();
        });
      });

      document.getElementById("chatInput").addEventListener("keydown",e=>{
        if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendChat(); }
      });
      document.getElementById("micBtn").addEventListener("click", startDictation);
      document.getElementById("sendBtn").addEventListener("click", sendChat);

      // Upload controls
      const fileInput=document.getElementById("fileInput");
      const filePill=document.getElementById("filePill");
      document.getElementById("uploadBtn").addEventListener("click",()=>fileInput.click());
      fileInput.addEventListener("change",(e)=>{
        attachedFile = e.target.files?.[0] || null;
        if(attachedFile){
          filePill.textContent = attachedFile.name;
          filePill.classList.remove("hidden");
        }else{
          filePill.classList.add("hidden");
        }
      });
    });

    // ---------- Send
    async function sendChat(){
      const input=document.getElementById("chatInput");
      const msg=(input.value||"").trim();
      const mode=document.querySelector('input[name="mode"]:checked')?.value || "Plain";
      if(!msg && !attachedFile) return;

      if(!firstSendAttempted){
        firstSendAttempted=true;
        const authed=await isAuthenticated();
        if(!authed){ showSignupGate(); return; }
      }

      if(msg) appendBubble(msg,true);
      input.value="";

      // typing indicator
      const chatWindow=document.getElementById("chatWindow");
      const typingWrap=document.createElement("div"); typingWrap.className="w-full flex mb-2";
      const typing=document.createElement("div"); typing.className="chat-bubble chat-ai text-slate-500 italic";
      typing.innerHTML='<i class="fa-solid fa-spinner pulse mr-2"></i>Thinking…';
      typingWrap.appendChild(typing); chatWindow.appendChild(typingWrap);
      chatWindow.scrollTop=chatWindow.scrollHeight;

      // payload
      const fd=new FormData();
      if(msg) fd.append("message", msg);
      fd.append("mode", mode);
      if(attachedFile) fd.append("file", attachedFile);

      try{
        const res=await fetch("/api/send-chat/",{
          method:"POST",
          headers:{ "X-CSRFToken": getCSRFToken() },
          body: fd,
          credentials:"include"
        });
        const data=await res.json();
        typing.classList.remove("italic","text-slate-500");
        typing.classList.add("text-slate-800");
        typing.innerText=data.reply || "⚠️ No reply received.";
      }catch(e){
        typing.classList.remove("italic","text-slate-500");
        typing.classList.add("text-red-700","bg-red-100");
        typing.innerText="❌ Error getting a response.";
      }finally{
        // clear selection after send
        const fileInput=document.getElementById("fileInput");
        const filePill=document.getElementById("filePill");
        fileInput.value=""; attachedFile=null; filePill.classList.add("hidden");
      }
    }

    // ---------- Speech
    function startDictation(){
      if(!('webkitSpeechRecognition' in window)){ alert("Speech recognition works best in Chrome."); return; }
      const rec=new webkitSpeechRecognition(); rec.lang="en-US";
      rec.onresult=(e)=>{ document.getElementById("chatInput").value=e.results[0][0].transcript; };
      rec.start();
    }

    // ---------- Gate modal
    function showSignupGate(){ const m=document.getElementById("signupGate"); m.classList.remove("hidden"); m.classList.add("flex"); }
    function hideSignupGate(){ const m=document.getElementById("signupGate"); m.classList.add("hidden"); m.classList.remove("flex"); }
  </script>
</body>
</html>
