<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NeuroMed.ai — Friendlier Chat</title>
  <link rel="manifest" href="/static/pwa/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/static/pwa/icons/apple-touch-icon-180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/pwa/icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/pwa/icons/favicon-16.png">
  <meta name="theme-color" content="#0f766e">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{
      --brand:#0b3b36;
      --font-scale: 1.125;              /* 18px base for readability */
      --line-scale: 1.08;
      --max-ch: 68ch;
      --tour-blur: 6px;
      --tour-wash: rgba(255,255,255,.26);
      --tour-dim:  rgba(2,6,23,.18);
    }
    html{ font-size: calc(16px * var(--font-scale)); }
    body{ background:#f6f8fb; line-height: calc(1.55 * var(--line-scale)); letter-spacing:.1px; }
    .easy-read{ --font-scale: 1.2; --line-scale: 1.12; } /* toggle-able bump */
    .hc *{ color:#000 !important; border-color:#0003 !important }
    .hc .chat-ai{ background:#fff !important; }
    .hc .chat-user{ background:#111 !important; color:#fff !important; }

    .chip{ border:1px solid rgba(0,0,0,.08); }
    .chat-bubble{
      border-radius:18px; padding:12px 16px; line-height:1.7;
      box-shadow:0 1px 4px rgba(0,0,0,.04); max-width:80%;
      white-space:pre-wrap; word-break:break-word; font-size:1.05rem;
    }
    @media (min-width:640px){ .chat-bubble{ max-width: var(--max-ch); } }
    .chat-user{ background:#0f172a; color:#fff; border-bottom-right-radius:6px!important; margin-left:auto }
    .chat-ai{ background:#ffffff; color:#111827; border:1px solid rgba(0,0,0,.05); border-bottom-left-radius:6px!important; margin-right:auto }

    .pulse{ animation:pulse 1.1s ease-in-out infinite }
    @keyframes pulse{ 0%,100%{opacity:.55} 50%{opacity:1} }
    .dotty::after{ content:""; display:inline-block; width:1.2ch; text-align:left; animation:ellipsis 1.2s steps(4,end) infinite }
    @keyframes ellipsis{ 0%{content:""} 25%{content:"."} 50%{content:".."} 75%{content:"..."} 100%{content:""} }

    .mode-badge{display:inline-flex;align-items:center;gap:.5rem;font-size:.75rem;border-radius:999px;padding:.25rem .6rem;border:1px solid rgba(0,0,0,.08);background:#fff}
    .toast{transform:translateY(-10px);opacity:0;transition:transform .2s ease,opacity .2s ease}
    .toast.show{transform:translateY(0);opacity:1}
    .shimmer{position:relative;overflow:hidden}
    .shimmer::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.7) 50%,rgba(255,255,255,0) 100%);transform:translateX(-100%);animation:shimmer 900ms ease forwards}
    @keyframes shimmer{to{transform:translateX(100%)}}

    #modeGroup{ gap:.6rem; }
    #modeGroup button{ min-height:42px; padding:.6rem .75rem; letter-spacing:.1px; }
    .suggestion{ padding:.6rem .8rem; font-size:.98rem; }
    #suggestionsList.compact > .suggestion:nth-child(n+4){ display:none; }

    #uploadBtn,#micBtn,#sendBtn{ min-width:44px; min-height:44px; }
    :focus-visible{ outline:3px solid #10b981; outline-offset:2px; border-radius:.5rem; }

    /* dropzone clearer for elders */
    .dropwrap{ border:2px dashed #cbd5e1; border-radius:16px; background:#fff; }

    @media (prefers-reduced-motion: reduce){
      .pulse, .dotty::after{ animation:none!important; }
      .shimmer::after{ animation:none!important; }
      * { scroll-behavior:auto; }
    }

    /* Spotlight Tour (opt-in) */
    .nm-tour-overlay{ position:fixed; inset:0; z-index:10050; pointer-events:auto; }
    .nm-tour-dim{ position:absolute; inset:0; pointer-events:auto; }
    .nm-slab{ position:absolute; background: var(--tour-wash);
      backdrop-filter: blur(var(--tour-blur)) saturate(110%);
      -webkit-backdrop-filter: blur(var(--tour-blur)) saturate(110%); }
    .nm-tour-hole{ position:absolute; border-radius:12px; border:2px solid rgba(255,255,255,.95);
      box-shadow:0 0 0 1px rgba(2,6,23,.05), 0 8px 28px rgba(2,6,23,.22), 0 0 0 200vmax var(--tour-dim);
      background:transparent; pointer-events:none; transition: top .18s ease, left .18s ease, width .18s ease, height .18s ease; }
    .nm-tour-pop{
      position:fixed; z-index:10051; max-width:min(92vw, 340px); border-radius:16px;
      background: rgba(255,255,255,.94); border:1px solid rgba(2,6,23,.06);
      box-shadow:0 24px 48px rgba(2,6,23,.22); padding:14px; }
    #nmTitle{ font-weight:700; font-size:1.05rem; color:#0f172a; margin-bottom:6px; }
    #nmBody{ color:#475569; font-size:.95rem; line-height:1.55; }
    #nmPop .btn{ padding:.45rem .85rem; border-radius:10px; font-weight:600; }
    #nmPop .btn-text{ color:#475569; background:transparent; border:1px solid rgba(2,6,23,.08); }
    #nmPop .btn-primary{ color:#fff; background:#0f766e; border:1px solid #0d6e67; }
    .nm-tour-sr-only{ position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    #nmTourHelp{ position:fixed; left:12px; bottom:12px; z-index:10052; width:44px; height:44px; border-radius:9999px; display:grid; place-items:center; font-weight:700; background:#0f172a; color:#fff; box-shadow:0 8px 20px rgba(2,6,23,.22); }
    #nmTourHelp:hover{ filter:brightness(1.05); }

    /* action bar buttons start disabled */
    .is-disabled{ opacity:.5; pointer-events:none }

    /* --- Mobile-only tweaks --- */
@media (max-width: 767px){
  /* hide the 6-tone button grid on mobile */
  #modeGroup{ display:none !important; }

  /* show the compact tone selector on mobile only */
  #modeSelectWrap{ display:block !important; }

  /* slightly tighten paddings in the composer */
  #chatWindow{ max-height: 60vh; }
}

/* desktop/tablet keep current look */
@media (min-width: 768px){
  #modeSelectWrap{ display:none !important; }
}


/* Airier mode chips */
.mode-chip{
  display:inline-flex; align-items:center; gap:.5rem;
  padding:.6rem .85rem;
  border:1px solid rgba(2,6,23,.08);
  background:#fff; border-radius:.75rem;
  box-shadow:0 1px 2px rgba(2,6,23,.03);
  transition:box-shadow .15s ease, transform .06s ease;
  white-space:nowrap;
}
.mode-chip:hover{ box-shadow:0 6px 20px rgba(2,6,23,.08); }
.mode-chip:active{ transform:translateY(1px); }
.mode-chip i{ min-width:1em; }

/* Roomier grid that wraps instead of cramming 6 per row */
#modeGroup{
  gap:.75rem;                /* more breathing room */
}
@media (min-width: 640px){   /* sm: */
  #modeGroup{ gap:.9rem; }
}

  </style>
</head>
<body class="text-slate-800">
  <!-- Top bar -->
  <!-- Top bar -->
  <header class="w-full border-b bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-5 py-3 flex items-center justify-between">
      <!-- Brand -->
      <a href="/" class="flex items-center gap-3">
        <i class="fa-solid fa-heart-pulse text-teal-600 text-xl" aria-hidden="true"></i>
        <span class="font-semibold tracking-tight">NeuroMed.ai</span>
      </a>

      <!-- Desktop controls -->
      <div class="hidden md:flex items-center gap-2">
        <button id="fontMinus" class="px-3 py-1 rounded-full border" title="Smaller">A−</button>
        <button id="fontPlus"  class="px-3 py-1 rounded-full border" title="Larger">A＋</button>
        <button id="easyReadBtn" class="px-3 py-1 rounded-full border" aria-pressed="false" title="Easy Read">Easy</button>
        <button id="highContrast" class="px-3 py-1 rounded-full border" aria-pressed="false" title="High contrast">Contrast</button>
        <a href="/signup" class="ml-2 text-slate-600 hover:text-slate-900">Sign up</a>
        <a href="/login" class="rounded-full px-3 py-1.5 border hover:bg-slate-50">Log in</a>
      </div>

      <!-- Mobile hamburger -->
      <button id="nmMenuBtn"
              class="md:hidden inline-flex items-center justify-center rounded-lg p-2 border border-slate-200 text-slate-700 hover:bg-slate-50"
              aria-label="Open menu" aria-controls="nmMobileMenu" aria-expanded="false">
        <svg id="nmIconOpen" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-width="2" stroke-linecap="round" d="M4 7h16M4 12h16M4 17h16"/>
        </svg>
        <svg id="nmIconClose" class="h-5 w-5 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-width="2" stroke-linecap="round" d="M6 6l12 12M18 6l-12 12"/>
        </svg>
      </button>
    </div>

    <!-- Mobile menu panel -->
    <div id="nmMobileMenu" class="md:hidden hidden border-t bg-white/95 backdrop-blur">
      <div class="max-w-6xl mx-auto px-5 py-3 grid gap-3">
        <div class="flex items-center gap-2">
          <button id="mFontMinus" class="px-3 py-1 rounded-full border w-full">A−</button>
          <button id="mFontPlus"  class="px-3 py-1 rounded-full border w-full">A＋</button>
          <button id="mEasyReadBtn"  class="px-3 py-1 rounded-full border w-full" aria-pressed="false">Easy</button>
          <button id="mHighContrast" class="px-3 py-1 rounded-full border w-full" aria-pressed="false">Contrast</button>
        </div>
        <div class="flex items-center gap-2">
          <a href="/signup" class="flex-1 text-center rounded-full px-3 py-2 border hover:bg-slate-50">Sign up</a>
          <a href="/login"  class="flex-1 text-center rounded-full px-3 py-2 border hover:bg-slate-50">Log in</a>
        </div>
      </div>
    </div>
  </header>


  <!-- Main -->
  <main class="max-w-4xl mx-auto px-4 md:px-5 pt-6 md:pt-10 pb-24">
    <!-- Hero (shortened) -->
    <!-- Hero intro -->
    <div id="heroIntro" class="text-center">
      <h1 class="text-3xl md:text-5xl font-bold tracking-tight">
        Make medical papers easy.
      </h1>
      <p class="mt-2 text-slate-600 max-w-2xl mx-auto">
        Upload a note, lab, or script — get clear next steps.
      </p>
      <div class="mt-4 flex flex-col sm:flex-row gap-3 justify-center">
        <button id="ctaUpload" class="px-5 py-3 rounded-xl bg-teal-600 text-white hover:bg-teal-700">
          Upload a file
        </button>
        <button id="ctaDemo" class="px-5 py-3 rounded-xl border hover:bg-slate-50">
          Try a quick demo
        </button>
      </div>
    </div>


    <!-- Mode switcher (kept, tighter) -->
<div class="mt-6">
  <div class="text-center text-sm text-slate-600 mb-3">Choose a mode</div>

  <!-- auto-fit grid = any number of modes, nicely wrapped -->
  <div id="modeGroup"
       class="mx-auto max-w-4xl grid grid-cols-[repeat(auto-fit,minmax(160px,1fr))] gap-3">
    <button data-mode="Caregiver" class="mode-chip justify-center text-sm" aria-pressed="true">
      <i class="fa-solid fa-hands-holding-child text-amber-700"></i><span>Caregiver</span>
    </button>
    <button data-mode="PlainClinical" class="mode-chip justify-center text-sm" aria-pressed="false">
      <i class="fa-regular fa-message text-teal-600"></i><span>Balanced</span>
    </button>
    <button data-mode="Clinical" class="mode-chip justify-center text-sm" aria-pressed="false">
      <i class="fa-solid fa-stethoscope text-slate-800"></i><span>Clinical</span>
    </button>
    <button data-mode="Faith" class="mode-chip justify-center text-sm" aria-pressed="false">
      <i class="fa-solid fa-hands-praying text-indigo-700"></i><span>Faith</span>
    </button>
    <button data-mode="Bilingual" class="mode-chip justify-center text-sm" aria-pressed="false">
      <i class="fa-solid fa-language text-teal-700"></i><span>Bilingual</span>
    </button>
    <button data-mode="Geriatric" class="mode-chip justify-center text-sm" aria-pressed="false">
      <i class="fa-solid fa-person-cane text-emerald-700"></i><span>Geriatric</span>
    </button>
    <!-- New / extra category fits naturally -->
    <button data-mode="EmotionalSupport" class="mode-chip justify-center text-sm" aria-pressed="false">
      <i class="fa-solid fa-heart text-rose-700"></i><span>Emotional Support</span>
    </button>
  </div>
</div>



    <!-- Mobile tone selector (compact) -->
<!-- Mobile tone picker -->
<div id="modeSelectWrap" class="mt-3 hidden md:hidden">
  <!-- trigger -->
  <button id="modePickerBtn"
          class="w-full rounded-xl border bg-white px-3 py-2.5 flex items-center justify-between shadow-sm active:scale-[.99] transition">
    <span class="flex items-center gap-2">
      <i id="modePickerIcon" class="fa-regular fa-message text-teal-600"></i>
      <span id="modePickerLabel" class="text-sm font-medium">Caregiver</span>
    </span>
    <span class="text-slate-400"><i class="fa-solid fa-sliders"></i></span>
  </button>

  <!-- accessible, hidden fallback -->
  <select id="modeSelect" class="sr-only" aria-hidden="true" tabindex="-1">
    <option value="Caregiver">Caregiver</option>
    <option value="PlainClinical">Balanced</option>
    <option value="Clinical">Clinical</option>
    <option value="Faith">Faith</option>
    <option value="Bilingual">Bilingual</option>
    <option value="Geriatric">Geriatric</option>
    <option value="EmotionalSupport">Emotional Support</option>

  </select>

  <!-- bottom sheet -->
  <div id="modeSheet" class="fixed inset-0 z-[70] hidden">
    <!-- backdrop -->
    <button id="modeSheetBackdrop" class="absolute inset-0 bg-black/40 backdrop-blur-[2px]"></button>

    <!-- sheet panel -->
    <div id="modeSheetPanel"
         class="absolute inset-x-0 bottom-0 rounded-t-2xl bg-white border-t shadow-2xl translate-y-full transition-transform duration-200 ease-out">
      <div class="px-4 pt-3 pb-2 flex items-center justify-between">
        <div class="text-sm font-semibold">Choose a tone</div>
        <button id="modeSheetClose" class="p-2 text-slate-500"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="divide-y">
        <!-- option -->
        <button class="w-full px-4 py-3 flex items-center gap-3 hover:bg-slate-50 text-left"
                data-mode="Caregiver">
          <i class="fa-solid fa-hands-holding-child text-amber-700"></i>
          <div class="min-w-0">
            <div class="text-[15px] font-medium">Caregiver</div>
            <div class="text-xs text-slate-500 truncate">Gentle, practical steps</div>
          </div>
          <i class="fa-solid fa-check ml-auto text-emerald-600 hidden"></i>
        </button>

        <button class="w-full px-4 py-3 flex items-center gap-3 hover:bg-slate-50 text-left"
                data-mode="PlainClinical">
          <i class="fa-regular fa-message text-teal-600"></i>
          <div class="min-w-0">
            <div class="text-[15px] font-medium">Balanced</div>
            <div class="text-xs text-slate-500 truncate">Clear + calm explanations</div>
          </div>
          <i class="fa-solid fa-check ml-auto text-emerald-600 hidden"></i>
        </button>

        <button class="w-full px-4 py-3 flex items-center gap-3 hover:bg-slate-50 text-left"
                data-mode="Clinical">
          <i class="fa-solid fa-stethoscope text-slate-800"></i>
          <div class="min-w-0">
            <div class="text-[15px] font-medium">Clinical</div>
            <div class="text-xs text-slate-500 truncate">Concise & technical</div>
          </div>
          <i class="fa-solid fa-check ml-auto text-emerald-600 hidden"></i>
        </button>

        <button class="w-full px-4 py-3 flex items-center gap-3 hover:bg-slate-50 text-left"
                data-mode="Faith">
          <i class="fa-solid fa-hands-praying text-indigo-700"></i>
          <div class="min-w-0">
            <div class="text-[15px] font-medium">Faith</div>
            <div class="text-xs text-slate-500 truncate">Guidance with encouragement</div>
          </div>
          <i class="fa-solid fa-check ml-auto text-emerald-600 hidden"></i>
        </button>

        <button class="w-full px-4 py-3 flex items-center gap-3 hover:bg-slate-50 text-left"
                data-mode="Bilingual">
          <i class="fa-solid fa-language text-teal-700"></i>
          <div class="min-w-0">
            <div class="text-[15px] font-medium">Bilingual</div>
            <div class="text-xs text-slate-500 truncate">Tagalog + English</div>
          </div>
          <i class="fa-solid fa-check ml-auto text-emerald-600 hidden"></i>
        </button>

        <button class="w-full px-4 py-3 flex items-center gap-3 hover:bg-slate-50 text-left"
                data-mode="Geriatric">
          <i class="fa-solid fa-person-cane text-emerald-700"></i>
          <div class="min-w-0">
            <div class="text-[15px] font-medium">Geriatric</div>
            <div class="text-xs text-slate-500 truncate">Larger text, simpler steps</div>
          </div>
          <i class="fa-solid fa-check ml-auto text-emerald-600 hidden"></i>
        </button>

        <button class="w-full px-4 py-3 flex items-center gap-3 hover:bg-slate-50 text-left"
              data-mode="EmotionalSupport">
        <i class="fa-solid fa-heart text-rose-700"></i>
        <div class="min-w-0">
          <div class="text-[15px] font-medium">Emotional Support</div>
          <div class="text-xs text-slate-500 truncate">Validating, calm & gentle</div>
        </div>
        <i class="fa-solid fa-check ml-auto text-emerald-600 hidden"></i>
      </button>

      </div>

      <div class="p-4">
        <button id="modeSheetDone" class="w-full rounded-xl bg-black text-white py-2.5">Done</button>
      </div>
    </div>
  </div>
</div>



    <!-- Card -->
    <section class="mt-6 bg-white border rounded-2xl shadow-sm overflow-hidden">
      <div class="px-5 md:px-6 pt-5 flex items-start justify-between gap-3">
        <div id="intro" class="chat-bubble chat-ai flex-1">
Hi! Upload a file or ask a question. I’ll turn it into clear next steps.
        </div>
        <span id="modeBadge" class="mode-badge text-slate-600" title="Current tone">
          <i class="fa-regular fa-message"></i><span>Caregiver</span>
        </span>
      </div>

      <!-- Chat area -->
      <div id="chatWindow" class="px-5 md:px-6 pb-3 pt-3 max-h-[55vh] overflow-y-auto scroll-smooth"></div>

      <!-- Suggestions (trimmed) -->
      <div class="px-5 md:px-6 pb-3">
        <div id="suggestionsList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 compact" role="list">
          <button class="chip w-full text-left px-3 py-2 rounded-full text-sm hover:bg-slate-50 suggestion" role="listitem"><i class="fa-regular fa-hospital mr-2"></i>Simplify this ER discharge for my family</button>
          <button class="chip w-full text-left px-3 py-2 rounded-full text-sm hover:bg-slate-50 suggestion" role="listitem"><i class="fa-solid fa-vial-circle-check mr-2"></i>Explain these labs in plain English</button>
          <button class="chip w-full text-left px-3 py-2 rounded-full text-sm hover:bg-slate-50 suggestion" role="listitem"><i class="fa-solid fa-pills mr-2"></i>Make a daily medication schedule</button>
          <button class="chip w-full text-left px-3 py-2 rounded-full text-sm hover:bg-slate-50 suggestion" role="listitem"><i class="fa-regular fa-clipboard mr-2"></i>Questions to ask my doctor</button>
          <button class="chip w-full text-left px-3 py-2 rounded-full text-sm hover:bg-slate-50 suggestion" role="listitem"><i class="fa-solid fa-language mr-2"></i>Translate this for my lola (Taglish)</button>
        </div>
        <div class="mt-2 text-center">
          <button id="toggleSuggestions" class="text-sm text-slate-600 underline" type="button">Show more</button>
        </div>
      </div>

      <!-- Composer (cleaned, dashed dropzone) -->
      <div class="border-t bg-slate-50/50">
        <div class="px-3 md:px-4 py-3 md:py-4">
          <div class="dropwrap p-3 md:p-3.5">
            <div id="dropZone" class="relative flex items-end gap-2">
              <input id="fileInput" type="file" class="hidden" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.heic,.webp" />
              <button id="uploadBtn" class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-slate-100 hover:bg-slate-200 grid place-items-center" title="Upload a record" aria-label="Upload a medical record">
                <i class="fa-solid fa-paperclip"></i>
              </button>

              <div class="flex-1 min-w-0">
                <textarea id="chatInput" rows="1" class="w-full resize-none px-3 py-2 outline-none placeholder-slate-400" placeholder="Type your question… (Shift+Enter for new line)" aria-label="Message"></textarea>
                <div class="flex flex-wrap gap-2 mt-1" id="fileChips"></div>
              </div>

              <div class="flex items-center gap-2">
                <button id="micBtn" class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-slate-100 hover:bg-slate-200 grid place-items-center" title="Dictate" aria-label="Dictate">
                  <i class="fa-solid fa-microphone"></i>
                </button>
                <button id="sendBtn" class="w-16 h-9 md:h-10 rounded-xl bg-black text-white hover:bg-slate-900 grid place-items-center disabled:opacity-40 disabled:cursor-not-allowed" title="Send" aria-label="Send" disabled>
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>

              <div id="dropHint" class="pointer-events-none hidden absolute inset-0 rounded-xl ring-2 ring-emerald-600/50 bg-emerald-50/50 grid place-items-center text-emerald-900 text-sm font-medium">
                Drop your file to attach
              </div>
            </div>
          </div>

          <!-- gentle line; removed broken /how-to-share link -->
          <div class="px-1 pt-2 text-[12px] text-slate-500">
            Educational use only.
          </div>
        </div>
      </div>
    </section>

    <!-- Actions (start disabled) -->
    
  </main>

  <!-- Toast -->
  <div id="toast" class="toast fixed top-4 right-4 z-[60] hidden">
    <div class="bg-white border shadow-lg rounded-xl px-3 py-2 text-sm flex items-center gap-2">
      <i id="toastIcon" class="fa-regular fa-message text-teal-600" aria-hidden="true"></i>
      <span id="toastText" class="text-slate-800">Mode set</span>
    </div>
  </div>

  <!-- Help button for tour (opt-in) -->
  <button id="nmTourHelp" title="Quick tour">?</button>

  <!-- Post-result invite (kept) -->
  <div id="postResultInvite" class="fixed bottom-4 right-4 z-[60] hidden">
    <div class="bg-white border shadow-xl rounded-2xl p-4 max-w-sm">
      <div class="font-semibold">Like this summary?</div>
      <p class="text-sm text-slate-600 mt-1">Create a free account to keep your history and download PDFs.</p>
      <div class="mt-3 flex gap-2">
        <a href="/signup" class="px-3 py-1.5 rounded-lg bg-teal-600 text-white text-sm">Create free account</a>
        <button class="px-3 py-1.5 rounded-lg border text-sm" onclick="document.getElementById('postResultInvite').classList.add('hidden')">Not now</button>
      </div>
    </div>
  </div>

  <script>
    // ---------------- Utilities
    function getCSRFToken(){ const m=document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)'); return m?m.pop():''; }
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function track(ev, data={}){ try{ navigator.sendBeacon('/api/track', new Blob([JSON.stringify({ ev, ...data })], {type:'application/json'})); }catch{} }

    function appendAttachmentBubble(fileList){
  const chatWindow = document.getElementById('chatWindow');

  const wrap = document.createElement('div');
  wrap.className = 'w-full flex mb-3';

  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble chat-user';   // same look as user text

  const grid = document.createElement('div');
  grid.className = 'grid grid-cols-2 gap-2';

  const isImg = f => (f.type?.startsWith('image/') || /\.(png|jpe?g|webp)$/i.test(f.name));

  fileList.forEach(f => {
    if (isImg(f)) {
      const url = URL.createObjectURL(f);
      const img = document.createElement('img');
      img.src = url;
      img.alt = f.name;
      img.className = 'max-w-[160px] max-h-[120px] rounded-lg object-cover border';
      img.onload = () => URL.revokeObjectURL(url);
      grid.appendChild(img);
    } else {
      const row = document.createElement('div');
      row.className = 'flex items-center gap-2 rounded-md border bg-white/90 px-2 py-1 text-sm';
      row.innerHTML = `<i class="${iconFor(f.name)}"></i><span class="truncate max-w-[180px]" title="${escapeHtml(f.name)}">${escapeHtml(f.name)}</span>`;
      grid.appendChild(row);
    }
  });

  // Title + grid
  const title = document.createElement('div');
  title.className = 'text-[13px] mb-1 opacity-90';
  title.textContent = fileList.length > 1 ? 'You sent attachments' : 'You sent an attachment';

  bubble.appendChild(title);
  bubble.appendChild(grid);

  const meta = document.createElement('div');
  meta.className = 'text-[11px] text-slate-300 mt-1 text-right ml-auto pr-1';
  meta.innerText = new Intl.DateTimeFormat(undefined,{ hour:'2-digit', minute:'2-digit' }).format(new Date());

  const col = document.createElement('div');
  col.className = 'flex flex-col items-end ml-auto';
  col.appendChild(bubble);
  col.appendChild(meta);

  wrap.appendChild(col);
  chatWindow.appendChild(wrap);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function appendBubble({ message, isUser=false, timestamp=new Date() }) {
  const chatWindow = document.getElementById('chatWindow');

  const wrap = document.createElement('div');
  wrap.className = 'w-full flex mb-3';

  const bubble = document.createElement('div');
  bubble.className = `chat-bubble ${isUser ? 'chat-user' : 'chat-ai'}`;
  bubble.innerText = message;

  const meta = document.createElement('div');
  meta.className = 'text-[11px] text-slate-400 mt-1 ' + (isUser ? 'text-right ml-auto pr-1' : 'pl-1');
  meta.innerText = new Intl.DateTimeFormat(undefined,{ hour:'2-digit', minute:'2-digit' }).format(timestamp);

  const col = document.createElement('div');
  col.className = 'flex flex-col ' + (isUser ? 'items-end ml-auto' : 'items-start mr-auto');
  col.appendChild(bubble);
  col.appendChild(meta);

  wrap.appendChild(col);
  chatWindow.appendChild(wrap);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}


    function setSendDisabled(disabled){ $('#sendBtn').disabled = disabled; }

    function loadMode(){ return localStorage.getItem('nm_mode') || 'Caregiver'; }
    function saveMode(m){ localStorage.setItem('nm_mode', m); }

    async function isAuthenticated(){
      try{
        const r=await fetch('/api/auth/status/',{ credentials:'include' });
        if(!r.ok) return false; const j=await r.json(); return !!j.authenticated;
      }catch{ return false; }
    }

    let firstSendAttempted = false;
    let files = [];
    let abortController = null;
    let showGateAfterResponse = false;
    let guestTurnsUsed = parseInt(localStorage.getItem('nm_guest_turns') || '0', 10);
    const GUEST_TURNS_LIMIT = 3;

    // Readability & a11y
    (function(){
      const root = document.documentElement;
      const body = document.body;
      $('#fontMinus')?.addEventListener('click', () => {
        const curr = parseFloat(getComputedStyle(root).getPropertyValue('font-size')) || 18;
        root.style.setProperty('font-size', Math.max(16, curr - 1) + 'px');
      });
      $('#fontPlus')?.addEventListener('click', () => {
        const curr = parseFloat(getComputedStyle(root).getPropertyValue('font-size')) || 18;
        root.style.setProperty('font-size', Math.min(22, curr + 1) + 'px');
      });
      $('#easyReadBtn')?.addEventListener('click', () => {
        body.classList.toggle('easy-read');
        $('#easyReadBtn').setAttribute('aria-pressed', body.classList.contains('easy-read') ? 'true' : 'false');
      });
      $('#highContrast')?.addEventListener('click', ()=> {
        body.classList.toggle('hc');
        $('#highContrast').setAttribute('aria-pressed', body.classList.contains('hc') ? 'true' : 'false');
      });
    })();

    // Suggestions toggle
    (function(){
      const list = $('#suggestionsList');
      const toggle = $('#toggleSuggestions');
      if (list && toggle){
        let expanded = false;
        const update = () => {
          if (expanded){ list.classList.remove('compact'); toggle.textContent = 'Show fewer'; }
          else { list.classList.add('compact'); toggle.textContent = 'Show more'; }
        };
        toggle.addEventListener('click', () => { expanded = !expanded; update(); });
        update();
      }
    })();

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      // Mode buttons
      const savedMode = loadMode();
      $$('#modeGroup button').forEach(btn => {
        const mode = btn.dataset.mode;
        if(mode === savedMode){ selectMode(btn); }
        btn.addEventListener('click', () => selectMode(btn));
      });

      // Suggestions -> input
      $$('.suggestion').forEach(btn => btn.addEventListener('click', () => {
        $('#chatInput').value = btn.innerText.trim(); autosize(); toggleSend(); $('#chatInput').focus();
      }));

      // Input events
      $('#chatInput').addEventListener('input', () => { autosize(); toggleSend(); });
      $('#chatInput').addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }});
      $('#sendBtn').addEventListener('click', sendChat);

      // Upload controls
      $('#ctaUpload').addEventListener('click', () => $('#fileInput').click());
      $('#uploadBtn').addEventListener('click', () => $('#fileInput').click());
      $('#fileInput').addEventListener('change', (e) => { if(e.target.files?.length){ for(const f of e.target.files){ addFile(f); } e.target.value=''; } });

      // Drag & drop
      const dz = $('#dropZone');
      ;['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, (e)=>{ e.preventDefault(); $('#dropHint').classList.remove('hidden'); }));
      ;['dragleave','drop'].forEach(evt => dz.addEventListener(evt, (e)=>{ e.preventDefault(); if(evt==='drop'){ const dt=e.dataTransfer; if(dt?.files?.length){ for(const f of dt.files){ addFile(f); } } } $('#dropHint').classList.add('hidden'); }));

      // Paste image/file
      document.addEventListener('paste', (e)=>{ const items=e.clipboardData?.items || []; for(const it of items){ if(it.kind==='file'){ addFile(it.getAsFile()); } } });

      // Mic
      $('#micBtn').addEventListener('click', startDictation);

      autosize(); toggleSend();
      setTimeout(()=>$('#chatInput').focus(), 200);

      // Help button triggers tour on demand (no auto unless first run)
      startChatTourAuto();

      showAuthNudgeIfGuest();

      // Actions
      $('#btnPdf')?.addEventListener('click', ()=> { if (!hasSummary()) return; window.open('/api/export/pdf/latest', '_blank'); track('export_clicked', {type:'pdf'}); });
      $('#btnShare')?.addEventListener('click', doShareLink);
      document.querySelectorAll('#langSwitch [data-lang]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const lang = btn.dataset.lang;
          const r = await fetch('/api/translate/latest?lang='+encodeURIComponent(lang), { credentials:'include' });
          const j = await r.json();
          if(j?.translation){ appendBubble({ message: j.translation, isUser:false }); }
        });
      });
    });

    function selectMode(btn){
      $$('#modeGroup button').forEach(b => { b.setAttribute('aria-pressed','false'); b.classList.remove('ring','ring-emerald-600'); });
      btn.setAttribute('aria-pressed','true'); btn.classList.add('ring','ring-emerald-600');
      const mode = btn.dataset.mode;
      saveMode(mode);
      applyModeUI(mode);
      track('mode_chosen', { mode });
    }

    const MODE_META = {
      'PlainClinical': { icon:'fa-regular fa-message', color:'text-teal-600', intro:"Balanced mode on. Clear explanations; add clinician notes when helpful." },
      'Caregiver':     { icon:'fa-solid fa-hands-holding-child', color:'text-amber-700', intro:"Caregiver mode on. Gentle, practical steps." },
      'Faith':         { icon:'fa-solid fa-hands-praying', color:'text-indigo-700', intro:"Faith mode on. Clear guidance with encouragement." },
      'Clinical':      { icon:'fa-solid fa-stethoscope', color:'text-slate-800', intro:"Clinical mode on. Concise and technical." },
      'Bilingual':     { icon:'fa-solid fa-language', color:'text-teal-700', intro:"Bilingual mode on. Tagalog + English." },
      'Geriatric':     { icon:'fa-solid fa-person-cane', color:'text-emerald-700', intro:"Geriatric mode on. Larger text and simpler steps." },
      'EmotionalSupport': { icon:'fa-solid fa-heart', color:'text-rose-700', intro:"Emotional Support mode on. Validating, calm, and actionably gentle." }
    };

    function applyModeUI(mode){
      const meta = MODE_META[mode] || MODE_META['Caregiver'];
      const badge = $('#modeBadge');
      badge.querySelector('i').className = meta.icon + ' ' + meta.color;
      badge.querySelector('span').textContent =
  mode === 'PlainClinical' ? 'Balanced' :
  mode === 'EmotionalSupport' ? 'Emotional Support' :
  mode;
      const intro = $('#intro');
      intro.classList.add('shimmer');
      setTimeout(()=>{ intro.textContent = meta.intro; intro.classList.remove('shimmer'); }, 220);
      showToast(`${mode} mode applied` , meta.icon, meta.color);

      if (mode === 'Geriatric'){
        document.body.classList.add('easy-read');
      }
    }

    function showToast(text, icon, color){
      const t = $('#toast'); const ti = $('#toastIcon'); const tt = $('#toastText');
      ti.className = icon + ' ' + color; tt.textContent = text;
      t.classList.remove('hidden'); void t.offsetWidth; t.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.classList.add('hidden'), 220); }, 1500);
    }

    function iconFor(name){
      const n = name.toLowerCase();
      if(n.endsWith('.pdf')) return 'fa-regular fa-file-pdf';
      if(n.endsWith('.doc')||n.endsWith('.docx')) return 'fa-regular fa-file-word';
      if(n.endsWith('.jpg')||n.endsWith('.jpeg')||n.endsWith('.png')||n.endsWith('.heic')||n.endsWith('.webp')) return 'fa-regular fa-file-image';
      return 'fa-regular fa-file';
    }

    function addFile(file){
      if(!file) return;
      files = [file]; // single file to minimize confusion
      const chip = document.createElement('span');
      chip.className = 'text-xs bg-slate-100 border rounded-full px-2 py-1 inline-flex items-center gap-1';
      chip.innerHTML = `<i class="${iconFor(file.name)}"></i><span class="max-w-[12rem] truncate">${escapeHtml(file.name)}</span>`;
      const x = document.createElement('button'); x.className='ml-1 text-slate-500 hover:text-slate-800'; x.innerHTML='&times;'; x.setAttribute('aria-label','Remove attachment');
      x.addEventListener('click', ()=>{ files = []; chip.remove(); toggleSend(); });
      chip.appendChild(x);
      $('#fileChips').innerHTML = '';
      $('#fileChips').appendChild(chip);
      toggleSend();
      track('file_upload_started');
    }

    function escapeHtml(str){ return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    function autosize(){
      const ta = $('#chatInput');
      ta.style.height = 'auto';
      ta.style.height = Math.min(200, ta.scrollHeight) + 'px';
    }

    function toggleSend(){
      const hasText = ( $('#chatInput').value || '' ).trim().length > 0;
      const hasFile = files.length > 0;
      setSendDisabled(!(hasText || hasFile));
    }

    function hasSummary(){
      // enabled buttons mean we’ve produced at least one summary this session
      return !$('#btnPdf').classList.contains('is-disabled');
    }

    async function sendChat(){
  const msg  = (document.getElementById('chatInput').value || '').trim();
  const mode = loadMode();
  if(!msg && files.length===0) return;

  if(!firstSendAttempted){
    firstSendAttempted = true;
    const authed = await isAuthenticated();
    if(!authed){ showGateAfterResponse = true; }
  }

  // after rendering user message / attachments:
  if (window.innerWidth < 768) {
    // hide the intro prompt
    document.getElementById('intro')?.classList.add('hidden');

    // OPTIONAL: also collapse suggestions area on mobile to save space
    document.getElementById('suggestionsList')?.classList.add('hidden');
    document.getElementById('toggleSuggestions')?.classList.add('hidden');
  }

  // Hide intro + prompt + suggestions on first message (mobile only)
if (window.innerWidth < 768) {
  document.getElementById('heroIntro')?.classList.add('hidden'); // ⬅️ hides the hero
  document.getElementById('intro')?.classList.add('hidden');     // ⬅️ hides the prompt
  document.getElementById('suggestionsList')?.classList.add('hidden');
  document.getElementById('toggleSuggestions')?.classList.add('hidden');
}



  // snapshot files for this send (so we can safely clear UI chips)
  const filesToSend = [...files];

  // render user bubbles
  if (msg) appendBubble({ message: msg, isUser:true });
  if (filesToSend.length){
    appendAttachmentBubble(filesToSend);
    document.getElementById('fileChips').innerHTML = '';
  }

  document.getElementById('chatInput').value=''; 
  autosize(); 
  toggleSend();

  // typing bubble
  const chatWindow = document.getElementById('chatWindow');
  const typingWrap = document.createElement('div'); typingWrap.className='w-full flex mb-2';
  const typing = document.createElement('div'); typing.className='chat-bubble chat-ai text-slate-600';
  typing.innerHTML = '<i class="fa-solid fa-spinner pulse mr-2" aria-hidden="true"></i><span class="dotty">Thinking</span>';
  const col = document.createElement('div'); col.className='flex flex-col items-start mr-auto';
  col.appendChild(typing); typingWrap.appendChild(col); chatWindow.appendChild(typingWrap);
  chatWindow.scrollTop=chatWindow.scrollHeight;

  // always use FormData to avoid 415 and send all files
  const fd = new FormData();
  if (msg) fd.append('message', msg);
  fd.append('tone', mode);
  if (filesToSend.length) {
    // backend supports files[] OR file (single). Prefer files[].
    for (const f of filesToSend) fd.append('files[]', f);
  }

  abortController = new AbortController();

  try{
    const res = await fetch('/api/send-chat/', { 
      method:'POST',
      headers:{ 'X-CSRFToken': getCSRFToken() },
      body: fd,
      credentials:'include',
      signal: abortController.signal
    });
    const data = await res.json();
    typing.classList.remove('text-slate-600'); typing.classList.add('text-slate-800');
    typing.innerText = data.reply || '⚠️ No reply received.';

    const ok = !!(data && typeof data.reply === 'string' && data.reply.trim().length);
    document.getElementById('btnPdf')?.classList.toggle('is-disabled', !ok);
    document.getElementById('btnShare')?.classList.toggle('is-disabled', !ok);
    track('result_rendered');
  }catch(e){
    typing.classList.remove('text-slate-600'); typing.classList.add('text-red-700','bg-red-100');
    typing.innerText = 'I couldn’t finish that—want me to try a lighter summary or split the file?';
  }finally{
    files = []; // clear for next turn
    document.getElementById('fileChips').innerHTML='';
    toggleSend();

    if(showGateAfterResponse){
      const authed = await isAuthenticated();
      if(!authed){
        guestTurnsUsed += 1;
        localStorage.setItem('nm_guest_turns', String(guestTurnsUsed));
        if(guestTurnsUsed === 1) { showPostResultInvite(); }
        else if(guestTurnsUsed >= GUEST_TURNS_LIMIT){ showSignupGate(); }
      }
      showGateAfterResponse=false;
    }
  }
}


    async function doShareLink(){
      if ($('#btnShare').classList.contains('is-disabled')) return;
      try{
        const r = await fetch('/api/share/latest', { method:'POST', credentials:'include' });
        const j = await r.json();
        if(j?.url){ await navigator.clipboard.writeText(j.url); showToast('Share link copied', 'fa-regular fa-copy', 'text-teal-600'); }
        track('export_clicked', {type:'share'});
      }catch(e){
        showToast('Could not create link', 'fa-regular fa-circle-xmark', 'text-red-600');
      }
    }

    function startDictation(){
      if(!('webkitSpeechRecognition' in window)){ alert('Speech recognition works best in Chrome.'); return; }
      const rec = new webkitSpeechRecognition(); rec.lang='en-US';
      rec.onresult = (e)=>{ $('#chatInput').value = e.results[0][0].transcript; autosize(); toggleSend(); };
      rec.start();
    }

    function showSignupGate(){ const m=$('#signupGate'); if(!m) return; m.classList.remove('hidden'); m.classList.add('flex'); track('signup_shown'); }
    function showPostResultInvite(){ $('#postResultInvite').classList.remove('hidden'); }

    async function showAuthNudgeIfGuest(){
      try{
        const authed = await isAuthenticated();
        const dismissed = localStorage.getItem('nm_auth_nudge_dismissed') === '1';
        if(!authed && !dismissed){
          setTimeout(()=>{
            // keep your existing nudge if you have it on the page
            const n = document.getElementById('authNudge');
            if(!n) return;
            n.classList.remove('hidden');
            document.getElementById('authNudgeClose')?.addEventListener('click', ()=>{
              localStorage.setItem('nm_auth_nudge_dismissed','1');
              n.classList.add('hidden');
            });
          }, 2000);
        }
      }catch{}
    }

    // ---------- Minimal Spotlight Tour (opt-in only)
    (function(){
      const KEY = 'nm_chat_tour_done_v1';
      // your existing overlay code is fine; only call it when pressing the ? button
      window.startChatTourAuto = function(){
        // only auto-run if never seen (gentle)
        if (!localStorage.getItem(KEY)){
          document.getElementById('nmTourHelp')?.addEventListener('click', ()=> startTour(true));
        }else{
          document.getElementById('nmTourHelp')?.addEventListener('click', ()=> startTour(true));
        }
      };
      function startTour(){ alert('Quick tips:\n1) Upload or type.\n2) Pick a tone.\n3) Get summary, then Download or Share.'); }
    })();


    (function(){
  const KEY = 'nm_chat_tour_done_v2'; // bumped so new steps show once for everyone

  // --- tiny helpers
  const $ = s => document.querySelector(s);
  function isVisible(el){
    if(!el) return false;
    const cs = getComputedStyle(el);
    if(cs.display === 'none' || cs.visibility === 'hidden' || +cs.opacity === 0) return false;
    const r = el.getBoundingClientRect(), vw = innerWidth, vh = innerHeight;
    return r.width>0 && r.height>0 && r.bottom>0 && r.top<vh && r.right>0 && r.left<vw;
  }
  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  // allow selector as string | string[] | () => Element | null
  function resolveTarget(sel){
    if (!sel) return null;
    if (typeof sel === 'function') return sel();
    if (Array.isArray(sel)){
      for (const s of sel){ const el = document.querySelector(s); if (isVisible(el)) return el; }
      // fall back to first even if not visible
      return document.querySelector(sel[0]);
    }
    return document.querySelector(sel);
  }

  // --- build overlay DOM once
  function ensureOverlay(){
    let root = $('#nmTour');
    if (root) return root;

    root = document.createElement('div');
    root.id = 'nmTour';
    root.className = 'nm-tour-overlay hidden';
    root.innerHTML = `
      <div class="nm-tour-dim" aria-hidden="true">
        <div id="nmSlabN" class="nm-slab"></div>
        <div id="nmSlabW" class="nm-slab"></div>
        <div id="nmSlabE" class="nm-slab"></div>
        <div id="nmSlabS" class="nm-slab"></div>
      </div>
      <div id="nmHole" class="nm-tour-hole" aria-hidden="true"></div>
      <div id="nmPop" class="nm-tour-pop">
        <div id="nmTitle" class="text-base font-semibold mb-1"></div>
        <div id="nmBody"  class="text-slate-700 text-sm leading-relaxed"></div>
        <div class="mt-3 flex items-center justify-between gap-2">
          <button id="nmSkip" class="btn btn-text">Skip</button>
          <div class="flex items-center gap-2">
            <button id="nmPrev" class="btn btn-text">Back</button>
            <button id="nmNext" class="btn btn-primary">Next</button>
          </div>
        </div>
      </div>
      <span id="nmA11y" class="nm-tour-sr-only" role="status" aria-live="polite"></span>
    `;
    document.body.appendChild(root);
    return root;
  }

  // --- layout helpers
  function setRect(el, top, left, width, height){
    el.style.top    = `${Math.max(0, top)}px`;
    el.style.left   = `${Math.max(0, left)}px`;
    el.style.width  = `${Math.max(0, width)}px`;
    el.style.height = `${Math.max(0, height)}px`;
  }

  // --- steps (now includes A−/A＋ + Sign up/Log in)
  const STEPS = [
    { selector: null, placement:'center',
      title: 'Welcome to NeuroMed 👋',
      body:  'We turn medical papers into clear next steps you can use and share.' },

    { selector: ['#fontMinus','#fontPlus','#easyReadBtn'],
      title: 'Make text comfortable',
      body:  'Use A−/A＋ to change size. “Easy” adds spacing; “Contrast” boosts visibility.' },

    { selector: '#modeGroup',
      title: 'Pick your tone',
      body:  'Caregiver, Balanced, Clinical, Faith, Bilingual, Geriatric, or Emotional Support. Switch anytime.' },


    { selector: '#dropZone',
      title: 'Add a file or just type',
      body:  'Click the paperclip or drag & drop PDFs/images. Pasting from clipboard works too.' },

    { selector: '#suggestionsList',
      title: 'Quick starters',
      body:  'Tap a suggestion, then edit it to fit your case.' },

    { selector: () => document.querySelector('a[href="/signup"]') || document.querySelector('a[href="/login"]'),
      title: 'Save your progress',
      body:  'Sign up or Log in to keep your history and download/share summaries.' },

    { selector: '#chatInput',
      title: 'Ask your question',
      body:  'One or two sentences is enough. Press Enter to send (Shift+Enter for a new line).' },

    { selector: '#sendBtn',
      title: 'Get your plan',
      body:  'You’ll get a plain-English summary, watch-outs, and next steps.' },

    { selector: null, placement:'center',
      title: 'You’re all set ✅',
      body:  'Hit “?” anytime to replay this tour.' },
  ];

  // --- tour controller
  const Tour = {
    i: 0, running: false,

    start(force=false){
      ensureOverlay().classList.remove('hidden');
      this.running = true;
      this.i = 0;
      this.bind();
      this.goto(0);
      if (!force) localStorage.setItem(KEY, '1');
    },
    end(){
      const ov = $('#nmTour'); if(ov) ov.classList.add('hidden');
      this.unbind(); this.running = false;
    },
    next(){
      if (this.i >= STEPS.length - 1) return this.end();
      let j = this.i + 1;
      while (j < STEPS.length){
        const s = STEPS[j];
        const el = resolveTarget(s.selector);
        if (!s.selector || s.placement === 'center' || isVisible(el)) break;
        j++;
      }
      this.goto(Math.min(j, STEPS.length - 1));
    },
    prev(){
      if (this.i <= 0) return;
      let j = this.i - 1;
      while (j >= 0){
        const s = STEPS[j];
        const el = resolveTarget(s.selector);
        if (!s.selector || s.placement === 'center' || isVisible(el)) break;
        j--;
      }
      this.goto(Math.max(0, j));
    },
    goto(idx){
      this.i = idx;
      requestAnimationFrame(()=> placeStep(STEPS[this.i], this.i));
    },
    bind(){
      window.addEventListener('resize', this.recalc, { passive:true });
      window.addEventListener('scroll', this.recalc, { passive:true });
      $('#nmNext').onclick = () => this.next();
      $('#nmPrev').onclick = () => this.prev();
      $('#nmSkip').onclick = () => this.end();
      document.addEventListener('keydown', this.onKey);
    },
    unbind(){
      window.removeEventListener('resize', this.recalc);
      window.removeEventListener('scroll', this.recalc);
      document.removeEventListener('keydown', this.onKey);
    },
    recalc: () => { if (Tour.running) placeStep(STEPS[Tour.i], Tour.i); },
    onKey(e){
      if(!Tour.running) return;
      if(e.key === 'Escape') Tour.end();
      if(e.key === 'Enter' || e.key === ' ') Tour.next();
      if(e.key === 'ArrowRight') Tour.next();
      if(e.key === 'ArrowLeft') Tour.prev();
    }
  };

  // --- position current step
  function placeStep(step, idx){
    const hole = $('#nmHole');
    const pop  = $('#nmPop');
    const a11y = $('#nmA11y');
    const slabN = $('#nmSlabN'), slabW = $('#nmSlabW'), slabE = $('#nmSlabE'), slabS = $('#nmSlabS');

    // content
    $('#nmTitle').textContent = step.title || '';
    $('#nmBody').innerHTML    = step.body  || '';
    a11y.textContent = `Step ${idx+1}: ${step.title || ''}`;

    const vw = innerWidth, vh = innerHeight, pad = 8;

    // center step (no target)
    if (!step.selector || step.placement === 'center'){
      setRect(slabN, 0, 0, vw, vh);
      setRect(slabW, 0, 0, 0, 0);
      setRect(slabE, 0, 0, 0, 0);
      setRect(slabS, 0, 0, 0, 0);
      setRect(hole, -9999, -9999, 0, 0);
      pop.style.left = '50%'; pop.style.top = '50%'; pop.style.transform = 'translate(-50%, -50%)';
      return;
    }

    // target step
    const target = resolveTarget(step.selector);
    if (!isVisible(target)){
      try { target?.scrollIntoView({ block:'center', inline:'center', behavior:'smooth' }); } catch {}
    }
    const r = target?.getBoundingClientRect() || {top:vh/2,left:vw/2,width:0,height:0,right:vw/2,bottom:vh/2};

    // hole rectangle
    const hTop = clamp(r.top - pad, 6, vh - 12);
    const hLeft = clamp(r.left - pad, 6, vw - 12);
    const hW = Math.min(vw - 12, r.width + pad*2);
    const hH = Math.min(vh - 12, r.height + pad*2);

    setRect(hole, hTop, hLeft, hW, hH);
    setRect(slabN, 0, 0, vw, hTop);
    setRect(slabW, hTop, 0, hLeft, hH);
    setRect(slabE, hTop, hLeft + hW, vw - (hLeft + hW), hH);
    setRect(slabS, hTop + hH, 0, vw, vh - (hTop + hH));

    // pop near target with fallbacks
    const margin = 10;
    pop.style.transform = 'none';

    const canBottom = (r.bottom + margin + pop.offsetHeight) <= vh;
    const canTop    = (r.top    - margin - pop.offsetHeight) >= 0;
    const canRight  = (r.right  + margin + Math.min(pop.offsetWidth, 360)) <= vw;
    const canLeft   = (r.left   - margin - Math.min(pop.offsetWidth, 360)) >= 0;

    if (canBottom){
      pop.style.top  = (r.bottom + margin) + 'px';
      pop.style.left = clamp(r.left, 8, vw - pop.offsetWidth - 8) + 'px';
    } else if (canTop){
      pop.style.top  = (r.top - pop.offsetHeight - margin) + 'px';
      pop.style.left = clamp(r.left, 8, vw - pop.offsetWidth - 8) + 'px';
    } else if (canRight){
      pop.style.top  = clamp(r.top, 8, vh - pop.offsetHeight - 8) + 'px';
      pop.style.left = (r.right + margin) + 'px';
    } else if (canLeft){
      pop.style.top  = clamp(r.top, 8, vh - pop.offsetHeight - 8) + 'px';
      pop.style.left = (r.left - pop.offsetWidth - margin) + 'px';
    } else {
      pop.style.left = '50%'; pop.style.top = '50%'; pop.style.transform = 'translate(-50%, -50%)';
    }
  }

  // --- public hook (keep your call to startChatTourAuto() after DOMContentLoaded)
  window.startChatTourAuto = function(){
    // wire the help button every time
    document.getElementById('nmTourHelp')?.addEventListener('click', () => {
      ensureOverlay();
      Tour.start(true);     // user-triggered
    });

    // auto-run once per browser (gentle delay so layout is ready)
    if (!localStorage.getItem(KEY)){
      setTimeout(() => { ensureOverlay(); Tour.start(false); }, 700);
    }
  };
})();

  </script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js").catch(console.warn);
      });
    }
  </script>

  <script>
/* ---------- DEMO: wire the button + send FormData (no JSON) ---------- */

// 1) Hook the button
document.getElementById('ctaDemo')?.addEventListener('click', () => runDemo('er'));

// 2) Demo samples (short + readable)
const DEMO_SAMPLES = {
  er: `Please summarize this ER discharge note for a caregiver with clear steps:

Reason for visit: Dizziness and dehydration.
Diagnosis: Viral gastroenteritis, mild dehydration.
What was done: IV fluids 1L, ondansetron 4 mg IV, basic labs.
Key labs: Na 139, K 3.6, Cr 0.9, WBC 8.2.
Medications: Ondansetron 4 mg tablet PO q8h PRN nausea (12 tabs). Continue home meds.
Red flags: Worsening vomiting, blood in stool, fever >101.5°F, confusion, no urination in 8–10 hrs.
Follow-up: PCP in 2–3 days. Hydration: 2–3 L/day small sips. Diet: BRAT for 24–48 hrs.
Please provide: (1) plain-English summary, (2) what to watch, (3) step-by-step home plan, (4) 5 questions for the doctor.`,
  labs: `Explain these labs in plain English and note what to watch and next steps:

CBC: WBC 6.1, Hgb 11.2 (L), Hct 34% (L), Plt 250.
CMP: Na 137, K 4.1, Cl 102, CO2 25, BUN 12, Cr 0.8, Glucose 96.
LFTs: AST 22, ALT 24, Alk Phos 90, T. bili 0.6, Albumin 3.9.
Lipids: TC 210 (H), LDL 138 (H), HDL 46, TG 140.
TSH 2.1.

Make it caregiver-friendly; add watch-outs, lifestyle tips, and 3 doctor questions.`
};

// 3) Helper to add a quick user bubble (short and clean)
function addUserNote(text){
  const chatWindow = document.getElementById('chatWindow');
  const wrap = document.createElement('div'); wrap.className = 'w-full flex mb-3';
  const bubble = document.createElement('div'); bubble.className = 'chat-bubble chat-user'; bubble.innerText = text;
  const meta = document.createElement('div'); meta.className = 'text-[11px] text-slate-400 mt-1 text-right ml-auto pr-1';
  meta.innerText = new Intl.DateTimeFormat(undefined,{ hour:'2-digit', minute:'2-digit' }).format(new Date());
  const col = document.createElement('div'); col.className = 'flex flex-col items-end ml-auto';
  col.appendChild(bubble); col.appendChild(meta); wrap.appendChild(col); chatWindow.appendChild(wrap);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// 4) Minimal typing bubble (same visual as your sendChat)
function addTypingBubble(){
  const chatWindow = document.getElementById('chatWindow');
  const wrap = document.createElement('div'); wrap.className='w-full flex mb-2';
  const bubble = document.createElement('div'); bubble.className='chat-bubble chat-ai text-slate-600';
  bubble.innerHTML = '<i class="fa-solid fa-spinner pulse mr-2" aria-hidden="true"></i><span class="dotty">Thinking</span>';
  const col = document.createElement('div'); col.className='flex flex-col items-start mr-auto';
  col.appendChild(bubble); wrap.appendChild(col); chatWindow.appendChild(wrap);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  return bubble; // so we can replace its text later
}

// 5) Run the demo
async function runDemo(kind = 'er'){
  const mode = (typeof loadMode === 'function' ? loadMode() : 'Caregiver');
  const sample = DEMO_SAMPLES[kind] || DEMO_SAMPLES.er;

  // UX: short user note (don’t dump the big prompt in the chat)
  addUserNote(kind === 'labs' ? 'Running lab results demo…' : 'Running ER discharge demo…');

  // typing bubble
  const typing = addTypingBubble();

  // Always use FormData for this endpoint
  const fd = new FormData();
  fd.append('tone', mode);
  fd.append('message', sample);

  try{
    const res = await fetch('/api/send-chat/', {
      method:'POST',
      headers:{ 'X-CSRFToken': (typeof getCSRFToken === 'function' ? getCSRFToken() : '') },
      body: fd,
      credentials:'include'
    });
    const data = await res.json();
    typing.classList.remove('text-slate-600'); typing.classList.add('text-slate-800');
    typing.innerText = data?.reply || '⚠️ No reply received.';
    // if you still have action buttons, enable them on success
    document.getElementById('btnPdf')?.classList.toggle('is-disabled', !(data?.reply?.trim()));
    document.getElementById('btnShare')?.classList.toggle('is-disabled', !(data?.reply?.trim()));
    try{ track('demo_started', { kind }); }catch{}
  }catch(e){
    typing.classList.remove('text-slate-600'); typing.classList.add('text-red-700','bg-red-100');
    typing.innerText = 'Demo failed to run. Try again or switch modes.';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const btn   = document.getElementById('nmMenuBtn');
  const menu  = document.getElementById('nmMobileMenu');
  const icoOpen  = document.getElementById('nmIconOpen');
  const icoClose = document.getElementById('nmIconClose');

  function setOpen(isOpen){
    menu.classList.toggle('hidden', !isOpen);
    btn.setAttribute('aria-expanded', String(isOpen));
    icoOpen.classList.toggle('hidden',  isOpen);
    icoClose.classList.toggle('hidden', !isOpen);
  }

  btn?.addEventListener('click', () => setOpen(menu.classList.contains('hidden')));

  // Close on outside click
  document.addEventListener('click', (e) => {
    if (!menu || menu.classList.contains('hidden')) return;
    const within = menu.contains(e.target) || btn.contains(e.target);
    if (!within) setOpen(false);
  });

  // Close on Esc
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') setOpen(false);
  });

  // Mirror readability controls for mobile
  const root = document.documentElement, body = document.body;

  function bumpFont(delta){
    const curr = parseFloat(getComputedStyle(root).getPropertyValue('font-size')) || 18;
    root.style.setProperty('font-size', Math.max(16, Math.min(22, curr + delta)) + 'px');
  }

  document.getElementById('mFontMinus')?.addEventListener('click', () => bumpFont(-1));
  document.getElementById('mFontPlus') ?.addEventListener('click', () => bumpFont(1));

  document.getElementById('mEasyReadBtn')?.addEventListener('click', (ev) => {
    body.classList.toggle('easy-read');
    ev.currentTarget.setAttribute('aria-pressed', body.classList.contains('easy-read') ? 'true' : 'false');
  });

  document.getElementById('mHighContrast')?.addEventListener('click', (ev) => {
    body.classList.toggle('hc');
    ev.currentTarget.setAttribute('aria-pressed', body.classList.contains('hc') ? 'true' : 'false');
  });
});


// keep your existing loadMode/saveMode/selectMode/applyModeUI

function syncMobileSelect(mode){
  const sel = document.getElementById('modeSelect');
  if (sel && sel.value !== mode) sel.value = mode;
}

document.addEventListener('DOMContentLoaded', () => {
  const sheet   = document.getElementById('modeSheet');
  const panel   = document.getElementById('modeSheetPanel');
  const btn     = document.getElementById('modePickerBtn');
  const close   = document.getElementById('modeSheetClose');
  const done    = document.getElementById('modeSheetDone');
  const backdrop= document.getElementById('modeSheetBackdrop');
  const iconEl  = document.getElementById('modePickerIcon');
  const labelEl = document.getElementById('modePickerLabel');

  const MODE_ICON = {
    'Caregiver':     'fa-solid fa-hands-holding-child text-amber-700',
    'PlainClinical': 'fa-regular fa-message text-teal-600',
    'Clinical':      'fa-solid fa-stethoscope text-slate-800',
    'Faith':         'fa-solid fa-hands-praying text-indigo-700',
    'Bilingual':     'fa-solid fa-language text-teal-700',
    'Geriatric':     'fa-solid fa-person-cane text-emerald-700',
    'EmotionalSupport': 'fa-solid fa-heart text-rose-700'
  };

  function labelFor(mode){
  if (mode === 'PlainClinical')    return 'Balanced';
  if (mode === 'EmotionalSupport') return 'Emotional Support';
  return mode;
}


  function updateTrigger(mode){
    if (!iconEl || !labelEl) return;
    iconEl.className = MODE_ICON[mode] || 'fa-regular fa-message text-teal-600';
    labelEl.textContent = labelFor(mode);
    // reflect on hidden select for a11y state
    const sel = document.getElementById('modeSelect');
    if (sel) sel.value = mode;
    // highlight checkmarks in list
    document.querySelectorAll('#modeSheet [data-mode]').forEach(item => {
      const check = item.querySelector('.fa-check');
      if (check) check.classList.toggle('hidden', item.dataset.mode !== mode);
    });
  }

  function openSheet(){
    if (!sheet) return;
    sheet.classList.remove('hidden');
    document.body.classList.add('lock-scroll');
    // animate up
    requestAnimationFrame(() => { panel.classList.remove('translate-y-full'); });
  }

  function closeSheet(){
    if (!sheet) return;
    panel.classList.add('translate-y-full');
    setTimeout(() => {
      sheet.classList.add('hidden');
      document.body.classList.remove('lock-scroll');
    }, 180);
  }

  // init from saved mode
  const current = (typeof loadMode === 'function') ? loadMode() : 'Caregiver';
  updateTrigger(current);

  // open/close handlers
  btn?.addEventListener('click', openSheet);
  close?.addEventListener('click', closeSheet);
  done?.addEventListener('click', closeSheet);
  backdrop?.addEventListener('click', closeSheet);

  // option clicks
  document.querySelectorAll('#modeSheet [data-mode]').forEach(item => {
    item.addEventListener('click', () => {
      const mode = item.dataset.mode;
      if (typeof selectModeFromValue === 'function') {
        selectModeFromValue(mode);       // updates app + saves + toast
      } else {
        // fallback if helper isn't present
        if (typeof saveMode === 'function') saveMode(mode);
        if (typeof applyModeUI === 'function') applyModeUI(mode);
      }
      updateTrigger(mode);
      // subtle haptic-esque feedback
      item.classList.add('bg-emerald-50');
      setTimeout(() => item.classList.remove('bg-emerald-50'), 180);
    });
  });

  // keep trigger in sync if desktop buttons change the mode
  document.querySelectorAll('#modeGroup button').forEach(b => {
    b.addEventListener('click', () => updateTrigger((typeof loadMode === 'function') ? loadMode() : 'Caregiver'));
  });
});


document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('modeBadge')?.addEventListener('click', () => {
    if (window.innerWidth < 768) {
      document.getElementById('modeSelect')?.focus();
    }
  });
});

document.addEventListener('DOMContentLoaded', () => {
  if (window.innerWidth < 768) {
    const ta = document.getElementById('chatInput');
    if (ta) ta.placeholder = 'Type a question…';
  }
});


</script>

</body>
</html>
