{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>NeuroMed AI - Premium Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  {# PWA manifest temporarily disabled to avoid 500s in production #}
  {# <link rel="manifest" href="{% static 'pwa/manifest.webmanifest' %}"> #}
  <link rel="apple-touch-icon" href="/static/pwa/icons/apple-touch-icon-180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/pwa/icons/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/pwa/icons/favicon-16.png">
  <meta name="theme-color" content="#236092">
  <!-- FontAwesome - Using jsDelivr CDN (more reliable) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" />
  
  <!-- Apply theme IMMEDIATELY to prevent flash of wrong theme -->
  <script>
    (function() {
      const savedAppearance = localStorage.getItem('nm_appearance') || 'system';
      const root = document.documentElement;
      
      if (savedAppearance === 'system') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        root.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
      } else {
        root.setAttribute('data-theme', savedAppearance);
      }
      
      // Apply accent color immediately
      const savedAccentColor = localStorage.getItem('nm_accent_color') || 'default';
      const accentMap = {
        'default': { main: '#28926D', light: '#10b981', focusRing: 'rgba(40, 146, 109, 0.4)' },
        'green': { main: '#28926D', light: '#10b981', focusRing: 'rgba(40, 146, 109, 0.4)' },
        'blue': { main: '#236092', light: '#3B82F6', focusRing: 'rgba(35, 96, 146, 0.4)' },
        'purple': { main: '#7C3AED', light: '#A78BFA', focusRing: 'rgba(124, 58, 237, 0.4)' },
        'red': { main: '#DC2626', light: '#EF4444', focusRing: 'rgba(220, 38, 38, 0.4)' }
      };
      const accentData = accentMap[savedAccentColor] || accentMap['default'];
      root.style.setProperty('--nm-accent', accentData.main);
      root.style.setProperty('--nm-accent-light', accentData.light);
      root.style.setProperty('--nm-accent-focus-ring', accentData.focusRing);
    })();
  </script>
  
<style>
/* ============================================
   PREMIUM DASHBOARD - "BILLION-DOLLAR" VISUAL SYSTEM
   Medical-grade minimalism: bright, airy, ultra-readable
   ============================================ */

/* ============================================
   DESIGN TOKEN SYSTEM - SINGLE SOURCE OF TRUTH
   All colors centralized here - NO hard-coded colors elsewhere
   ============================================ */

:root,
[data-theme="light"] {
  /* Brand tokens - consistent across themes */
  --nm-primary: #236092;
  --nm-primary-dark: #1B5A8E;
  
  /* Accent colors - user selectable (default: green) */
  --nm-accent: #28926D;
  --nm-accent-light: #10b981;
  --nm-accent-focus-ring: rgba(40, 146, 109, 0.4);
  --nm-accent-softer: #2d9f7a;
  
  /* Background surfaces - Light mode */
  --nm-bg-body-start: #f8fafc;
  --nm-bg-body-end: #f1f5f9;
  --nm-paper: #ffffff;
  --nm-glass: rgba(255, 255, 255, 0.85);
  --nm-glass-border: rgba(229, 231, 235, 0.8);
  --nm-frost: rgba(255, 255, 255, 0.95);
  --nm-bg-table-header: #f8fafc;
  --nm-bg-code: #f1f5f9;
  --nm-bg-blockquote: #f8fafc;
  --nm-bg-dropzone: #f0fdfa;
  --nm-bg-dropzone-hover: #f0fdfa;
  --nm-bg-attachment-card: #f8fafc;
  --nm-bg-attachment-ready: #d1fae5;
  --nm-bg-attachment-queued: #dbeafe;
  --nm-bg-attachment-error: #fee2e2;
  --nm-bg-skeleton: #f1f5f9;
  --nm-bg-skeleton-shine: #e2e8f0;
  
  /* Chat bubble backgrounds - Light mode */
  --nm-chat-user-start: #dbeafe;
  --nm-chat-user-end: #bfdbfe;
  --nm-chat-ai: #ffffff;
  --nm-chat-code-bg: #0f172a;
  --nm-chat-code-text: #f1f5f9;
  
  /* Text hierarchy - Light mode */
  --nm-text-primary: #0f172a;
  --nm-text-secondary: #475569;
  --nm-text-muted: #94a3b8;
  --nm-text-gray-800: #1f2937;
  --nm-text-gray-700: #374151;
  --nm-text-gray-600: #4b5563;
  --nm-text-gray-500: #6b7280;
  --nm-text-gray-400: #9ca3af;
  --nm-text-attachment-ready: #065f46;
  --nm-text-attachment-queued: #1e40af;
  --nm-text-attachment-error: #991b1b;
  
  /* Borders - Light mode */
  --nm-border-color: rgba(229, 231, 235, 0.8);
  --nm-border-table: #e2e8f0;
  --nm-border-dropzone: #cbd5e1;
  --nm-border-focus: 2px solid var(--nm-accent);
  
  /* Shadows - Light mode */
  --nm-shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --nm-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --nm-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --nm-shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  
  /* Tone colors - Light mode */
  --nm-tone-balanced-icon: #236092;
  --nm-tone-balanced-bg: #e2e8f0;
  --nm-tone-balanced-text: #334155;
  --nm-tone-caregiver-icon: #F59E0B;
  --nm-tone-caregiver-bg: #ffe4e6;
  --nm-tone-caregiver-text: #9f1239;
  --nm-tone-faith-icon: #4F46E5;
  --nm-tone-faith-bg: #e0e7ff;
  --nm-tone-faith-text: #3730a3;
  --nm-tone-clinical-icon: #475569;
  --nm-tone-clinical-bg: #fef9c3;
  --nm-tone-clinical-text: #92400e;
  --nm-tone-geriatric-icon: #28926D;
  --nm-tone-geriatric-bg: #dcfce7;
  --nm-tone-geriatric-text: #065f46;
  --nm-tone-emotional-icon: #E11D48;
  --nm-tone-emotional-bg: #ede9fe;
  --nm-tone-emotional-text: #6d28d9;
  
  /* State colors - Light mode */
  --nm-state-hover-primary: #1B5A8E;
  --nm-state-active-selected: #28926D;
  --nm-state-error: #ef4444;
  --nm-state-error-border: #ef4444;
  
  /* UI element colors - Light mode */
  --nm-ui-avatar-bg: #236092;
  --nm-ui-bubble-action-bg: rgba(255, 255, 255, 0.9);
  --nm-ui-divider: #e5e7eb;
  --nm-ui-toast-error-border: #ef4444;
  
  /* Spacing */
  --nm-radius: 12px;
  --nm-radius-lg: 16px;
  --nm-radius-xl: 20px;
}

/* Dark mode theme */
[data-theme="dark"] {
  /* Brand tokens - same as light */
  --nm-primary: #236092;
  --nm-primary-dark: #1B5A8E;
  
  /* Accent colors - same values, different context */
  --nm-accent: #28926D;
  --nm-accent-light: #10b981;
  --nm-accent-focus-ring: rgba(40, 146, 109, 0.4);
  --nm-accent-softer: #2d9f7a;
  
  /* Background surfaces - Dark mode */
  --nm-bg-body-start: #0f172a;
  --nm-bg-body-end: #1e293b;
  --nm-paper: #1e293b;
  --nm-glass: rgba(30, 41, 59, 0.85);
  --nm-glass-border: rgba(51, 65, 85, 0.8);
  --nm-frost: rgba(30, 41, 59, 0.95);
  --nm-bg-table-header: #334155;
  --nm-bg-code: #334155;
  --nm-bg-blockquote: #334155;
  --nm-bg-dropzone: rgba(15, 23, 42, 0.5);
  --nm-bg-dropzone-hover: rgba(15, 23, 42, 0.7);
  --nm-bg-attachment-card: #334155;
  --nm-bg-attachment-ready: rgba(16, 185, 129, 0.2);
  --nm-bg-attachment-queued: rgba(59, 130, 246, 0.2);
  --nm-bg-attachment-error: rgba(239, 68, 68, 0.2);
  --nm-bg-skeleton: #334155;
  --nm-bg-skeleton-shine: #475569;
  
  /* Chat bubble backgrounds - Dark mode */
  --nm-chat-user-start: #1e293b;
  --nm-chat-user-end: #0f172a;
  --nm-chat-ai: #0b1120;
  --nm-chat-code-bg: #0f172a;
  --nm-chat-code-text: #f1f5f9;
  
  /* Text hierarchy - Dark mode */
  --nm-text-primary: #f1f5f9;
  --nm-text-secondary: #cbd5e1;
  --nm-text-muted: #64748b;
  --nm-text-gray-800: #f1f5f9;
  --nm-text-gray-700: #cbd5e1;
  --nm-text-gray-600: #94a3b8;
  --nm-text-gray-500: #64748b;
  --nm-text-gray-400: #475569;
  --nm-text-attachment-ready: #10b981;
  --nm-text-attachment-queued: #3b82f6;
  --nm-text-attachment-error: #ef4444;
  
  /* Borders - Dark mode */
  --nm-border-color: rgba(51, 65, 85, 0.8);
  --nm-border-table: #475569;
  --nm-border-dropzone: #475569;
  --nm-border-focus: 2px solid var(--nm-accent);
  
  /* Shadows - Dark mode (lighter shadows for visibility) */
  --nm-shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
  --nm-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
  --nm-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
  --nm-shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
  
  /* Tone colors - Dark mode (darker backgrounds, lighter text) */
  --nm-tone-balanced-icon: #236092;
  --nm-tone-balanced-bg: #334155;
  --nm-tone-balanced-text: #cbd5e1;
  --nm-tone-caregiver-icon: #F59E0B;
  --nm-tone-caregiver-bg: #7c2d12;
  --nm-tone-caregiver-text: #fecdd3;
  --nm-tone-faith-icon: #4F46E5;
  --nm-tone-faith-bg: #312e81;
  --nm-tone-faith-text: #c7d2fe;
  --nm-tone-clinical-icon: #475569;
  --nm-tone-clinical-bg: #78350f;
  --nm-tone-clinical-text: #fef3c7;
  --nm-tone-geriatric-icon: #28926D;
  --nm-tone-geriatric-bg: #064e3b;
  --nm-tone-geriatric-text: #d1fae5;
  --nm-tone-emotional-icon: #E11D48;
  --nm-tone-emotional-bg: #581c87;
  --nm-tone-emotional-text: #e9d5ff;
  
  /* State colors - Dark mode */
  --nm-state-hover-primary: #1B5A8E;
  --nm-state-active-selected: #28926D;
  --nm-state-error: #ef4444;
  --nm-state-error-border: #ef4444;
  
  /* UI element colors - Dark mode */
  --nm-ui-avatar-bg: #236092;
  --nm-ui-bubble-action-bg: rgba(30, 41, 59, 0.9);
  --nm-ui-divider: #475569;
  --nm-ui-toast-error-border: #ef4444;
}

/* ============================================
   UTILITY CLASSES - Token-based replacements
   ============================================ */

/* Background utilities */
.bg-token-primary { background-color: var(--nm-primary) !important; }
.bg-token-primary-dark { background-color: var(--nm-primary-dark) !important; }
.bg-token-accent { background-color: var(--nm-accent) !important; }
.bg-token-accent-light { background-color: var(--nm-accent-light) !important; }
.bg-token-paper { background-color: var(--nm-paper) !important; }

/* Text utilities */
.text-token-primary { color: var(--nm-primary) !important; }
.text-token-accent { color: var(--nm-accent) !important; }
.text-token-gray-800 { color: var(--nm-text-gray-800) !important; }
.text-token-gray-700 { color: var(--nm-text-gray-700) !important; }
.text-token-gray-600 { color: var(--nm-text-gray-600) !important; }
.text-token-gray-500 { color: var(--nm-text-gray-500) !important; }

/* Border utilities */
.border-token-accent { border-color: var(--nm-accent) !important; }
.border-token-gray-200 { border-color: var(--nm-border-color) !important; }
.border-token-gray-300 { border-color: var(--nm-border-color) !important; }

/* Ring/Focus utilities */
.focus-ring-accent:focus {
  outline: none;
  box-shadow: 0 0 0 2px var(--nm-accent-focus-ring);
  border-color: var(--nm-accent);
}

/* Tone icon color utilities */
.tone-icon-balanced { color: var(--nm-tone-balanced-icon) !important; }
.tone-icon-caregiver { color: var(--nm-tone-caregiver-icon) !important; }
.tone-icon-faith { color: var(--nm-tone-faith-icon) !important; }
.tone-icon-clinical { color: var(--nm-tone-clinical-icon) !important; }
.tone-icon-geriatric { color: var(--nm-tone-geriatric-icon) !important; }
.tone-icon-emotional { color: var(--nm-tone-emotional-icon) !important; }

/* Map Tailwind gray classes to tokens for theme compatibility */
.text-gray-800 { color: var(--nm-text-gray-800) !important; }
.text-gray-700 { color: var(--nm-text-gray-700) !important; }
.text-gray-600 { color: var(--nm-text-gray-600) !important; }
.text-gray-500 { color: var(--nm-text-gray-500) !important; }
.text-gray-400 { color: var(--nm-text-gray-400) !important; }

.border-gray-200,
.border-gray-300 { border-color: var(--nm-border-color) !important; }

.bg-white { background-color: var(--nm-paper) !important; }
.bg-gray-50,
.bg-gray-100 { background-color: var(--nm-bg-skeleton) !important; }
.bg-gray-200 { background-color: var(--nm-bg-skeleton-shine) !important; }
.bg-gray-900 { background-color: var(--nm-text-primary) !important; }
.bg-gray-800 { background-color: var(--nm-text-gray-800) !important; }

.hover\:bg-gray-100:hover { background-color: var(--nm-bg-skeleton) !important; }
.hover\:bg-gray-800:hover { background-color: var(--nm-text-gray-800) !important; }

/* Dark mode specific styling for inputs and selects */
[data-theme="dark"] input,
[data-theme="dark"] textarea,
[data-theme="dark"] select {
  background-color: var(--nm-paper) !important;
  color: var(--nm-text-primary) !important;
  border-color: var(--nm-border-color) !important;
}

[data-theme="dark"] input:focus,
[data-theme="dark"] textarea:focus,
[data-theme="dark"] select:focus {
  background-color: var(--nm-paper) !important;
  color: var(--nm-text-primary) !important;
  border-color: var(--nm-accent) !important;
  box-shadow: 0 0 0 2px var(--nm-accent-focus-ring) !important;
}

[data-theme="dark"] input::placeholder,
[data-theme="dark"] textarea::placeholder {
  color: var(--nm-text-muted) !important;
}

[data-theme="dark"] select option {
  background-color: var(--nm-paper) !important;
  color: var(--nm-text-primary) !important;
}

/* Dark mode text colors for better visibility */
[data-theme="dark"] .text-gray-800,
[data-theme="dark"] h3.text-gray-800,
[data-theme="dark"] .text-sm.font-medium.text-gray-800 {
  color: var(--nm-text-primary) !important;
}

[data-theme="dark"] .text-gray-700 {
  color: var(--nm-text-secondary) !important;
}

[data-theme="dark"] .text-gray-500 {
  color: var(--nm-text-muted) !important;
}

/* Dark mode borders */
[data-theme="dark"] .border-gray-100 {
  border-color: var(--nm-border-color) !important;
}

/* Dark mode settings section styling */
[data-theme="dark"] #settingsModal {
  background: var(--nm-glass) !important;
}

[data-theme="dark"] #settingsModal .modal-content {
  background: var(--nm-paper) !important;
  color: var(--nm-text-primary) !important;
}

/* Dark mode select dropdown arrow - ensure it's visible */
[data-theme="dark"] select {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23cbd5e1' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important;
  background-position: right 0.5rem center !important;
  background-repeat: no-repeat !important;
  background-size: 1.5em 1.5em !important;
  padding-right: 2.5rem !important;
  -webkit-appearance: none !important;
  -moz-appearance: none !important;
  appearance: none !important;
}

/* Chat window styling */
.chat-main-area {
  background: linear-gradient(135deg, var(--nm-bg-body-start) 0%, var(--nm-bg-body-end) 100%);
}

.chat-header {
  border-color: var(--nm-border-color);
  background: var(--nm-glass);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

.chat-window {
  background: transparent;
}

/* Dark mode chat window improvements */
[data-theme="dark"] .chat-window {
  background: transparent;
}

[data-theme="dark"] .chat-header {
  background: var(--nm-glass);
  border-color: var(--nm-glass-border);
}

[data-theme="dark"] .chat-header h1,
[data-theme="dark"] .chat-header .text-gray-800,
[data-theme="dark"] .chat-header .text-gray-600,
[data-theme="dark"] .chat-header .text-gray-500 {
  color: var(--nm-text-primary) !important;
}

[data-theme="dark"] #emptyState h2,
[data-theme="dark"] #emptyState .text-gray-800 {
  color: var(--nm-text-primary) !important;
}

/* Ensure chat window header text is visible in dark mode */
[data-theme="dark"] .chat-header-title,
[data-theme="dark"] header h1.text-gray-800 {
  color: var(--nm-text-primary) !important;
}

/* Chat window background should use body gradient */
.chat-main-area {
  background: linear-gradient(135deg, var(--nm-bg-body-start) 0%, var(--nm-bg-body-end) 100%);
  transition: background 0.3s ease;
}

/* Composer area styling - Floaty like ChatGPT */
.composer-area {
  background: transparent;
  border: none;
  box-shadow: none;
  padding: 16px 24px;
}

/* Dark mode composer */
[data-theme="dark"] .composer-area {
  background: transparent;
  border: none;
  box-shadow: none;
}

/* Dark mode session cards - ensure text is visible */
[data-theme="dark"] .session-card {
  background: var(--nm-paper);
  border-color: var(--nm-border-color);
}

[data-theme="dark"] .session-card:hover {
  background: var(--nm-bg-skeleton);
}

[data-theme="dark"] .session-card.active {
  background: var(--nm-bg-dropzone);
}

[data-theme="dark"] .session-chip {
  background: var(--nm-bg-skeleton-shine);
  color: var(--nm-text-secondary);
}

[data-theme="dark"] .session-title {
  color: var(--nm-text-primary) !important;
}

[data-theme="dark"] .session-meta {
  color: var(--nm-text-muted) !important;
}

/* Chip styling for dark mode */
[data-theme="dark"] .chip {
  background: var(--nm-bg-skeleton);
  border-color: var(--nm-border-color);
  color: var(--nm-text-secondary);
}

[data-theme="dark"] .chip:hover {
  background: var(--nm-bg-skeleton-shine);
}

[data-theme="dark"] .chip-label,
[data-theme="dark"] .chip .text-gray-500 {
  color: var(--nm-text-muted) !important;
}

[data-theme="dark"] .chip-value {
  color: var(--nm-text-primary) !important;
}

[data-theme="dark"] .chip-arrow,
[data-theme="dark"] .chip .text-gray-400,
[data-theme="dark"] .chip .fa-chevron-down {
  color: var(--nm-text-muted) !important;
}

[data-theme="dark"] .chip:hover .fa-chevron-down {
  color: var(--nm-accent) !important;
}

/* Sidebar logo styling for dark mode */
[data-theme="dark"] .sidebar-logo-container {
  background: transparent;
}

[data-theme="dark"] .sidebar-logo-heart {
  filter: brightness(1.1) contrast(1.05); /* Slightly brighten logo in dark mode for better visibility */
}

[data-theme="dark"] .sidebar-logo-icon {
  color: var(--nm-text-secondary);
}

[data-theme="dark"] .sidebar-logo-icon:hover {
  background-color: var(--nm-bg-skeleton);
  color: var(--nm-text-primary);
}

[data-theme="dark"] .sidebar-header-container {
  border-color: var(--nm-border-color);
  background: var(--nm-glass);
}

/* Ensure logo is visible in dark mode */
[data-theme="dark"] .sidebar-logo {
  opacity: 1;
  filter: brightness(1.05); /* Slight brightness boost for dark backgrounds */
}

/* First message view styling */
.first-message-heading {
  color: var(--nm-text-primary);
}

.first-message-input-container {
  background: var(--nm-paper);
  border-color: var(--nm-border-color);
}

.first-message-input {
  background: transparent;
  border: none;
  color: var(--nm-text-primary);
}

.first-message-input::placeholder {
  color: var(--nm-text-muted);
}

.first-message-btn {
  background: var(--nm-bg-skeleton);
  color: var(--nm-text-secondary);
}

.first-message-btn:hover {
  background: var(--nm-bg-skeleton-shine);
  color: var(--nm-text-primary);
}

.first-message-icon {
  color: var(--nm-text-secondary);
}

.first-message-btn:hover .first-message-icon {
  color: var(--nm-text-primary);
}

/* Dark mode first message view */
[data-theme="dark"] .first-message-heading {
  color: var(--nm-text-primary) !important;
}

[data-theme="dark"] .first-message-input-container {
  background: var(--nm-paper);
  border-color: var(--nm-border-color);
}

[data-theme="dark"] .first-message-input {
  background: transparent;
  color: var(--nm-text-primary);
}

[data-theme="dark"] .first-message-input::placeholder {
  color: var(--nm-text-muted);
}

[data-theme="dark"] .first-message-btn {
  background: var(--nm-bg-skeleton);
  color: var(--nm-text-secondary);
}

[data-theme="dark"] .first-message-btn:hover {
  background: var(--nm-bg-skeleton-shine);
  color: var(--nm-text-primary);
}

/* Ensure proper contrast in dark mode */
[data-theme="dark"] .border-gray-200,
[data-theme="dark"] .border-gray-300 {
  border-color: var(--nm-border-color) !important;
}

/* Dark mode modal and settings improvements */
[data-theme="dark"] .glass,
[data-theme="dark"] .glass-strong {
  background: var(--nm-glass) !important;
  border-color: var(--nm-glass-border) !important;
}

[data-theme="dark"] .settings-nav-item {
  color: var(--nm-text-secondary) !important;
}

[data-theme="dark"] .settings-nav-item:hover {
  background-color: var(--nm-bg-skeleton) !important;
}

[data-theme="dark"] .settings-nav-item.active {
  background-color: var(--nm-bg-skeleton) !important;
  color: var(--nm-text-primary) !important;
}

/* Base */
body {
  background: linear-gradient(135deg, var(--nm-bg-body-start) 0%, var(--nm-bg-body-end) 100%);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
  color: var(--nm-text-primary);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* Glass surfaces */
.glass {
  background: var(--nm-glass);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--nm-glass-border);
  box-shadow: var(--nm-shadow);
}

.glass-strong {
  background: var(--nm-frost);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
}

/* Premium chat bubbles */
.chat-bubble {
  border-radius: var(--nm-radius-lg);
  padding: 14px 18px;
  font-size: 15px;
  line-height: 1.5;
  max-width: 75%;
  word-break: break-word;
  box-shadow: var(--nm-shadow);
  animation: fadeInUp 0.3s ease-out;
  position: relative;
  transition: box-shadow 0.2s ease;
}

.chat-bubble:hover {
  box-shadow: var(--nm-shadow-lg);
}

.chat-user {
  background: linear-gradient(135deg, var(--nm-chat-user-start) 0%, var(--nm-chat-user-end) 100%);
  color: var(--nm-text-primary);
  margin-left: auto;
  margin-right: 0;
  border-bottom-right-radius: 4px;
}

.chat-ai {
  background: var(--nm-chat-ai);
  color: var(--nm-text-primary);
  margin-right: auto;
  margin-left: 0;
  border-bottom-left-radius: 4px;
  border-left: 3px solid var(--nm-accent);
}

/* AI badge on assistant bubbles */
.chat-ai::before {
  content: 'NeuroMed';
  position: absolute;
  top: -8px;
  left: 12px;
  font-size: 10px;
  font-weight: 600;
  color: var(--nm-accent);
  background: var(--nm-paper);
  padding: 2px 6px;
  border-radius: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Message grouping - reduced spacing for consecutive messages */
.chat-bubble + .chat-bubble {
  margin-top: 4px;
}

.chat-user + .chat-user,
.chat-ai + .chat-ai {
  margin-top: 2px;
}

/* Rich markdown in bubbles */
.chat-ai .md-prose {
  font-size: 15px;
  line-height: 1.5;
}

.chat-ai .md-prose h1 { font-size: 1.25rem; font-weight: 700; margin: 0.75em 0 0.5em; }
.chat-ai .md-prose h2 { font-size: 1.15rem; font-weight: 600; margin: 0.65em 0 0.4em; }
.chat-ai .md-prose h3 { font-size: 1.05rem; font-weight: 600; margin: 0.55em 0 0.35em; }
.chat-ai .md-prose h4 { font-size: 1rem; font-weight: 600; margin: 0.45em 0 0.3em; }

.chat-ai .md-prose p { margin: 0.5em 0; }
.chat-ai .md-prose ul, .chat-ai .md-prose ol { margin: 0.5em 0 0.5em 1.5em; }
.chat-ai .md-prose li { margin: 0.25em 0; }

.chat-ai .md-prose table {
  width: 100%;
  border-collapse: collapse;
  margin: 0.75em 0;
  font-size: 14px;
  overflow-x: auto;
  display: block;
}

.chat-ai .md-prose table thead {
  background: var(--nm-bg-table-header);
  position: sticky;
  top: 0;
}

.chat-ai .md-prose th,
.chat-ai .md-prose td {
  border: 1px solid var(--nm-border-table);
  padding: 8px 12px;
  text-align: left;
}

.chat-ai .md-prose blockquote {
  border-left: 3px solid var(--nm-accent);
  padding-left: 16px;
  margin: 0.75em 0;
  color: var(--nm-text-secondary);
  background: var(--nm-bg-blockquote);
  border-radius: 0 8px 8px 0;
  padding: 12px 16px;
}

.chat-ai .md-prose code {
  background: var(--nm-bg-code);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.9em;
  font-family: 'Monaco', 'Courier New', monospace;
}

.chat-ai .md-prose pre {
  background: var(--nm-chat-code-bg);
  color: var(--nm-chat-code-text);
  padding: 12px;
  border-radius: 8px;
  margin: 0.75em 0;
  overflow-x: auto;
}

.chat-ai .md-prose pre code {
  background: transparent;
  color: inherit;
  padding: 0;
}

/* Inline actions in assistant bubbles */
.chat-ai .bubble-actions {
  position: absolute;
  top: 8px;
  right: 8px;
  opacity: 0;
  transition: opacity 0.2s ease;
  display: flex;
  gap: 4px;
}

.chat-ai:hover .bubble-actions {
  opacity: 1;
}

.bubble-actions button {
  width: 24px;
  height: 24px;
  border-radius: 6px;
  border: none;
  background: var(--nm-ui-bubble-action-bg);
  color: var(--nm-text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  transition: all 0.2s ease;
}

.bubble-actions button:hover {
  background: var(--nm-paper);
  color: var(--nm-primary);
  transform: scale(1.1);
}

/* Typing indicator - premium status row */
.typing-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--nm-paper);
  border-radius: var(--nm-radius);
  box-shadow: var(--nm-shadow-sm);
  margin: 12px 0;
  font-size: 13px;
  color: var(--nm-text-secondary);
  max-width: fit-content;
}

.typing-dots {
  display: flex;
  gap: 4px;
}

.typing-dots span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--nm-accent);
  opacity: 0.4;
  animation: typing-bounce 1.4s infinite;
}

.typing-dots span:nth-child(1) { animation-delay: 0s; }
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing-bounce {
  0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
  40% { transform: translateY(-4px); opacity: 1; }
}

/* Premium attachment dock */
.attachment-dock {
  background: var(--nm-paper);
  border-radius: var(--nm-radius);
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: var(--nm-shadow-sm);
  border: var(--nm-border);
}

.attachment-dock-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
  font-size: 13px;
  color: var(--nm-text-secondary);
  font-weight: 500;
}

.attachment-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 8px;
  max-height: 200px;
  overflow-y: auto;
}

.attachment-card {
  position: relative;
  background: var(--nm-bg-attachment-card);
  border: var(--nm-border);
  border-radius: 8px;
  padding: 8px;
  transition: all 0.2s ease;
  cursor: pointer;
}

.attachment-card:hover {
  background: var(--nm-bg-skeleton);
  box-shadow: var(--nm-shadow);
  transform: translateY(-2px);
}

.attachment-card.unsupported {
  opacity: 0.6;
  cursor: not-allowed;
}

.attachment-thumbnail {
  width: 100%;
  height: 80px;
  object-fit: cover;
  border-radius: 6px;
  margin-bottom: 6px;
}

.attachment-icon {
  width: 100%;
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--nm-bg-skeleton-shine);
  border-radius: 6px;
  margin-bottom: 6px;
  color: var(--nm-text-secondary);
  font-size: 24px;
}

.attachment-name {
  font-size: 11px;
  font-weight: 500;
  color: var(--nm-text-primary);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  margin-bottom: 2px;
}

.attachment-meta {
  font-size: 9px;
  color: var(--nm-text-muted);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.attachment-status {
  font-size: 9px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 500;
}

.attachment-status.ready { background: var(--nm-bg-attachment-ready); color: var(--nm-text-attachment-ready); }
.attachment-status.queued { background: var(--nm-bg-attachment-queued); color: var(--nm-text-attachment-queued); }
.attachment-status.error { background: var(--nm-bg-attachment-error); color: var(--nm-text-attachment-error); }

.attachment-remove {
  position: absolute;
  top: 4px;
  right: 4px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.attachment-card:hover .attachment-remove {
  opacity: 1;
}

.attachment-remove:hover {
  background: rgba(0, 0, 0, 0.8);
  transform: scale(1.1);
}

/* Dropzone - ChatGPT-style unified floating bar */
.dropzone {
  border: none;
  border-radius: 9999px; /* Fully rounded like ChatGPT */
  padding: 0;
  text-align: center;
  transition: all 0.3s ease;
  background: var(--nm-paper);
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
  max-width: 768px;
  margin: 0 auto;
}

/* Dark mode shadow */
[data-theme="dark"] .dropzone {
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2);
}

.dropzone.dragover {
  background: var(--nm-bg-dropzone-hover);
  box-shadow: 0 0 0 2px var(--nm-accent-focus-ring);
}

.dropzone.dragover::before {
  content: 'Drop files to attach';
  display: block;
  color: var(--nm-accent);
  font-weight: 600;
  margin-top: 8px;
}

/* Premium sidebar */
.sidebar {
  background: var(--nm-glass);
  backdrop-filter: blur(12px);
  border-right: var(--nm-border);
  box-shadow: var(--nm-shadow-lg);
}

/* Collapsed sidebar styles */
.sidebar.sidebar-collapsed {
  width: 60px !important;
}

.sidebar.sidebar-collapsed .sidebar-logo-container {
  width: 24px;
  justify-content: center;
  overflow: visible;
}

.sidebar.sidebar-collapsed .sidebar-logo-heart {
  display: none !important;
}

.sidebar.sidebar-collapsed .sidebar-logo-icon {
  display: flex !important;
  align-items: center;
  justify-content: center;
}

.sidebar.sidebar-expanded .sidebar-logo-heart {
  display: block !important;
}

.sidebar.sidebar-expanded .sidebar-logo-icon {
  display: none !important;
}

/* Expanded state - full logo */
.sidebar.sidebar-expanded .sidebar-logo {
  height: 32px;
  width: auto;
}

.sidebar.sidebar-collapsed .sidebar-toggle-btn {
  display: none !important;
}

.sidebar.sidebar-expanded .sidebar-toggle-btn {
  display: flex !important;
  align-items: center;
  justify-content: center;
}

.sidebar.sidebar-expanded .sidebar-icon-svg {
  color: #6b7280;
  width: 16px;
  height: 16px;
}

/* Show "Open sidebar" panel on hover when collapsed */
.sidebar.sidebar-collapsed:hover .sidebar-open-hover {
  display: flex !important;
}

.sidebar.sidebar-expanded .sidebar-open-hover {
  display: none !important;
}

/* Position the hover panel correctly */
.sidebar.sidebar-collapsed .sidebar-header-container {
  position: relative;
}

.sidebar.sidebar-collapsed .sidebar-search-container,
.sidebar.sidebar-collapsed .sidebar-menu-text,
.sidebar.sidebar-collapsed .sidebar-badge,
.sidebar.sidebar-collapsed #sessionListContainer,
.sidebar.sidebar-collapsed .sidebar-footer-text {
  display: none !important;
}

.sidebar.sidebar-collapsed .sidebar-menu-item {
  justify-content: center;
  padding: 12px;
}

.sidebar.sidebar-collapsed .sidebar-menu-item i {
  margin: 0;
  font-size: 18px !important;
}

.sidebar.sidebar-collapsed .sidebar-menu-item svg {
  width: 22px !important;
  height: 22px !important;
  flex-shrink: 0;
}

.sidebar.sidebar-collapsed .sidebar-user-btn {
  justify-content: center;
  padding: 8px;
  width: 100%;
}

.sidebar.sidebar-collapsed .sidebar-user-icon {
  width: 32px !important;
  height: 32px !important;
  border-radius: 50% !important;
  flex-shrink: 0;
}

.session-card {
  background: var(--nm-paper);
  border: var(--nm-border);
  border-radius: var(--nm-radius);
  padding: 12px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.session-card:hover {
  background: var(--nm-bg-skeleton);
  box-shadow: var(--nm-shadow);
  transform: translateX(2px);
}

.session-card.active {
  background: var(--nm-bg-dropzone);
  border-left: 3px solid var(--nm-accent);
  box-shadow: var(--nm-shadow);
}

.session-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--nm-text-primary);
  margin-bottom: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}


.session-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 11px;
  color: var(--nm-text-muted);
}

.session-chips {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.session-chip {
  font-size: 9px;
  padding: 2px 6px;
  border-radius: 4px;
  background: var(--nm-bg-skeleton-shine);
  color: var(--nm-text-secondary);
  font-weight: 500;
}

.session-menu {
  position: absolute;
  top: 8px;
  right: 8px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.session-card:hover .session-menu {
  opacity: 1;
}

/* Premium buttons */
.btn-primary {
  background: var(--nm-primary);
  color: white;
  border: none;
  border-radius: var(--nm-radius);
  padding: 10px 20px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-primary:hover {
  background: var(--nm-primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--nm-shadow-lg);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-pill {
  border-radius: 9999px;
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 500;
}

/* Premium chips */
.chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 9999px;
  font-size: 12px;
  font-weight: 500;
  background: var(--nm-bg-skeleton);
  color: var(--nm-text-secondary);
  border: var(--nm-border);
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.chip:hover {
  background: var(--nm-bg-skeleton-shine);
  transform: translateY(-1px);
  box-shadow: var(--nm-shadow-sm);
}

.chip:hover .fa-chevron-down {
  color: var(--nm-accent);
  transform: translateY(2px);
}

.chip:active {
  transform: translateY(0);
}

.chip.active {
  background: var(--nm-accent);
  color: white;
  border-color: var(--nm-accent);
}

.chip.active .fa-chevron-down {
  color: white;
}

/* Premium popovers */
.popover {
  position: fixed;
  background: var(--nm-paper);
  border: var(--nm-border);
  border-radius: var(--nm-radius-lg);
  box-shadow: var(--nm-shadow-xl);
  padding: 12px;
  z-index: 1000;
  min-width: 280px;
  max-width: 320px;
  max-height: 80vh;
  overflow-y: auto;
  animation: fadeInUp 0.2s ease-out;
  transition: opacity 0.2s ease, transform 0.2s ease;
}

/* Session menu popover needs higher z-index to appear above session cards */
.session-menu-popover {
  z-index: 9999 !important;
  position: fixed !important;
  pointer-events: auto !important;
}

.popover .tone-option {
  position: relative;
  border: 1px solid transparent;
}

.popover .tone-option:hover {
  border-color: rgba(40, 146, 109, 0.3);
  transform: translateX(2px);
}

.popover .tone-option:active {
  transform: scale(0.98);
}

/* Active tone option - improved contrast with softer green */
.popover .tone-option.active-tone {
  background-color: var(--nm-accent-softer) !important;
  color: white !important;
}

.popover .tone-option.active-tone .tone-title,
.popover .tone-option.active-tone .tone-description {
  color: white !important;
}

.popover .tone-option.active-tone .tone-icon {
  color: white !important;
  opacity: 0.95;
}

.popover .tone-option.active-tone .tone-check {
  color: white !important;
}

/* Also handle Tailwind class for compatibility */
.popover .tone-option[class*="bg-\[#28926D\]"] .tone-title,
.popover .tone-option[class*="bg-\[#28926D\]"] .tone-description {
  color: white !important;
}

.popover .tone-option[class*="bg-\[#28926D\]"] .tone-icon {
  color: white !important;
  opacity: 0.95;
}

/* Premium modals */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.2s ease-out;
}

.modal-content {
  background: var(--nm-paper);
  border-radius: var(--nm-radius-xl);
  box-shadow: var(--nm-shadow-xl);
  max-width: 90vw;
  max-height: 90vh;
  overflow: auto;
  animation: scaleIn 0.2s ease-out;
}

/* Base tone selector styles */
.base-tone-option.selected {
  background: var(--nm-accent) !important;
  border-color: var(--nm-accent) !important;
  color: white;
}

.base-tone-option.selected .font-medium,
.base-tone-option.selected .text-gray-800 {
  color: white !important;
}

.base-tone-option.selected .text-gray-500 {
  color: rgba(255, 255, 255, 0.9) !important;
}

.base-tone-option.selected i:not(.base-tone-check) {
  color: white !important;
}

.base-tone-option.selected .base-tone-check {
  opacity: 1 !important;
  color: white !important;
}

/* Mobile responsive settings modal */
@media (max-width: 768px) {
  .modal-content {
    max-width: 100vw;
    max-height: 100vh;
    border-radius: 0;
    flex-direction: column;
  }
  
  /* Hide left navigation panel on mobile */
  #settingsModal .modal-content > div.hidden.md\:flex {
    display: none !important;
  }
  
  /* Mobile dropdown styling */
  #settingsMobileDropdown {
    font-size: 16px !important; /* Prevents zoom on iOS */
    min-height: 48px;
    padding: 12px 16px;
    border: 1px solid var(--nm-border-color);
    border-radius: var(--nm-radius);
    background: var(--nm-paper);
    color: var(--nm-text-primary);
    flex: 1; /* Takes remaining space, leaving room for X button */
  }
  
  /* Close button on mobile - positioned beside dropdown */
  #settingsModal .md\:hidden.flex button {
    min-width: 40px;
    min-height: 40px;
  }
  
  /* Content area - full width on mobile */
  #settingsModal .modal-content > div.flex-1 {
    width: 100% !important;
    padding: 1rem !important;
  }
  
  #settingsModal .flex-1.overflow-y-auto {
    padding: 1rem !important;
    max-height: calc(100vh - 80px);
    overflow-y: auto;
  }
  
  /* Settings navigation items - hidden on mobile */
  .settings-nav-item {
    display: none !important;
  }
  
  /* Stack characteristics on mobile */
  .grid.grid-cols-1.sm\:grid-cols-2 {
    grid-template-columns: 1fr !important;
  }
  
  /* Make selects full width on mobile */
  .flex.items-center.justify-between {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 0.75rem !important;
  }
  
  .flex.items-center.justify-between select,
  .flex.items-center.justify-between > div:last-child {
    width: 100% !important;
    margin-left: 0 !important;
  }
  
  /* Inputs and textareas - mobile friendly */
  input[type="text"],
  input[type="email"],
  textarea,
  select {
    font-size: 16px !important; /* Prevents zoom on iOS */
    min-height: 44px !important;
    padding: 12px 16px !important;
  }
  
  /* Buttons - mobile touch targets */
  button:not(.chip):not(.tone-option):not(.base-tone-option),
  .btn-primary {
    min-height: 44px !important;
    min-width: 44px !important;
    padding: 12px 20px !important;
    font-size: 15px !important;
  }
  
  /* Popovers - mobile full width */
  .popover,
  .session-menu-popover {
    max-width: calc(100vw - 32px) !important;
    left: 16px !important;
    right: 16px !important;
  }
  
  /* Search modal - mobile full screen */
  #searchModal {
    padding: 1rem !important;
  }
  
  #searchModal .modal-content {
    max-width: 100vw !important;
    max-height: 100vh !important;
    border-radius: 0 !important;
  }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(12px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Settings Navigation */
.settings-nav-item {
  color: var(--nm-text-gray-600);
}

.settings-nav-item:hover {
  background-color: var(--nm-bg-skeleton);
}

.settings-nav-item.active {
  background-color: var(--nm-bg-skeleton);
  color: var(--nm-text-gray-800);
}

.settings-nav-item.active i {
  color: var(--nm-text-gray-800);
}

@keyframes fadeOut {
  from {
    opacity: 1;
    transform: translateX(0);
  }
  to {
    opacity: 0;
    transform: translateX(-20px);
  }
}

/* Toast system */
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--nm-paper);
  border: var(--nm-border);
  border-radius: var(--nm-radius);
  box-shadow: var(--nm-shadow-xl);
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 300px;
  max-width: 400px;
  z-index: 1000;
  animation: slideInRight 0.3s ease-out;
}

.toast.success { border-left: 3px solid var(--nm-accent); }
.toast.error { border-left: 3px solid var(--nm-ui-toast-error-border); }
.toast.info { border-left: 3px solid var(--nm-primary); }

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(100%);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* Geriatric mode */
body.geriatric-zoom {
  --nm-zoom: 1.25;
  font-size: 112%;
}

body.geriatric-zoom .chat-bubble {
  font-size: 18px;
  line-height: 1.6;
  padding: 16px 20px;
}

body.geriatric-zoom button {
  min-height: 44px;
  padding: 12px 20px;
}

/* Mobile optimizations */
@media (max-width: 768px) {
  /* iOS Safari 100vh fix */
  @supports (height: 100dvh) {
    .h-screen {
      height: 100dvh;
    }
  }
  
  /* Touch optimization */
  * {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  
  button, a {
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
  }
  
  /* Sidebar mobile behavior - override hidden class */
  .sidebar {
    position: fixed !important;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 50 !important;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    display: flex !important; /* Override hidden class on mobile */
    width: 320px !important;
    max-width: 85vw !important;
  }
  
  .sidebar.sidebar-open {
    transform: translateX(0) !important;
  }
  
  /* Mobile overlay */
  #mobileOverlay {
    z-index: 40 !important;
    display: none;
  }
  
  #mobileOverlay:not(.hidden) {
    display: block !important;
    opacity: 1;
  }
  
  /* Ensure main content is visible on mobile */
  main {
    width: 100% !important;
    margin-left: 0 !important;
    padding: 0 !important;
  }
  
  /* Header - mobile optimized */
  .chat-header {
    padding: 12px 16px !important;
    flex-wrap: nowrap !important;
    gap: 8px !important;
  }
  
  .chat-header h1 {
    font-size: 18px !important;
    flex: 1;
    min-width: 0;
  }
  
  /* Logo on mobile header - smaller to fit */
  .chat-header img {
    height: 24px !important;
    width: auto;
    flex-shrink: 0;
    object-fit: contain;
  }
  
  /* Globe icon on mobile - no padding, positioned at far right */
  #langBtn {
    padding: 0 !important;
    margin: 0 !important;
    min-width: 32px !important;
    min-height: 32px !important;
  }
  
  .chat-header > div > div:last-child {
    gap: 0 !important;
    margin-left: auto;
  }
  
  /* Hide desktop-only elements on mobile */
  #activeChips {
    display: none !important;
  }
  
  /* Hide NEW badge on mobile */
  #imagesNewBadge {
    display: none !important;
  }
  
  /* Hide "Select multiple" button on mobile */
  #toggleBulkSelectContainer {
    display: none !important;
  }
  
  /* Sidebar menu items - mobile touch targets and left alignment */
  .sidebar-menu-item {
    min-height: 48px;
    padding: 14px 16px !important;
    justify-content: flex-start !important; /* Force left alignment on mobile */
  }
  
  /* Search input - fix icon overlap on mobile */
  .sidebar-search-input {
    padding-left: 2.75rem !important; /* Ensure enough space for icon */
    padding-right: 0.75rem !important;
  }
  
  .sidebar-search-container .fa-magnifying-glass {
    left: 0.875rem !important; /* Adjust icon position */
    top: 50% !important;
    transform: translateY(-50%) !important;
    pointer-events: none;
  }
  
  /* Session cards - mobile optimized */
  .session-card {
    min-height: 60px;
    padding: 14px 16px !important;
  }
  
  /* User menu button - mobile */
  .sidebar-user-btn {
    min-height: 48px;
    padding: 12px 16px !important;
  }
  
  /* Attachment dock - mobile */
  .attachment-dock {
    padding: 12px !important;
    margin-bottom: 12px;
  }
  
  /* First message view - mobile */
  #firstMessageView {
    padding: 24px 16px !important;
  }
  
  .first-message-input-container {
    padding: 12px !important;
  }
  
  /* Bulk actions - mobile */
  #bulkActionsBar {
    padding: 12px 16px !important;
    flex-wrap: wrap;
  }
  
  #bulkActionsBar button {
    min-height: 40px;
    padding: 8px 16px !important;
    font-size: 14px;
  }
  
  /* Chat bubbles - mobile optimized */
  .chat-bubble {
    max-width: 85%;
    font-size: 15px;
    padding: 12px 16px;
    line-height: 1.5;
  }
  
  .chat-user {
    margin-left: auto;
    margin-right: 0;
  }
  
  .chat-ai {
    margin-left: 0;
    margin-right: auto;
  }
  
  /* Chat window - mobile padding */
  #chatWindow {
    padding: 12px 16px;
    padding-bottom: calc(100px + env(safe-area-inset-bottom));
  }
  
  /* Composer - mobile optimized */
  .composer-area {
    padding: 12px 16px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
    position: sticky;
    bottom: 0;
    background: var(--nm-bg-body-start);
    z-index: 20;
  }
  
  /* Dropzone - mobile touch targets */
  .dropzone {
    padding: 10px 12px;
    max-width: 100%;
  }
  
  /* Buttons - minimum 44x44px touch target */
  #attachBtn,
  #micBtn,
  #sendBtn,
  #toneBtn {
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  #attachBtn {
    width: 44px;
    height: 44px;
  }
  
  #micBtn,
  #sendBtn {
    width: 44px;
    height: 44px;
  }
  
  /* Chat input - mobile optimized */
  #chatInput {
    font-size: 16px; /* Prevents zoom on iOS */
    padding: 12px 16px;
    min-height: 44px;
  }
  
  /* Header - mobile optimized */
  .chat-header {
    padding: 12px 16px;
  }
  
  .chat-header h1 {
    font-size: 18px;
  }
  
  /* Session cards - mobile optimized */
  .session-card {
    padding: 14px;
    margin-bottom: 10px;
  }
  
  .session-title {
    font-size: 15px;
  }
  
  /* Attachment grid - mobile */
  .attachment-grid {
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 8px;
  }
  
  /* Toast - mobile full width */
  .toast {
    bottom: 16px;
    right: 16px;
    left: 16px;
    max-width: none;
    margin: 0;
  }
  
  /* First message view - mobile optimized */
  #firstMessageView {
    padding: 24px 16px;
  }
  
  .first-message-heading {
    font-size: 24px;
    margin-bottom: 24px;
  }
  
  .first-message-input-container {
    padding: 12px;
  }
  
  .first-message-input {
    font-size: 16px;
    padding: 14px 16px;
    min-height: 44px;
  }
  
  /* Settings modal - mobile full screen */
  #settingsModal .modal-content {
    max-width: 100vw;
    max-height: 100vh;
    border-radius: 0;
    margin: 0;
  }
  
  /* Jump to latest - mobile position */
  .jump-to-latest {
    bottom: calc(100px + env(safe-area-inset-bottom));
    right: 16px;
    width: 44px;
    height: 44px;
  }
  
  /* Bulk actions bar - mobile optimized */
  #bulkActionsBar {
    padding: 12px 16px;
    flex-wrap: wrap;
    gap: 8px;
  }
  
  /* Search modal - mobile full screen */
  #searchModal {
    border-radius: 0;
  }
  
  /* Tone selector - mobile friendly */
  .tone-option {
    min-height: 44px;
    padding: 12px;
  }
  
  /* Base tone selector - mobile grid */
  #baseStyleToneSelector {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .base-tone-option {
    min-height: 60px;
    padding: 16px;
  }
}

/* Small phones (<= 375px) */
@media (max-width: 375px) {
  .chat-bubble {
    max-width: 90%;
    font-size: 14px;
    padding: 10px 14px;
  }
  
  #chatWindow {
    padding: 10px 12px;
  }
  
  .composer-area {
    padding: 10px 12px;
  }
  
  .dropzone {
    padding: 8px 10px;
  }
  
  .first-message-heading {
    font-size: 20px;
  }
  
  .session-card {
    padding: 12px;
  }
  
  .session-title {
    font-size: 14px;
  }
}

/* Very small phones (<= 320px) */
@media (max-width: 320px) {
  .chat-bubble {
    max-width: 95%;
    font-size: 13px;
    padding: 8px 12px;
  }
  
  #chatInput {
    font-size: 16px;
    padding: 10px 12px;
  }
  
  #attachBtn,
  #micBtn,
  #sendBtn {
    width: 40px;
    height: 40px;
  }
  
  .first-message-heading {
    font-size: 18px;
  }
}

/* Accessibility */
*:focus-visible {
  outline: 2px solid var(--nm-accent);
  outline-offset: 2px;
}

/* Skeleton loaders */
.skeleton {
  background: linear-gradient(90deg, var(--nm-bg-skeleton) 25%, var(--nm-bg-skeleton-shine) 50%, var(--nm-bg-skeleton) 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Jump to latest button */
.jump-to-latest {
  position: fixed;
  bottom: 100px;
  right: 24px;
  background: var(--nm-primary);
  color: white;
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--nm-shadow-lg);
  cursor: pointer;
  z-index: 10;
  transition: all 0.2s ease;
  opacity: 0;
  pointer-events: none;
}

.jump-to-latest.visible {
  opacity: 1;
  pointer-events: all;
}

.jump-to-latest:hover {
  transform: translateY(-2px);
  box-shadow: var(--nm-shadow-xl);
}

/* Microphone button enhancements */
#micBtn {
  position: relative;
  transition: all 0.3s ease;
}

#micBtn.listening {
  animation: micPulse 1.5s ease-in-out infinite;
  box-shadow: 0 0 0 0 rgba(35, 96, 146, 0.7);
}

@keyframes micPulse {
  0% {
    box-shadow: 0 0 0 0 rgba(35, 96, 146, 0.7);
  }
  50% {
    box-shadow: 0 0 0 8px rgba(35, 96, 146, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(35, 96, 146, 0);
  }
}

#micBtn:disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

#micBtn:not(:disabled):hover {
  transform: scale(1.05);
}

#micBtn.listening i {
  animation: micIconBounce 0.6s ease-in-out infinite;
}

@keyframes micIconBounce {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
}
</style>
</head>
<body>
  <!-- 3-Zone Architecture -->
  <div id="appShell" class="w-full h-screen flex overflow-hidden">
    
    <!-- Zone 1: Premium Sidebar -->
    <aside id="sidebar" class="sidebar w-[320px] flex flex-col h-full overflow-hidden hidden md:flex transition-all duration-300 sidebar-expanded sidebar-content">
      <!-- Sidebar Header -->
      <div class="p-3 border-b border-gray-200/80 relative sidebar-header-container">
        <div class="flex items-center justify-between w-full">
          <div class="flex items-center gap-2 justify-center flex-1 sidebar-logo-container overflow-hidden">
            <!-- Heart Logo (shown when expanded) -->
            <img src="https://res.cloudinary.com/djzks0atj/image/upload/v1759412135/NeuroMed_AI_Logo-10_yassi6.png" 
                 alt="NeuroMed AI" 
                 class="h-8 sidebar-logo sidebar-logo-heart" />
            <!-- Sidebar Icon (shown when collapsed) -->
            <button id="sidebarIconBtn" type="button" class="p-1.5 hover:bg-gray-100 rounded-lg transition sidebar-logo-icon hidden" aria-label="Open sidebar">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="1" y="2" width="14" height="12" rx="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                <line x1="6" y1="2" x2="6" y2="14" stroke="currentColor" stroke-width="1.5"/>
              </svg>
            </button>
          </div>
          <button id="toggleHistoryBtn" type="button" class="p-1.5 hover:bg-gray-100 rounded-lg transition sidebar-toggle-btn" aria-label="Toggle sidebar">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="sidebar-icon-svg">
              <rect x="1" y="2" width="14" height="12" rx="2" stroke="currentColor" stroke-width="1.5" fill="none"/>
              <line x1="6" y1="2" x2="6" y2="14" stroke="currentColor" stroke-width="1.5"/>
            </svg>
          </button>
        </div>
        
        <!-- Open Sidebar Hover Panel (shown on hover when collapsed) -->
        <div class="sidebar-open-hover hidden absolute left-full top-0 ml-2 z-50 flex items-center gap-2">
          <!-- Sidebar Icon -->
          <div class="w-8 h-8 bg-gray-200 rounded-lg flex items-center justify-center">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="2" y="2" width="4" height="12" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
              <rect x="8" y="2" width="6" height="12" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
            </svg>
          </div>
          <!-- Open Sidebar Button -->
          <button id="openSidebarHoverBtn" class="px-4 py-2 bg-gray-900 hover:bg-gray-800 text-white rounded-full transition text-sm font-medium whitespace-nowrap shadow-lg">
            Open sidebar
        </button>
        </div>
      </div>
      
      <!-- Search Zone -->
      <div class="px-3 py-2 border-b border-gray-200/80 sidebar-search-container">
        <div class="relative">
          <input type="text" 
                 id="sessionSearch" 
                 placeholder="Search sessions, keywords, summaries" 
                 class="w-full px-4 py-2 pl-10 pr-3 text-sm border border-token-gray-200 rounded-lg focus-ring-accent bg-token-paper sidebar-search-input" />
          <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
        </div>
      </div>
      
      <!-- Sidebar Menu -->
      <div class="px-3 py-2 border-b border-gray-200/80">
        <div class="space-y-1">
          <button id="sidebarNewChat" class="w-full flex items-center justify-start gap-3 px-3 py-2.5 hover:bg-gray-100 rounded-lg transition text-left sidebar-menu-item">
            <i class="fa-regular fa-pen-to-square text-gray-700 text-base"></i>
            <span class="text-sm font-medium text-gray-800 sidebar-menu-text">New chat</span>
          </button>
          <button id="sidebarSearchChats" class="w-full flex items-center justify-start gap-3 px-3 py-2.5 hover:bg-gray-100 rounded-lg transition text-left sidebar-menu-item">
            <svg width="22" height="22" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-gray-800">
              <circle cx="7" cy="7" r="4.5" stroke="currentColor" stroke-width="1.5" fill="none"/>
              <path d="M10.5 10.5 L13.5 13.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            <span class="text-sm font-medium text-gray-800 sidebar-menu-text">Search chats</span>
          </button>
          <button id="sidebarImages" class="w-full flex items-center justify-start gap-3 px-3 py-2.5 hover:bg-gray-100 rounded-lg transition text-left relative sidebar-menu-item">
            <i class="fa-regular fa-images text-gray-700 text-base"></i>
            <span class="text-sm font-medium text-gray-800 sidebar-menu-text">Images</span>
            <span id="imagesNewBadge" class="hidden ml-auto px-2 py-0.5 text-xs font-semibold text-gray-600 bg-gray-200 rounded-full sidebar-badge">NEW</span>
          </button>
          <button id="sidebarApps" class="w-full flex items-center justify-start gap-3 px-3 py-2.5 hover:bg-gray-100 rounded-lg transition text-left sidebar-menu-item">
            <i class="fa-solid fa-th-large text-gray-700 text-base"></i>
            <span class="text-sm font-medium text-gray-800 sidebar-menu-text">Apps</span>
          </button>
        </div>
      </div>
      
      <!-- Session List (Collapsible) -->
      <div id="sessionListContainer" class="flex-1 overflow-y-auto p-4">
        <!-- Toggle Bulk Select Button (shown when not in bulk mode) -->
        <div id="toggleBulkSelectContainer" class="mb-2 flex justify-end">
          <button id="toggleBulkSelectBtn" class="text-xs text-gray-500 hover:text-gray-700 px-2 py-1 rounded transition flex items-center gap-1">
            <i class="fa-solid fa-check-square text-xs"></i>
            <span>Select multiple</span>
          </button>
        </div>
        
        <!-- Bulk Actions Bar (hidden by default) -->
        <div id="bulkActionsBar" class="hidden mb-3 px-3 py-2 bg-token-paper border-b border-token-border-color">
          <div class="flex items-center justify-between gap-4 overflow-hidden">
            <div class="flex items-center gap-3 flex-shrink-0">
              <span id="selectedCount" class="text-xs font-medium text-token-text-primary whitespace-nowrap">0 selected</span>
              <button id="selectAllBtn" class="text-xs text-token-accent hover:text-token-accent-dark font-medium transition whitespace-nowrap flex-shrink-0">
                Select all
              </button>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0 ml-auto">
              <button id="bulkDeleteBtn" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-medium disabled:opacity-50 disabled:cursor-not-allowed transition whitespace-nowrap flex-shrink-0">
                Delete
              </button>
              <button id="cancelBulkSelectBtn" onclick="toggleBulkSelect()" class="w-7 h-7 flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition flex-shrink-0" title="Cancel selection">
                <i class="fa-solid fa-xmark text-sm"></i>
              </button>
            </div>
          </div>
        </div>
        
        <ul id="sessionList" class="space-y-2">
          <!-- Sessions will be populated by JS -->
        </ul>
        
        <!-- Archived Section (collapsible) -->
        <div id="archivedSection" class="mt-6 hidden">
          <button id="toggleArchived" class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 flex items-center gap-2 hover:text-gray-700 transition">
            <i class="fa-solid fa-chevron-down"></i>
            <span>Archived</span>
          </button>
          <ul id="archivedList" class="space-y-2 hidden">
            <!-- Archived sessions -->
          </ul>
        </div>
      </div>
      
      <!-- Sidebar Footer -->
      <div class="p-4 border-t border-gray-200/80">
        <button id="userMenuBtn" class="w-full flex items-center justify-center md:justify-start gap-3 p-2 hover:bg-gray-100 rounded-lg transition sidebar-user-btn">
          <div class="w-8 h-8 rounded-full bg-token-primary flex items-center justify-center text-white font-semibold sidebar-user-icon">
            <i class="fa-solid fa-user"></i>
          </div>
          <div class="flex-1 text-left sidebar-footer-text">
            <div class="text-sm font-medium text-gray-800" id="userDisplayName">User</div>
            <div class="text-xs text-gray-500">Settings & Logout</div>
          </div>
          <i class="fa-solid fa-chevron-right text-gray-400 sidebar-footer-text"></i>
        </button>
      </div>
    </aside>
    
    <!-- Zone 2: Main Chat Area -->
    <main class="flex-1 flex flex-col h-full overflow-hidden chat-main-area relative">
      <!-- Header -->
      <header class="px-6 py-4 border-b chat-header">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4 flex-1">
            <!-- Mobile burger -->
            <button id="burgerBtn" class="md:hidden p-3 hover:bg-gray-100 rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center touch-manipulation" aria-label="Toggle sidebar" type="button">
              <i class="fa-solid fa-bars text-gray-600 text-lg"></i>
            </button>
            
            <!-- Open Sidebar Button (shown when sidebar is hidden) -->
            <button id="openSidebarBtn" class="hidden px-4 py-2 bg-gray-900 hover:bg-gray-800 text-white rounded-lg transition text-sm font-medium">
              Open sidebar
            </button>
            
            <!-- Logo on mobile, text on desktop -->
            <img src="https://res.cloudinary.com/djzks0atj/image/upload/v1759412135/NeuroMed_AI_Logo-10_yassi6.png" 
                 alt="NeuroMed AI" 
                 class="md:hidden h-6 w-auto" />
            <h1 class="hidden md:block text-xl font-semibold text-gray-800">NeuroMed AI</h1>
            
            <!-- Active chips (tone, care, faith, language) -->
            <div id="activeChips" class="hidden md:flex items-center gap-2">
              <!-- Populated by JS -->
            </div>
          </div>
          
          <div class="flex items-center gap-2">
            <!-- Language Picker -->
            <button id="langBtn" class="md:p-2 hover:bg-gray-100 rounded-lg transition flex items-center justify-center min-w-[32px] min-h-[32px] md:min-w-[40px] md:min-h-[40px]" aria-label="Language">
              <i class="fa-solid fa-globe text-gray-600 text-base md:text-lg"></i>
            </button>
            
            <!-- Security indicator -->
            <div class="hidden md:flex items-center gap-2 text-xs text-gray-500">
              <i class="fa-solid fa-lock"></i>
              <span>Secure</span>
            </div>
          </div>
        </div>
      </header>
      
      <!-- Chat Window -->
      <div id="chatWindow" class="flex-1 overflow-y-auto px-6 py-6 space-y-4 chat-window">
        <!-- Messages will be populated here -->
        <!-- Empty state will show here if no messages -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center h-full text-center px-4">
          <div class="mb-6">
            <i class="fa-solid fa-brain text-6xl text-token-primary opacity-20"></i>
          </div>
          <h2 class="text-2xl font-semibold text-gray-800 mb-2" id="greetingText">Hi there!</h2>
          <p class="text-gray-600 mb-6 max-w-md">What are we reviewing today?</p>
          <div class="flex flex-wrap gap-2 justify-center">
            <button class="chip" onclick="quickPrompt('Summarize this discharge note')">
              Summarize discharge note
            </button>
            <button class="chip" onclick="quickPrompt('Explain these lab results')">
              Explain lab results
            </button>
            <button class="chip" onclick="quickPrompt('Compare two documents')">
              Compare documents
            </button>
            <button class="chip" onclick="quickPrompt('Draft caregiver-friendly plan')">
              Caregiver plan
            </button>
          </div>
        </div>
      </div>
      
      <!-- Centered First Message View (overlays main content area only) -->
      <div id="firstMessageView" class="hidden absolute inset-0 flex flex-col items-center justify-center chat-main-area z-10">
        <h2 id="firstMessageHeading" class="text-2xl font-medium first-message-heading mb-8">Hi there! How can I help you?</h2>
        <div class="w-full max-w-2xl px-4">
          <div class="flex items-center gap-3 first-message-input-container border rounded-full px-4 py-4 shadow-sm">
            <button id="firstAttachBtn" class="shrink-0 w-8 h-8 rounded-full first-message-btn flex items-center justify-center transition">
              <i class="fa-solid fa-plus first-message-icon text-sm"></i>
            </button>
            <input type="file" id="firstFileInput" class="hidden" multiple accept=".pdf,.docx,.txt,.jpg,.jpeg,.png,.webp,.heic" />
            <input type="text" 
                   id="firstChatInput" 
                   placeholder="Ask anything" 
                   class="flex-1 min-w-0 text-base first-message-input border-none focus:outline-none bg-transparent" />
            <button id="firstMicBtn" class="shrink-0 w-8 h-8 rounded-full first-message-btn flex items-center justify-center transition">
              <i class="fa-solid fa-microphone first-message-icon text-sm"></i>
            </button>
            <button id="firstSendBtn" class="shrink-0 w-10 h-10 rounded-full bg-token-primary hover:bg-token-primary-dark text-white flex items-center justify-center transition">
              <i class="fa-solid fa-arrow-up text-white text-sm"></i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Jump to latest button -->
      <button id="jumpToLatest" class="jump-to-latest">
        <i class="fa-solid fa-arrow-down"></i>
      </button>
      
      <!-- Zone 3: Premium Composer -->
      <div id="composer" class="composer-area backdrop-blur-sm p-4">
        <!-- Attachment Dock -->
        <div id="attachmentDock" class="attachment-dock hidden">
          <div class="attachment-dock-header">
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-paperclip text-gray-500"></i>
              <span>Pending attachments</span>
              <span id="attachmentCount" class="text-xs bg-gray-200 px-2 py-0.5 rounded-full">0</span>
            </div>
            <button id="clearAllBtn" class="text-xs text-red-600 hover:text-red-700 font-medium">
              Clear all
            </button>
          </div>
          <div id="attachmentGrid" class="attachment-grid">
            <!-- Attachments will be populated here -->
          </div>
          <div id="fileLimitWarning" class="hidden mt-2 text-xs text-amber-600 bg-amber-50 p-2 rounded">
            <i class="fa-solid fa-exclamation-triangle mr-1"></i>
            15 file limit reached. Remove one to add more.
          </div>
        </div>
        
        <!-- Composer Input Area - ChatGPT-style unified floating bar -->
        <div id="dropzone" class="dropzone flex items-center gap-2 px-4 py-3 rounded-full bg-token-paper shadow-lg">
          <!-- Attach Button -->
          <button id="attachBtn" class="shrink-0 w-8 h-8 flex items-center justify-center transition hover:bg-gray-100 rounded-full" title="Attach files (Up to 15 files  PDF/DOCX/TXT/Images)">
            <i class="fa-solid fa-plus text-gray-700 text-lg"></i>
          </button>
          <input type="file" id="fileInput" class="hidden" multiple accept=".pdf,.docx,.txt,.jpg,.jpeg,.png,.webp,.heic" />
          
          <!-- Text Input - No border, seamless integration -->
          <input type="text" 
                 id="chatInput" 
                 placeholder="Ask anything" 
                 class="flex-1 min-w-0 px-2 py-2 text-base border-none rounded-full focus:outline-none focus:ring-0 bg-transparent placeholder:text-gray-400" />
          
          <!-- Tools Row - Integrated seamlessly -->
          <div class="flex items-center gap-1 shrink-0">
            <!-- Tone Selector - Minimal style -->
            <button id="toneBtn" class="px-3 py-1.5 rounded-full hover:bg-gray-100 transition flex items-center gap-1.5 text-sm text-gray-700" title="Tone">
              <i class="fa-solid fa-sliders text-xs"></i>
              <span class="hidden sm:inline">Tone</span>
            </button>
            
            <!-- Mic Button -->
            <button id="micBtn" class="w-8 h-8 flex items-center justify-center transition hover:bg-gray-100 rounded-full" title="Dictate">
              <i class="fa-solid fa-microphone text-gray-700"></i>
            </button>
            
            <!-- Send Button - Integrated seamlessly -->
            <button id="sendBtn" class="w-8 h-8 rounded-full bg-black hover:bg-gray-800 text-white flex items-center justify-center transition" title="Send">
              <i class="fa-solid fa-paper-plane text-xs"></i>
            </button>
          </div>
        </div>
        
        <p class="mt-2 text-xs text-gray-500 text-center">
          Tip: Drag & drop files here to stage them. They won't send until you hit <b>Send</b>.
        </p>
      </div>
    </main>
  </div>
  
  <!-- Mobile Sidebar Overlay -->
  <div id="mobileOverlay" class="fixed inset-0 bg-black/40 z-40 hidden transition-opacity duration-300"></div>
  
  <!-- Premium Modals & Overlays -->
  
  <!-- Tone Selector Popover -->
  <div id="tonePopover" class="popover hidden" style="display: none;">
    <div class="space-y-2">
      <div class="font-semibold text-sm text-gray-800 mb-3">Summary Tone</div>
      <button class="tone-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-token-paper" data-tone="PlainClinical">
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-scale-balanced text-token-primary tone-icon"></i>
          <div class="flex-1">
            <div class="font-medium tone-title">Balanced</div>
            <div class="text-xs text-gray-500 tone-description">Clear explanations with clinical notes</div>
          </div>
          <i class="fa-solid fa-check text-token-accent opacity-0 tone-check" style="font-size: 14px;"></i>
        </div>
      </button>
      <button class="tone-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-white" data-tone="Caregiver">
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-hand-holding-heart tone-icon tone-icon-caregiver"></i>
          <div class="flex-1">
            <div class="font-medium tone-title">Caregiver</div>
            <div class="text-xs text-gray-500 tone-description">Gentle, practical guidance</div>
          </div>
          <i class="fa-solid fa-check text-token-accent opacity-0 tone-check" style="font-size: 14px;"></i>
        </div>
      </button>
      <button class="tone-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-white" data-tone="Faith">
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-hands-praying tone-icon tone-icon-faith"></i>
          <div class="flex-1">
            <div class="font-medium tone-title">Faith</div>
            <div class="text-xs text-gray-500 tone-description">Spiritual support and encouragement</div>
          </div>
          <i class="fa-solid fa-check text-token-accent opacity-0 tone-check" style="font-size: 14px;"></i>
        </div>
      </button>
      <button class="tone-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-white" data-tone="Clinical">
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-stethoscope tone-icon tone-icon-clinical"></i>
          <div class="flex-1">
            <div class="font-medium tone-title">Clinical</div>
            <div class="text-xs text-gray-500 tone-description">Structured, medical-first approach</div>
          </div>
          <i class="fa-solid fa-check text-token-accent opacity-0 tone-check" style="font-size: 14px;"></i>
        </div>
      </button>
      <button class="tone-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-white" data-tone="Geriatric">
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-person-cane text-token-accent tone-icon"></i>
          <div class="flex-1">
            <div class="font-medium tone-title">Geriatric</div>
            <div class="text-xs text-gray-500 tone-description">Simple, clear steps for older adults</div>
          </div>
          <i class="fa-solid fa-check text-token-accent opacity-0 tone-check" style="font-size: 14px;"></i>
        </div>
      </button>
      <button class="tone-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-white" data-tone="EmotionalSupport">
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-heart tone-icon tone-icon-emotional"></i>
          <div class="flex-1">
            <div class="font-medium tone-title">Emotional Support</div>
            <div class="text-xs text-gray-500 tone-description">Calm, validating support</div>
          </div>
          <i class="fa-solid fa-check text-token-accent opacity-0 tone-check" style="font-size: 14px;"></i>
        </div>
      </button>
    </div>
  </div>
  
  <!-- Care Setting Popover (conditional) -->
  <div id="carePopover" class="popover hidden" style="display: none;">
    <div class="space-y-2">
      <div class="font-semibold text-sm text-gray-800 mb-3">Care Setting</div>
      <button class="care-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-token-paper" data-care="hospital">
        <div class="font-medium">Hospital</div>
        <div class="text-xs text-gray-500">Inpatient context</div>
      </button>
      <button class="care-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-white" data-care="ambulatory">
        <div class="font-medium">Ambulatory</div>
        <div class="text-xs text-gray-500">Clinic/outpatient</div>
      </button>
      <button class="care-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-white" data-care="urgent">
        <div class="font-medium">Urgent</div>
        <div class="text-xs text-gray-500">Fast triage & critical highlights</div>
      </button>
    </div>
  </div>
  
  <!-- Faith Setting Popover (conditional) -->
  <div id="faithPopover" class="popover hidden" style="display: none;">
    <div class="space-y-2">
      <div class="font-semibold text-sm text-gray-800 mb-3">Faith Setting</div>
      <button class="faith-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-token-paper" data-faith="general">
        <div class="font-medium">General</div>
        <div class="text-xs text-gray-500">Universal spiritual support</div>
      </button>
      <button class="faith-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-white" data-faith="christian">
        <div class="font-medium">Christian</div>
        <div class="text-xs text-gray-500">Christian faith-based guidance</div>
      </button>
      <button class="faith-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-white" data-faith="jewish">
        <div class="font-medium">Jewish</div>
        <div class="text-xs text-gray-500">Jewish faith-based guidance</div>
      </button>
      <button class="faith-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-white" data-faith="muslim">
        <div class="font-medium">Muslim</div>
        <div class="text-xs text-gray-500">Islamic faith-based guidance</div>
      </button>
      <button class="faith-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-white" data-faith="buddhist">
        <div class="font-medium">Buddhist</div>
        <div class="text-xs text-gray-500">Buddhist faith-based guidance</div>
      </button>
      <button class="faith-option w-full text-left p-3 hover:bg-gray-100 rounded-lg transition-all duration-200 cursor-pointer bg-white" data-faith="hindu">
        <div class="font-medium">Hindu</div>
        <div class="text-xs text-gray-500">Hindu faith-based guidance</div>
      </button>
    </div>
  </div>
  
  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-overlay hidden" onclick="if(event.target===this) closeSettingsModal()">
    <div class="modal-content w-full max-w-5xl bg-white rounded-lg shadow-xl relative" onclick="event.stopPropagation()" style="max-height: 90vh; overflow: hidden; display: flex;">
      <!-- Mobile Dropdown (shown only on mobile) -->
      <div class="md:hidden p-4 border-b border-gray-200 flex items-center gap-3">
        <select id="settingsMobileDropdown" class="flex-1 px-4 py-3 text-sm border border-gray-300 rounded-lg focus-ring-accent bg-white">
          <option value="general"> General</option>
          <option value="notifications"> Notifications</option>
          <option value="personalization"> Personalization</option>
          <option value="apps"> Apps</option>
          <option value="schedules"> Schedules</option>
          <option value="data"> Data controls</option>
          <option value="security"> Security</option>
          <option value="parental"> Parental controls</option>
          <option value="account"> Account</option>
        </select>
        <!-- Close button - positioned beside dropdown -->
        <button onclick="closeSettingsModal()" class="flex items-center justify-center w-10 h-10 flex-shrink-0" aria-label="Close">
          <i class="fa-solid fa-times text-gray-500 text-base"></i>
        </button>
      </div>
      
      <!-- Left Navigation Panel (hidden on mobile) -->
        <div class="hidden md:flex w-64 flex-col flex-shrink-0">
         <div class="p-4">
           <h2 class="text-lg font-semibold text-gray-800">Settings</h2>
          </div>
        <div class="flex-1 overflow-y-auto p-2">
          <nav class="space-y-1">
            <button class="settings-nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition text-left active" data-section="general">
              <i class="fa-solid fa-gear text-gray-600"></i>
              <span class="text-sm font-medium">General</span>
            </button>
            <button class="settings-nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition text-left" data-section="notifications">
              <i class="fa-regular fa-bell text-gray-600"></i>
              <span class="text-sm font-medium">Notifications</span>
            </button>
            <button class="settings-nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition text-left" data-section="personalization">
              <i class="fa-solid fa-palette text-gray-600"></i>
              <span class="text-sm font-medium">Personalization</span>
            </button>
            <button class="settings-nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition text-left" data-section="apps">
              <i class="fa-solid fa-th-large text-gray-600"></i>
              <span class="text-sm font-medium">Apps</span>
            </button>
            <button class="settings-nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition text-left" data-section="schedules">
              <i class="fa-regular fa-calendar text-gray-600"></i>
              <span class="text-sm font-medium">Schedules</span>
            </button>
            <button class="settings-nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition text-left" data-section="data">
              <i class="fa-solid fa-database text-gray-600"></i>
              <span class="text-sm font-medium">Data controls</span>
            </button>
            <button class="settings-nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition text-left" data-section="security">
              <i class="fa-solid fa-key text-gray-600"></i>
              <span class="text-sm font-medium">Security</span>
            </button>
            <button class="settings-nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition text-left" data-section="parental">
              <i class="fa-solid fa-users text-gray-600"></i>
              <span class="text-sm font-medium">Parental controls</span>
            </button>
            <button class="settings-nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition text-left" data-section="account">
              <i class="fa-regular fa-user text-gray-600"></i>
              <span class="text-sm font-medium">Account</span>
            </button>
          </nav>
        </div>
      </div>
      
      <!-- Right Content Area -->
      <div class="flex-1 overflow-y-auto p-8">
        <!-- General Settings -->
        <div id="settingsSection-general" class="settings-section">
          <h3 class="text-2xl font-semibold text-gray-800 mb-6">General</h3>
          <div class="space-y-6">
            <!-- Appearance -->
            <div class="flex items-center justify-between py-3 border-b border-gray-100">
              <div>
                <div class="text-sm font-medium text-gray-800">Appearance</div>
              </div>
              <select id="appearanceSelect" class="px-3 py-1.5 border border-token-gray-300 rounded-lg text-sm focus-ring-accent">
                <option value="system">System</option>
                <option value="light">Light</option>
                <option value="dark">Dark</option>
              </select>
            </div>
            
            <!-- Accent color -->
            <div class="flex items-center justify-between py-3 border-b border-gray-100">
              <div>
                <div class="text-sm font-medium text-gray-800">Accent color</div>
              </div>
              <div class="flex items-center gap-3">
                <label class="flex items-center gap-2">
                  <input type="radio" name="accentColor" value="default" checked class="text-token-accent">
                  <span class="text-sm text-gray-700">Default</span>
                </label>
                <select id="accentColorSelect" class="px-3 py-1.5 border border-token-gray-300 rounded-lg text-sm focus-ring-accent">
                  <option value="green">Green</option>
                  <option value="blue">Blue</option>
                  <option value="purple">Purple</option>
                  <option value="red">Red</option>
                </select>
              </div>
            </div>
            
            <!-- Language -->
            <div class="flex items-center justify-between py-3 border-b border-gray-100">
              <div>
                <div class="text-sm font-medium text-gray-800">Language</div>
              </div>
              <select id="languageSelect" class="px-3 py-1.5 border border-token-gray-300 rounded-lg text-sm focus-ring-accent">
                <option value="auto">Auto-detect</option>
                <option value="en-US">English (US)</option>
                <option value="es-ES">Spanish</option>
                <option value="fr-FR">French</option>
                <option value="de-DE">German</option>
              </select>
            </div>
            
            <!-- Spoken language -->
            <div class="flex items-center justify-between py-3 border-b border-gray-100">
              <div class="flex-1">
                <div class="text-sm font-medium text-gray-800 mb-1">Spoken language</div>
                <div class="text-xs text-gray-500">For best results, select the language you mainly speak. If it's not listed, it may still be supported via auto-detection.</div>
              </div>
              <select id="spokenLanguageSelect" class="px-3 py-1.5 border border-token-gray-300 rounded-lg text-sm focus-ring-accent ml-4">
                <option value="auto">Auto-detect</option>
                <option value="en-US">English (US)</option>
                <option value="es-ES">Spanish</option>
                <option value="fr-FR">French</option>
                <option value="de-DE">German</option>
              </select>
            </div>
            
            <!-- Voice -->
            <div class="flex items-center justify-between py-3 border-b border-gray-100">
              <div>
                <div class="text-sm font-medium text-gray-800">Voice</div>
              </div>
              <div class="flex items-center gap-2">
                <button id="playVoiceBtn" class="p-2 hover:bg-gray-100 rounded-lg transition">
                  <i class="fa-solid fa-play text-gray-600 text-xs"></i>
                </button>
                <select id="voiceSelect" class="px-3 py-1.5 border border-token-gray-300 rounded-lg text-sm focus-ring-accent">
                  <option value="spruce">Spruce</option>
                  <option value="cove">Cove</option>
                  <option value="ember">Ember</option>
                  <option value="juniper">Juniper</option>
                </select>
              </div>
            </div>
            
            <!-- Separate voice mode -->
            <div class="flex items-center justify-between py-3 border-b border-gray-100">
              <div class="flex-1">
                <div class="text-sm font-medium text-gray-800 mb-1">Separate voice mode</div>
                <div class="text-xs text-gray-500">Keep ChatGPT Voice in a separate full screen, without real time transcripts and visuals.</div>
              </div>
              <label class="relative inline-flex items-center cursor-pointer ml-4">
                <input type="checkbox" id="separateVoiceMode" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-token-accent"></div>
              </label>
            </div>
            
            <!-- Show additional models -->
            <div class="flex items-center justify-between py-3">
              <div>
                <div class="text-sm font-medium text-gray-800">Show additional models</div>
              </div>
              <label class="relative inline-flex items-center cursor-pointer ml-4">
                <input type="checkbox" id="showAdditionalModels" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-token-accent"></div>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Other Settings Sections (hidden by default) -->
        <div id="settingsSection-notifications" class="settings-section hidden">
          <h3 class="text-2xl font-semibold text-gray-800 mb-6">Notifications</h3>
          <div class="text-gray-500 text-sm">Notification settings coming soon...</div>
        </div>
        
        <div id="settingsSection-personalization" class="settings-section hidden">
          <h3 class="text-2xl font-semibold text-gray-800 mb-6">Personalization</h3>
          <div class="space-y-8">
            <!-- Base style and tone -->
            <div class="space-y-3">
              <div>
                <div class="text-sm font-medium text-gray-800 mb-1">Base style and tone</div>
                <div class="text-xs text-gray-500 mb-4">Set the style and tone of how ChatGPT responds to you. This doesn't impact ChatGPT's capabilities.</div>
              </div>
              
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="baseStyleToneSelector">
                <!-- Balanced -->
                <button class="base-tone-option w-full text-left p-3 rounded-lg transition-all duration-200 cursor-pointer bg-token-paper border-2 border-token-gray-200 hover:border-token-accent/50" data-tone="PlainClinical">
                  <div class="flex items-center gap-3">
                    <i class="fa-solid fa-scale-balanced text-token-primary text-lg"></i>
                    <div class="flex-1">
                      <div class="font-medium text-gray-800">Balanced</div>
                      <div class="text-xs text-gray-500">Clear explanations with clinical notes</div>
                    </div>
                    <i class="fa-solid fa-check text-white opacity-0 base-tone-check" style="font-size: 14px;"></i>
                  </div>
                </button>
                
                <!-- Caregiver -->
                <button class="base-tone-option w-full text-left p-3 rounded-lg transition-all duration-200 cursor-pointer bg-token-paper border-2 border-token-gray-200 hover:border-token-accent/50" data-tone="Caregiver">
                  <div class="flex items-center gap-3">
                    <i class="fa-solid fa-hand-holding-heart tone-icon-caregiver text-lg"></i>
                    <div class="flex-1">
                      <div class="font-medium text-gray-800">Caregiver</div>
                      <div class="text-xs text-gray-500">Gentle, practical guidance</div>
                    </div>
                    <i class="fa-solid fa-check text-white opacity-0 base-tone-check" style="font-size: 14px;"></i>
                  </div>
                </button>
                
                <!-- Faith -->
                <button class="base-tone-option w-full text-left p-3 rounded-lg transition-all duration-200 cursor-pointer bg-token-paper border-2 border-token-gray-200 hover:border-token-accent/50" data-tone="Faith">
                  <div class="flex items-center gap-3">
                    <i class="fa-solid fa-hands-praying tone-icon-faith text-lg"></i>
                    <div class="flex-1">
                      <div class="font-medium text-gray-800">Faith</div>
                      <div class="text-xs text-gray-500">Spiritual support and encouragement</div>
                    </div>
                    <i class="fa-solid fa-check text-white opacity-0 base-tone-check" style="font-size: 14px;"></i>
                  </div>
                </button>
                
                <!-- Clinical -->
                <button class="base-tone-option w-full text-left p-3 rounded-lg transition-all duration-200 cursor-pointer bg-token-paper border-2 border-token-gray-200 hover:border-token-accent/50" data-tone="Clinical">
                  <div class="flex items-center gap-3">
                    <i class="fa-solid fa-stethoscope tone-icon-clinical text-lg"></i>
                    <div class="flex-1">
                      <div class="font-medium text-gray-800">Clinical</div>
                      <div class="text-xs text-gray-500">Structured, medical-first approach</div>
                    </div>
                    <i class="fa-solid fa-check text-white opacity-0 base-tone-check" style="font-size: 14px;"></i>
                  </div>
                </button>
                
                <!-- Geriatric -->
                <button class="base-tone-option w-full text-left p-3 rounded-lg transition-all duration-200 cursor-pointer bg-token-paper border-2 border-gray-200 hover:border-[#28926D]/50" data-tone="Geriatric">
                  <div class="flex items-center gap-3">
                    <i class="fa-solid fa-person-cane text-[#28926D] text-lg"></i>
                    <div class="flex-1">
                      <div class="font-medium text-gray-800">Geriatric</div>
                      <div class="text-xs text-gray-500">Simple, clear steps for older adults</div>
                    </div>
                    <i class="fa-solid fa-check text-white opacity-0 base-tone-check" style="font-size: 14px;"></i>
                  </div>
                </button>
                
                <!-- Emotional Support -->
                <button class="base-tone-option w-full text-left p-3 rounded-lg transition-all duration-200 cursor-pointer bg-token-paper border-2 border-token-gray-200 hover:border-token-accent/50" data-tone="EmotionalSupport">
                  <div class="flex items-center gap-3">
                    <i class="fa-solid fa-heart tone-icon-emotional text-lg"></i>
                    <div class="flex-1">
                      <div class="font-medium text-gray-800">Emotional Support</div>
                      <div class="text-xs text-gray-500">Calm, validating support</div>
                    </div>
                    <i class="fa-solid fa-check text-white opacity-0 base-tone-check" style="font-size: 14px;"></i>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- Characteristics -->
            <div class="space-y-4">
              <div>
                <div class="text-sm font-medium text-gray-800 mb-1">Characteristics</div>
                <div class="text-xs text-gray-500 mb-4">Choose additional customizations on top of your base style and tone.</div>
              </div>
              
              <div class="space-y-3">
                <!-- Warm -->
                <div class="flex items-center justify-between py-2 border-b border-gray-100">
                  <div class="text-sm text-gray-800">Warm</div>
                  <select id="characteristicWarm" class="px-3 py-1.5 border border-token-gray-300 rounded-lg text-sm focus-ring-accent">
                    <option value="default">Default</option>
                    <option value="more">More</option>
                    <option value="less">Less</option>
                  </select>
                </div>
                
                <!-- Enthusiastic -->
                <div class="flex items-center justify-between py-2 border-b border-gray-100">
                  <div class="text-sm text-gray-800">Enthusiastic</div>
                  <select id="characteristicEnthusiastic" class="px-3 py-1.5 border border-token-gray-300 rounded-lg text-sm focus-ring-accent">
                    <option value="default">Default</option>
                    <option value="more">More</option>
                    <option value="less">Less</option>
                  </select>
                </div>
                
                <!-- Headers & Lists -->
                <div class="flex items-center justify-between py-2 border-b border-gray-100">
                  <div class="text-sm text-gray-800">Headers & Lists</div>
                  <select id="characteristicHeaders" class="px-3 py-1.5 border border-token-gray-300 rounded-lg text-sm focus-ring-accent">
                    <option value="default">Default</option>
                    <option value="more">More</option>
                    <option value="less">Less</option>
                  </select>
                </div>
                
                <!-- Emoji -->
                <div class="flex items-center justify-between py-2">
                  <div class="text-sm text-gray-800">Emoji</div>
                  <select id="characteristicEmoji" class="px-3 py-1.5 border border-token-gray-300 rounded-lg text-sm focus-ring-accent">
                    <option value="default">Default</option>
                    <option value="more">More</option>
                    <option value="less">Less</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Custom instructions -->
            <div class="space-y-2">
              <div class="text-sm font-medium text-gray-800">Custom instructions</div>
              <textarea 
                id="customInstructions" 
                rows="6"
                placeholder="I want ChatGPT to response wisely yet witty enough. Write like you talk and share wins and lessons. Use 'i' with weight. Don't sound like a brand and show what built me and always sound human. I want it to be always kind, compassionate, understanding, intelligent yet funny. I want the response not too short yet not too long. I want it to be compelling enough that people can understand and relate."
                class="w-full px-4 py-3 border border-token-gray-300 rounded-lg focus-ring-accent text-sm resize-none"
              ></textarea>
            </div>
            
            <!-- About you -->
            <div class="space-y-4">
              <div class="text-sm font-medium text-gray-800">About you</div>
              
              <!-- Nickname -->
              <div class="space-y-1">
                <label class="block text-xs text-gray-600">Nickname</label>
                <input 
                  type="text" 
                  id="personalizationNickname" 
                  placeholder="What should ChatGPT call you?"
                  class="w-full px-4 py-2 border border-token-gray-300 rounded-lg focus-ring-accent text-sm"
                />
              </div>
              
              <!-- Occupation -->
              <div class="space-y-1">
                <label class="block text-xs text-gray-600">Occupation</label>
                <input 
                  type="text" 
                  id="personalizationOccupation" 
                  placeholder="e.g., Pharma sales"
                  class="w-full px-4 py-2 border border-token-gray-300 rounded-lg focus-ring-accent text-sm"
                />
              </div>
              
              <!-- More about you -->
              <div class="space-y-1">
                <label class="block text-xs text-gray-600">More about you</label>
                <textarea 
                  id="moreAboutYou" 
                  rows="5"
                  placeholder="I'm a business coach, philanthropist, I love God and I love helping people, and I love making a difference to people's lives. I want to sound informal when responding to text messages and a combination of formal and informal when I'm talking about business. I sometimes like detailed responses with a touch of wits and humor if necessary. I like making people feel comfortable and I want to feel..."
                  class="w-full px-4 py-3 border border-token-gray-300 rounded-lg focus-ring-accent text-sm resize-none"
                ></textarea>
              </div>
            </div>
            
            <!-- Memory -->
            <div class="space-y-4 pt-4 border-t border-gray-200">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <div class="text-sm font-medium text-gray-800">Memory</div>
                  <button class="text-gray-400 hover:text-gray-600 transition" title="Learn more about Memory">
                    <i class="fa-regular fa-circle-question text-xs"></i>
                  </button>
                </div>
                <button id="manageMemoryBtn" class="px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition">
                  Manage
                </button>
              </div>
              
              <!-- Reference saved memories -->
              <div class="flex items-center justify-between py-3 border-b border-gray-100">
                <div class="flex-1">
                  <div class="text-sm font-medium text-gray-800 mb-1">Reference saved memories</div>
                  <div class="text-xs text-gray-500">Let ChatGPT save and use memories when responding.</div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer ml-4">
                  <input type="checkbox" id="referenceSavedMemories" class="sr-only peer" checked>
                  <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-token-accent"></div>
                </label>
              </div>
              
              <!-- Reference chat history -->
              <div class="flex items-center justify-between py-3">
                <div class="flex-1">
                  <div class="text-sm font-medium text-gray-800 mb-1">Reference chat history</div>
                  <div class="text-xs text-gray-500">Let ChatGPT reference all previous conversations when responding.</div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer ml-4">
                  <input type="checkbox" id="referenceChatHistory" class="sr-only peer" checked>
                  <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-accent/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-token-accent"></div>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <div id="settingsSection-apps" class="settings-section hidden">
          <h3 class="text-2xl font-semibold text-gray-800 mb-6">Apps</h3>
          <div class="text-gray-500 text-sm">Apps settings coming soon...</div>
        </div>
        
        <div id="settingsSection-schedules" class="settings-section hidden">
          <h3 class="text-2xl font-semibold text-gray-800 mb-6">Schedules</h3>
          <div class="text-gray-500 text-sm">Schedules settings coming soon...</div>
        </div>
        
        <div id="settingsSection-data" class="settings-section hidden">
          <h3 class="text-2xl font-semibold text-gray-800 mb-6">Data controls</h3>
          <div class="text-gray-500 text-sm">Data controls settings coming soon...</div>
        </div>
        
        <div id="settingsSection-security" class="settings-section hidden">
          <h3 class="text-2xl font-semibold text-gray-800 mb-6">Security</h3>
          <div class="text-gray-500 text-sm">Security settings coming soon...</div>
        </div>
        
        <div id="settingsSection-parental" class="settings-section hidden">
          <h3 class="text-2xl font-semibold text-gray-800 mb-6">Parental controls</h3>
          <div class="text-gray-500 text-sm">Parental controls settings coming soon...</div>
        </div>
        
        <!-- Account Settings -->
        <div id="settingsSection-account" class="settings-section hidden">
          <h3 class="text-2xl font-semibold text-gray-800 mb-6">Account</h3>
      <div class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
          <input type="text" id="displayName" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#28926D]/40" />
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Profession</label>
          <input type="text" id="profession" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#28926D]/40" />
        </div>
        
        <div class="flex items-center justify-between pt-4 border-t">
          <button onclick="logoutUser()" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition flex items-center gap-2">
            <i class="fa-solid fa-right-from-bracket"></i>
            <span>Logout</span>
          </button>
          <div class="flex items-center gap-3">
            <button onclick="closeSettingsModal()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition">
              Cancel
            </button>
            <button onclick="saveSettings()" class="btn-primary">
              <i class="fa-solid fa-check"></i>
              <span>Save</span>
            </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Search Modal -->
  <div id="searchModal" class="modal-overlay hidden" onclick="if(event.target===this) closeSearchModal()">
    <div class="modal-content w-full max-w-md bg-white rounded-lg shadow-xl" onclick="event.stopPropagation()" style="max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
      <!-- Search Header -->
      <div class="p-4 border-b border-gray-200">
        <div class="flex items-center gap-3">
          <div class="flex-1 relative">
            <input type="text" 
                   id="searchModalInput" 
                   placeholder="Search chats..." 
                   class="w-full px-4 py-2.5 pl-10 pr-10 text-sm border border-token-gray-300 rounded-lg focus-ring-accent focus:border-token-accent bg-token-paper" 
                   autocomplete="off" />
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3.5 text-gray-400 text-sm"></i>
            <button id="clearSearchBtn" class="absolute right-3 top-3 p-1 hover:bg-gray-100 rounded transition hidden">
              <i class="fa-solid fa-times text-gray-400 text-sm"></i>
            </button>
          </div>
          <button onclick="closeSearchModal()" class="p-2 hover:bg-gray-100 rounded-lg transition" aria-label="Close search">
            <i class="fa-solid fa-times text-gray-500"></i>
          </button>
        </div>
      </div>
      
      <!-- New Chat Option -->
      <div class="px-4 py-3 border-b border-gray-200">
        <button id="searchNewChatBtn" class="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-gray-100 rounded-lg transition text-left">
          <i class="fa-regular fa-pen-to-square text-gray-700 text-base"></i>
          <span class="text-sm font-medium text-gray-800">New chat</span>
        </button>
      </div>
      
      <!-- Search Results / Chat History -->
      <div class="flex-1 overflow-y-auto px-4 py-4" id="searchResultsContainer">
        <div id="searchResultsList" class="space-y-1">
          <!-- Results will be populated by JS -->
        </div>
        <div id="searchEmptyState" class="hidden text-center py-8 text-gray-500 text-sm">
          No chats found
        </div>
      </div>
    </div>
  </div>
  
  <!-- Summary Modal -->
  <div id="summaryModal" class="modal-overlay hidden" onclick="if(event.target===this) closeSummaryModal()">
    <div class="modal-content w-full max-w-4xl p-8" onclick="event.stopPropagation()">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold text-gray-800 flex items-center gap-2">
          <i class="fa-solid fa-brain text-token-primary"></i>
          Full Summary
        </h2>
        <div class="flex items-center gap-2">
          <button onclick="copySummary()" class="p-2 hover:bg-gray-100 rounded-lg" title="Copy" aria-label="Copy summary">
            <i class="fa-solid fa-copy text-gray-600"></i>
          </button>
          <button onclick="closeSummaryModal()" class="p-2 hover:bg-gray-100 rounded-lg" aria-label="Close">
            <i class="fa-solid fa-times text-gray-500"></i>
          </button>
        </div>
      </div>
      <div id="summaryContent" class="prose max-w-none">
        <!-- Summary content -->
      </div>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal-overlay hidden">
    <div class="modal-content w-full max-w-md p-8" onclick="event.stopPropagation()">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Delete this chat?</h2>
      <p class="text-gray-600 mb-6">This can't be undone.</p>
      <div class="space-y-3 mb-6">
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" id="deleteFiles" />
          <span class="text-sm text-gray-700">Also clear uploaded files from this session</span>
        </label>
      </div>
      <div class="flex items-center justify-end gap-3">
        <button onclick="closeDeleteModal()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition">
          Cancel
        </button>
        <button id="confirmDeleteBtn" onclick="confirmDelete()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition">
          Delete
        </button>
      </div>
    </div>
  </div>
  
  <!-- Bulk Delete Confirmation Modal -->
  <div id="bulkDeleteModal" class="modal-overlay hidden">
    <div class="modal-content w-full max-w-md p-8" onclick="event.stopPropagation()">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Delete <span id="bulkDeleteCount">0</span> chats?</h2>
      <p class="text-gray-600 mb-6">This can't be undone.</p>
      <div class="space-y-3 mb-6">
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" id="bulkDeleteFiles" />
          <span class="text-sm text-gray-700">Also clear uploaded files from these sessions</span>
        </label>
      </div>
      <div class="flex items-center justify-end gap-3">
        <button onclick="closeBulkDeleteModal()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition">
          Cancel
        </button>
        <button id="confirmBulkDeleteBtn" onclick="confirmBulkDelete()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition">
          Delete All
        </button>
      </div>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div id="toastContainer"></div>
  
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js"></script>
  
  <script>
// ============================================
// PREMIUM DASHBOARD - JAVASCRIPT
// All functions with premium UX
// ============================================

// Constants
const SESSION_KEY = 'nm_session_id';
const MAX_FILES = 15;
const LANGUAGE_CHOICES = [
  ['en-US','English'],['ja-JP','Japanese'],['es-ES','Spanish'],['fr-FR','French'],['de-DE','German'],
  ['it-IT','Italian'],['pt-PT','Portuguese (Portugal)'],['pt-BR','Portuguese (Brazil)'],['ru-RU','Russian'],
  ['zh-CN','Chinese (Simplified)'],['zh-TW','Chinese (Traditional)'],['ko-KR','Korean'],['ar-SA','Arabic (Saudi Arabia)'],
  ['tr-TR','Turkish'],['nl-NL','Dutch'],['sv-SE','Swedish'],['pl-PL','Polish'],['da-DK','Danish'],['no-NO','Norwegian'],
  ['fi-FI','Finnish'],['he-IL','Hebrew'],['th-TH','Thai'],['hi-IN','Hindi'],['cs-CZ','Czech'],['ro-RO','Romanian'],
  ['hu-HU','Hungarian'],['sk-SK','Slovak'],['bg-BG','Bulgarian'],['uk-UA','Ukrainian'],['vi-VN','Vietnamese'],['id-ID','Indonesian'],
  ['ms-MY','Malay'],['sr-RS','Serbian'],['hr-HR','Croatian'],['el-GR','Greek'],['lt-LT','Lithuanian'],['lv-LV','Latvian'],
  ['et-EE','Estonian'],['sl-SI','Slovenian'],['is-IS','Icelandic'],['sq-AL','Albanian'],['mk-MK','Macedonian'],
  ['bs-BA','Bosnian'],['ca-ES','Catalan'],['gl-ES','Galician'],['eu-ES','Basque'],['hy-AM','Armenian'],['fa-IR','Persian'],
  ['sw-KE','Swahili'],['ta-IN','Tamil'],['te-IN','Telugu'],['kn-IN','Kannada'],['ml-IN','Malayalam'],['mr-IN','Marathi'],
  ['pa-IN','Punjabi'],['gu-IN','Gujarati'],['or-IN','Odia'],['as-IN','Assamese'],['ne-NP','Nepali'],['si-LK','Sinhala'],
];

// State
let pending = [];
let chatLocked = false;
let currentSessionId = null;
let deleteSessionId = null;

// Utility Functions
function getCSRFToken() {
  const match = document.cookie.match(/(^|;)\s*csrftoken\s*=\s*([^;]+)/);
  return match ? match.pop() : '';
}

function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^|; )' + name + '=([^;]*)'));
  return match ? decodeURIComponent(match[2]) : null;
}

function getSessionId() {
  return localStorage.getItem(SESSION_KEY);
}

function setSessionId(id) {
  localStorage.setItem(SESSION_KEY, String(id));
  currentSessionId = id;
}

function clearSessionId() {
  localStorage.removeItem(SESSION_KEY);
  currentSessionId = null;
}

function debounce(fn, ms = 80) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), ms);
  };
}

// Toast System
function showToast(message, type = 'info', action = null) {
  const container = document.getElementById('toastContainer');
  if (!container) return;
  
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
    <div class="flex-1">${message}</div>
    ${action ? `<button onclick="${action}" class="text-sm font-medium underline">${action.text || 'Retry'}</button>` : ''}
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideInRight 0.3s ease-out reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ============================================
// CHAT MESSAGING - Premium Bubbles
// ============================================

function appendChatBubble(role, content, isHistory = false) {
  const chatWindow = document.getElementById('chatWindow');
  if (!chatWindow) return;
  
  // Hide empty state
  const emptyState = document.getElementById('emptyState');
  if (emptyState) emptyState.classList.add('hidden');
  
  // Hide first message view when messages are added
  const firstMessageView = document.getElementById('firstMessageView');
  if (firstMessageView && !firstMessageView.classList.contains('hidden')) {
    transitionToNormalChat();
  }
  
  const bubbleWrap = document.createElement('div');
  bubbleWrap.className = `w-full flex mb-3 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
  
  const bubble = document.createElement('div');
  bubble.className = `chat-bubble ${role === 'user' ? 'chat-user' : 'chat-ai'}`;
  
  if (typeof content === 'string') {
    if (role === 'assistant') {
      // Render markdown for assistant messages
      const rendered = renderMarkdown(content);
      bubble.innerHTML = rendered;
      
      // Add bubble actions (copy, view full)
      const actions = document.createElement('div');
      actions.className = 'bubble-actions';
      actions.innerHTML = `
        <button onclick="copyBubbleText(this)" title="Copy">
          <i class="fa-solid fa-copy"></i>
        </button>
        ${content.length > 500 ? `<button onclick="viewFullSummary('${escapeHtml(content)}')" title="View full">
          <i class="fa-solid fa-expand"></i>
        </button>` : ''}
      `;
      bubble.appendChild(actions);
    } else {
      bubble.textContent = content;
    }
  } else if (content instanceof Node) {
    bubble.appendChild(content);
  }
  
  bubbleWrap.appendChild(bubble);
  chatWindow.appendChild(bubbleWrap);
  
  // Auto-scroll if user is at bottom
  if (!isHistory) {
    const isAtBottom = chatWindow.scrollHeight - chatWindow.scrollTop - chatWindow.clientHeight < 100;
    if (isAtBottom) {
      setTimeout(() => {
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }, 100);
    } else {
      // Show jump to latest button
      const jumpBtn = document.getElementById('jumpToLatest');
      if (jumpBtn) jumpBtn.classList.add('visible');
    }
  } else {
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  
  updateComposerPadding();
}

function renderMarkdown(text) {
  if (typeof marked === 'undefined') {
    // Fallback if marked.js not loaded
    return `<div class="md-prose">${escapeHtml(text).replace(/\n/g, '<br>')}</div>`;
  }
  
  const html = marked.parse(text);
  const clean = DOMPurify ? DOMPurify.sanitize(html) : html;
  return `<div class="md-prose">${clean}</div>`;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function copyBubbleText(btn) {
  const bubble = btn.closest('.chat-bubble');
  const text = bubble.textContent || bubble.innerText;
  navigator.clipboard.writeText(text).then(() => {
    showToast('Copied to clipboard', 'success');
    btn.innerHTML = '<i class="fa-solid fa-check"></i>';
    setTimeout(() => {
      btn.innerHTML = '<i class="fa-solid fa-copy"></i>';
    }, 2000);
  }).catch(() => {
    showToast('Failed to copy', 'error');
  });
}

function viewFullSummary(content) {
  const modal = document.getElementById('summaryModal');
  const contentDiv = document.getElementById('summaryContent');
  if (modal && contentDiv) {
    contentDiv.innerHTML = renderMarkdown(unescapeHtml(content));
    modal.classList.remove('hidden');
  }
}

function unescapeHtml(html) {
  const div = document.createElement('div');
  div.innerHTML = html;
  return div.textContent || div.innerText;
}

function closeSummaryModal() {
  const modal = document.getElementById('summaryModal');
  if (modal) modal.classList.add('hidden');
}

// ============================================
// SEARCH MODAL
// ============================================

function openSearchModal() {
  const modal = document.getElementById('searchModal');
  if (modal) {
    modal.classList.remove('hidden');
    const input = document.getElementById('searchModalInput');
    if (input) {
      setTimeout(() => input.focus(), 100);
    }
    loadSearchResults();
  }
}

function closeSearchModal() {
  const modal = document.getElementById('searchModal');
  if (modal) {
    modal.classList.add('hidden');
    const input = document.getElementById('searchModalInput');
    if (input) {
      input.value = '';
    }
    const clearBtn = document.getElementById('clearSearchBtn');
    if (clearBtn) clearBtn.classList.add('hidden');
  }
}

async function loadSearchResults(query = '') {
  const resultsList = document.getElementById('searchResultsList');
  const emptyState = document.getElementById('searchEmptyState');
  if (!resultsList) return;
  
  try {
    const res = await fetch('/api/chat/sessions/', { credentials: 'include' });
    if (!res.ok) {
      console.error('Failed to fetch sessions:', res.status);
      emptyState.classList.remove('hidden');
      return;
    }
    
    const sessions = await res.json();
    console.log('Loaded sessions:', sessions.length);
    
    // Filter sessions with messages (use message_count if available, otherwise check messages array)
    const validSessions = sessions.filter(s => {
      if (s.message_count !== undefined) {
        return s.message_count > 0;
      }
      if (s.messages && Array.isArray(s.messages)) {
        return s.messages.length > 0;
      }
      // If no message info, include it (backend should have filtered empty ones)
      return true;
    });
    
    console.log('Valid sessions:', validSessions.length);
    
    // Filter by query if provided
    let filteredSessions = validSessions;
    if (query.trim()) {
      const lowerQuery = query.toLowerCase();
      filteredSessions = validSessions.filter(s => {
        const title = (s.title || 'New chat').toLowerCase();
        return title.includes(lowerQuery);
      });
    }
    
    resultsList.innerHTML = '';
    
    if (filteredSessions.length === 0) {
      if (query.trim()) {
        emptyState.textContent = 'No chats found';
      } else {
        emptyState.textContent = 'No chats yet';
      }
      emptyState.classList.remove('hidden');
      return;
    }
    
    emptyState.classList.add('hidden');
    
    // Group by date
    const grouped = groupSessionsByDate(filteredSessions);
    
    Object.keys(grouped).forEach(dateLabel => {
      const dateHeader = document.createElement('div');
      dateHeader.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2 mt-4 first:mt-0';
      dateHeader.textContent = dateLabel;
      resultsList.appendChild(dateHeader);
      
      grouped[dateLabel].forEach(session => {
        const item = document.createElement('button');
        item.className = 'w-full flex items-center gap-3 px-3 py-2.5 hover:bg-gray-100 rounded-lg transition text-left';
        item.onclick = () => {
          closeSearchModal();
          openSession(session.id);
        };
        
        item.innerHTML = `
          <i class="fa-regular fa-message text-gray-600 text-sm"></i>
          <span class="text-sm font-medium text-gray-800 flex-1 text-left">${escapeHtml(session.title || 'New chat')}</span>
        `;
        
        resultsList.appendChild(item);
      });
    });
  } catch (err) {
    console.error('Failed to load search results:', err);
    emptyState.textContent = 'Failed to load chats';
    emptyState.classList.remove('hidden');
  }
}

function groupSessionsByDate(sessions) {
  const groups = {};
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  
  sessions.forEach(session => {
    const sessionDate = new Date(session.updated_at || session.created_at);
    const sessionDay = new Date(sessionDate.getFullYear(), sessionDate.getMonth(), sessionDate.getDate());
    
    let label;
    const diffTime = today - sessionDay;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) {
      label = 'Today';
    } else if (diffDays === 1) {
      label = 'Yesterday';
    } else if (diffDays < 7) {
      label = sessionDate.toLocaleDateString('en-US', { weekday: 'long' });
    } else {
      label = sessionDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: sessionDate.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
    }
    
    if (!groups[label]) {
      groups[label] = [];
    }
    groups[label].push(session);
  });
  
  // Sort sessions within each group by updated_at (newest first)
  Object.keys(groups).forEach(key => {
    groups[key].sort((a, b) => {
      const dateA = new Date(a.updated_at || a.created_at);
      const dateB = new Date(b.updated_at || b.created_at);
      return dateB - dateA;
    });
  });
  
  return groups;
}

function copySummary() {
  const contentDiv = document.getElementById('summaryContent');
  if (contentDiv) {
    const text = contentDiv.textContent || contentDiv.innerText;
    navigator.clipboard.writeText(text).then(() => {
      showToast('Summary copied to clipboard', 'success');
    });
  }
}

// Typing indicator with context-aware messages
function showTypingIndicator(context = 'Analyzing...') {
  const chatWindow = document.getElementById('chatWindow');
  if (!chatWindow) return;
  
  const typingWrap = document.createElement('div');
  typingWrap.className = 'typing-indicator';
  typingWrap.id = 'typingIndicator';
  typingWrap.innerHTML = `
    <div class="typing-dots">
      <span></span><span></span><span></span>
    </div>
    <span>${context}</span>
  `;
  chatWindow.appendChild(typingWrap);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  return typingWrap;
}

function hideTypingIndicator() {
  const indicator = document.getElementById('typingIndicator');
  if (indicator) indicator.remove();
}

// ============================================
// FILE MANAGEMENT - Premium Attachment Dock
// ============================================

function addFiles(files) {
  if (!files || files.length === 0) return;
  
  const fileArray = Array.from(files);
  const validExtensions = ['.pdf', '.docx', '.txt', '.jpg', '.jpeg', '.png', '.webp', '.heic'];
  
  fileArray.forEach(file => {
    // Check file limit
    if (pending.length >= MAX_FILES) {
      showToast(`Maximum ${MAX_FILES} files allowed`, 'error');
      const warning = document.getElementById('fileLimitWarning');
      if (warning) warning.classList.remove('hidden');
      return;
    }
    
    // Check if duplicate
    const isDuplicate = pending.some(p => p.file.name === file.name && p.file.size === file.size);
    if (isDuplicate) {
      showToast('This file is already added', 'info');
      return;
    }
    
    // Check file type
    const ext = '.' + file.name.split('.').pop().toLowerCase();
    if (!validExtensions.includes(ext)) {
      const item = {
        file: file,
        kind: 'doc',
        status: 'unsupported',
        url: null
      };
      pending.push(item);
      renderPending();
      showToast(`Unsupported file type: ${ext}`, 'error');
      return;
    }
    
    // Add file
    const isImage = /^image\//.test(file.type) || ['.jpg', '.jpeg', '.png', '.webp', '.heic'].includes(ext);
    const item = {
      file: file,
      kind: isImage ? 'image' : 'doc',
      status: 'ready',
      url: isImage ? URL.createObjectURL(file) : null
    };
    pending.push(item);
  });
  
  renderPending();
  updateFileLimitWarning();
  updateImagesBadge();
}

// Update Images badge in sidebar
function updateImagesBadge() {
  const imagesBadge = document.getElementById('imagesNewBadge');
  if (!imagesBadge) return;
  
  // Check if there are any images in pending files
  const hasImages = pending.some(item => item.kind === 'image');
  
  // Also check localStorage to see if user has uploaded images before
  const hasUploadedBefore = localStorage.getItem('has_uploaded_images') === 'true';
  
  if (hasImages || hasUploadedBefore) {
    imagesBadge.classList.remove('hidden');
  } else {
    imagesBadge.classList.add('hidden');
  }
}

function renderPending() {
  const dock = document.getElementById('attachmentDock');
  const grid = document.getElementById('attachmentGrid');
  const count = document.getElementById('attachmentCount');
  
  if (!dock || !grid) return;
  
  if (pending.length === 0) {
    dock.classList.add('hidden');
    dock.style.display = 'none'; // Force hide
    if (grid) grid.innerHTML = ''; // Clear grid
    if (count) count.textContent = '0';
    return;
  }
  
  dock.classList.remove('hidden');
  dock.style.display = ''; // Remove inline style if present
  if (count) count.textContent = pending.length;
  
  grid.innerHTML = '';
  
  pending.forEach((item, idx) => {
    const card = document.createElement('div');
    card.className = `attachment-card ${item.status === 'unsupported' ? 'unsupported' : ''}`;
    
    if (item.kind === 'image' && item.url) {
      const img = document.createElement('img');
      img.src = item.url;
      img.className = 'attachment-thumbnail';
      img.alt = item.file.name;
      card.appendChild(img);
    } else {
      const icon = document.createElement('div');
      icon.className = 'attachment-icon';
      icon.innerHTML = `<i class="fa-solid fa-file-lines"></i>`;
      card.appendChild(icon);
    }
    
    const name = document.createElement('div');
    name.className = 'attachment-name';
    name.textContent = item.file.name;
    card.appendChild(name);
    
    const meta = document.createElement('div');
    meta.className = 'attachment-meta';
    const size = formatFileSize(item.file.size);
    meta.innerHTML = `
      <span>${size}</span>
      <span class="attachment-status ${item.status}">${item.status}</span>
    `;
    card.appendChild(meta);
    
    // Remove button
    const removeBtn = document.createElement('button');
    removeBtn.className = 'attachment-remove';
    removeBtn.innerHTML = '<i class="fa-solid fa-times"></i>';
    removeBtn.onclick = (e) => {
      e.stopPropagation();
      removePending(idx);
    };
    card.appendChild(removeBtn);
    
    // Preview button (for images)
    if (item.kind === 'image' && item.url) {
      card.style.cursor = 'pointer';
      card.onclick = () => previewAttachment(idx);
    }
    
    grid.appendChild(card);
  });
}

function removePending(index) {
  if (index < 0 || index >= pending.length) return;
  const item = pending[index];
  if (item.url) URL.revokeObjectURL(item.url);
  pending.splice(index, 1);
  renderPending();
  updateFileLimitWarning();
  updateImagesBadge();
}

function clearPending() {
  // Force hide the dock IMMEDIATELY (before clearing array)
  const dock = document.getElementById('attachmentDock');
  const grid = document.getElementById('attachmentGrid');
  const count = document.getElementById('attachmentCount');
  
  if (dock) {
    dock.classList.add('hidden');
    dock.style.display = 'none'; // Force hide with inline style too
  }
  
  if (grid) {
    grid.innerHTML = ''; // Clear grid content immediately
  }
  
  if (count) {
    count.textContent = '0';
  }
  
  // Clean up object URLs
  pending.forEach(item => {
    if (item.url) URL.revokeObjectURL(item.url);
  });
  pending.length = 0;
  
  // Call renderPending to ensure everything is synced (though dock should already be hidden)
  renderPending();
  updateFileLimitWarning();
  updateImagesBadge();
}

function updateFileLimitWarning() {
  const warning = document.getElementById('fileLimitWarning');
  if (warning) {
    if (pending.length >= MAX_FILES) {
      warning.classList.remove('hidden');
    } else {
      warning.classList.add('hidden');
    }
  }
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function previewAttachment(index) {
  const item = pending[index];
  if (!item || item.kind !== 'image' || !item.url) return;
  
  // Create preview modal
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content max-w-2xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">${escapeHtml(item.file.name)}</h3>
        <button onclick="this.closest('.modal-overlay').remove()" class="p-2 hover:bg-gray-100 rounded-lg">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <img src="${item.url}" alt="${escapeHtml(item.file.name)}" class="w-full rounded-lg" />
    </div>
  `;
  modal.onclick = (e) => {
    if (e.target === modal) modal.remove();
  };
  document.body.appendChild(modal);
}

// ============================================
// SESSION MANAGEMENT
// ============================================

async function refreshSessionList() {
  const ul = document.getElementById('sessionList');
  const archivedList = document.getElementById('archivedList');
  if (!ul) return;
  
  // Show skeleton
  ul.innerHTML = '';
  for (let i = 0; i < 3; i++) {
    const li = document.createElement('li');
    li.className = 'session-card skeleton';
    li.style.height = '60px';
    ul.appendChild(li);
  }
  
  try {
    const res = await fetch('/api/chat/sessions/', { credentials: 'include' });
    
    // Check if response is ok
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ detail: `HTTP ${res.status}` }));
      throw new Error(errorData.detail || errorData.error || `Failed to load sessions: ${res.status}`);
    }
    
    const rows = await res.json();
    
    // Handle case where API returns error object instead of array
    if (!Array.isArray(rows)) {
      throw new Error(rows.detail || rows.error || 'Invalid response format');
    }
    
    ul.innerHTML = '';
    const activeId = String(getSessionId() || '');
    const activeSessions = [];
    const archivedSessions = [];
    
    rows.forEach(s => {
      // Filter out empty sessions (sessions with no messages) - additional safety check
      // Backend should already filter these, but this ensures empty sessions don't show up
      const messageCount = s.message_count || (s.messages && Array.isArray(s.messages) ? s.messages.length : 0);
      if (messageCount === 0 && !s.archived) {
        // Skip empty active sessions (they shouldn't appear in history)
        return;
      }
      
      if (s.archived) {
        archivedSessions.push(s);
      } else {
        activeSessions.push(s);
      }
    });
    
    // Check if any session has images and update badge
    let hasImagesInSessions = false;
    activeSessions.forEach(s => {
      // Check if session has images in messages
      if (s.messages && Array.isArray(s.messages)) {
        const hasImages = s.messages.some(m => {
          if (m.meta && m.meta.files) {
            return m.meta.files.some(f => 
              (f.type && f.type.startsWith('image/')) || 
              /\.(jpg|jpeg|png|webp|heic)$/i.test(f.name || '')
            );
          }
          return false;
        });
        if (hasImages) {
          hasImagesInSessions = true;
        }
      }
    });
    
    if (hasImagesInSessions) {
      localStorage.setItem('has_uploaded_images', 'true');
      updateImagesBadge();
    }
    
    // Render active sessions
    activeSessions.forEach(s => {
      const isActive = String(s.id) === activeId;
      const li = createSessionCard(s, isActive);
      ul.appendChild(li);
    });
    
    // Render archived sessions
    if (archivedSessions.length > 0) {
      const archivedSection = document.getElementById('archivedSection');
      const archivedList = document.getElementById('archivedList');
      if (archivedSection) {
        archivedSection.classList.remove('hidden');
        if (archivedList) {
          archivedList.innerHTML = '';
          archivedSessions.forEach(s => {
            const li = createSessionCard(s, false, true);
            archivedList.appendChild(li);
          });
          // Show archived list by default (user can collapse)
          archivedList.classList.remove('hidden');
        }
      }
    } else {
      const archivedSection = document.getElementById('archivedSection');
      if (archivedSection) archivedSection.classList.add('hidden');
    }
    
  } catch (err) {
    console.error('Failed to load sessions:', err);
    const errorMsg = err.message || 'Could not load sessions';
    ul.innerHTML = `<li class="text-sm text-red-600 p-4">
      <div class="font-semibold mb-1">Failed to load sessions</div>
      <div class="text-xs text-gray-600">${escapeHtml(errorMsg)}</div>
      <button onclick="refreshSessionList()" class="mt-2 text-blue-600 hover:underline text-xs">Retry</button>
    </li>`;
    showToast(`Failed to load sessions: ${errorMsg}`, 'error');
  }
}

function createSessionCard(session, isActive = false, isArchived = false) {
  const li = document.createElement('li');
  li.className = `session-card ${isActive ? 'active' : ''}`;
  li.dataset.sid = session.id;
  
  // Format date
  const date = new Date(session.updated_at || session.created_at);
  const dateStr = formatDate(date);
  
  li.innerHTML = `
    <div class="flex items-start gap-3">
      <div class="flex items-center gap-2 session-checkbox-container" style="display: none; min-width: 24px; padding-top: 2px;">
        <input type="checkbox" class="session-checkbox w-4 h-4 text-token-accent border-gray-300 rounded focus:ring-token-accent focus:ring-2 cursor-pointer" data-session-id="${session.id}" onclick="event.stopPropagation()" />
      </div>
      <div class="flex-1 min-w-0">
        <div class="session-title">${escapeHtml(session.title || 'New chat')}</div>
        <div class="session-meta">
          <div class="session-chips">
            ${session.tone ? `<span class="session-chip">${session.tone}</span>` : ''}
            ${session.lang ? `<span class="session-chip">${session.lang}</span>` : ''}
          </div>
          <span>${dateStr}</span>
        </div>
      </div>
      <div class="session-menu">
        <button class="p-1 hover:bg-gray-100 rounded" onclick="openSessionMenu(${session.id}, event)">
          <i class="fa-solid fa-ellipsis-vertical text-gray-500"></i>
        </button>
      </div>
    </div>
  `;
  
  // Click to open session (but not if clicking checkbox)
  li.addEventListener('click', (e) => {
    if (!e.target.closest('.session-menu') && !e.target.closest('.session-checkbox') && !e.target.closest('.session-checkbox-container')) {
      openSession(session.id);
    }
  });
  
  return li;
}

function formatDate(date) {
  const now = new Date();
  const diff = now - date;
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  
  if (days === 0) return 'Today';
  if (days === 1) return 'Yesterday';
  if (days < 7) return `${days} days ago`;
  if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
  return date.toLocaleDateString();
}

async function openSession(id) {
  try {
    const res = await fetch(`/api/chat/sessions/${id}/`, { credentials: 'include' });
    
    // Check if response is ok
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ detail: `HTTP ${res.status}` }));
      throw new Error(errorData.detail || errorData.error || `Failed to load session: ${res.status}`);
    }
    
    const data = await res.json();
    
    // Validate response structure
    if (!data || typeof data !== 'object') {
      throw new Error('Invalid session data received');
    }
    
    setSessionId(id);
    const chatWindow = document.getElementById('chatWindow');
    if (chatWindow) chatWindow.innerHTML = '';
    
    // Ensure we're in normal chat view (not first message view) - do this FIRST
    transitionToNormalChat();
    
    // Hide empty state
    const emptyState = document.getElementById('emptyState');
    if (emptyState) emptyState.classList.add('hidden');
    
    // Load messages
    const messages = Array.isArray(data.messages) ? data.messages : [];
    if (messages.length === 0) {
      // No messages in session, show AI greeting instead of empty state
      await greetUser(true);
    } else {
      // Session has messages - ensure first message view is definitely hidden
      transitionToNormalChat();
      let hasImagesInHistory = false;
      messages.forEach(m => {
        if (m && (m.role === 'user' || m.role === 'assistant') && m.content) {
          appendChatBubble(m.role, m.content, true);
          // Check if message has image attachments
          if (m.meta && m.meta.files) {
            const imageFiles = m.meta.files.filter(f => 
              f.type && f.type.startsWith('image/') || 
              /\.(jpg|jpeg|png|webp|heic)$/i.test(f.name || '')
            );
            if (imageFiles.length > 0) {
              hasImagesInHistory = true;
            }
          }
        }
      });
      
      // Final check - ensure first message view is hidden after loading messages
      transitionToNormalChat();
      // Update images badge if images found in history
      if (hasImagesInHistory) {
        localStorage.setItem('has_uploaded_images', 'true');
        updateImagesBadge();
      }
    }
    
    // Update active session highlight
    document.querySelectorAll('.session-card').forEach(card => {
      card.classList.remove('active');
      if (String(card.dataset.sid) === String(id)) {
        card.classList.add('active');
      }
    });
    
    // Refresh session list to update highlights
    await refreshSessionList();
    
    showToast('Session loaded', 'success');
    
  } catch (err) {
    console.error('Failed to open session:', err);
    const errorMsg = err.message || 'Failed to load session';
    showToast(errorMsg, 'error');
    // Clear session ID if it was invalid
    if (err.message && err.message.includes('not found')) {
      clearSessionId();
    }
  }
}

// Helper function to initialize a new chat (used for automatic initialization on login)
async function initializeNewChat() {
  const chatWindow = document.getElementById('chatWindow');
  if (chatWindow) {
    chatWindow.innerHTML = '';
    const emptyState = document.getElementById('emptyState');
    if (emptyState) emptyState.classList.add('hidden');
  }
  
  clearPending();
  
  try {
    // Create new session
    const res = await fetch('/api/chat/sessions/new/', {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() },
      credentials: 'include'
    });
    
    if (!res.ok) {
      throw new Error('Failed to create session');
    }
    
    const data = await res.json();
    
    if (data.session_id) {
      setSessionId(data.session_id);
      await refreshSessionList();
    }
    
    // Show first message view (centered, minimal)
    showFirstMessageView();
    
  } catch (err) {
    console.error('Failed to initialize new chat:', err);
    // Still show first message view even if session creation fails
    showFirstMessageView();
  }
}

// Show the centered first message view
async function showFirstMessageView() {
  const firstMessageView = document.getElementById('firstMessageView');
  const composer = document.getElementById('composer');
  const chatWindow = document.getElementById('chatWindow');
  const heading = document.getElementById('firstMessageHeading');
  
  if (firstMessageView) {
    // Fetch user name and update heading
    try {
      const res = await fetch('/api/user/settings/', { credentials: 'include' });
      const data = await res.json();
      // Use full_name (first_name + last_name) if available, otherwise display_name, then 'there'
      const name = data.full_name || data.display_name || 'there';
      if (heading) {
        heading.textContent = `Hi ${name}! How can I help you?`;
      }
    } catch (err) {
      console.error('Failed to load user settings:', err);
      // Keep default text if API fails
      if (heading) {
        heading.textContent = 'Hi there! How can I help you?';
      }
    }
    
    // Remove hidden class and clear any inline styles that might hide it
    firstMessageView.classList.remove('hidden');
    firstMessageView.style.display = '';
    firstMessageView.style.visibility = '';
    firstMessageView.style.opacity = '';
    firstMessageView.style.pointerEvents = '';
    
    // Hide composer for minimal first view (sidebar stays visible)
    if (composer) composer.style.display = 'none';
    // Hide chat window content
    if (chatWindow) {
      chatWindow.style.display = 'none';
    }
  }
}

// Transition from first message view to normal chat interface
function transitionToNormalChat() {
  const firstMessageView = document.getElementById('firstMessageView');
  const composer = document.getElementById('composer');
  const chatWindow = document.getElementById('chatWindow');
  
  // Hide first message view IMMEDIATELY - use both class and inline style for reliability
  if (firstMessageView) {
    firstMessageView.classList.add('hidden');
    firstMessageView.style.display = 'none';
    firstMessageView.style.visibility = 'hidden';
  }
  
  // Show composer and chat window
  if (composer) {
    composer.style.display = '';
  }
  
  // Ensure chat window is visible
  if (chatWindow) {
    chatWindow.style.display = '';
  }
  
  // Focus the regular input
  const regularInput = document.getElementById('chatInput');
  if (regularInput) {
    setTimeout(() => regularInput.focus(), 100);
  }
}

async function newChat() {
  const chatWindow = document.getElementById('chatWindow');
  if (chatWindow) {
    chatWindow.innerHTML = '';
    const emptyState = document.getElementById('emptyState');
    if (emptyState) emptyState.classList.add('hidden');
  }
  
  clearSessionId();
  clearPending();
  
  try {
    await fetch('/clear-session/', {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() },
      credentials: 'include'
    });
    
    const res = await fetch('/api/chat/sessions/new/', {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() },
      credentials: 'include'
    });
    const data = await res.json();
    
    if (data.session_id) {
      setSessionId(data.session_id);
      await refreshSessionList();
    }
    
    // Show first message view with greeting after creating new session
    showFirstMessageView();
    
  } catch (err) {
    console.error('Failed to create new chat:', err);
    showToast('Failed to create new chat', 'error');
    // Still show first message view even if session creation fails
    showFirstMessageView();
  }
}

async function greetUser(showBubble = false) {
  try {
    const res = await fetch('/api/user/settings/', { credentials: 'include' });
    const data = await res.json();
    const name = data.display_name || 'there';
    
    const greetings = [
      `Hi ${name}!  I'm your medical assistant. I'm here to help you understand your health information, analyze medical documents, and answer your questions. What would you like to explore today?`,
      `Welcome, ${name}!  I'm ready to assist you with medical information, document analysis, and health questions. Feel free to share documents, images, or ask me anything.`,
      `Hello ${name}!  I can help you understand medical documents, analyze health images, and provide clear explanations. What can I help you with today?`,
      `Hi there, ${name}!  I'm your medical guide. I'm here to translate medical jargon, review documents, and help you make sense of your health information. How can I assist you?`,
      `Welcome back, ${name}!  Whether you have questions about symptoms, need help understanding test results, or want to review medical documents, I'm here to help. What's on your mind?`,
    ];
    
    const greeting = greetings[Math.floor(Math.random() * greetings.length)];
    
    // Update empty state greeting text
    const greetingEl = document.getElementById('greetingText');
    if (greetingEl) greetingEl.textContent = greeting.split('!')[0] + '!';
    
    // Show greeting as AI chat bubble if requested (only for restored sessions with no messages)
    if (showBubble) {
      const chatWindow = document.getElementById('chatWindow');
      const emptyState = document.getElementById('emptyState');
      const firstMessageView = document.getElementById('firstMessageView');
      
      // Only show bubble if we're not in first message view and chat window is empty
      if (chatWindow && chatWindow.children.length === 0 && 
          (!firstMessageView || firstMessageView.classList.contains('hidden'))) {
        // Hide empty state
        if (emptyState) emptyState.classList.add('hidden');
        
        // Add greeting bubble
        appendChatBubble('assistant', greeting, false);
      }
    }
    
  } catch (err) {
    console.error('Failed to load user settings:', err);
    // Fallback greeting if API fails
    if (showBubble) {
      const chatWindow = document.getElementById('chatWindow');
      const emptyState = document.getElementById('emptyState');
      const firstMessageView = document.getElementById('firstMessageView');
      if (chatWindow && chatWindow.children.length === 0 && 
          (!firstMessageView || firstMessageView.classList.contains('hidden'))) {
        if (emptyState) emptyState.classList.add('hidden');
        appendChatBubble('assistant', 'Hi there!  I\'m your medical assistant. How can I help you today?', false);
      }
    }
  }
}

// Session menu (3-dot menu)
function openSessionMenu(sessionId, event) {
  event.stopPropagation();
  
  // Close any existing menus
  document.querySelectorAll('.session-menu-popover').forEach(m => m.remove());
  
  const popover = document.createElement('div');
  popover.className = 'popover session-menu-popover';
  
  // Check if session is archived
  const sessionCard = event.target.closest('.session-card');
  const isArchived = sessionCard?.closest('#archivedList') !== null;
  
  // Get button position
  const button = event.target.closest('button') || event.target;
  const buttonRect = button.getBoundingClientRect();
  
  // Calculate position - show below the button, aligned to the right
  const popoverTop = buttonRect.bottom + 4;
  const popoverRight = window.innerWidth - buttonRect.right;
  
  // Set fixed positioning relative to viewport
  popover.style.position = 'fixed';
  popover.style.top = `${popoverTop}px`;
  popover.style.right = `${popoverRight}px`;
  popover.style.minWidth = '160px';
  popover.style.zIndex = '9999';
  
  popover.innerHTML = `
    <button class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded flex items-center gap-2" onclick="startRenameSession(${sessionId})">
      <i class="fa-solid fa-pen text-gray-500"></i>
      <span>Rename</span>
    </button>
    <button class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded flex items-center gap-2" onclick="${isArchived ? 'unarchiveSession' : 'archiveSession'}(${sessionId})">
      <i class="fa-solid fa-box-archive text-gray-500"></i>
      <span>${isArchived ? 'Unarchive' : 'Archive'}</span>
    </button>
    <button class="w-full text-left px-3 py-2 hover:bg-gray-50 rounded flex items-center gap-2 text-red-600" onclick="confirmDeleteSession(${sessionId})">
      <i class="fa-solid fa-trash text-red-600"></i>
      <span>Delete</span>
    </button>
  `;
  
  // Append to body instead of session card to avoid z-index issues
  document.body.appendChild(popover);
  
  // Adjust position if popover would go off screen
  setTimeout(() => {
    const popoverRect = popover.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const viewportWidth = window.innerWidth;
    
    // If popover goes off bottom, show above button instead
    if (popoverRect.bottom > viewportHeight - 10) {
      popover.style.top = `${buttonRect.top - popoverRect.height - 4}px`;
    }
    
    // If popover goes off right, align to left edge of button
    if (popoverRect.right > viewportWidth - 10) {
      popover.style.right = `${window.innerWidth - buttonRect.left}px`;
    }
  }, 0);
  
  // Close on outside click
  setTimeout(() => {
    document.addEventListener('click', function closeMenu(e) {
      if (!popover.contains(e.target) && e.target !== button && !button.contains(e.target)) {
        popover.remove();
        document.removeEventListener('click', closeMenu);
      }
    }, { once: true });
  }, 0);
}

async function startRenameSession(sessionId) {
  const card = document.querySelector(`.session-card[data-sid="${sessionId}"]`);
  if (!card) return;
  
  const titleEl = card.querySelector('.session-title');
  if (!titleEl) return;
  
  const currentTitle = titleEl.textContent;
  const input = document.createElement('input');
  input.type = 'text';
  input.value = currentTitle;
  input.className = 'w-full px-2 py-1 border border-[#28926D] rounded focus:outline-none focus:ring-2 focus:ring-[#28926D]/40';
  input.style.fontSize = '14px';
  input.style.fontWeight = '600';
  
  const saveRename = async () => {
    const newTitle = input.value.trim();
    if (!newTitle) {
      showToast('Title cannot be empty', 'error');
      titleEl.textContent = currentTitle;
      return;
    }
    
    try {
      const res = await fetch(`/api/chat/sessions/${sessionId}/rename/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ title: newTitle }),
        credentials: 'include'
      });
      
      if (res.ok) {
        titleEl.textContent = newTitle;
        showToast('Session renamed', 'success');
        await refreshSessionList();
      } else {
        throw new Error('Rename failed');
      }
    } catch (err) {
      showToast('Failed to rename session', 'error');
      titleEl.textContent = currentTitle;
    }
  };
  
  titleEl.replaceWith(input);
  input.focus();
  input.select();
  
  input.addEventListener('blur', saveRename);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      input.blur();
    } else if (e.key === 'Escape') {
      titleEl.textContent = currentTitle;
      input.replaceWith(titleEl);
    }
  });
  
  // Close menu
  document.querySelectorAll('.session-menu-popover').forEach(m => m.remove());
}

async function archiveSession(sessionId) {
  try {
    const res = await fetch(`/api/chat/sessions/${sessionId}/archive/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({ archived: true }),
      credentials: 'include'
    });
    
    if (res.ok) {
      showToast('Session archived', 'success');
      
      // If this was the active session, clear it
      if (String(getSessionId()) === String(sessionId)) {
        clearSessionId();
        const chatWindow = document.getElementById('chatWindow');
        if (chatWindow) chatWindow.innerHTML = '';
        const emptyState = document.getElementById('emptyState');
        if (emptyState) emptyState.classList.remove('hidden');
      }
      
      // Update UI immediately - remove from active, add to archived
      const sessionCard = document.querySelector(`.session-card[data-sid="${sessionId}"]`);
      if (sessionCard) {
        sessionCard.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
          sessionCard.remove();
          refreshSessionList(); // Refresh to update archived section
        }, 300);
      } else {
        await refreshSessionList();
      }
    } else {
      throw new Error('Archive failed');
    }
  } catch (err) {
    showToast('Failed to archive session', 'error');
  }
  
  // Close menu
  document.querySelectorAll('.session-menu-popover').forEach(m => m.remove());
}

async function unarchiveSession(sessionId) {
  try {
    const res = await fetch(`/api/chat/sessions/${sessionId}/archive/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({ archived: false }),
      credentials: 'include'
    });
    
    if (res.ok) {
      showToast('Session unarchived', 'success');
      
      // Update UI immediately - remove from archived, add to active
      const sessionCard = document.querySelector(`.session-card[data-sid="${sessionId}"]`);
      if (sessionCard) {
        sessionCard.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
          sessionCard.remove();
          refreshSessionList(); // Refresh to update lists
        }, 300);
      } else {
        await refreshSessionList();
      }
    } else {
      throw new Error('Unarchive failed');
    }
  } catch (err) {
    showToast('Failed to unarchive session', 'error');
  }
  
  // Close menu
  document.querySelectorAll('.session-menu-popover').forEach(m => m.remove());
}

function confirmDeleteSession(sessionId) {
  deleteSessionId = sessionId;
  const modal = document.getElementById('deleteModal');
  if (modal) modal.classList.remove('hidden');
  
  // Close menu
  document.querySelectorAll('.session-menu-popover').forEach(m => m.remove());
}

function closeDeleteModal() {
  const modal = document.getElementById('deleteModal');
  if (modal) modal.classList.add('hidden');
  deleteSessionId = null;
}

async function confirmDelete() {
  if (!deleteSessionId) return;
  
  const deleteFiles = document.getElementById('deleteFiles')?.checked || false;
  const sessionIdToDelete = deleteSessionId;
  
  // OPTIMISTIC UI UPDATE - Remove from UI immediately for instant feedback
  const sessionCard = document.querySelector(`.session-card[data-sid="${sessionIdToDelete}"]`);
  const wasActiveSession = String(getSessionId()) === String(sessionIdToDelete);
  
  // Close modal immediately
  closeDeleteModal();
  
  // Remove card instantly (no animation delay)
  if (sessionCard) {
    sessionCard.remove();
  }
  
  // If this was the active session, clear it immediately
  if (wasActiveSession) {
    clearSessionId();
    const chatWindow = document.getElementById('chatWindow');
    if (chatWindow) chatWindow.innerHTML = '';
    showFirstMessageView();
  }
  
  // Show success toast immediately
  showToast('Session deleted', 'success');
  
  // Perform actual deletion in background (don't block UI)
  fetch(`/api/chat/sessions/${sessionIdToDelete}/delete/`, {
      method: 'POST',
    headers: { 
      'X-CSRFToken': getCSRFToken(),
      'Content-Type': 'application/json'
    },
      credentials: 'include'
  })
  .then(async (res) => {
    let responseData;
    try {
      responseData = await res.json();
    } catch {
      responseData = {};
    }
    
    if (!res.ok || (!responseData.deleted && !responseData.ok)) {
      // If deletion failed, refresh list to restore the card
      console.error('Delete failed on server:', responseData);
      refreshSessionList().catch(() => {});
      showToast('Failed to delete session. Please try again.', 'error');
    } else {
      // Success - refresh list in background to ensure consistency
      refreshSessionList().catch(() => {});
    }
  })
  .catch((err) => {
    console.error('Delete error:', err);
    // Refresh list to restore card if network error
    refreshSessionList().catch(() => {});
    showToast('Network error. Please check your connection.', 'error');
  });
}

// ============================================
// BULK DELETE FUNCTIONALITY
// ============================================

let bulkSelectMode = false;

function toggleBulkSelect() {
  bulkSelectMode = !bulkSelectMode;
  const checkboxes = document.querySelectorAll('.session-checkbox-container');
  const bulkActionsBar = document.getElementById('bulkActionsBar');
  const toggleContainer = document.getElementById('toggleBulkSelectContainer');
  
  checkboxes.forEach(container => {
    container.style.display = bulkSelectMode ? 'flex' : 'none';
  });
  
  if (bulkActionsBar) {
    if (bulkSelectMode) {
      bulkActionsBar.classList.remove('hidden');
      updateSelectedCount();
    } else {
      bulkActionsBar.classList.add('hidden');
      // Uncheck all
      document.querySelectorAll('.session-checkbox').forEach(cb => cb.checked = false);
    }
  }
  
  // Hide/show toggle button container
  if (toggleContainer) {
    toggleContainer.style.display = bulkSelectMode ? 'none' : 'flex';
  }
}

function updateSelectedCount() {
  const checked = document.querySelectorAll('.session-checkbox:checked');
  const count = checked.length;
  const countEl = document.getElementById('selectedCount');
  if (countEl) {
    countEl.textContent = `${count} selected`;
  }
  
  const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
  if (bulkDeleteBtn) {
    bulkDeleteBtn.disabled = count === 0;
  }
}

function selectAllSessions() {
  const checkboxes = document.querySelectorAll('.session-checkbox');
  const allChecked = Array.from(checkboxes).every(cb => cb.checked);
  
  // Toggle: if all are checked, deselect all; otherwise select all
  checkboxes.forEach(cb => {
    cb.checked = !allChecked;
  });
  updateSelectedCount();
}

function deselectAllSessions() {
  document.querySelectorAll('.session-checkbox').forEach(cb => {
    cb.checked = false;
  });
  updateSelectedCount();
}

function getSelectedSessionIds() {
  const checked = document.querySelectorAll('.session-checkbox:checked');
  return Array.from(checked).map(cb => cb.dataset.sessionId);
}

function openBulkDeleteModal() {
  const selectedIds = getSelectedSessionIds();
  if (selectedIds.length === 0) {
    showToast('Please select at least one chat to delete', 'info');
    return;
  }
  
  const modal = document.getElementById('bulkDeleteModal');
  const countEl = document.getElementById('bulkDeleteCount');
  if (countEl) countEl.textContent = selectedIds.length;
  if (modal) modal.classList.remove('hidden');
}

function closeBulkDeleteModal() {
  const modal = document.getElementById('bulkDeleteModal');
  if (modal) modal.classList.add('hidden');
  const checkbox = document.getElementById('bulkDeleteFiles');
  if (checkbox) checkbox.checked = false;
}

async function confirmBulkDelete() {
  const selectedIds = getSelectedSessionIds();
  if (selectedIds.length === 0) return;
  
  const deleteFiles = document.getElementById('bulkDeleteFiles')?.checked || false;
  const deleteBtn = document.getElementById('confirmBulkDeleteBtn');
  const originalText = deleteBtn?.textContent || 'Delete All';
  
  if (deleteBtn) {
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting...';
  }
  
  try {
    // Delete all sessions in parallel for speed
    const deletePromises = selectedIds.map(sessionId => 
      fetch(`/api/chat/sessions/${sessionId}/delete/`, {
        method: 'POST',
        headers: { 
          'X-CSRFToken': getCSRFToken(),
          'Content-Type': 'application/json'
        },
        credentials: 'include'
      })
    );
    
    const results = await Promise.allSettled(deletePromises);
    
    // Count successful deletions
    let successCount = 0;
    let failCount = 0;
    
    results.forEach((result, index) => {
      if (result.status === 'fulfilled' && result.value.ok) {
        successCount++;
        // Immediately remove from UI
        const sessionCard = document.querySelector(`.session-card[data-sid="${selectedIds[index]}"]`);
        if (sessionCard) {
          sessionCard.style.animation = 'fadeOut 0.2s ease-out';
          setTimeout(() => sessionCard.remove(), 200);
        }
      
      // If this was the active session, clear it
        if (String(getSessionId()) === String(selectedIds[index])) {
        clearSessionId();
          const chatWindow = document.getElementById('chatWindow');
          if (chatWindow) chatWindow.innerHTML = '';
          showFirstMessageView();
      }
    } else {
        failCount++;
      }
    });
    
    closeBulkDeleteModal();
    
    if (successCount > 0) {
      showToast(`Deleted ${successCount} chat${successCount > 1 ? 's' : ''} successfully`, 'success');
      // Refresh in background
      refreshSessionList().catch(() => {});
      
      // Exit bulk select mode
      toggleBulkSelect();
    }
    
    if (failCount > 0) {
      showToast(`Failed to delete ${failCount} chat${failCount > 1 ? 's' : ''}`, 'error');
    }
    
  } catch (err) {
    console.error('Bulk delete error:', err);
    showToast('Failed to delete chats', 'error');
  } finally {
    if (deleteBtn) {
      deleteBtn.disabled = false;
      deleteBtn.textContent = originalText;
    }
  }
}

// ============================================
// SEND CHAT - Premium Flow
// ============================================

async function sendChat() {
  if (chatLocked) return;
  
  // Check if we're using the first message view
  const firstMessageView = document.getElementById('firstMessageView');
  const isFirstMessage = firstMessageView && !firstMessageView.classList.contains('hidden');
  
  const firstInputEl = document.getElementById('firstChatInput');
  const regularInputEl = document.getElementById('chatInput');
  
  // Get text - check both inputs (event handlers should have copied from first to regular)
  // But also check first input in case it wasn't copied yet
  let text = '';
  if (firstInputEl && firstInputEl.value.trim()) {
    text = firstInputEl.value.trim();
    // Copy to regular input if not already there
    if (regularInputEl && !regularInputEl.value.trim()) {
      regularInputEl.value = text;
    }
  } else if (regularInputEl && regularInputEl.value.trim()) {
    text = regularInputEl.value.trim();
  }
  
  // Validation: must have text or files
  if (!text && pending.length === 0) {
    showToast('Please enter a message or attach files', 'info');
    return;
  }
  
  // If this is the first message, transition to normal chat view IMMEDIATELY (before sending)
  // Note: This should already be called by the event handlers, but ensure it here too
  if (isFirstMessage) {
    transitionToNormalChat();
    // Clear first input after copying
    if (firstInputEl) firstInputEl.value = '';
    
    // Double-check first message view is hidden (in case transition wasn't called)
    if (firstMessageView && !firstMessageView.classList.contains('hidden')) {
      transitionToNormalChat();
    }
  }
  
  const inputEl = regularInputEl; // Always use regular input after transition
  
  chatLocked = true;
  
  // Disable send button
  const sendBtn = document.getElementById('sendBtn');
  if (sendBtn) {
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
  }
  
  // Save pending files BEFORE clearing (for API call and user bubble display)
  const pendingFilesToSend = [...pending];
  
  // Show user message immediately (optimistic UI)
  if (text || pendingFilesToSend.length > 0) {
    const userContent = document.createElement('div');
    
    if (text) {
      const textDiv = document.createElement('div');
      textDiv.textContent = text;
      userContent.appendChild(textDiv);
    }
    
    if (pendingFilesToSend.length > 0) {
      const filesDiv = document.createElement('div');
      filesDiv.className = 'flex flex-wrap gap-2 mt-2';
      pendingFilesToSend.forEach(item => {
        const fileChip = document.createElement('div');
        fileChip.className = 'flex items-center gap-2 bg-white/20 rounded-lg px-3 py-2 text-sm';
        if (item.kind === 'image' && item.url) {
          const img = document.createElement('img');
          img.src = item.url;
          img.className = 'w-8 h-8 object-cover rounded';
          fileChip.appendChild(img);
        } else {
          const icon = document.createElement('i');
          icon.className = 'fa-solid fa-file-lines';
          fileChip.appendChild(icon);
        }
        const name = document.createElement('span');
        name.textContent = item.file.name;
        name.className = 'max-w-[120px] truncate';
        fileChip.appendChild(name);
        filesDiv.appendChild(fileChip);
      });
      userContent.appendChild(filesDiv);
    }
    
    appendChatBubble('user', userContent);
  }
  
  // Clear input (both first message and regular input)
  const regularInput = document.getElementById('chatInput');
  if (regularInput) regularInput.value = '';
  // Also clear first input if it exists
  if (firstInputEl) firstInputEl.value = '';
  
  // Clear pending attachments IMMEDIATELY after sending (optimistic UI)
  // This removes them from the pending section right away
  clearPending();
  
  // Ensure chat window is visible before showing typing indicator
  const chatWindow = document.getElementById('chatWindow');
  if (chatWindow) {
    chatWindow.style.display = '';
  }
  
  // Show typing indicator with context-aware message
  let typingContext = 'Analyzing...';
  if (pendingFilesToSend.length > 0) {
    const imageCount = pendingFilesToSend.filter(p => p.kind === 'image').length;
    if (imageCount > 0) {
      typingContext = `Processing ${imageCount} image${imageCount > 1 ? 's' : ''}...`;
    } else {
      typingContext = 'Extracting text from documents...';
    }
  }
  showTypingIndicator(typingContext);
  
  try {
    // Get settings
    const tone = localStorage.getItem('nm_tone') || 'PlainClinical';
    const lang = localStorage.getItem('nm_lang') || 'en-US';
    const care = localStorage.getItem('nm_care_setting') || 'hospital';
    const faith = localStorage.getItem('nm_faith_setting') || 'general';
    
    // Log language being sent for debugging
    console.log('Sending chat with language:', lang);
    
    // Build FormData
    const formData = new FormData();
    if (text) formData.append('message', text);
    formData.append('tone', tone);
    formData.append('lang', lang); // Ensure language is sent
    formData.append('care_setting', care);
    formData.append('faith_setting', faith);
    
    const sid = getSessionId();
    if (sid) formData.append('session_id', sid);
    
    // Add files and track if images are being sent (use saved copy since pending is already cleared)
    let hasImagesInUpload = false;
    pendingFilesToSend.forEach(item => {
      formData.append('files[]', item.file, item.file.name);
      if (item.kind === 'image') {
        hasImagesInUpload = true;
      }
    });
    
    // Mark that user has uploaded images
    if (hasImagesInUpload) {
      localStorage.setItem('has_uploaded_images', 'true');
      updateImagesBadge();
    }
    
    // Send request
    const res = await fetch('/api/send-chat/', {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() },
      body: formData,
      credentials: 'include'
    });
    
    let data;
    try {
      data = await res.json();
    } catch {
      const text = await res.text();
      throw new Error(`Server error: ${res.status}`);
    }
    
    if (!res.ok) {
      throw new Error(data.detail || data.message || 'Request failed');
    }
    
    // Update session ID if provided
    if (data.session_id) {
      setSessionId(data.session_id);
      await refreshSessionList();
    }
    
    // Hide typing indicator
    hideTypingIndicator();
    
    // Show response
    appendChatBubble('assistant', data.reply);
    
    // Ensure first message view is hidden after sending (double-check)
    transitionToNormalChat();
    
    // Note: Pending files are already cleared above (optimistic UI) - no need to clear again
    
    // Show success
    showToast('Message sent', 'success');
    
  } catch (err) {
    console.error('sendChat error:', err);
    hideTypingIndicator();
    showToast('Failed to send message. Please try again.', 'error', {
      text: 'Retry',
      onclick: 'sendChat()'
    });
    appendChatBubble('assistant', ' Sorry, something went wrong. Please try again.');
  } finally {
    chatLocked = false;
    if (sendBtn) {
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
    }
  }
}

// ============================================
// TONE / CARE / FAITH SELECTORS
// ============================================

let currentTone = localStorage.getItem('nm_tone') || 'PlainClinical';
let currentCare = localStorage.getItem('nm_care_setting') || 'hospital';
let currentFaith = localStorage.getItem('nm_faith_setting') || 'general';

function initToneSelector() {
  const toneBtn = document.getElementById('toneBtn');
  const tonePopover = document.getElementById('tonePopover');
  
  if (!toneBtn || !tonePopover) return;
  
  toneBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const rect = toneBtn.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const viewportWidth = window.innerWidth;
    
    // Calculate position - prefer above if near bottom
    let top = rect.bottom + 8;
    let left = rect.left;
    
    // If popover would go off bottom, show above button
    const popoverHeight = 400; // Approximate height
    if (top + popoverHeight > viewportHeight - 20) {
      top = rect.top - popoverHeight - 8;
    }
    
    // Ensure popover doesn't go off right edge
    const popoverWidth = 320;
    if (left + popoverWidth > viewportWidth - 20) {
      left = viewportWidth - popoverWidth - 20;
    }
    
    // Ensure popover doesn't go off left edge
    if (left < 20) {
      left = 20;
    }
    
    // Ensure popover doesn't go off top
    if (top < 20) {
      top = 20;
    }
    
    tonePopover.style.display = 'block';
    tonePopover.style.position = 'fixed';
    tonePopover.style.top = `${top}px`;
    tonePopover.style.left = `${left}px`;
    tonePopover.style.zIndex = '1000';
    tonePopover.classList.remove('hidden');
    
    // Mark current selection with visual indicator
    tonePopover.querySelectorAll('.tone-option').forEach(opt => {
      opt.classList.remove('bg-token-accent', 'text-white', 'ring-2', 'ring-accent', 'active-tone');
      opt.classList.add('bg-token-paper');
      
      // Reset text colors to default
      const title = opt.querySelector('.tone-title');
      const description = opt.querySelector('.tone-description');
      const icon = opt.querySelector('.tone-icon');
      const checkIcon = opt.querySelector('.tone-check');
      
      if (opt.dataset.tone === currentTone) {
        opt.classList.add('bg-token-accent', 'text-white', 'ring-2', 'ring-accent', 'active-tone');
        
        // Force white text for all elements when active
        if (title) {
          title.classList.add('text-white');
          title.style.color = 'white';
        }
        if (description) {
          description.classList.remove('text-gray-500');
          description.classList.add('text-white');
          description.style.color = 'white';
        }
        if (icon) {
          icon.classList.add('text-white');
          icon.style.color = 'white';
        }
        if (checkIcon) {
          checkIcon.classList.remove('opacity-0');
          checkIcon.classList.add('opacity-100', 'text-white');
          checkIcon.style.color = 'white';
        }
      } else {
        // Reset to default colors
        if (title) title.classList.remove('text-white');
        if (description) {
          description.classList.remove('text-white');
          description.classList.add('text-gray-500');
        }
        if (icon) icon.classList.remove('text-white');
        if (checkIcon) {
          checkIcon.classList.add('opacity-0');
          checkIcon.classList.remove('opacity-100', 'text-white');
        }
      }
    });
    
    // Scroll popover into view if needed
    tonePopover.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  });
  
  // Close on outside click
  document.addEventListener('click', (e) => {
    if (!tonePopover.contains(e.target) && 
        e.target !== toneBtn && 
        !toneBtn.contains(e.target)) {
      tonePopover.classList.add('hidden');
      tonePopover.style.display = 'none';
    }
  });
  
  // Close on ESC key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !tonePopover.classList.contains('hidden')) {
      tonePopover.classList.add('hidden');
      tonePopover.style.display = 'none';
    }
  });
  
  // Handle tone selection - improved UX with better feedback
  tonePopover.querySelectorAll('.tone-option').forEach(opt => {
    // Add click handler with proper event handling
    opt.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const tone = opt.dataset.tone;
      console.log('Tone selected:', tone);
      
      // Immediate visual feedback - highlight selected option
      tonePopover.querySelectorAll('.tone-option').forEach(o => {
        o.classList.remove('bg-token-accent', 'text-white', 'ring-2', 'ring-accent', 'active-tone');
        o.classList.add('bg-white');
        
        // Reset text colors with inline styles
        const title = o.querySelector('.tone-title');
        const desc = o.querySelector('.tone-description');
        const icon = o.querySelector('.tone-icon');
        const check = o.querySelector('.tone-check');
        
        if (title) {
          title.classList.remove('text-white');
          title.style.color = '';
        }
        if (desc) {
          desc.classList.remove('text-white');
          desc.classList.add('text-gray-500');
          desc.style.color = '';
        }
        if (icon) {
          icon.classList.remove('text-white');
          icon.style.color = '';
        }
        if (check) {
          check.classList.add('opacity-0');
          check.classList.remove('opacity-100', 'text-white');
          check.style.color = '';
        }
      });
      
      // Highlight the clicked option immediately with white text and softer green
      opt.classList.remove('bg-white', 'bg-gray-100');
      opt.classList.add('bg-[#28926D]', 'text-white', 'ring-2', 'ring-[#28926D]', 'active-tone');
      
      const title = opt.querySelector('.tone-title');
      const description = opt.querySelector('.tone-description');
      const icon = opt.querySelector('.tone-icon');
      const checkIcon = opt.querySelector('.tone-check');
      
      // Force all text to white when active using both classes and inline styles
      if (title) {
        title.classList.add('text-white');
        title.style.color = 'white';
      }
      if (description) {
        description.classList.remove('text-gray-500');
        description.classList.add('text-white');
        description.style.color = 'white';
      }
      if (icon) {
        icon.classList.add('text-white');
        icon.style.color = 'white';
      }
      if (checkIcon) {
        checkIcon.classList.remove('opacity-0');
        checkIcon.classList.add('opacity-100', 'text-white');
        checkIcon.style.color = 'white';
      }
      
      // Apply selection after brief visual feedback
      setTimeout(() => {
        currentTone = tone;
        localStorage.setItem('nm_tone', tone);
        
        // Update button text
        const toneLabels = {
          'PlainClinical': 'Balanced',
          'Caregiver': 'Caregiver',
          'Faith': 'Faith',
          'Clinical': 'Clinical',
          'Geriatric': 'Geriatric',
          'EmotionalSupport': 'Emotional Support'
        };
        const label = toneLabels[tone] || tone;
        const toneBtnSpan = toneBtn.querySelector('span');
        if (toneBtnSpan) {
          toneBtnSpan.textContent = label;
        }
        
        // Close popover smoothly
        tonePopover.style.opacity = '0';
        tonePopover.style.transform = 'translateY(-10px)';
        setTimeout(() => {
          tonePopover.classList.add('hidden');
          tonePopover.style.display = 'none';
          tonePopover.style.opacity = '1';
          tonePopover.style.transform = 'translateY(0)';
        }, 200);
        
        // Update UI
        updateActiveChips();
        showToast(` Tone set to ${label}`, 'success');
        
        // Show/hide care/faith based on tone
        updateConditionalSettings();
      }, 200);
    });
    
    // Enhanced hover effect - only if not selected
    opt.addEventListener('mouseenter', () => {
      if (!opt.classList.contains('bg-token-accent')) {
        opt.classList.remove('bg-white');
        opt.classList.add('bg-gray-100');
      }
    });
    
    opt.addEventListener('mouseleave', () => {
      if (!opt.classList.contains('bg-token-accent')) {
        opt.classList.remove('bg-gray-100');
        opt.classList.add('bg-white');
      }
    });
  });
}

function updateConditionalSettings() {
  const careGroup = document.getElementById('careGroup');
  const faithGroup = document.getElementById('faithGroup');
  
  // Care setting only for Caregiver and Clinical
  if (careGroup) {
    if (currentTone === 'Caregiver' || currentTone === 'Clinical') {
      careGroup.classList.remove('hidden');
    } else {
      careGroup.classList.add('hidden');
    }
  }
  
  // Faith setting only for Faith tone
  if (faithGroup) {
    if (currentTone === 'Faith') {
      faithGroup.classList.remove('hidden');
    } else {
      faithGroup.classList.add('hidden');
    }
  }
}

function initCareSelector() {
  const carePopover = document.getElementById('carePopover');
  if (!carePopover) return;
  
  // Care selector triggered from active chips
  carePopover.querySelectorAll('.care-option').forEach(opt => {
    opt.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const care = opt.dataset.care;
      
      // Visual feedback
      carePopover.querySelectorAll('.care-option').forEach(o => {
        o.classList.remove('bg-token-accent', 'text-white', 'ring-2', 'ring-accent', 'active-tone');
        o.classList.add('bg-white');
      });
      
      opt.classList.remove('bg-white');
      opt.classList.add('bg-[#28926D]', 'text-white', 'ring-2', 'ring-[#28926D]', 'active-tone');
      
      setTimeout(() => {
        currentCare = care;
        localStorage.setItem('nm_care_setting', care);
        carePopover.classList.add('hidden');
        carePopover.style.display = 'none';
        updateActiveChips();
        showToast(`Care setting: ${opt.querySelector('.font-medium').textContent}`, 'success');
      }, 200);
    });
  });
  
  // Close on outside click
  document.addEventListener('click', (e) => {
    if (!carePopover.contains(e.target) && !carePopover.classList.contains('hidden')) {
      const careChip = document.querySelector('[data-chip="care"]');
      if (!careChip || !careChip.contains(e.target)) {
        carePopover.classList.add('hidden');
        carePopover.style.display = 'none';
      }
    }
  });
}

function initFaithSelector() {
  const faithPopover = document.getElementById('faithPopover');
  if (!faithPopover) return;
  
  // Faith selector triggered from active chips
  faithPopover.querySelectorAll('.faith-option').forEach(opt => {
    opt.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const faith = opt.dataset.faith;
      
      // Visual feedback
      faithPopover.querySelectorAll('.faith-option').forEach(o => {
        o.classList.remove('bg-token-accent', 'text-white', 'ring-2', 'ring-accent', 'active-tone');
        o.classList.add('bg-white');
      });
      
      opt.classList.remove('bg-white');
      opt.classList.add('bg-[#28926D]', 'text-white', 'ring-2', 'ring-[#28926D]', 'active-tone');
      
      setTimeout(() => {
        currentFaith = faith;
        localStorage.setItem('nm_faith_setting', faith);
        faithPopover.classList.add('hidden');
        faithPopover.style.display = 'none';
        updateActiveChips();
        showToast(`Faith setting: ${opt.querySelector('.font-medium').textContent}`, 'success');
      }, 200);
    });
  });
  
  // Close on outside click
  document.addEventListener('click', (e) => {
    if (!faithPopover.contains(e.target) && !faithPopover.classList.contains('hidden')) {
      const faithChip = document.querySelector('[data-chip="faith"]');
      if (!faithChip || !faithChip.contains(e.target)) {
        faithPopover.classList.add('hidden');
        faithPopover.style.display = 'none';
      }
    }
  });
  
  console.log('Faith selector initialized');
}

function updateActiveChips() {
  const chipsContainer = document.getElementById('activeChips');
  if (!chipsContainer) return;
  
  chipsContainer.innerHTML = '';
  
  // Tone chip
  const toneLabels = {
    'PlainClinical': 'Balanced',
    'Caregiver': 'Caregiver',
    'Faith': 'Faith',
    'Clinical': 'Clinical',
    'Geriatric': 'Geriatric',
    'EmotionalSupport': 'Emotional Support'
  };
  const toneChip = createChip('Tone', toneLabels[currentTone] || currentTone, (e) => {
    e.preventDefault();
    e.stopPropagation();
    console.log('Tone chip clicked');
    const toneBtn = document.getElementById('toneBtn');
    const tonePopover = document.getElementById('tonePopover');
    if (toneBtn && tonePopover) {
      // Trigger the same logic as tone button click
      const rect = toneChip.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      const viewportWidth = window.innerWidth;
      
      let top = rect.bottom + 8;
      let left = rect.left;
      
      const popoverHeight = 400;
      if (top + popoverHeight > viewportHeight - 20) {
        top = rect.top - popoverHeight - 8;
      }
      
      const popoverWidth = 320;
      if (left + popoverWidth > viewportWidth - 20) {
        left = viewportWidth - popoverWidth - 20;
      }
      
      if (left < 20) left = 20;
      if (top < 20) top = 20;
      
      tonePopover.style.display = 'block';
      tonePopover.style.position = 'fixed';
      tonePopover.style.top = `${top}px`;
      tonePopover.style.left = `${left}px`;
      tonePopover.style.zIndex = '1000';
      tonePopover.classList.remove('hidden');
      
      // Mark current selection
      tonePopover.querySelectorAll('.tone-option').forEach(opt => {
        opt.classList.remove('bg-[#28926D]', 'text-white', 'ring-2', 'ring-[#28926D]', 'active-tone');
        opt.classList.add('bg-white');
        const checkIcon = opt.querySelector('.tone-check');
        
        if (opt.dataset.tone === currentTone) {
          opt.classList.add('bg-token-accent', 'text-white', 'ring-2', 'ring-accent', 'active-tone');
          if (checkIcon) {
            checkIcon.classList.remove('opacity-0');
            checkIcon.classList.add('opacity-100');
          }
        } else {
          if (checkIcon) {
            checkIcon.classList.add('opacity-0');
            checkIcon.classList.remove('opacity-100');
          }
        }
      });
    } else {
      // Fallback: try clicking the button
      toneBtn?.click();
    }
  });
  toneChip.setAttribute('title', 'Click to change tone');
  chipsContainer.appendChild(toneChip);
  
  // Care chip (conditional)
  if (currentTone === 'Caregiver' || currentTone === 'Clinical') {
    const careLabels = {
      'hospital': 'Hospital',
      'ambulatory': 'Ambulatory',
      'urgent': 'Urgent'
    };
    const careLabel = careLabels[currentCare] || currentCare;
    const careChip = createChip('Care', careLabel, () => {
      // Open care popover
      const carePopover = document.getElementById('carePopover');
      if (carePopover) {
        const rect = careChip.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;
        
        let top = rect.bottom + 8;
        let left = rect.left;
        
        const popoverHeight = 250;
        if (top + popoverHeight > viewportHeight - 20) {
          top = rect.top - popoverHeight - 8;
        }
        
        const popoverWidth = 280;
        if (left + popoverWidth > viewportWidth - 20) {
          left = viewportWidth - popoverWidth - 20;
        }
        
        if (left < 20) left = 20;
        if (top < 20) top = 20;
        
        carePopover.style.display = 'block';
        carePopover.style.position = 'fixed';
        carePopover.style.top = `${top}px`;
        carePopover.style.left = `${left}px`;
        carePopover.style.zIndex = '1000';
        carePopover.classList.remove('hidden');
        
        // Mark current selection
        carePopover.querySelectorAll('.care-option').forEach(o => {
          o.classList.remove('bg-token-accent', 'text-white', 'ring-2', 'ring-accent', 'active-tone');
          o.classList.add('bg-white');
          if (o.dataset.care === currentCare) {
            o.classList.add('bg-[#28926D]', 'text-white', 'ring-2', 'ring-[#28926D]', 'active-tone');
          }
        });
      }
    });
    careChip.setAttribute('data-chip', 'care');
    careChip.setAttribute('title', 'Click to change care setting');
    chipsContainer.appendChild(careChip);
  }
  
  // Faith chip (conditional)
  if (currentTone === 'Faith') {
    const faithLabels = {
      'general': 'General',
      'christian': 'Christian',
      'jewish': 'Jewish',
      'muslim': 'Muslim',
      'buddhist': 'Buddhist',
      'hindu': 'Hindu'
    };
    const faithLabel = faithLabels[currentFaith] || currentFaith;
    const faithChip = createChip('Faith', faithLabel, () => {
      // Open faith popover
      const faithPopover = document.getElementById('faithPopover');
      if (faithPopover) {
        const rect = faithChip.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;
        
        let top = rect.bottom + 8;
        let left = rect.left;
        
        const popoverHeight = 400;
        if (top + popoverHeight > viewportHeight - 20) {
          top = rect.top - popoverHeight - 8;
        }
        
        const popoverWidth = 320;
        if (left + popoverWidth > viewportWidth - 20) {
          left = viewportWidth - popoverWidth - 20;
        }
        
        if (left < 20) left = 20;
        if (top < 20) top = 20;
        
        faithPopover.style.display = 'block';
        faithPopover.style.position = 'fixed';
        faithPopover.style.top = `${top}px`;
        faithPopover.style.left = `${left}px`;
        faithPopover.style.zIndex = '1000';
        faithPopover.classList.remove('hidden');
        
        // Mark current selection
        faithPopover.querySelectorAll('.faith-option').forEach(o => {
          o.classList.remove('bg-token-accent', 'text-white', 'ring-2', 'ring-accent', 'active-tone');
          o.classList.add('bg-white');
          if (o.dataset.faith === currentFaith) {
            o.classList.add('bg-[#28926D]', 'text-white', 'ring-2', 'ring-[#28926D]', 'active-tone');
          }
        });
      }
    });
    faithChip.setAttribute('data-chip', 'faith');
    faithChip.setAttribute('title', 'Click to change faith setting');
    chipsContainer.appendChild(faithChip);
  }
  
  // Language chip
  const lang = localStorage.getItem('nm_lang') || 'en-US';
  const langLabel = LANGUAGE_CHOICES.find(([code]) => code === lang)?.[1] || lang;
  const langChip = createChip('Language', langLabel, (e) => {
    e.preventDefault();
    e.stopPropagation();
    console.log('Language chip clicked');
    const langMenu = document.getElementById('langMenu');
    
    if (langMenu) {
      // Render languages before opening - use the renderLanguages function
      const langList = langMenu.querySelector('.space-y-1');
      const langSearchInput = langMenu.querySelector('input');
      
      // Clear search and render all languages
      if (langSearchInput) {
        langSearchInput.value = '';
      }
      
      // Use the renderLanguages function that's already defined
      if (langList) {
        langList.innerHTML = '';
        const currentLang = localStorage.getItem('nm_lang') || 'en-US';
        
        LANGUAGE_CHOICES.forEach(([code, name]) => {
          const btn = document.createElement('button');
          btn.className = 'w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center justify-between transition cursor-pointer';
          btn.type = 'button';
          btn.innerHTML = `
            <span class="flex-1">${name}</span>
            ${currentLang === code ? '<i class="fa-solid fa-check text-token-accent ml-2"></i>' : '<span class="ml-2 w-4"></span>'}
          `;
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            selectLanguage(code);
          });
          langList.appendChild(btn);
        });
        
        console.log(`Rendered ${LANGUAGE_CHOICES.length} languages in menu`);
      }
      
      // Open language menu directly
      const rect = langChip.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      const viewportWidth = window.innerWidth;
      
      let top = rect.bottom + 8;
      let left = rect.left;
      
      // If popover would go off bottom, show above chip
      const popoverHeight = 400;
      if (top + popoverHeight > viewportHeight - 20) {
        top = rect.top - popoverHeight - 8;
      }
      
      // Ensure popover doesn't go off right edge
      const popoverWidth = 280;
      if (left + popoverWidth > viewportWidth - 20) {
        left = viewportWidth - popoverWidth - 20;
      }
      
      // Ensure popover doesn't go off left edge
      if (left < 20) {
        left = 20;
      }
      
      // Ensure popover doesn't go off top
      if (top < 20) {
        top = 20;
      }
      
      langMenu.style.display = 'block';
      langMenu.style.position = 'fixed';
      langMenu.style.top = `${top}px`;
      langMenu.style.left = `${left}px`;
      langMenu.style.zIndex = '1000';
      langMenu.classList.remove('hidden');
      
      // Focus search input if it exists
      const langSearchInput2 = langMenu.querySelector('input');
      if (langSearchInput2) {
        setTimeout(() => langSearchInput2.focus(), 100);
      }
    } else {
      console.error('Language menu not found - initializing...');
      // Initialize language picker if not done yet
      initLanguagePicker();
      // Try again after a brief delay
      setTimeout(() => {
        const langBtn = document.getElementById('langBtn');
        if (langBtn) langBtn.click();
      }, 100);
    }
  });
  langChip.setAttribute('title', 'Click to change language');
  chipsContainer.appendChild(langChip);
  
  // Always show chips container (remove hidden class)
  chipsContainer.classList.remove('hidden');
  chipsContainer.style.display = 'flex';
}

function createChip(label, value, onClick) {
  const chip = document.createElement('button');
  chip.className = 'chip';
  chip.type = 'button'; // Prevent form submission
  chip.innerHTML = `
    <span class="text-xs chip-label">${label}:</span>
    <span class="chip-value">${value}</span>
    <i class="fa-solid fa-chevron-down chip-arrow text-xs ml-1 transition-transform duration-200"></i>
  `;
  
  // Use addEventListener instead of onclick for better control
  chip.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    if (onClick) onClick(e);
  });
  
  // Add hover effect to arrow
  chip.addEventListener('mouseenter', () => {
    const arrow = chip.querySelector('.fa-chevron-down');
    if (arrow) arrow.style.transform = 'translateY(2px)';
  });
  
  chip.addEventListener('mouseleave', () => {
    const arrow = chip.querySelector('.fa-chevron-down');
    if (arrow) arrow.style.transform = 'translateY(0)';
  });
  
  return chip;
}

// ============================================
// LANGUAGE PICKER
// ============================================

function initLanguagePicker() {
  const langBtn = document.getElementById('langBtn');
  const langMenu = document.createElement('div');
  langMenu.id = 'langMenu';
  langMenu.className = 'popover hidden';
  langMenu.style.position = 'absolute';
  langMenu.style.right = '0';
  langMenu.style.top = '100%';
  langMenu.style.marginTop = '8px';
  langMenu.style.maxHeight = '400px';
  langMenu.style.overflowY = 'auto';
  langMenu.style.minWidth = '250px';
  
  // Search input
  const searchInput = document.createElement('input');
  searchInput.type = 'text';
  searchInput.placeholder = 'Search languages...';
  searchInput.className = 'w-full px-3 py-2 border border-token-gray-200 rounded-lg mb-2 focus-ring-accent';
  langMenu.appendChild(searchInput);
  
  // Language list
  const langList = document.createElement('div');
  langList.className = 'space-y-1';
  
  function renderLanguages(filter = '') {
    langList.innerHTML = '';
    const filtered = LANGUAGE_CHOICES.filter(([code, name]) => 
      name.toLowerCase().includes(filter.toLowerCase()) ||
      code.toLowerCase().includes(filter.toLowerCase())
    );
    
    if (filtered.length === 0) {
      langList.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500">No languages found</div>';
      return;
    }
    
    const currentLang = localStorage.getItem('nm_lang') || 'en-US';
    
    filtered.forEach(([code, name]) => {
      const btn = document.createElement('button');
      btn.className = 'w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center justify-between transition cursor-pointer';
      btn.type = 'button';
      btn.innerHTML = `
        <span class="flex-1">${name}</span>
        ${currentLang === code ? '<i class="fa-solid fa-check text-[#28926D] ml-2"></i>' : '<span class="ml-2 w-4"></span>'}
      `;
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        selectLanguage(code);
      });
      langList.appendChild(btn);
    });
    
    console.log(`Rendered ${filtered.length} languages`);
  }
  
  searchInput.addEventListener('input', (e) => {
    renderLanguages(e.target.value);
  });
  
  langMenu.appendChild(langList);
  document.body.appendChild(langMenu);
  
  // Render languages initially
  renderLanguages('');
  console.log(`Language menu initialized with ${LANGUAGE_CHOICES.length} languages`);
  
  langBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    e.preventDefault();
    console.log('Language button clicked');
    const currentLang = localStorage.getItem('nm_lang') || 'en-US';
    
    // Always render languages before opening to ensure they're visible
    renderLanguages('');
    
    // Position menu relative to button
    const rect = langBtn.getBoundingClientRect();
    const viewportHeight = window.innerHeight;
    const viewportWidth = window.innerWidth;
    
    let top = rect.bottom + 8;
    let right = viewportWidth - rect.right;
    
    const popoverHeight = 400;
    if (top + popoverHeight > viewportHeight - 20) {
      top = rect.top - popoverHeight - 8;
    }
    
    langMenu.style.display = 'block';
    langMenu.style.position = 'fixed';
    langMenu.style.top = `${top}px`;
    langMenu.style.right = `${right}px`;
    langMenu.style.zIndex = '1000';
    langMenu.classList.toggle('hidden');
    
      // Focus search if opening
      if (!langMenu.classList.contains('hidden')) {
        const langSearchInput3 = langMenu.querySelector('input');
        if (langSearchInput3) {
          langSearchInput3.value = ''; // Clear search
          setTimeout(() => langSearchInput3.focus(), 100);
        }
      }
  });
  
  // Close on outside click
  document.addEventListener('click', (e) => {
    if (!langMenu.contains(e.target) && e.target !== langBtn && !langBtn.contains(e.target)) {
      langMenu.classList.add('hidden');
      langMenu.style.display = 'none';
    }
  });
}

function selectLanguage(code) {
  localStorage.setItem('nm_lang', code);
  const langMenu = document.getElementById('langMenu');
  if (langMenu) langMenu.classList.add('hidden');
  updateActiveChips();
  showToast(`Language set to ${LANGUAGE_CHOICES.find(([c]) => c === code)?.[1] || code}`, 'success');
}

// ============================================
// VOICE DICTATION
// ============================================

function initVoiceDictation() {
  const micBtn = document.getElementById('micBtn');
  const input = document.getElementById('chatInput');
  if (!micBtn || !input) return;
  
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRec) {
    micBtn.title = 'Voice dictation not supported in this browser';
    micBtn.disabled = true;
    micBtn.style.opacity = '0.5';
    micBtn.style.cursor = 'not-allowed';
    return;
  }
  
  // Check if microphone is available
  async function checkMicrophonePermission() {
    try {
      if (navigator.permissions && navigator.permissions.query) {
        const result = await navigator.permissions.query({ name: 'microphone' });
        return result.state;
      }
      // Fallback: try to get user media to check availability
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(track => track.stop()); // Stop immediately
        return 'granted';
      } catch (e) {
        if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
          return 'denied';
        }
        return 'prompt';
      }
    } catch (e) {
      console.log('Permission check not available:', e);
      return 'prompt'; // Assume we can prompt
    }
  }
  
  let recognition = null;
  let isListening = false;
  let silenceTimeout = null;
  let listeningStartTime = null;
  let lastProcessedIndex = 0; // Track the last processed result index to avoid duplicates
  let lastInterimText = ''; // Track last interim text to replace it instead of appending
  const MAX_LISTENING_TIME = 60000; // 60 seconds max
  const SILENCE_TIMEOUT = 3000; // 3 seconds of silence before auto-stop
  
  function resetMicButton() {
    isListening = false;
    micBtn.classList.remove('bg-[#236092]', 'text-white', 'listening');
    micBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
    micBtn.title = 'Dictate';
    if (silenceTimeout) {
      clearTimeout(silenceTimeout);
      silenceTimeout = null;
    }
    listeningStartTime = null;
    lastProcessedIndex = 0; // Reset processed index
    lastInterimText = ''; // Reset interim text
  }
  
  function stopRecognition() {
    if (recognition) {
      try {
        recognition.stop();
      } catch (e) {
        console.log('Error stopping recognition:', e);
      }
      recognition = null;
    }
    resetMicButton();
  }
  
  micBtn.addEventListener('click', async () => {
    if (isListening) {
      stopRecognition();
      return;
    }
    
    // Check microphone permission before starting
    const permissionState = await checkMicrophonePermission();
    if (permissionState === 'denied') {
      showToast('Microphone access denied. Please enable it in your browser settings.', 'error');
      micBtn.title = 'Microphone access denied - Click to check settings';
      return;
    }
    
    if (!recognition) {
      recognition = new SpeechRec();
      recognition.lang = localStorage.getItem('nm_lang') || 'en-US';
      recognition.continuous = true; // Changed to true for better detection
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;
      
      recognition.onstart = () => {
        isListening = true;
        listeningStartTime = Date.now();
        micBtn.classList.add('bg-[#236092]', 'text-white', 'listening');
        micBtn.innerHTML = '<i class="fa-solid fa-stop"></i>';
        micBtn.title = 'Listening... Click to stop';
        showToast(' Listening... Speak now', 'info');
        
        // Auto-stop after max time
        setTimeout(() => {
          if (isListening) {
            stopRecognition();
            showToast('Recording stopped automatically after 60 seconds', 'info');
          }
        }, MAX_LISTENING_TIME);
      };
      
      recognition.onend = () => {
        // Only reset if we're still supposed to be listening (unexpected end)
        if (isListening && Date.now() - listeningStartTime < 2000) {
          // If it ended very quickly, might be an error - try to restart
          console.log('Recognition ended unexpectedly, might restart...');
        }
        stopRecognition();
      };
      
      recognition.onerror = (e) => {
        console.error('Speech recognition error:', e);
        let errorMessage = 'Voice recognition error';
        
        // Handle specific error types
        switch (e.error) {
          case 'no-speech':
            errorMessage = 'No speech detected. Please try again.';
            break;
          case 'audio-capture':
            errorMessage = 'No microphone found. Please check your microphone.';
            break;
          case 'not-allowed':
            errorMessage = 'Microphone access denied. Please enable it in your browser settings.';
            micBtn.title = 'Microphone access denied - Click to check settings';
            break;
          case 'network':
            errorMessage = 'Network error. Please check your connection.';
            break;
          case 'aborted':
            // User stopped it, don't show error
            return;
          case 'service-not-allowed':
            errorMessage = 'Speech recognition service not available.';
            break;
          default:
            errorMessage = `Voice recognition error: ${e.error || 'Unknown error'}`;
        }
        
        stopRecognition();
        if (e.error !== 'aborted') {
          showToast(errorMessage, 'error');
        }
      };
      
      recognition.onresult = (e) => {
        // Reset silence timeout on any result
        if (silenceTimeout) {
          clearTimeout(silenceTimeout);
        }
        
        let newFinalText = '';
        let newInterimText = '';
        let hasNewFinal = false;
        
        // Only process new results (from lastProcessedIndex onwards)
        const startIndex = Math.max(e.resultIndex, lastProcessedIndex);
        
        for (let i = startIndex; i < e.results.length; i++) {
          const transcript = e.results[i][0].transcript;
          if (e.results[i].isFinal) {
            // This is a final result - add it to final text
            newFinalText += transcript + ' ';
            hasNewFinal = true;
            lastProcessedIndex = i + 1; // Mark this as processed
            lastInterimText = ''; // Clear interim since this is now final
          } else {
            // This is an interim result - replace previous interim
            newInterimText = transcript;
          }
        }
        
        // Get current input value (without any previous interim text)
        let currentText = input.value.trim();
        
        // Remove the last interim text if it exists (to replace it with new one)
        if (lastInterimText && currentText.endsWith(lastInterimText)) {
          currentText = currentText.slice(0, -lastInterimText.length).trim();
        }
        
        // Update input with final results, or show interim results
        if (hasNewFinal) {
          // Add new final text to the input
          input.value = (currentText + ' ' + newFinalText).trim();
          lastInterimText = ''; // Clear interim
          
          // Auto-stop after getting final result (user finished speaking)
          silenceTimeout = setTimeout(() => {
            if (isListening) {
              stopRecognition();
              showToast('Voice input complete', 'success');
            }
          }, SILENCE_TIMEOUT);
        } else if (newInterimText) {
          // Show interim results in real-time (replace previous interim)
          input.value = currentText + (currentText ? ' ' : '') + newInterimText;
          lastInterimText = newInterimText; // Save for next replacement
        }
        
        input.focus();
      };
      
      recognition.onspeechstart = () => {
        // User started speaking
        if (silenceTimeout) {
          clearTimeout(silenceTimeout);
          silenceTimeout = null;
        }
      };
      
      recognition.onspeechend = () => {
        // User stopped speaking - wait a bit then auto-stop
        if (isListening) {
          silenceTimeout = setTimeout(() => {
            if (isListening) {
              stopRecognition();
              showToast('Voice input complete', 'success');
            }
          }, SILENCE_TIMEOUT);
        }
      };
    }
    
    try {
      recognition.start();
    } catch (err) {
      console.error('Failed to start recognition:', err);
      if (err.name === 'InvalidStateError') {
        // Recognition already started, ignore
        return;
      }
      showToast('Failed to start voice recognition. Please try again.', 'error');
      stopRecognition();
    }
  });
  
  // Check initial permission state and update button
  checkMicrophonePermission().then(state => {
    if (state === 'denied') {
      micBtn.title = 'Microphone access denied - Click to check settings';
      micBtn.style.opacity = '0.7';
    }
  });
}

// ============================================
// SETTINGS MODAL
// ============================================

async function openSettingsModal() {
  const modal = document.getElementById('settingsModal');
  if (!modal) return;
  
  modal.classList.remove('hidden');
  
  // Initialize navigation and load settings
  initSettingsNavigation();
  await loadSettings();
  initVoicePlayButton();
  initSettingsChangeHandlers(); // Initialize change handlers for real-time updates
  
  // Switch to General section by default
  switchSettingsSection('general');
  
  // User display name is already loaded by loadSettings()
  try {
    const res = await fetch('/api/user/settings/', { credentials: 'include' });
    if (res.ok) {
    const data = await res.json();
    const userDisplayName = document.getElementById('userDisplayName');
    if (userDisplayName) {
      // Prioritize display_name (user's preferred name from Account settings), then full_name, then fallback
      userDisplayName.textContent = data.display_name || data.full_name || 'User';
    }
    }
  } catch (err) {
    console.error('Failed to load user settings:', err);
  }
}

function closeSettingsModal() {
  const modal = document.getElementById('settingsModal');
  if (modal) modal.classList.add('hidden');
}

// Settings Navigation
function initSettingsNavigation() {
  // Desktop navigation buttons
  const navItems = document.querySelectorAll('.settings-nav-item');
  navItems.forEach(item => {
    item.addEventListener('click', () => {
      const section = item.getAttribute('data-section');
      switchSettingsSection(section);
    });
  });
  
  // Mobile dropdown
  const mobileDropdown = document.getElementById('settingsMobileDropdown');
  if (mobileDropdown) {
    mobileDropdown.addEventListener('change', (e) => {
      const section = e.target.value;
      switchSettingsSection(section);
    });
  }
}

function switchSettingsSection(section) {
  // Update desktop navigation active state
  document.querySelectorAll('.settings-nav-item').forEach(item => {
    item.classList.remove('active');
    if (item.getAttribute('data-section') === section) {
      item.classList.add('active');
    }
  });
  
  // Update mobile dropdown value
  const mobileDropdown = document.getElementById('settingsMobileDropdown');
  if (mobileDropdown) {
    mobileDropdown.value = section;
  }
  
  // Show/hide sections
  document.querySelectorAll('.settings-section').forEach(sec => {
    sec.classList.add('hidden');
  });
  
  const targetSection = document.getElementById(`settingsSection-${section}`);
  if (targetSection) {
    targetSection.classList.remove('hidden');
  }
}

// Load settings from localStorage and server
// Function to apply accent color to CSS variables
function applyAccentColor(color) {
  const colorMap = {
    'default': { main: '#28926D', light: '#10b981', focusRing: 'rgba(40, 146, 109, 0.4)' },
    'green': { main: '#28926D', light: '#10b981', focusRing: 'rgba(40, 146, 109, 0.4)' },
    'blue': { main: '#236092', light: '#3B82F6', focusRing: 'rgba(35, 96, 146, 0.4)' },
    'purple': { main: '#7C3AED', light: '#A78BFA', focusRing: 'rgba(124, 58, 237, 0.4)' },
    'red': { main: '#DC2626', light: '#EF4444', focusRing: 'rgba(220, 38, 38, 0.4)' }
  };
  
  const colorData = colorMap[color] || colorMap['default'];
  console.log('Applying accent color:', color, '->', colorData);
  
  // Update CSS variables - these are used throughout the app
  document.documentElement.style.setProperty('--nm-accent', colorData.main);
  document.documentElement.style.setProperty('--nm-accent-light', colorData.light);
  document.documentElement.style.setProperty('--nm-accent-focus-ring', colorData.focusRing);
  
  // Update check icons in tone selectors (use CSS variable)
  const checkIcons = document.querySelectorAll('.tone-check, .base-tone-check');
  checkIcons.forEach(icon => {
    icon.style.color = '';
    icon.classList.add('text-token-accent');
  });
  
  // Update selected tone option backgrounds (use CSS variable)
  const selectedToneOptions = document.querySelectorAll('.tone-option.selected, .base-tone-option.selected');
  selectedToneOptions.forEach(option => {
    option.style.backgroundColor = '';
    option.style.borderColor = '';
    option.classList.add('bg-token-accent', 'border-token-accent');
  });
  
  console.log('Accent color applied successfully');
  
  // Trigger a custom event so other parts of the app can react
  window.dispatchEvent(new CustomEvent('accentColorChanged', { detail: { color: color, value: colorData.main } }));
}

// Function to apply theme (light/dark/system)
function applyTheme(theme) {
  const root = document.documentElement;
  
  if (theme === 'system') {
    // Follow OS preference
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    root.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
  } else {
    root.setAttribute('data-theme', theme);
  }
  
  console.log('Theme applied:', theme === 'system' ? (root.getAttribute('data-theme')) : theme);
  
  // Trigger custom event
  window.dispatchEvent(new CustomEvent('themeChanged', { detail: { theme: root.getAttribute('data-theme') } }));
}

async function loadSettings() {
  // Load from localStorage first (for client-side settings)
  const appearance = localStorage.getItem('nm_appearance') || 'system';
  const accentColor = localStorage.getItem('nm_accent_color') || 'default';
  const language = localStorage.getItem('nm_language') || 'auto';
  const spokenLanguage = localStorage.getItem('nm_spoken_language') || 'auto';
  const voice = localStorage.getItem('nm_voice') || 'spruce';
  const separateVoiceMode = localStorage.getItem('nm_separate_voice_mode') === 'true';
  const showAdditionalModels = localStorage.getItem('nm_show_additional_models') === 'true';
  
  // Set UI values
  const appearanceSelect = document.getElementById('appearanceSelect');
  if (appearanceSelect) appearanceSelect.value = appearance;
  
  // Apply appearance on load using the theme system
  applyTheme(appearance);
  
  const accentColorSelect = document.getElementById('accentColorSelect');
  if (accentColorSelect) {
    accentColorSelect.value = accentColor === 'default' ? 'green' : accentColor;
  }
  
  // Apply the accent color on load
  applyAccentColor(accentColor);
  
  // Set default radio button state
  const accentColorRadio = document.querySelector('input[name="accentColor"][value="default"]');
  if (accentColorRadio) {
    accentColorRadio.checked = accentColor === 'default';
  }
  
  const languageSelect = document.getElementById('languageSelect');
  if (languageSelect) languageSelect.value = language;
  
  const spokenLanguageSelect = document.getElementById('spokenLanguageSelect');
  if (spokenLanguageSelect) spokenLanguageSelect.value = spokenLanguage;
  
  const voiceSelect = document.getElementById('voiceSelect');
  if (voiceSelect) voiceSelect.value = voice;
  
  const separateVoiceModeToggle = document.getElementById('separateVoiceMode');
  if (separateVoiceModeToggle) separateVoiceModeToggle.checked = separateVoiceMode;
  
  const showAdditionalModelsToggle = document.getElementById('showAdditionalModels');
  if (showAdditionalModelsToggle) showAdditionalModelsToggle.checked = showAdditionalModels;
  
  // Load personalization settings from localStorage
  // Default to PlainClinical (Balanced) if not set
  const baseStyleTone = localStorage.getItem('nm_base_style_tone') || localStorage.getItem('nm_mode') || 'PlainClinical';
  const characteristicWarm = localStorage.getItem('nm_characteristic_warm') || 'default';
  const characteristicEnthusiastic = localStorage.getItem('nm_characteristic_enthusiastic') || 'default';
  const characteristicHeaders = localStorage.getItem('nm_characteristic_headers') || 'default';
  const characteristicEmoji = localStorage.getItem('nm_characteristic_emoji') || 'default';
  const customInstructions = localStorage.getItem('nm_custom_instructions') || '';
  const personalizationNickname = localStorage.getItem('nm_personalization_nickname') || '';
  const personalizationOccupation = localStorage.getItem('nm_personalization_occupation') || '';
  const moreAboutYou = localStorage.getItem('nm_more_about_you') || '';
  const referenceSavedMemories = localStorage.getItem('nm_reference_saved_memories') !== 'false'; // Default true
  const referenceChatHistory = localStorage.getItem('nm_reference_chat_history') !== 'false'; // Default true
  
  // Load user name from server
  try {
    const res = await fetch('/api/user/settings/', { credentials: 'include' });
    if (res.ok) {
      const data = await res.json();
      const userDisplayName = document.getElementById('userDisplayName');
      if (userDisplayName) {
        // Prioritize display_name (user's preferred name from Account settings), then full_name, then fallback
        userDisplayName.textContent = data.display_name || data.full_name || 'User';
      }
    }
  } catch (err) {
    console.error('Failed to load user name:', err);
  }
  
  // Set personalization UI values - base tone selector (buttons)
  const baseToneOptions = document.querySelectorAll('.base-tone-option');
  baseToneOptions.forEach(btn => {
    if (btn.getAttribute('data-tone') === baseStyleTone) {
      btn.classList.add('selected');
      const checkIcon = btn.querySelector('.base-tone-check');
      if (checkIcon) checkIcon.style.opacity = '1';
    } else {
      btn.classList.remove('selected');
      const checkIcon = btn.querySelector('.base-tone-check');
      if (checkIcon) checkIcon.style.opacity = '0';
    }
  });
  
  const characteristicWarmSelect = document.getElementById('characteristicWarm');
  if (characteristicWarmSelect) characteristicWarmSelect.value = characteristicWarm;
  
  const characteristicEnthusiasticSelect = document.getElementById('characteristicEnthusiastic');
  if (characteristicEnthusiasticSelect) characteristicEnthusiasticSelect.value = characteristicEnthusiastic;
  
  const characteristicHeadersSelect = document.getElementById('characteristicHeaders');
  if (characteristicHeadersSelect) characteristicHeadersSelect.value = characteristicHeaders;
  
  const characteristicEmojiSelect = document.getElementById('characteristicEmoji');
  if (characteristicEmojiSelect) characteristicEmojiSelect.value = characteristicEmoji;
  
  const customInstructionsTextarea = document.getElementById('customInstructions');
  if (customInstructionsTextarea) customInstructionsTextarea.value = customInstructions;
  
  const personalizationNicknameInput = document.getElementById('personalizationNickname');
  if (personalizationNicknameInput) personalizationNicknameInput.value = personalizationNickname;
  
  const personalizationOccupationInput = document.getElementById('personalizationOccupation');
  if (personalizationOccupationInput) personalizationOccupationInput.value = personalizationOccupation;
  
  const moreAboutYouTextarea = document.getElementById('moreAboutYou');
  if (moreAboutYouTextarea) moreAboutYouTextarea.value = moreAboutYou;
  
  const referenceSavedMemoriesToggle = document.getElementById('referenceSavedMemories');
  if (referenceSavedMemoriesToggle) referenceSavedMemoriesToggle.checked = referenceSavedMemories;
  
  const referenceChatHistoryToggle = document.getElementById('referenceChatHistory');
  if (referenceChatHistoryToggle) referenceChatHistoryToggle.checked = referenceChatHistory;
  
  // Load account settings from server
  try {
    const res = await fetch('/api/user/settings/', {
      credentials: 'include'
    });
    
    if (res.ok) {
      const data = await res.json();
      const nameInput = document.getElementById('displayName');
      const profInput = document.getElementById('profession');
      
      if (nameInput && data.display_name) nameInput.value = data.display_name;
      if (profInput && data.profession) profInput.value = data.profession;
      
      // Load personalization from server if available
      if (data.personalization) {
        if (data.personalization.base_style_tone) {
          const serverTone = data.personalization.base_style_tone;
          baseToneOptions.forEach(btn => {
            if (btn.getAttribute('data-tone') === serverTone) {
              btn.classList.add('selected');
              const checkIcon = btn.querySelector('.base-tone-check');
              if (checkIcon) checkIcon.style.opacity = '1';
            } else {
              btn.classList.remove('selected');
              const checkIcon = btn.querySelector('.base-tone-check');
              if (checkIcon) checkIcon.style.opacity = '0';
            }
          });
        }
        if (characteristicWarmSelect && data.personalization.characteristic_warm) characteristicWarmSelect.value = data.personalization.characteristic_warm;
        if (characteristicEnthusiasticSelect && data.personalization.characteristic_enthusiastic) characteristicEnthusiasticSelect.value = data.personalization.characteristic_enthusiastic;
        if (characteristicHeadersSelect && data.personalization.characteristic_headers) characteristicHeadersSelect.value = data.personalization.characteristic_headers;
        if (characteristicEmojiSelect && data.personalization.characteristic_emoji) characteristicEmojiSelect.value = data.personalization.characteristic_emoji;
        if (customInstructionsTextarea && data.personalization.custom_instructions) customInstructionsTextarea.value = data.personalization.custom_instructions;
        if (personalizationNicknameInput && data.personalization.nickname) personalizationNicknameInput.value = data.personalization.nickname;
        if (personalizationOccupationInput && data.personalization.occupation) personalizationOccupationInput.value = data.personalization.occupation;
        if (moreAboutYouTextarea && data.personalization.more_about_you) moreAboutYouTextarea.value = data.personalization.more_about_you;
        if (referenceSavedMemoriesToggle && data.personalization.reference_saved_memories !== undefined) referenceSavedMemoriesToggle.checked = data.personalization.reference_saved_memories;
        if (referenceChatHistoryToggle && data.personalization.reference_chat_history !== undefined) referenceChatHistoryToggle.checked = data.personalization.reference_chat_history;
      }
    }
  } catch (err) {
    console.error('Failed to load account settings:', err);
  }
}

async function saveSettings() {
  // Get account settings
  const nameInput = document.getElementById('displayName');
  const profInput = document.getElementById('profession');
  
  if (!nameInput || !profInput) return;
  
  const name = nameInput.value.trim();
  const profession = profInput.value.trim();
  
  // Validation
  if (!name) {
    showToast('Display name is required', 'error');
    nameInput.focus();
    return;
  }
  
  // Get general settings
  const appearance = document.getElementById('appearanceSelect')?.value || 'system';
  const accentColor = document.getElementById('accentColorSelect')?.value || 'default';
  const language = document.getElementById('languageSelect')?.value || 'auto';
  const spokenLanguage = document.getElementById('spokenLanguageSelect')?.value || 'auto';
  const voice = document.getElementById('voiceSelect')?.value || 'spruce';
  const separateVoiceMode = document.getElementById('separateVoiceMode')?.checked || false;
  const showAdditionalModels = document.getElementById('showAdditionalModels')?.checked || false;
  
  // Get personalization settings - base tone from selected button
  const selectedBaseTone = document.querySelector('.base-tone-option.selected');
  const baseStyleTone = selectedBaseTone ? selectedBaseTone.getAttribute('data-tone') : 'PlainClinical';
  const characteristicWarm = document.getElementById('characteristicWarm')?.value || 'default';
  const characteristicEnthusiastic = document.getElementById('characteristicEnthusiastic')?.value || 'default';
  const characteristicHeaders = document.getElementById('characteristicHeaders')?.value || 'default';
  const characteristicEmoji = document.getElementById('characteristicEmoji')?.value || 'default';
  const customInstructions = document.getElementById('customInstructions')?.value || '';
  const personalizationNickname = document.getElementById('personalizationNickname')?.value || '';
  const personalizationOccupation = document.getElementById('personalizationOccupation')?.value || '';
  const moreAboutYou = document.getElementById('moreAboutYou')?.value || '';
  const referenceSavedMemories = document.getElementById('referenceSavedMemories')?.checked !== false;
  const referenceChatHistory = document.getElementById('referenceChatHistory')?.checked !== false;
  
  // Save client-side settings to localStorage
  localStorage.setItem('nm_appearance', appearance);
  localStorage.setItem('nm_accent_color', accentColor);
  localStorage.setItem('nm_language', language);
  localStorage.setItem('nm_spoken_language', spokenLanguage);
  localStorage.setItem('nm_voice', voice);
  localStorage.setItem('nm_separate_voice_mode', separateVoiceMode.toString());
  localStorage.setItem('nm_show_additional_models', showAdditionalModels.toString());
  
  // Save personalization settings to localStorage
  localStorage.setItem('nm_base_style_tone', baseStyleTone);
  localStorage.setItem('nm_characteristic_warm', characteristicWarm);
  localStorage.setItem('nm_characteristic_enthusiastic', characteristicEnthusiastic);
  localStorage.setItem('nm_characteristic_headers', characteristicHeaders);
  localStorage.setItem('nm_characteristic_emoji', characteristicEmoji);
  localStorage.setItem('nm_custom_instructions', customInstructions);
  localStorage.setItem('nm_personalization_nickname', personalizationNickname);
  localStorage.setItem('nm_personalization_occupation', personalizationOccupation);
  localStorage.setItem('nm_more_about_you', moreAboutYou);
  localStorage.setItem('nm_reference_saved_memories', referenceSavedMemories.toString());
  localStorage.setItem('nm_reference_chat_history', referenceChatHistory.toString());
  
  const saveBtn = document.querySelector('#settingsSection-account .btn-primary');
  const originalHTML = saveBtn?.innerHTML;
  
  // Show loading state
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
  }
  
  try {
    const res = await fetch('/api/user/settings/update/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({ 
        display_name: name, 
        profession,
        appearance,
        accent_color: accentColor,
        language,
        spoken_language: spokenLanguage,
        voice,
        separate_voice_mode: separateVoiceMode,
        show_additional_models: showAdditionalModels,
        personalization: {
          base_style_tone: baseStyleTone,
          characteristic_warm: characteristicWarm,
          characteristic_enthusiastic: characteristicEnthusiastic,
          characteristic_headers: characteristicHeaders,
          characteristic_emoji: characteristicEmoji,
          custom_instructions: customInstructions,
          nickname: personalizationNickname,
          occupation: personalizationOccupation,
          more_about_you: moreAboutYou,
          reference_saved_memories: referenceSavedMemories,
          reference_chat_history: referenceChatHistory
        }
      }),
      credentials: 'include'
    });
    
    if (res.ok) {
      showToast('Settings saved', 'success');
      closeSettingsModal();
      
      // Update UI immediately - fetch fresh data to get updated name
      try {
        const refreshRes = await fetch('/api/user/settings/', { credentials: 'include' });
        if (refreshRes.ok) {
          const refreshData = await refreshRes.json();
          const userDisplayName = document.getElementById('userDisplayName');
          if (userDisplayName) {
            // Prioritize display_name (what user just set), then full_name, then fallback
            // This ensures the display_name change is immediately reflected in the sidebar
            userDisplayName.textContent = refreshData.display_name || refreshData.full_name || 'User';
          }
        }
      } catch (err) {
        console.error('Failed to refresh user name:', err);
        // Fallback to the name that was saved
      const userDisplayName = document.getElementById('userDisplayName');
      if (userDisplayName) userDisplayName.textContent = name;
      }
      
      // Apply appearance if changed using the theme system
      applyTheme(appearance);
      
    } else {
      throw new Error('Save failed');
    }
  } catch (err) {
    showToast('Failed to save settings', 'error');
  } finally {
    if (saveBtn) {
      saveBtn.disabled = false;
      if (originalHTML) saveBtn.innerHTML = originalHTML;
    }
  }
}

// Initialize real-time change handlers for client-side settings
function initSettingsChangeHandlers() {
  // Appearance
  const appearanceSelect = document.getElementById('appearanceSelect');
  if (appearanceSelect) {
    appearanceSelect.addEventListener('change', (e) => {
      const selectedAppearance = e.target.value;
      localStorage.setItem('nm_appearance', selectedAppearance);
      applyTheme(selectedAppearance);
      showToast(`Appearance changed to ${selectedAppearance}`, 'success');
    });
  }
  
  // Accent color - Remove old listeners first to prevent duplicates
  const accentColorSelect = document.getElementById('accentColorSelect');
  const accentColorRadio = document.querySelector('input[name="accentColor"][value="default"]');
  
  if (accentColorSelect) {
    // Clone and replace to remove old listeners
    const newSelect = accentColorSelect.cloneNode(true);
    accentColorSelect.parentNode.replaceChild(newSelect, accentColorSelect);
    
    // Get fresh reference after replacement
    const freshSelect = document.getElementById('accentColorSelect');
    if (freshSelect) {
      freshSelect.addEventListener('change', function(e) {
        const selectedColor = e.target.value;
        console.log('Accent color selector changed to:', selectedColor);
        localStorage.setItem('nm_accent_color', selectedColor);
        applyAccentColor(selectedColor);
        showToast(`Accent color changed to ${selectedColor}`, 'success');
        
        // Uncheck default radio if a color is selected
        const radio = document.querySelector('input[name="accentColor"][value="default"]');
        if (radio && selectedColor !== 'default') {
          radio.checked = false;
        }
      });
      console.log('Accent color selector event listener attached successfully');
    } else {
      console.error('Could not find accent color select after replacement!');
    }
  } else {
    console.error('Accent color select element not found!');
  }
  
  // Handle default radio button
  if (accentColorRadio) {
    accentColorRadio.addEventListener('change', (e) => {
      if (e.target.checked) {
        const defaultColor = 'default';
        console.log('Accent color reset to default');
        localStorage.setItem('nm_accent_color', defaultColor);
        applyAccentColor(defaultColor);
        const select = document.getElementById('accentColorSelect');
        if (select) select.value = 'green';
        showToast('Accent color reset to default', 'success');
      }
    });
  }
  
  // Language
  const languageSelect = document.getElementById('languageSelect');
  if (languageSelect) {
    languageSelect.addEventListener('change', (e) => {
      localStorage.setItem('nm_language', e.target.value);
    });
  }
  
  // Spoken language
  const spokenLanguageSelect = document.getElementById('spokenLanguageSelect');
  if (spokenLanguageSelect) {
    spokenLanguageSelect.addEventListener('change', (e) => {
      localStorage.setItem('nm_spoken_language', e.target.value);
    });
  }
  
  // Voice
  const voiceSelect = document.getElementById('voiceSelect');
  if (voiceSelect) {
    voiceSelect.addEventListener('change', (e) => {
      localStorage.setItem('nm_voice', e.target.value);
    });
  }
  
  // Separate voice mode
  const separateVoiceMode = document.getElementById('separateVoiceMode');
  if (separateVoiceMode) {
    separateVoiceMode.addEventListener('change', (e) => {
      localStorage.setItem('nm_separate_voice_mode', e.target.checked.toString());
    });
  }
  
  // Show additional models
  const showAdditionalModels = document.getElementById('showAdditionalModels');
  if (showAdditionalModels) {
    showAdditionalModels.addEventListener('change', (e) => {
      localStorage.setItem('nm_show_additional_models', e.target.checked.toString());
    });
  }
  
  // Personalization settings - base tone selector (buttons)
  const baseToneOptions = document.querySelectorAll('.base-tone-option');
  baseToneOptions.forEach(btn => {
    btn.addEventListener('click', () => {
      // Remove selected class from all buttons
      baseToneOptions.forEach(b => {
        b.classList.remove('selected');
        const checkIcon = b.querySelector('.base-tone-check');
        if (checkIcon) checkIcon.style.opacity = '0';
      });
      
      // Add selected class to clicked button
      btn.classList.add('selected');
      const checkIcon = btn.querySelector('.base-tone-check');
      if (checkIcon) checkIcon.style.opacity = '1';
      
      // Save to localStorage
      const selectedTone = btn.getAttribute('data-tone');
      localStorage.setItem('nm_base_style_tone', selectedTone);
      localStorage.setItem('nm_mode', selectedTone); // Also update main tone setting
      
      // Update the main chat tone if it exists
      if (typeof updateTone === 'function') {
        updateTone(selectedTone);
      }
    });
  });
  
  const characteristicWarm = document.getElementById('characteristicWarm');
  if (characteristicWarm) {
    characteristicWarm.addEventListener('change', (e) => {
      localStorage.setItem('nm_characteristic_warm', e.target.value);
    });
  }
  
  const characteristicEnthusiastic = document.getElementById('characteristicEnthusiastic');
  if (characteristicEnthusiastic) {
    characteristicEnthusiastic.addEventListener('change', (e) => {
      localStorage.setItem('nm_characteristic_enthusiastic', e.target.value);
    });
  }
  
  const characteristicHeaders = document.getElementById('characteristicHeaders');
  if (characteristicHeaders) {
    characteristicHeaders.addEventListener('change', (e) => {
      localStorage.setItem('nm_characteristic_headers', e.target.value);
    });
  }
  
  const characteristicEmoji = document.getElementById('characteristicEmoji');
  if (characteristicEmoji) {
    characteristicEmoji.addEventListener('change', (e) => {
      localStorage.setItem('nm_characteristic_emoji', e.target.value);
    });
  }
  
  const customInstructions = document.getElementById('customInstructions');
  if (customInstructions) {
    customInstructions.addEventListener('input', (e) => {
      localStorage.setItem('nm_custom_instructions', e.target.value);
    });
  }
  
  const personalizationNickname = document.getElementById('personalizationNickname');
  if (personalizationNickname) {
    personalizationNickname.addEventListener('input', (e) => {
      localStorage.setItem('nm_personalization_nickname', e.target.value);
    });
  }
  
  const personalizationOccupation = document.getElementById('personalizationOccupation');
  if (personalizationOccupation) {
    personalizationOccupation.addEventListener('input', (e) => {
      localStorage.setItem('nm_personalization_occupation', e.target.value);
    });
  }
  
  const moreAboutYou = document.getElementById('moreAboutYou');
  if (moreAboutYou) {
    moreAboutYou.addEventListener('input', (e) => {
      localStorage.setItem('nm_more_about_you', e.target.value);
    });
  }
  
  const referenceSavedMemories = document.getElementById('referenceSavedMemories');
  if (referenceSavedMemories) {
    referenceSavedMemories.addEventListener('change', (e) => {
      localStorage.setItem('nm_reference_saved_memories', e.target.checked.toString());
    });
  }
  
  const referenceChatHistory = document.getElementById('referenceChatHistory');
  if (referenceChatHistory) {
    referenceChatHistory.addEventListener('change', (e) => {
      localStorage.setItem('nm_reference_chat_history', e.target.checked.toString());
    });
  }
  
  // Manage Memory button
  const manageMemoryBtn = document.getElementById('manageMemoryBtn');
  if (manageMemoryBtn) {
    manageMemoryBtn.addEventListener('click', () => {
      showToast('Memory management coming soon', 'info');
      // TODO: Implement memory management modal/page
    });
  }
}

// Voice play button functionality
function initVoicePlayButton() {
  const playBtn = document.getElementById('playVoiceBtn');
  if (!playBtn) return;
  
  let isPlaying = false;
  let audioContext = null;
  let oscillator = null;
  
  playBtn.addEventListener('click', () => {
    if (isPlaying) {
      // Stop playing
      if (oscillator) {
        oscillator.stop();
        oscillator = null;
      }
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      playBtn.innerHTML = '<i class="fa-solid fa-play text-gray-600 text-xs"></i>';
      isPlaying = false;
    } else {
      // Start playing
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 440; // A4 note
        oscillator.type = 'sine';
        gainNode.gain.value = 0.1;
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.5); // Play for 0.5 seconds
        
        playBtn.innerHTML = '<i class="fa-solid fa-stop text-gray-600 text-xs"></i>';
        isPlaying = true;
        
        oscillator.onended = () => {
          playBtn.innerHTML = '<i class="fa-solid fa-play text-gray-600 text-xs"></i>';
          isPlaying = false;
          if (audioContext) {
            audioContext.close();
            audioContext = null;
          }
        };
      } catch (err) {
        console.error('Failed to play voice preview:', err);
        showToast('Voice preview not available', 'info');
      }
    }
  });
}

// ============================================
// LAYOUT & NAVIGATION
// ============================================

// Mobile sidebar toggle (for burger button)
function toggleMobileSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('mobileOverlay');
  
  if (!sidebar || !overlay) {
    console.error('Sidebar or overlay not found');
    return;
  }
  
  // Check if we're on mobile
  if (window.innerWidth > 768) {
    return; // Don't toggle on desktop
  }
  
  const isOpen = sidebar.classList.contains('sidebar-open');
  
    if (isOpen) {
    // Close sidebar
    sidebar.classList.remove('sidebar-open');
      overlay.classList.add('hidden');
    document.body.style.overflow = '';
    console.log('Mobile sidebar closed');
    } else {
    // Open sidebar
    sidebar.classList.add('sidebar-open');
      overlay.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    console.log('Mobile sidebar opened');
  }
}

function initMobileSidebar() {
  const burgerBtn = document.getElementById('burgerBtn');
  const overlay = document.getElementById('mobileOverlay');
  const sidebar = document.getElementById('sidebar');
  
  console.log('Initializing mobile sidebar...', { burgerBtn, overlay, sidebar });
  
  // Burger button click
  if (burgerBtn) {
    // Remove old listeners by cloning
    const newBtn = burgerBtn.cloneNode(true);
    burgerBtn.parentNode.replaceChild(newBtn, burgerBtn);
    
    newBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      console.log('Burger button clicked in initMobileSidebar');
      toggleMobileSidebar();
    });
  } else {
    console.error('Burger button not found in initMobileSidebar');
  }
  
  // Overlay click to close
  if (overlay) {
    overlay.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleMobileSidebar();
    });
  }
  
  // Close sidebar when clicking on a session card (mobile)
  document.addEventListener('click', (e) => {
    if (window.innerWidth <= 768) {
      const sessionCard = e.target.closest('.session-card');
      if (sessionCard && sidebar && sidebar.classList.contains('sidebar-open')) {
        toggleMobileSidebar();
      }
    }
  });
  
  // Handle window resize
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
      // Desktop: ensure sidebar is visible and reset mobile state
      if (sidebar) {
        sidebar.classList.remove('sidebar-open');
        sidebar.style.transform = '';
      }
      if (overlay) {
        overlay.classList.add('hidden');
      }
      document.body.style.overflow = '';
    }
  });
}

function updateComposerPadding() {
  const composer = document.getElementById('composer');
  const chatWindow = document.getElementById('chatWindow');
  if (!composer || !chatWindow) return;
  
  const height = composer.getBoundingClientRect().height;
  chatWindow.style.paddingBottom = `${height + 24}px`;
}

// Jump to latest
function initJumpToLatest() {
  const jumpBtn = document.getElementById('jumpToLatest');
  const chatWindow = document.getElementById('chatWindow');
  
  if (!jumpBtn || !chatWindow) return;
  
  jumpBtn.addEventListener('click', () => {
    chatWindow.scrollTo({
      top: chatWindow.scrollHeight,
      behavior: 'smooth'
    });
    jumpBtn.classList.remove('visible');
  });
  
  // Show/hide based on scroll position
  chatWindow.addEventListener('scroll', debounce(() => {
    const isAtBottom = chatWindow.scrollHeight - chatWindow.scrollTop - chatWindow.clientHeight < 100;
    if (isAtBottom) {
      jumpBtn.classList.remove('visible');
    } else {
      jumpBtn.classList.add('visible');
    }
  }, 100));
}

// ============================================
// QUICK PROMPTS
// ============================================

function quickPrompt(text) {
  const input = document.getElementById('chatInput');
  if (input) {
    input.value = text;
    input.focus();
    // Auto-send or let user review
    // sendChat(); // Uncomment to auto-send
  }
}

// ============================================
// TOGGLE HISTORY
// ============================================

// Global function to toggle sidebar (used by multiple buttons)
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  if (!sidebar) {
    console.error('Sidebar not found');
    return;
  }
  
  // Don't collapse on mobile
  if (window.innerWidth <= 768) {
    return;
  }
  
  const isCollapsed = sidebar.classList.contains('sidebar-collapsed');
  
  if (isCollapsed) {
    // Expand sidebar
    sidebar.classList.remove('sidebar-collapsed');
    sidebar.classList.add('sidebar-expanded');
    localStorage.setItem('sidebarCollapsed', 'false');
  } else {
    // Collapse sidebar
    sidebar.classList.remove('sidebar-expanded');
    sidebar.classList.add('sidebar-collapsed');
    localStorage.setItem('sidebarCollapsed', 'true');
  }
}

function initToggleHistory() {
  const toggleBtn = document.getElementById('toggleHistoryBtn');
  const sidebar = document.getElementById('sidebar');
  
  if (!toggleBtn || !sidebar) {
    console.error('Toggle sidebar elements not found');
    return;
  }
  
  // Check localStorage for saved state
  const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
  if (isCollapsed) {
    sidebar.classList.add('sidebar-collapsed');
    sidebar.classList.remove('sidebar-expanded');
  } else {
    sidebar.classList.remove('sidebar-collapsed');
    sidebar.classList.add('sidebar-expanded');
  }
  
  // Toggle from split-screen button (when expanded) - desktop only
  toggleBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    console.log('Toggle history button clicked');
    // Only collapse/expand on desktop
    if (window.innerWidth > 768) {
      toggleSidebar();
    }
  });
  
  // Toggle from "Open sidebar" hover button
  const openSidebarHoverBtn = document.getElementById('openSidebarHoverBtn');
  if (openSidebarHoverBtn) {
    openSidebarHoverBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleSidebar();
    });
  }
  
  // Toggle from sidebar icon button (when collapsed)
  const sidebarIconBtn = document.getElementById('sidebarIconBtn');
  if (sidebarIconBtn) {
    sidebarIconBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (sidebar.classList.contains('sidebar-collapsed')) {
        toggleSidebar();
      }
    });
  }
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async () => {
  console.log('Dashboard initializing...');
  
  // Apply appearance on page load FIRST (before other initializations) - CRITICAL: Do this first to avoid flash
  const savedAppearance = localStorage.getItem('nm_appearance') || 'system';
  applyTheme(savedAppearance);
  
  // Listen for system theme changes if using system preference
  if (savedAppearance === 'system') {
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      applyTheme('system');
    });
  }
  
  // Apply accent color on page load
  const savedAccentColor = localStorage.getItem('nm_accent_color') || 'default';
  applyAccentColor(savedAccentColor);
  
  // Load user name on page load
  try {
    const res = await fetch('/api/user/settings/', { credentials: 'include' });
    if (res.ok) {
      const data = await res.json();
      const userDisplayName = document.getElementById('userDisplayName');
      if (userDisplayName) {
        // Prioritize display_name (user's preferred name from Account settings), then full_name, then fallback
        userDisplayName.textContent = data.display_name || data.full_name || 'User';
      }
    }
  } catch (err) {
    console.error('Failed to load user name on page load:', err);
  }
  
  try {
    // Initialize all components
    initToneSelector();
    initCareSelector();
    initFaithSelector();
    initLanguagePicker();
    initVoiceDictation();
    initJumpToLatest();
    updateActiveChips();
    updateConditionalSettings();
    updateComposerPadding();
    
    // File input
    const fileInput = document.getElementById('fileInput');
    const attachBtn = document.getElementById('attachBtn');
    console.log('File input:', fileInput, 'Attach button:', attachBtn);
    if (attachBtn && fileInput) {
      attachBtn.addEventListener('click', () => {
        console.log('Attach button clicked');
        fileInput.click();
      });
      fileInput.addEventListener('change', (e) => {
        console.log('Files selected:', e.target.files);
        if (e.target.files) addFiles(e.target.files);
        e.target.value = ''; // Reset to allow re-selecting same file
      });
    } else {
      console.warn('File input or attach button not found');
    }
    
    // Clear all button
    const clearAllBtn = document.getElementById('clearAllBtn');
    if (clearAllBtn) {
      clearAllBtn.addEventListener('click', () => {
        console.log('Clear all clicked');
        clearPending();
      });
    } else {
      console.warn('Clear all button not found');
    }
    
    // Send button
    const sendBtn = document.getElementById('sendBtn');
    if (sendBtn) {
      sendBtn.addEventListener('click', () => {
        console.log('Send button clicked');
        sendChat();
      });
    } else {
      console.error('Send button not found!');
    }
    
    // Chat input Enter key
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          console.log('Enter key pressed, sending chat');
          sendChat();
        }
      });
    } else {
      console.error('Chat input not found!');
    }
    
    // First message view input handlers
    const firstChatInput = document.getElementById('firstChatInput');
    const firstSendBtn = document.getElementById('firstSendBtn');
    const firstMicBtn = document.getElementById('firstMicBtn');
    const firstAttachBtn = document.getElementById('firstAttachBtn');
    const firstFileInput = document.getElementById('firstFileInput');
    
    if (firstChatInput) {
      firstChatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          // Copy text to regular input BEFORE transitioning
          const text = firstChatInput.value.trim();
          const regularInput = document.getElementById('chatInput');
          if (text && regularInput) {
            regularInput.value = text;
          }
          // Transition IMMEDIATELY before sending
          const firstMessageView = document.getElementById('firstMessageView');
          if (firstMessageView && !firstMessageView.classList.contains('hidden')) {
            transitionToNormalChat();
          }
          // Small delay to ensure transition completes, then send
          setTimeout(() => sendChat(), 50);
        }
      });
    }
    
    if (firstSendBtn) {
      firstSendBtn.addEventListener('click', () => {
        // Copy text to regular input BEFORE transitioning
        const text = firstChatInput.value.trim();
        const regularInput = document.getElementById('chatInput');
        if (text && regularInput) {
          regularInput.value = text;
        }
        // Transition IMMEDIATELY before sending
        const firstMessageView = document.getElementById('firstMessageView');
        if (firstMessageView && !firstMessageView.classList.contains('hidden')) {
          transitionToNormalChat();
        }
        // Small delay to ensure transition completes, then send
        setTimeout(() => sendChat(), 50);
      });
    }
    
    if (firstAttachBtn && firstFileInput) {
      firstAttachBtn.addEventListener('click', () => {
        firstFileInput.click();
      });
      firstFileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files.length > 0) {
          addFiles(e.target.files);
          // Transition to normal view IMMEDIATELY when files are added
          transitionToNormalChat();
          // Copy any text from first input to regular input
          const firstInputText = firstChatInput?.value || '';
          const regularInput = document.getElementById('chatInput');
          if (firstInputText && regularInput) {
            regularInput.value = firstInputText;
          }
          // Clear first input
          if (firstChatInput) firstChatInput.value = '';
        }
        e.target.value = '';
      });
    }
    
    // First message mic button (can reuse voice dictation logic)
    if (firstMicBtn) {
      firstMicBtn.addEventListener('click', () => {
        // Transition to normal view and trigger mic
        transitionToNormalChat();
        setTimeout(() => {
          const micBtn = document.getElementById('micBtn');
          if (micBtn) micBtn.click();
        }, 200);
      });
    }
    
    // New chat button
    const newChatBtn = document.getElementById('newChatBtn');
    if (newChatBtn) {
      newChatBtn.addEventListener('click', () => {
        console.log('New chat button clicked');
        newChat();
      });
    } else {
      console.error('New chat button not found!');
    }
    
    // Initialize mobile sidebar (with error handling)
    try {
      if (typeof initMobileSidebar === 'function') {
        initMobileSidebar();
        console.log('Mobile sidebar initialized');
      } else {
        console.error('initMobileSidebar function not found');
      }
    } catch (err) {
      console.error('Failed to initialize mobile sidebar:', err);
    }
    
    // Sidebar menu items
    const sidebarNewChat = document.getElementById('sidebarNewChat');
    if (sidebarNewChat) {
      sidebarNewChat.addEventListener('click', () => {
        newChat();
        // Close sidebar on mobile after clicking
        if (window.innerWidth <= 768) {
          toggleMobileSidebar();
        }
      });
    }
    
    const sidebarSearchChats = document.getElementById('sidebarSearchChats');
    if (sidebarSearchChats) {
      sidebarSearchChats.addEventListener('click', () => {
        openSearchModal();
        // Close sidebar on mobile after clicking
        if (window.innerWidth <= 768) {
          toggleMobileSidebar();
        }
      });
    }
    
    // Search modal functionality
    const searchModalInput = document.getElementById('searchModalInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const searchNewChatBtn = document.getElementById('searchNewChatBtn');
    
    if (searchModalInput) {
      searchModalInput.addEventListener('input', (e) => {
        const query = e.target.value;
        if (query.trim()) {
          if (clearSearchBtn) clearSearchBtn.classList.remove('hidden');
          loadSearchResults(query);
        } else {
          if (clearSearchBtn) clearSearchBtn.classList.add('hidden');
          loadSearchResults('');
        }
      });
      
      // Close on Escape
      searchModalInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeSearchModal();
        }
      });
    }
    
    if (clearSearchBtn) {
      clearSearchBtn.addEventListener('click', () => {
        if (searchModalInput) {
          searchModalInput.value = '';
          searchModalInput.focus();
        }
        clearSearchBtn.classList.add('hidden');
        loadSearchResults('');
      });
    }
    
    if (searchNewChatBtn) {
      searchNewChatBtn.addEventListener('click', () => {
        closeSearchModal();
        newChat();
      });
    }
    
    const sidebarImages = document.getElementById('sidebarImages');
    if (sidebarImages) {
      sidebarImages.addEventListener('click', () => {
        // Show images view or filter sessions with images
        // For now, just show a toast - can be expanded later
        showToast('Images feature coming soon', 'info');
        // Could filter sessions to show only those with images
      });
    }
    
    const sidebarApps = document.getElementById('sidebarApps');
    if (sidebarApps) {
      sidebarApps.addEventListener('click', () => {
        // Show apps view
        showToast('Apps feature coming soon', 'info');
      });
    }
    
    // Initialize images badge on load
    updateImagesBadge();
    
    // User menu button
    const userMenuBtn = document.getElementById('userMenuBtn');
    if (userMenuBtn) {
      userMenuBtn.addEventListener('click', () => {
        console.log('User menu button clicked');
        openSettingsModal();
        // Close sidebar on mobile after clicking
        if (window.innerWidth <= 768) {
          toggleMobileSidebar();
        }
      });
    } else {
      console.warn('User menu button not found');
    }
    
    // Burger button is handled by initMobileSidebar() above
    
    // Toggle history (arrow next to logo)
    initToggleHistory();
    
    // Header "Open sidebar" button
    const openSidebarBtn = document.getElementById('openSidebarBtn');
    if (openSidebarBtn) {
      openSidebarBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        toggleSidebar();
      });
    }
    
    // Toggle archived section
    const toggleArchived = document.getElementById('toggleArchived');
    const archivedList = document.getElementById('archivedList');
    if (toggleArchived && archivedList) {
      toggleArchived.addEventListener('click', () => {
        const isHidden = archivedList.classList.contains('hidden');
        archivedList.classList.toggle('hidden');
        const icon = toggleArchived.querySelector('i');
        if (icon) {
          icon.classList.toggle('fa-chevron-down');
          icon.classList.toggle('fa-chevron-up');
        }
      });
    }
    
    // Drag & drop
    const dropzone = document.getElementById('dropzone');
    if (dropzone) {
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });
      
      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
      });
      
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        if (e.dataTransfer.files) {
          addFiles(e.dataTransfer.files);
        }
      });
    }
    
    // Session search
    const sessionSearch = document.getElementById('sessionSearch');
    if (sessionSearch) {
      sessionSearch.addEventListener('input', debounce((e) => {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('.session-card').forEach(card => {
          const title = card.querySelector('.session-title')?.textContent.toLowerCase() || '';
          if (title.includes(query)) {
            card.style.display = '';
          } else {
            card.style.display = 'none';
          }
        });
      }, 300));
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // ESC closes modals
      if (e.key === 'Escape') {
        closeSettingsModal();
        closeSummaryModal();
        closeDeleteModal();
        document.querySelectorAll('.popover').forEach(p => {
          p.classList.add('hidden');
          p.style.display = 'none';
        });
      }
      
      // Cmd/Ctrl + K for new chat
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        newChat();
      }
    });
    
    // Bulk delete functionality
    const toggleBulkSelectBtn = document.getElementById('toggleBulkSelectBtn');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    
    if (toggleBulkSelectBtn) {
      toggleBulkSelectBtn.addEventListener('click', toggleBulkSelect);
    }
    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', selectAllSessions);
    }
    if (bulkDeleteBtn) {
      bulkDeleteBtn.addEventListener('click', openBulkDeleteModal);
    }
    
    // Update selected count when checkboxes change
    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('session-checkbox')) {
        updateSelectedCount();
      }
    });
    
    // Load initial state
    console.log('Loading sessions...');
    try {
      await refreshSessionList();
      console.log('Sessions loaded successfully');
    } catch (err) {
      console.error('Failed to load sessions on init:', err);
      showToast('Failed to load chat history. Please refresh the page.', 'error');
    }
    
    // Try to restore last session, or create new one automatically
    const sid = getSessionId();
    if (sid) {
      console.log('Restoring last session:', sid);
      // Ensure first message view is hidden BEFORE loading session (in case it's showing)
      // This prevents any flash of the first message view when loading existing sessions
      transitionToNormalChat();
      try {
        await openSession(sid);
        console.log('Session restored successfully');
        // If session has no messages, show greeting
        const chatWindow = document.getElementById('chatWindow');
        if (chatWindow && chatWindow.children.length === 0) {
          await greetUser(true);
        } else {
          // Session has messages - ensure first message view is definitely hidden
          transitionToNormalChat();
        }
      } catch (err) {
        console.error('Failed to restore session:', err);
        clearSessionId();
        // Automatically create new session and show greeting
        await initializeNewChat();
      }
    } else {
      // No session exists - automatically create new chat and show greeting
      console.log('No session found - creating new chat automatically');
      await initializeNewChat();
    }
    
    // Window resize handler
    window.addEventListener('resize', debounce(updateComposerPadding, 100));
    
    // Geriatric mode
    if (currentTone === 'Geriatric') {
      document.body.classList.add('geriatric-zoom');
    }
    
    console.log('Dashboard initialized successfully');
  } catch (error) {
    console.error('Dashboard initialization error:', error);
    // Show user-friendly error message
    showToast('Failed to initialize dashboard. Please refresh the page.', 'error');
    console.error('Error stack:', error.stack);
    // Try to show toast, but if showToast isn't defined, just alert
    try {
      showToast('Failed to initialize dashboard. Please refresh the page.', 'error');
    } catch {
      alert('Dashboard initialization failed. Please check console and refresh the page.');
    }
  }
});

// Expose functions globally for onclick handlers
window.quickPrompt = quickPrompt;
window.closeSettingsModal = closeSettingsModal;
window.saveSettings = saveSettings;
window.closeSummaryModal = closeSummaryModal;
window.copySummary = copySummary;
window.closeDeleteModal = closeDeleteModal;
window.confirmDelete = confirmDelete;
window.toggleSidebar = toggleSidebar;
window.openSessionMenu = openSessionMenu;
window.startRenameSession = startRenameSession;
window.archiveSession = archiveSession;
window.unarchiveSession = unarchiveSession;
window.confirmDeleteSession = confirmDeleteSession;
window.toggleBulkSelect = toggleBulkSelect;
window.selectAllSessions = selectAllSessions;
window.deselectAllSessions = deselectAllSessions;
window.openBulkDeleteModal = openBulkDeleteModal;
window.closeBulkDeleteModal = closeBulkDeleteModal;
window.confirmBulkDelete = confirmBulkDelete;
window.updateSelectedCount = updateSelectedCount;
window.logoutUser = function() {
  if (confirm('Are you sure you want to log out?')) {
    const logoutUrl = '{% url "logout" %}';
    const loginUrl = '{% url "login" %}';
    
    fetch(logoutUrl, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRFToken() },
      credentials: 'include'
    }).then(() => {
      clearSessionId();
      window.location.href = loginUrl;
    }).catch(() => {
      window.location.href = loginUrl;
    });
  }
};

// Make mobile functions available globally
window.toggleMobileSidebar = toggleMobileSidebar;
window.initMobileSidebar = initMobileSidebar;
  </script>
</body>
</html>
