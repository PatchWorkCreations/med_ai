{% load static %}


<style>
    #chatWindow {
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        padding-right: 4px;
        padding-bottom: 8px;
        line-height: 1.6;
        background-color: #fff;
        }

        #chatWindow span {
        word-wrap: break-word;
        display: inline-block;
        border-radius: 1rem;
        }

        #chatPopup input[type="text"] {
        font-family: 'Inter', sans-serif;
        border-radius: 0.5rem;
        padding: 0.75rem;
        border: 1px solid #e5e7eb;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }


    @keyframes fadeInUp {
    0% { opacity: 0; transform: translateY(10px); }
    100% { opacity: 1; transform: translateY(0); }
    }

    #chatWindow p {
  margin-bottom: 0.75rem;
  white-space: normal;
}

#chatWindow ul, #chatWindow ol {
  margin: 0.75rem 0 0.75rem 1rem;
  padding-left: 1rem;
  list-style-position: inside;
}

#chatWindow li {
  margin-bottom: 0.25rem;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}

.animate-bounce {
  animation: bounce 0.6s infinite;
}

#chatPopup input[type="text"] {
  flex: 1;
}

@keyframes pulse {
  0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(13, 148, 136, 0.4); }
  70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(13, 148, 136, 0); }
  100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(13, 148, 136, 0); }
}

.mic-listening {
  animation: pulse 1.5s infinite;
  background-color: #ccfbf1; /* light teal */
  border: 1px solid #14b8a6; /* teal */
  color: #1B5A8E; /* darker teal */
}

/* Add this near your existing styles */
#chatPopup::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  backdrop-filter: blur(6px);
  background: rgba(255, 255, 255, 0.4);
  z-index: -1;
  border-radius: inherit;
  transition: all 0.3s ease-in-out;
}

#chatPopup {
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s ease-in-out;
  pointer-events: none;
}

#chatPopup.open {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}


</style>
<div class="max-w-md mx-auto border border-gray-300 rounded-2xl overflow-hidden shadow-md bg-white flex flex-col h-[600px]">

  <!-- Header -->
  <div class="flex items-center justify-between px-4 py-3 border-b bg-white">
    <div class="flex items-center gap-2">
      <i class="fa-solid fa-notes-medical text-[#236092] text-xl"></i>
      <h1 class="text-lg font-bold text-gray-800">NeuroMed <span class="text-[#236092]">AI</span></h1>
    </div>
    <i class="fa-solid fa-lightbulb text-[#236092] text-lg cursor-pointer" title="Tips / Suggestions"></i>
  </div>

  <!-- Chat Window -->
  <div id="chatWindow" class="flex-1 overflow-y-auto p-4 space-y-3 text-sm text-gray-800 bg-white">
    <!-- Chat bubbles will be appended here -->
  </div>

  <!-- Input Area -->
  <div class="border-t p-3 flex items-center gap-2 bg-[#fefaf7]">

    <!-- Upload Button -->
    <button onclick="document.getElementById('fileInput').click()" class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center text-lg">
      <i class="fa-solid fa-plus"></i>
    </button>
    <input type="file" id="fileInput" class="hidden" accept=".pdf,.docx,.txt,.jpg,.jpeg,.png,.webp,.heic,.bmp,.tiff,.gif" />

    <!-- Text Input -->
    <input
      type="text"
      id="chatInput"
      class="flex-1 px-4 py-2 text-sm border rounded-xl focus:outline-none"
      placeholder="Type your question..."
      onkeydown="if(event.key==='Enter') sendChat()"
    />

    <!-- Mic Button -->
    <button id="micBtn" onclick="startDictation()" class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center">
      <i class="fa-solid fa-microphone"></i>
    </button>

    <!-- Send Button -->
    <button id="sendBtn" onclick="sendChat()" class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center">
      <i class="fa-solid fa-paper-plane"></i>
    </button>
  </div>
</div>


  
  
  <script>
function getCSRFToken() {
  const cookieValue = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)');
  return cookieValue ? cookieValue.pop() : '';
}

function toggleSuggestions() {
  const panel = document.getElementById("aiSuggestions");
  panel.classList.toggle("hidden");

  if (!panel.classList.contains("hidden")) {
    regenerateSuggestions(); // Call this only when opening the panel
  }
}

function toggleChat(forceClose = false) {
  const popup = document.getElementById("chatPopup");
  const toggleBtn = document.getElementById("chatToggleBtn");

  const isOpen = popup.classList.contains("open");

  if (forceClose || isOpen) {
    popup.classList.remove("open");
    setTimeout(() => popup.classList.add("hidden"), 300);
    toggleBtn.classList.remove("hidden");
  } else {
    popup.classList.remove("hidden");
    setTimeout(() => popup.classList.add("open"), 10); // Slight delay for transition
    toggleBtn.classList.add("hidden");
  }
}

document.addEventListener("click", function (event) {
  const popup = document.getElementById("chatPopup");
  const toggleBtn = document.getElementById("chatToggleBtn");

  if (!popup.contains(event.target) && !toggleBtn.contains(event.target)) {
    if (popup.classList.contains("open")) {
      toggleChat(true);
    }
  }
});




function appendBubble(message, isUser = true) {
  const chatWindow = document.getElementById("chatWindow");
  const bubble = document.createElement("div");

  bubble.className = "mb-3 flex items-start gap-2";
  const content = isUser
    ? `<div class="bg-blue-100 text-blue-800 ml-auto px-4 py-2 rounded-2xl text-sm leading-relaxed shadow-sm max-w-[85%]">${message}</div>`
    : `<div class="bg-gray-100 text-gray-700 px-4 py-2 rounded-2xl text-sm leading-relaxed shadow-sm max-w-[85%]">${formatAIResponse(message)}</div>`;

  bubble.innerHTML = content;
  chatWindow.appendChild(bubble);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}



async function sendChat() {
  const input = document.getElementById("chatInput");
  const chatWindow = document.getElementById("chatWindow");
  const userMessage = input.value.trim();
  if (!userMessage) return;

  appendBubble(userMessage, true);
  input.value = "";

  // Typing bubble with animation
  const typingBubble = document.createElement("div");
  typingBubble.className = "mb-2";
  typingBubble.innerHTML = `
    <div class="flex gap-1 items-center px-3 py-1 rounded-xl bg-gray-100 w-fit">
      <span class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 0s;"></span>
      <span class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 0.1s;"></span>
      <span class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 0.2s;"></span>
    </div>
  `;
  chatWindow.appendChild(typingBubble);
  chatWindow.scrollTop = chatWindow.scrollHeight;

  try {
    const response = await fetch("/api/send-chat/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken(),
      },
      body: JSON.stringify({
        message: userMessage,
        summary: document.getElementById("summaryOutput")?.value || "",
        tone: document.querySelector('input[name="tone"]:checked')?.value || "Plain"
      })
    });

    const data = await response.json();
    typingBubble.innerHTML = `
      <div class="bg-gray-100 text-gray-700 px-4 py-2 rounded-2xl text-sm leading-relaxed shadow-sm max-w-[85%]">
        ${formatAIResponse(data.reply)}
      </div>
    `;
  } catch (err) {
    typingBubble.innerHTML = `
      <span class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-xl">
        ‚ö†Ô∏è Failed to reply. Try again later.
      </span>
    `;
  }
}


function openChatWith(initialMessage) {
  toggleChat();
  const input = document.getElementById("chatInput");
  input.value = initialMessage;

  setTimeout(() => {
    document.getElementById("sendBtn")?.click() || sendChat(); // Trigger send
  }, 100);
}

async function regenerateSuggestions() {
  const summary = document.getElementById("summaryOutput")?.value || "";
  const container = document.getElementById("suggestionCards");
  const tone = document.querySelector('input[name="tone"]:checked')?.value || "PlainClinical";


  container.innerHTML = `<p class="text-sm text-gray-400">Thinking of ways to help you feel better‚Ä¶ üß†üí≠</p>`;

  try {
    const res = await fetch("/api/smart-suggestions/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken(),
      },
      body: JSON.stringify({ summary, tone })
    });

    const data = await res.json();
    container.innerHTML = "";

    data.suggestions.forEach(item => {
      const block = document.createElement("div");
      block.className = "bg-white p-3 rounded-md border border-gray-200 shadow-sm";
      block.innerHTML = `
        <p class="text-gray-700 font-medium mb-1">‚ùì ${item.question}</p>
        <button onclick="openChatWith(\`${item.question}\`)" class="text-xs text-blue-500 hover:underline mt-2">üí¨ Chat about this</button>
      `;
      container.appendChild(block);
    });
  } catch {
    container.innerHTML = `<p class="text-red-500 text-sm">‚ö†Ô∏è Sorry, di ako naka-connect ngayon. Try ulit later.</p>`;
  }
}

document.addEventListener("DOMContentLoaded", function () {
  const summaryOutput = document.getElementById("summaryOutput");

  document.getElementById("copyBtn")?.addEventListener("click", () => {
    navigator.clipboard.writeText(summaryOutput.value)
      .then(() => alert("‚úÖ Summary copied to clipboard"))
      .catch(() => alert("‚ùå Failed to copy"));
  });

  document.getElementById("downloadBtn")?.addEventListener("click", () => {
    const blob = new Blob([summaryOutput.value], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "neura_summary.txt";
    a.click();
    URL.revokeObjectURL(url);
  });
});


function formatAIResponse(text, keywords = []) {
  text = text.trim().replace(/\r\n|\r/g, '\n');

  // Convert double newlines to paragraphs
  const paragraphs = text.split(/\n{2,}/).map(p => p.trim());

  let html = paragraphs.map(p => {
    // Handle bullet points and numbered lists
    if (/^[-‚Ä¢*‚Äí]\s+/.test(p)) {
      const items = p.split(/\n/).map(item => `<li>${item.replace(/^[-‚Ä¢*‚Äí]\s+/, '')}</li>`).join('');
      return `<ul>${items}</ul>`;
    } else if (/^\d+\.\s+/.test(p)) {
      const items = p.split(/\n/).map(item => `<li>${item.replace(/^\d+\.\s+/, '')}</li>`).join('');
      return `<ol>${items}</ol>`;
    } else {
      return `<p>${p}</p>`;
    }
  }).join('');

  // Highlight keywords
  keywords.forEach(keyword => {
    const regex = new RegExp(`\\b(${keyword})\\b`, 'gi');
    html = html.replace(regex, '<strong>$1</strong>');
  });

  return html;
}

function startDictation() {
  const micBtn = document.getElementById("micBtn");

  if (!('webkitSpeechRecognition' in window)) {
    alert("Your browser doesn't support speech recognition. Try Chrome.");
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.continuous = true; // üëà Keeps listening as user composes thoughts
  recognition.interimResults = false;
  recognition.lang = 'en-US';

  recognition.onstart = () => {
    micBtn.classList.add("mic-listening");
    micBtn.title = "Listening...";
  };

  recognition.onerror = (event) => {
    micBtn.classList.remove("mic-listening");
    micBtn.title = "Speak your message";
    alert("‚ö†Ô∏è Speech recognition error: " + event.error);
  };

  recognition.onend = () => {
    micBtn.classList.remove("mic-listening");
    micBtn.title = "Speak your message";
  };

  recognition.onresult = (event) => {
    let fullTranscript = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      fullTranscript += event.results[i][0].transcript + " ";
    }

    document.getElementById("chatInput").value = fullTranscript.trim();
    // Optional: You can auto-send if you prefer by calling sendChat();
  };

  recognition.start();
}


const synth = window.speechSynthesis;
let currentUtterance = null;

document.getElementById("audioBtn")?.addEventListener("click", () => {
  const summaryText = document.getElementById("summaryOutput")?.value;

  if (!summaryText) {
    alert("‚ùóThere's no summary to read.");
    return;
  }

  if (synth.speaking) {
    synth.cancel(); // Stop reading
    return;
  }

  currentUtterance = new SpeechSynthesisUtterance(summaryText);
  currentUtterance.lang = "en-US";
  currentUtterance.pitch = 1;
  currentUtterance.rate = 1;
  currentUtterance.volume = 1;

  synth.speak(currentUtterance);
});

const audioIcon = document.querySelector("#audioBtn i");

currentUtterance.onstart = () => {
  audioIcon.classList.remove("fa-volume-up");
  audioIcon.classList.add("fa-stop");
};

currentUtterance.onend = () => {
  audioIcon.classList.remove("fa-stop");
  audioIcon.classList.add("fa-volume-up");
};




  </script>
  